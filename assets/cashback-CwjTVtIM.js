import{o as j,p as q,I as w}from"./solvers-GF9CDpzm.js";function pt(t){const{cashbackCalculator:n,uiUpdater:e}=t;return function(o){const{results:c,inputConfig:s,chartLabels:l,gachaConfig:p}=o,r=n(s,p,c.cashbackData.SSR,c.cashbackData.CharSR,c.cashbackData.WepSR,s.SR.rateUps);e(c.cashbackData.SSR,l,r)}}class mt{constructor(n,e={}){this.config=n,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...e}}async runGachaCalculation(n,e){this.adapters.contexts.contextSSR.target=e;let a=[],o={},c=!1,s=!1;const{ssrWorker:l,srWorker:p}=this.adapters.workerManager.getWorkers(),r=this.adapters.distributionArrays.sortPity(n);this.adapters.contexts.contextSSR.pities=r;let{distributionSSR:i}=this.adapters.distributionArrays.makeSSR(n,r),{distributionCharSR:f,distributionWepSR:h}=this.adapters.distributionArrays.makeSR(n);try{await z(l,p,this.adapters.contexts,i,{distributionCharSR:f,distributionWepSR:h},r)}catch(u){console.error("Failed to initialize workers:",u)}let m=await M(l);for(m.type==="IterationComplete"?o=m.lossData:(o=m.lossData,c=m.isTarget,s=m.isEmpty,a=m.allPullsDistributionSSR,i=m.distributionSSR);!s&&!c;)[m]=await Promise.all([M(l),F(p,o)]),m.type==="IterationComplete"?o=m.lossData:(o=m.lossData,c=m.isTarget,s=m.isEmpty,a=m.allPullsDistributionSSR,i=m.distributionSSR);let C=await N(p,o);this.adapters.workerManager.terminateWorkers(),f=C.distributionCharSR,h=C.distributionWepSR;const y={SSR:this.adapters.helpers.consolidateDistributionForCashback(i),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(h)};this.adapters.helpers.simplifyDistribution(i),f=null,h=null;let D=0;const B=10;for(;!s;)c&&(D++,this.adapters.pullLogic.rankUpSSRCheap(i,r),D===B&&this.adapters.helpers.normalizeCheap(i),a.push(this.adapters.helpers.consolidateProbabilitiesCheap(i)),s=this.adapters.helpers.checkIsEmpty(i,c));return{chartData:a,cashbackData:y};async function z(u,b,k,R,{distributionCharSR:d,distributionWepSR:H}){return new Promise((K,V)=>{let g=!1,v=!1,W=!1;function I(){!W&&g&&v&&K()}function O(S){W||(W=!0,V(S))}u.onerror=S=>{console.error("Worker error:",S),O(S)},b.onerror=S=>{O(S)},u.onmessage=function(S){switch(S.data.type){case"InitComplete":g=!0,I();break;default:console.warn("Unknown message type")}},b.onmessage=function(S){switch(S.data.type){case"InitComplete":v=!0,I();break;default:console.warn("Unknown message type")}},u.postMessage({type:"Initiate",distribution:R,context:k}),b.postMessage({type:"Initiate",distribution:{distributionCharSR:d,distributionWepSR:H},context:k})})}function M(u){return new Promise((b,k)=>{u.onmessage=R=>{switch(R.data.type){case"IterationComplete":b(R.data);break;case"LastIteration":b(R.data);break}},u.onerror=k,u.postMessage({type:"Iterate"})})}function F(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k()},u.onerror=R,u.postMessage({type:"Iterate",lossData:b})})}function N(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k(d.data)},u.onerror=R,u.postMessage({type:"IterateLast",lossData:b})})}}}function Y(t){return new Worker("/assets/ssr-worker-D4YCWSXa.js",{type:"module",name:t?.name})}function G(t){return new Worker("/assets/sr-worker-Bs6jCU2D.js",{type:"module",name:t?.name})}class ft{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new Y),this.srWorker||(this.srWorker=new G),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class U{constructor(n,e,a){this.rateUps=n,this.offRates=e,this.probability=a}}function $(t,n,e){const a=[],o=new Array(e).fill(0);function c(s,l){if(s===e){if(l===n){const r=P(o,t);a.push(new U([...o],r))}return}const p=Math.min(t[s],n-l);for(let r=0;r<=p;r++)o[s]=r,c(s+1,l+r),o[s]=0}return c(0,0),a}function P(t,n){const e=[...n];for(let a=0;a<t.length;a++)e[a]-=t[a];return e}function X(t,n,e){const a=t.length,o=e.reduce((r,i)=>r+i,0),c=n-o;if(c<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(a);for(let r=0;r<a;r++)if(s[r]=t[r]-e[r],s[r]<0)return console.error(`Error: Known picks for constellation ${r} exceed its capacity.`),[];return $(s,c,a).map(r=>{const i=r.rateUps.map((h,m)=>h+e[m]),f=P(i,t);return new U(i,f)})}function J(t,n,e){const a=n.map((s,l)=>s-e[l]),o=new Map;for(const s of t){const l=s.rateUps.map((r,i)=>r-e[i]);if(l.some(r=>r<0)){s.probability=0;continue}const p=new U(l,[]);o.set(p,s)}const c=Array.from(o.keys());c.length>0&&j(c,a);for(const[s,l]of o.entries())l.probability=s.probability}function A(t,n,e,a){return Array.from({length:t+1},(o,c)=>{const s=q(c,a);let l=0,p=0;for(let r=0;r<=c;r++){const i=c-r,f=n[r],h=i*e,m=f.mean+h,C=f.variance+Math.pow(m,2);l+=m*s[r],p+=C*s[r]}return{mean:l,variance:Math.max(0,p-Math.pow(l,2))}})}function Q(t,n,e,a){let o=n[t.rateUpCount],c=e[t.charOffRateCount],s=t.wepOffRateCount*a;return{mean:o+c.mean+s,variance:c.variance}}function Z(t){const e=Math.sqrt(t.variance),a=1/Math.sqrt(.2);let o=t.mean-e*a;o<0&&(o=0);const c=t.mean+e*a,s=t.mean;return{LOWER_BOUND:o,MEAN:s,UPPER_BOUND:c}}function tt(t,n){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[c,s]of t[o].offRates.entries()){const l=Math.floor(c/100);s.prob>n&&(e.push({rateUpCount:o,charOffRateCount:l,wepOffRateCount:c%100,probability:s.prob}),a=Math.max(a,l))}return{combos:e,maxOffRateCount:a}}function x(t,n){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[c,s]of t[o].offRates.entries())s.prob>n&&(e.push({rateUpCount:o,offRateCount:c,probability:s.prob}),a=Math.max(a,c));return{combos:e,maxOffRateCount:a}}function T(t,n,e){let a=0,o=0;for(const{rateUpCount:c,offRateCount:s,probability:l}of t){const p=n[c],r=e[s],i=p.mean+r.mean,f=p.variance+r.variance+Math.pow(i,2);a+=l*i,o+=l*f}return{mean:a,variance:Math.max(0,o-Math.pow(a,2))}}function _(t){let n=0,e=0;for(const{probability:a,cashback:o}of t)n+=a*o.mean;for(const{probability:a,cashback:o}of t){const c=o.variance+Math.pow(o.mean,2);e+=a*c}return{mean:n,variance:Math.max(0,e-Math.pow(n,2))}}function et(...t){return t.reduce((n,e)=>({mean:n.mean+e.mean,variance:n.variance+e.variance}),{mean:0,variance:0})}const L=.5,E=1e-8;function ut(t,n,e,a,o,c){e=at(e);const s=X(t.SR.consCount,n.rateUpCharacterSR,c);J(s,t.SR.consCount,c);const l=ot(e,n.poolStandardCharSSR,t.SSR.consCountStandard,t.SSR.cashbackRoadmap,n),p=rt(s,a,o,n,t),r=l;for(let i=0;i<r.length;i++)r[i].mean!=0&&(r[i].mean+=p.mean,r[i].variance+=p.variance,r[i]=Z(r[i]));return r}function at(t){let n=0;for(const e of t)for(const[a,o]of e.offRates)n+=o.prob;for(const e of t)for(const[a,o]of e.offRates)o.prob/=n;return t}function ot(t,n,e,a,o){const{combos:c,maxOffRateCount:s}=tt(t,E),l=[0];let p=0;for(let i=0;i<t.length;i++)a[i-1]==="none"?l.push(p):a[i-1]==="regular"&&(p+=o.configSSR.regularPoints,l.push(p));const r=Array.from({length:t.length},()=>[]);for(const i of c){const f=i.rateUpCount,h=i.probability,C=new w(e,n,o.configSSR).runSteps(s),y=Q(i,l,C,o.configWep.pointsSSR);r[f].push({cashback:y,probability:h})}for(let i=0;i<r.length;i++){const f=it(r[i]);r[i]=_(f)}return r}function rt(t,n,e,a,o){const{combos:c,maxOffRateCount:s}=x(n,E),{combos:l,maxOffRateCount:p}=x(e,E),r=nt(t,c,s,a),i=st(l,p,a,o);return et(r,i)}function nt(t,n,e,a){const o=Math.max(...n.map(s=>s.rateUpCount)),c=[];for(const{rateUps:s,offRates:l,probability:p}of t){const i=new w(s,a.rateUpCharacterSR,a.configSR).runSteps(o),h=new w(l,a.poolCharSR-a.rateUpCharacterSR,a.configSR).runSteps(e),m=A(e,h,a.configWep.pointsSR,L),C=T(n,i,m);c.push({probability:p,cashback:C})}return _(c)}function st(t,n,e,a){const o=Math.max(...t.map(i=>i.rateUpCount)),c=r(o,e.configWep.pointsSR),l=new w(a.SR.consCount,e.poolCharSR,e.configSR).runSteps(n),p=A(n,l,e.configWep.pointsSR,L);return T(t,c,p);function r(i,f){return Array.from({length:i+1},(h,m)=>({mean:m*f,variance:0}))}}function it(t){let n=0;for(const e of t)n+=e.probability;for(const e of t)e.probability/=n;return t}export{ft as W,ut as a,pt as c,mt as g};
