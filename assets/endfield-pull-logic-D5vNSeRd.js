function z(f,e,t,M,b,h,p=.5){const{charPullsSum:l,wepPullsSum:i}=U(f),u={characters:0,weapons:0},N={},k=f.length-2;for(let c=k;c>=0;c--){const o=f[c],r=h[c+1];if(!o.isEmpty)if(o.type==="Character")v(e,c,f,M,u,o.type,r);else if(o.type==="Weapon")v(t,c,f,b,u,o.type,r);else throw new Error(`Unknown SSR array type: ${o.type}`)}const{charRankUps:y,wepRankUps:E}=P(l,i,u);return N.charRankUps=y,N.wepRankUps=E,N;function U(c){const o={charPullsSum:0,wepPullsSum:0};if(c.length<=1)return o;const r=c.length-1;for(let a=0;a<r;a++){const{type:g,spark:V}=c[a];let L=0;for(const S of V)for(const R of S.pity)for(const{prob:_}of R.values())L+=_;switch(g){case"Character":o.charPullsSum+=L;break;case"Weapon":o.wepPullsSum+=L;break}}return o}function P(c,o,r){let a=r.characters,g=r.weapons;return{charRankUps:{pullsSum:c,rankUps:a},wepRankUps:{pullsSum:o,rankUps:g}}}}function j(f,e,t,M){if(f[0].states.length===0)return;const b=f.length-1;for(let h=b;h>=0;h--)f[h].isEmpty||F(t,h,f,M,e)}function G(f,e,t,M,b,h){const p=f.length-2;for(let l=p;l>=0;l--){const i=f[l],u=h[l+1];if(!i.isEmpty)if(i.type==="Character")D(e,l,f,M,i.type,u);else if(i.type==="Weapon")D(t,l,f,b,i.type,u);else throw new Error(`Unknown SSR array type: ${i.type}`)}}function v(f,e,t,M,b,h,p){t[e].isEmpty=!0;for(let l=t[e].spark.length-1;l>=0;l--){const i=e+2===t.length,u=t[e].spark[l];if(!u.isEmpty){u.isEmpty=!0;const N=u.pity.length;let k=h==="Weapon"?.25:.5,y=t[e].spark;const E=t[e+1].spark,U=t[e+1].bannerCount!==t[e].bannerCount;let P,c,o;i||(P=t[e+2].spark,c=t[e+2].bannerCount!==t[e].bannerCount,o=e+3===t.length);for(let r=N-1;r>=0;r--){const a=y[l].pity[r];for(const[g,V]of a){let L=g%10,S,R;h==="Character"?(l===119&&L===0?S=!0:S=!1,l===239?R=!0:R=!1):(S=L===80,L>1120&&(R=(L-1120)%160===0));let _=f[r];S&&(_=1,k=1);const B=V.prob*_,W=V.prob-B;let C=B*k;if(C>1e-10){let s=g,n;U?s=Math.trunc(s/1e3)*1e3:S&&(s+=1),i?n=E[0]:R?(o?n=P[0]:(n=P[0].pity[p],P[0].isEmpty=!1,t[e+2].isEmpty=!1),!U&&c&&(s=Math.trunc(s/1e3)*1e3)):(n=E[l+1].pity[p],E[l+1].isEmpty=!1,t[e+1].isEmpty=!1);const w=n.get(s);w?w.prob+=C:n.set(s,{prob:C}),h==="Character"?b.characters+=C:h==="Weapon"&&(b.weapons+=C)}let K=B*(1-k);if(K>1e-10){let s=g,n=g;h==="Character"&&(s+=10,n+=1e3);let w;R?(i?w=E[0]:(w=E[0].pity[0],E[0].isEmpty=!1,t[e+1].isEmpty=!1),U&&(s=Math.trunc(g/1e3)*1e3,n=Math.trunc(g/1e3)*1e3)):(w=y[l+1].pity[0],y[l+1].isEmpty=!1,t[e].isEmpty=!1);const A=w.get(s);A?A.prob+=K*5/7:w.set(s,{prob:K*5/7});const O=w.get(n);O?O.prob+=K*2/7:w.set(n,{prob:K*2/7})}let m=W;if(m>1e-10){let s,n=g;R?(U&&(n=Math.trunc(n/1e3)*1e3),i?s=E[0]:(s=E[0].pity[r+1],E[0].isEmpty=!1,t[e+1].isEmpty=!1)):(s=y[l+1].pity[r+1],y[l+1].isEmpty=!1,t[e].isEmpty=!1);const w=s.get(n);w?w.prob+=m:s.set(n,{prob:m})}a.delete(g)}}}}}function F(f,e,t,M,b){const h=M,p=t[e].states;b.rankUpFail=b.pullsSum-b.rankUps;let l=new Map;for(let i=h-1;i>=0;i--){const u=p[i],N=f[i];for(const[k,y]of u){const E=y.prob,U=E*b.pullsSum;if(U>1e-10){y.prob=E*(1-b.pullsSum);const P=E*N*b.rankUpFail,c=U*(1-N)*b.rankUpFail,o=E*b.rankUps;if(P>1e-10){const r=l,a=k+1,g=r.get(a);g?g.prob+=P:r.set(a,{prob:P})}if(c>1e-10){const r=p[i+1],a=r.get(k);a?a.prob+=c:r.set(k,{prob:c})}if(o>1e-10){const r=l,a=r.get(k);a?a.prob+=o:r.set(k,{prob:o})}}}}p[0]=l}function D(f,e,t,M,b,h){t[e].isEmpty=!0;for(let p=t[e].spark.length-1;p>=0;p--){const l=e+2===t.length,i=t[e].spark[p];if(!i.isEmpty){i.isEmpty=!0;const u=i.pity.length;let N=b==="Weapon"?.25:.5,k=t[e].spark;const y=t[e+1].spark,E=t[e+1].bannerCount!==t[e].bannerCount;let U,P,c;l||(U=t[e+2].spark,P=t[e+2].bannerCount!==t[e].bannerCount,c=e+3===t.length);for(let o=u-1;o>=0;o--){const r=k[p].pity[o];for(const[a,g]of r){let V=a,L,S;b==="Character"?(p===119&&a===0?L=!0:L=!1,p===239?S=!0:S=!1):(L=V===80,V>1120&&(S=(V-1120)%160===0));let R=f[o];L&&(R=1,N=1);const _=g.prob*R,B=g.prob-_;let W=_*N;if(W>1e-10){let m=a,s;E?m=0:L&&(m=1),l?s=y[0]:S?(c?s=U[0]:(s=U[0].pity[h],U[0].isEmpty=!1,t[e+2].isEmpty=!1),!E&&P&&(m=0)):(s=y[p+1].pity[h],y[p+1].isEmpty=!1,t[e+1].isEmpty=!1);const n=s.get(m);n?n.prob+=W:s.set(m,{prob:W})}let C=_*(1-N);if(C>1e-10){let m=a,s;S?(l?s=y[0]:(s=y[0].pity[0],y[0].isEmpty=!1,t[e+1].isEmpty=!1),E&&(m=0)):(s=k[p+1].pity[0],k[p+1].isEmpty=!1,t[e].isEmpty=!1);const n=s.get(m);n?n.prob+=C:s.set(m,{prob:C})}let K=B;if(K>1e-10){let m,s=a;S?(E&&(s=0),l?m=y[0]:(m=y[0].pity[o+1],y[0].isEmpty=!1,t[e+1].isEmpty=!1)):(m=k[p+1].pity[o+1],k[p+1].isEmpty=!1,t[e].isEmpty=!1);const n=m.get(s);n?n.prob+=K:m.set(s,{prob:K})}r.delete(a)}}}}}export{j as rankUpSR,z as rankUpSSR,G as rankUpSSRCheap};
