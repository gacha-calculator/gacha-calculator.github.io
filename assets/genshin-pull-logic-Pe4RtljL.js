function A(L,n,r,l,S,g){const{charPullsSum:h,wepPullsSum:c}=f(L),u={characters:0,weapons:0},P={},b=L.length-2;for(let s=b;s>=0;s--){const o=g[s+1],U=o.pity;let p=null;if(o.type==="firstChar"&&(p=o.special),!L[s].isEmpty)for(let t=0;t<4;t++){const e=L[s][t];if(!e.isEmpty)if(e.type==="Character")M(n,s,L,l,u,U,t);else if(e.type==="Weapon")O(r,s,L,S,u,U,t,p);else throw new Error(`Unknown SSR array type: ${e.type}`)}}const{charRankUps:i,wepRankUps:a}=E(h,c,u);return P.charRankUps=i,P.wepRankUps=a,P;function f(s){const o={charPullsSum:0,wepPullsSum:0};if(s.length<=1)return o;const U=s.length-1,p=s[0].length;for(let t=0;t<U;t++){let e=0;const R=s[t][0].type;for(let N=0;N<p;N++){const{states:w}=s[t][N];for(const V of w)for(const{prob:k}of V.values())e+=k}switch(R){case"Character":o.charPullsSum+=e;break;case"Weapon":o.wepPullsSum+=e;break}}return o}function E(s,o,U){let p=U.characters,t=U.weapons;return{charRankUps:{pullsSum:s,rankUps:p},wepRankUps:{pullsSum:o,rankUps:t}}}}function G(L,n,r,l){const S=L.length-1;for(let g=S;g>=0;g--)L[g].isEmpty||W(r,g,L,l,n)}function K(L,n,r,l,S,g){const h=L.length-2;for(let c=h;c>=0;c--){const u=g[c+1],P=u.pity;let b=null;if(u.type==="firstChar"&&(b=u.special),!L[c].isEmpty)for(let i=0;i<4;i++){const a=L[c][i];if(!a.isEmpty)if(a.type==="Character")x(n,c,L,l,P,i);else if(a.type==="Weapon")z(r,c,L,S,P,i,b);else throw new Error(`Unknown SSR array type: ${a.type}`)}}}function M(L,n,r,l,S,g,h){const c=Math.floor(h/2),u=r[n][h].states;if(h!=3){const P=r[n][h].states.length;let b=.5;h===2&&(b=.55);const i=r[n+1][c].states,a=r[n+1][h+1].states;for(let f=P-1;f>=0;f--){const E=u[f],s=f>=l,o=L[f-l*s];for(const[U,p]of E){const t=p.prob*o,e=p.prob-t;let R=t;if(R>1e-10){let w=a;s||(R*=b,w=i);const V=w[g],k=V.get(U);k?k.prob+=R:V.set(U,{prob:R}),S.characters+=R}if(!s){let w=t*(1-b);if(w>1e-10){let V=U+100;const k=u[l],_=k.get(V);_?_.prob+=w:k.set(V,{prob:w})}}let N=e;if(N>1e-10){const w=u[f+1],V=w.get(U);V?V.prob+=N:w.set(U,{prob:N})}p.prob=0}}}else{const P=r[n+1][c].states,b=r[n][h].states.length;for(let i=b-1;i>=0;i--){const a=u[i],f=L[i];for(const[E,s]of a){const o=s.prob*f,U=s.prob-o;let p=o;if(p>1e-10){const e=P[g],R=e.get(E);R?R.prob+=p:e.set(E,{prob:p}),S.characters+=p}let t=U;if(t>1e-10){const e=u[i+1],R=e.get(E);R?R.prob+=t:e.set(E,{prob:t})}s.prob=0}}}}function O(L,n,r,l,S,g,h,c){let u=h;c!=null&&(u=c);const P=r[n][h].states.length,b=.375,i=.5,a=r[n][h].states,f=r[n+1][u].states;for(let E=P-1;E>=0;E--){const s=a[E],o=E>=2*l;let U=!1;o||(U=E>=l);const p=L[E-l*U-l*o*2];for(const[t,e]of s){const R=e.prob*p,N=e.prob-R;let w=R;if(w>1e-10){o||(U?w*=i:w*=b);const k=f[g],_=k.get(t);_?_.prob+=w:k.set(t,{prob:w}),S.weapons+=w}if(!o){let k=R*(1-b);if(U&&(k=R*(1-i)),k>1e-10){let _=t+1;const y=a[l*2],m=y.get(_);m?m.prob+=k:y.set(_,{prob:k})}}let V=N;if(V>1e-10){const k=a[E+1],_=k.get(t);_?_.prob+=V:k.set(t,{prob:V})}e.prob=0}}}function W(L,n,r,l,S){const g=r[n].states.length,h=r[n].states;S.rankUpFail=S.pullsSum-S.rankUps;for(let c=g-1;c>=0;c--){const u=h[c],P=c>=l,b=L[c-l*P],i=.5;for(const[a,f]of u){const E=f.prob,s=E*S.pullsSum;if(f.prob=E*(1-S.pullsSum),s>1e-10){const o=E*b*S.rankUpFail,U=s*(1-b)+E*b*S.rankUps;let p=o;if(p>1e-10){P||(p*=i),r[n+1]===void 0&&(r[n+1]={states:Array.from({length:r[n].states.length},()=>new Map)});const t=r[n+1].states[0],e=t.get(a);e?e.prob+=p:t.set(a,{prob:p})}if(!P){let t=o*(1-i);if(t>1e-10){let e=a;e++;const R=h[l],N=R.get(e);N?N.prob+=t:R.set(e,{prob:t})}}if(U>1e-10)if(c-l*P===l-1)f.prob+=s*b*S.rankUps;else{const t=h[c+1],e=t.get(a);e?e.prob+=U:t.set(a,{prob:U})}}}}}function x(L,n,r,l,S,g){const h=Math.floor(g/2),c=r[n][g].states;if(g!=3){const u=r[n][g].states.length;let P=.5;g===2&&(P=.55);const b=r[n+1][h].states,i=r[n+1][g+1].states;for(let a=u-1;a>=0;a--){const f=c[a],E=a>=l,s=L[a-l*E],o=f*s,U=f-o;let p=o;if(p>1e-10){let e=i;E||(p*=P,e=b),e[S]+=p}if(!E){let e=o*(1-P);e>1e-10&&(c[l]+=e)}let t=U;t>1e-10&&(c[a+1]+=t),c[a]=0}}else{const u=r[n+1][h].states,P=r[n][g].states.length;for(let b=P-1;b>=0;b--){const i=c[b],a=L[b],f=i*a,E=i-f;let s=f;s>1e-10&&(u[S]+=s);let o=E;o>1e-10&&(c[b+1]+=o),c[b]=0}}}function z(L,n,r,l,S,g,h){let c=g;h!=null&&(c=h);const u=r[n][g].states.length,P=.375,b=.5,i=r[n][g].states,a=r[n+1][c].states;for(let f=u-1;f>=0;f--){const E=i[f],s=f>=2*l;let o=!1;s||(o=f>=l);const U=L[f-l*o-l*s*2],p=E*U,t=E-p;let e=p;if(e>1e-10&&(s||(o?e*=b:e*=P),a[S]+=e),!s){let N=p*(1-P);o&&(N=p*(1-b)),N>1e-10&&(i[l*2]+=N)}let R=t;R>1e-10&&(i[f+1]+=R),i[f]=0}}export{G as rankUpSR,A as rankUpSSR,K as rankUpSSRCheap};
