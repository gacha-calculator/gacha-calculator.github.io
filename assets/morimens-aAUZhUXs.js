import{c as z,C as F,r as H,a as M,u as W,g as Y,d as $,f as U,j as G,m as V,k as j,p as I,n as L,s as q}from"./recalc-inputs-D8Xku2nI.js";/* empty css               */import{s as J,n as K,b as Q}from"./common-helpers-CPLJV1Gy.js";class X{constructor({getPageConfiguration:a,getLabels:e,getPullPlan:n,getTarget:r,updateChart:i,convertToChartData:o,recalcInputs:l,calculatorFunction:s,calculatorConfig:c,pageConfig:u,postCalculationHooks:b,persistence:p,chibi:g}){this.getPageConfiguration=a,this.getLabels=e,this.getPullPlan=n,this.getTarget=r,this.updateChart=i,this.convertToChartData=o,this.recalcInputs=l,this.calculatorFunction=s,this.calculatorConfig=c,this.pageConfig=u,this.postCalculationHooks=b||[],this.persistence=p,this.chibi=g}async runCalculation(a){const e=this.getTarget(),n=this.getPageConfiguration(this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),r=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(r.length>99){this.chibi.showError("Too many items! Even I can't calculate so quickly, maximum 99 items allowed.");return}const i=await this.calculatorFunction(n,e),o=this.convertToChartData(i.chartData);if(this.updateChart(o.data,o.labels,r),this.recalcInputs(o.data),this.persistence){const l=parseInt(document.querySelector('[data-control="pulls"]').value),s=parseInt(document.querySelector('[data-control="probability"]').value);this.persistence.saveCalculation({input:this.getPullPlan(),targetProb:s,targetPull:l,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")}),this.persistence.saveButtons()}a(i,r)}}const R={CHARACTER:"character",WEAPON:"weapon"},m={PITY_ROW:"[data-banner]",PITY_TABLE:"#pity-table"},O={pitySettings:{[R.CHARACTER]:{pity5:0},[R.WEAPON]:{pity5:0}},isCharacter:!0,isWeapon:!0,isSpecial:!1},k={probability:70,pulls:57};function Z(t,a){const e=parseInt(document.querySelector('[data-control="pulls"]').value),n=[];for(let i=0;i<t.chartData[e-1].length;i++){let o=t.chartData[e-1][i];o=(o*100).toFixed(2),o>0&&n.push({name:a[i],probability:o,color:"#3498db"})}const r=document.querySelector("#probability-table tbody");r.innerHTML="",n.forEach(i=>{const o=document.createElement("tr"),l=i.probability;o.innerHTML=`
      <td>${i.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${l}%;background:${i.color}">
            <div class="progress-label">${i.probability}%</div>
          </div>
        </div>
      </td>
    `,r.appendChild(o)})}function tt(t,a){nt(a.pity);const e=t.loadTables();e&&ot(e.pity),et(t),window.addEventListener("beforeunload",()=>E()),E(t)}function et(t){const a=[`${m.PITY_TABLE} input`,`${m.PITY_TABLE} select`].join(",");document.querySelectorAll(a).forEach(e=>{e.addEventListener("input",()=>x(t)),e.addEventListener("change",()=>x(t))})}function x(t){let a=null;const e=1500;clearTimeout(a),a=setTimeout(()=>E(t),e)}function E(t){if(!t)return;const a={_schema:1,pity:at()};t._save("gacha_tables_morimens_v1",a)}function at(){return Array.from(document.querySelectorAll(`${m.PITY_TABLE} tbody tr`)).map(t=>({banner:t.dataset.banner,...t.querySelector('[data-control="pity-5"]')&&{pity5:t.querySelector('[data-control="pity-5"]').value},...t.querySelector('[data-control="guarantee-5"]')&&{guarantee5:t.querySelector('[data-control="guarantee-5"]').value}}))}function nt(t){const a=document.getElementById("pity-row-template"),e=document.querySelector(`${m.PITY_TABLE} tbody`);Object.entries(O.pitySettings).forEach(([o,l])=>{const s=a.content.cloneNode(!0).querySelector("tr");s.dataset.validationType="individual";const c=s.querySelector('[data-control="pity-5"]');c&&(c.min=0,c.max=t.pitySSR-1),s.dataset.banner=o,s.querySelector(".banner-name").textContent=o,s.querySelector('[data-control="pity-5"]').value=l.pity5,e.appendChild(s)});const n=document.querySelector("#pity-table");n&&n.querySelectorAll('tbody tr input[type="number"]').forEach(o=>o.addEventListener("input",function(){let l=this.value;l.length>1&&l.startsWith("0")&&(this.value=l.replace(/^0+/,""),this.value===""&&(this.value="0"));let s=parseInt(this.value)||0;s>o.max?(this.value=o.max,B(this)):s<=o.min&&(this.value=o.min,B(this))}));const r=document.querySelectorAll('[data-control="guarantee-5"]'),i={0:"0",1:"1",2:"2"};r.forEach((o,l)=>{for(const[s,c]of Object.entries(i))l===1&&s==="2"||o.add(new Option(c,s));o.value="0"})}function B(t){t.style.borderColor="#a71919",t.style.outline="1px solid #a71919",t.classList.add("flicker"),setTimeout(()=>{t.classList.remove("flicker"),t.style.borderColor="",t.style.outline=""},500)}function ot(t){t.forEach(a=>{const e=document.querySelector(`${m.PITY_TABLE} tr[data-banner="${a.banner}"]`);e&&(e.querySelector('[data-control="pity-5"]').value=a.pity5,e.querySelector('[data-control="guarantee-5"]').value=a.guarantee5)})}const w=(t,a=!1)=>t?a?t.checked:parseInt(t.value)||0:null;function rt(t,a,e){const n=document.getElementById("pity-panel"),r=t.paths;if(!n)return console.error("Required tab panels not found. Cannot get page configuration."),null;const i=n.querySelector(`${a.PITY_ROW}[data-banner="character"]`),o=n.querySelector(`${a.PITY_ROW}[data-banner="weapon"]`),{planConfigs:l}=st(r),s={},c={};return e.isCharacter&&(s.char=w(i.querySelector('[data-control="pity-5"]')),c.char=Number(i.querySelector('[data-control="guarantee-5"]').value),s.wep=w(o.querySelector('[data-control="pity-5"]')),c.wep=Number(o.querySelector('[data-control="guarantee-5"]').value)),{SSR:{pity:s,guarantee:c,pullPlan:l.typeArray,cashbackRoadmap:l.cashbackArray}}}function it(){const t=document.querySelectorAll(".row"),a=[];return Array.from(t).slice(1).forEach(n=>{const r=n.dataset.group,i=n.querySelector(".type-selector")?.value||"char",o=n.querySelector(".first-select")?.value||"None",l=n.querySelector(".second-select")?.value||"None";a.push({group:r,type:i,from:o,to:l})}),{pullPlan:a}}function st(t){const a=document.querySelectorAll(".row"),e={},n=[],r=[],i=[],o=[],l=Array.from(a).slice(1);let s=0;return l.forEach(c=>{const u=w(c.querySelector('[data-control="pity-4"]')),b=w(c.querySelector(".guarantee-4"),!0);i.push(u),o.push(b);const p=c.querySelector(".type-selector")?.value||"char",g=c.querySelector(".first-select")?.value||"None",d=c.querySelector(".second-select")?.value||"None",S=p==="char"?t.char:t.wep,h=S.indexOf(g),f=S.indexOf(d);if(h===-1||f===-1||h>=f)return;const y=f-h;let P=h,T=0;for(let A=0;A<y;A++)p==="char"&&P===0?T="none":T="regular",n.push({type:p,bannerCount:s}),r.push(T),P++;s++}),e.typeArray=n,e.cashbackArray=r,{planConfigs:e,pity4:i,guarantee4:o}}const lt=`
    <div class="chibi-group">
        <div class="bubble-wrapper bubble-wrapper--big">
            <svg class="bubble-svg-background" viewBox="0 0 1820 858" xmlns="http://www.w3.org/2000/svg">
                <path style="fill:#232338; stroke:#0b091b; stroke-width: 1px"
                    d="M 787.500 1.005 C 640.632 4.659, 524.925 15.685, 414 36.596 C 305.731 57.006, 229.612 80.375, 165.037 113.026 C 88.008 151.975, 38.939 199.840, 15.519 258.874 C 8.496 276.575, 3.327 301.798, 0.941 330 C -2.027 365.084, 6.008 405.046, 22.959 439.500 C 43.249 480.744, 73.516 513.346, 120 544.028 C 209.228 602.924, 363.734 646.238, 553 665.416 C 650.260 675.270, 808.209 681.908, 948.500 682.035 C 999.011 682.081, 1061.358 683.505, 1068.623 684.778 C 1072.726 685.497, 1072.776 685.559, 1079.177 698 C 1096.318 731.313, 1116.859 760.237, 1136.746 779.061 C 1155.047 796.384, 1181.968 815.466, 1202.839 825.908 C 1232.446 840.721, 1273.797 852.517, 1310.770 856.698 C 1324.340 858.232, 1326.511 858.262, 1330.270 856.962 C 1332.596 856.158, 1334.500 855.138, 1334.500 854.696 C 1334.500 854.254, 1331.125 852.760, 1327 851.377 C 1314.484 847.179, 1287.809 833.665, 1277.295 826.195 C 1265.925 818.116, 1226.275 778.561, 1216.635 765.680 C 1206.358 751.947, 1188.566 715.606, 1185.906 702.916 C 1185.282 699.937, 1183.944 693.900, 1182.931 689.500 C 1181.919 685.100, 1180.809 679.883, 1180.464 677.906 L 1179.836 674.312 1189.168 673.673 C 1234.976 670.533, 1307.910 662.018, 1358.500 653.902 C 1387.862 649.192, 1405.290 645.828, 1437.500 638.654 C 1443.550 637.306, 1457.500 634.310, 1468.500 631.995 C 1491.435 627.169, 1506.239 623.528, 1520.500 619.205 C 1526 617.538, 1538.150 614.072, 1547.500 611.504 C 1604.081 595.961, 1658.813 573.047, 1691.807 551.088 C 1716.705 534.517, 1726.861 526.038, 1752.999 500 C 1782.013 471.097, 1799.115 442.990, 1810.458 405.568 C 1814.346 392.741, 1819 366.582, 1819 357.554 C 1819 354.499, 1819.450 352, 1820 352 C 1821.274 352, 1821.299 340.366, 1820.046 330.791 C 1819.521 326.781, 1818.582 319.225, 1817.959 314 C 1809.521 243.236, 1771.421 185.672, 1703 140.314 C 1640.860 99.120, 1548.917 64.910, 1443 43.576 C 1339.978 22.824, 1215.062 9.498, 1072 3.996 C 994.931 1.032, 848.352 -0.509, 787.500 1.005 M 776 4.600 C 771.325 4.777, 754 5.405, 737.500 5.995 C 561.542 12.295, 402.823 35.450, 277.947 73.040 C 210.624 93.305, 153.205 120.092, 109 151.857 C 80.401 172.408, 53.246 200.489, 37.044 226.269 C 19.796 253.711, 10.505 280.375, 6.026 315.288 C 1.913 347.340, 4.080 374.322, 13.106 403.467 C 26.641 447.170, 50.753 482.527, 90 516.224 C 101.716 526.283, 126.303 543.639, 138.425 550.406 C 140.926 551.802, 146.466 554.925, 150.736 557.345 C 194.368 582.071, 259.942 606.163, 334.540 624.875 C 473.407 659.708, 622.538 674.025, 888 678.008 C 1034.249 680.203, 1070.594 680.938, 1073.423 681.757 C 1075.031 682.222, 1076.681 683.255, 1077.088 684.051 C 1077.496 684.848, 1079.729 689.325, 1082.051 694 C 1091.185 712.393, 1108.924 740.328, 1121.008 755.350 C 1129.418 765.805, 1144.301 780.492, 1156.104 789.986 C 1170.999 801.967, 1195.222 817.726, 1208.500 824.072 C 1231.867 835.241, 1272.170 847.555, 1298 851.418 C 1323.491 855.230, 1327.055 855.493, 1319.528 853.009 C 1311.535 850.371, 1284.081 836.370, 1276.055 830.838 C 1260.944 820.423, 1225.667 785.179, 1211.929 766.772 C 1201.655 753.007, 1184.830 717.485, 1182.499 704.638 C 1181.787 700.712, 1180.261 693.675, 1179.109 689 C 1176.730 679.347, 1176.376 672.148, 1178.250 671.514 C 1178.938 671.282, 1190.300 670.164, 1203.500 669.029 C 1239.066 665.973, 1275.315 662.018, 1309.500 657.465 C 1360.426 650.682, 1388.027 645.725, 1449 632.411 C 1463.025 629.349, 1479.778 625.754, 1486.229 624.424 C 1492.681 623.093, 1501.906 620.694, 1506.729 619.093 C 1511.553 617.492, 1527.169 612.983, 1541.432 609.074 C 1573.458 600.295, 1586.835 595.827, 1618.030 583.493 C 1644.114 573.179, 1671.994 559.215, 1688.966 547.965 C 1703.153 538.560, 1722.730 523.374, 1729.500 516.522 C 1732.800 513.182, 1739.501 506.636, 1744.391 501.975 C 1758.521 488.506, 1771.430 473.645, 1779.115 462 C 1788.491 447.791, 1793.962 437.449, 1800.288 421.977 C 1815.087 385.778, 1819.761 344.986, 1813.433 307.269 C 1804.545 254.291, 1779.063 209.320, 1736.709 171.866 C 1691.153 131.580, 1625.043 98.185, 1538.202 71.592 C 1418.757 35.015, 1261.222 14.066, 1048 6.407 C 1008.502 4.988, 802.012 3.616, 776 4.600 M 0.355 344.500 C 0.352 349.450, 0.521 351.601, 0.731 349.280 C 0.940 346.959, 0.943 342.909, 0.736 340.280 C 0.530 337.651, 0.358 339.550, 0.355 344.500" />
                </svg>
            <div class="bubble-text"> </div>
        <img src="/images/37_chibi.png" alt="Tutorial Assistant" class="tutorial-chibi">
        </div>
        <button class="btn btn--tutorial_next">>></button>
        <button class="btn btn--tutorial_end">x</button>
    </div>`,N=[{text:"<p>Welcome to the Gacha Calculator! Let me show you around.</p>",size:"small"},{id:"pity-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>First, input your current pity and guarantees here.</p>",position:"right",size:"small"},{id:"pull-plan-step",element:".pull-plan-section",text:"<p>Here add all the characters in the order you plan to obtain them.</p>",position:"bottom"},{id:"target-step",element:".header-controls",text:"<p>Now, set your target. This can be your desired confidence level(e.g., a 70% chance of getting all planned items) or your total pull budget.</p>",position:"top",chibiSide:"left",size:"big"},{id:"calculate-button-step",element:"#calculate-btn",text:"<p>Once your plan and target are set, click <strong>Calculate</strong> and I will calculate everything for you.</p>",position:"right",size:"small"},{element:".chart-wrapper",text:"<p>You'll get a chart showing the probability of success for each number of pulls until 100%.</p>",position:"top"},{element:"#probability-table",text:"<p>And down here, you can see a detailed probability table, for the given amount of pulls.</p>",position:"top"}],D={"pity-input-step":{tourStepId:"pity-input-step"},"constellation-input-step":{tourStepId:"constellation-input-step"},"pull-plan-step":{tourStepId:"pull-plan-step"},"calculate-button-step":{tourStepId:"calculate-button-step"},"import-help":{element:".tab-panel-card",text:'<p>" Click the "Import Data" button and paste your exported JSON data.</p>',position:"right"},"export-help":{element:".tab-panel-card",text:"<p>You can export your data as a JSON file to make backup or to carry over data when you are switching to a different browser/new device.</p>",position:"right",size:"big"},"pity-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>You can input your current pity and guarantees here, in morimens character guarantee is only after 2 lost rate up so look that up in history.</p>",position:"right",size:"big"},"pull-plan-help":{element:".pull-plan-section",text:"<p>Here add all the characters in the order you plan to obtain them.</p>",position:"bottom",size:"small"},"target-help":{element:".header-controls",text:"<p>Set your target here: either your desired confidence level(e.g., 70% chance of getting all planned items) or your total pull budget.</p>",position:"top",chibiSide:"left",size:"big"}};class ct{constructor(a){this.parts=a,this.persistence=z("morimens",m),this.tutorial=new F(lt);const e={getPageConfiguration:rt,getLabels:$,getPullPlan:it,getTarget:Y,updateChart:W,convertToChartData:M,recalcInputs:H,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:m,INITIAL_CONFIG:O},persistence:this.persistence,chibi:this.tutorial};this.calculationHandler=new X(e),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn"),this.toggleButtonsBtn=document.getElementById("toggle-buttons-btn")}initialize(){tt(this.persistence,this.parts.gachaConfig,this.validator),U(),G(this.persistence);const a=document.querySelectorAll('input[type="number"]');a.forEach(e=>{e.addEventListener("focus",()=>{e.select()})}),a.forEach(e=>{e.addEventListener("keydown",n=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(n.key)||(n.ctrlKey||n.metaKey)&&["a","c","v","x"].includes(n.key.toLowerCase())||/^\d$/.test(n.key)||n.preventDefault()})}),this.#t(),this.#e(),this.tutorial.showTutorialIfNeeded(N)}#t(){V(),this.isCalculating=!1,this.calculateBtn&&this.calculateBtn.addEventListener("click",async()=>{if(!this.isCalculating){window.goatcounter&&window.goatcounter.count({path:"/morimens-calculation-initiated",title:"Morimens Calculation Initiated"}),this.isCalculating=!0,this.calculateBtn.disabled=!0;try{await this.calculationHandler.runCalculation(this.parts.updateTableFn)}finally{this.isCalculating=!1,this.calculateBtn.disabled=!1}}}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>j(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(N)}),document.querySelectorAll(".help-btn").forEach(e=>{e.addEventListener("click",n=>{n.preventDefault();const r=e.getAttribute("data-help-key")||e.getAttribute("data-tour-step-id");if(r&&D[r]){const i=D[r];this.tutorial.showHelp(i,e)}else console.warn(`ChibiTutorial: No help configuration found for key '${r}'.`,e)})}),this.toggleButtonsBtn&&this.toggleButtonsBtn.addEventListener("click",()=>{document.querySelectorAll(".help-btn").forEach(n=>{n.classList.toggle("hidden")}),this.persistence.saveButtons()})}#e(){const a=this.persistence.loadCalculation(),e=a?a.input:null;a?(I(this.parts.gachaConfig.paths,e),L(k,a),q(a.persistInput)):(I(this.parts.gachaConfig.paths),L(k),q()),this.calculationHandler.runCalculation(this.parts.updateTableFn)}}const _=[.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,.0303,1],v={maxCharacterConstelation:15,configSSR:{maxType:16},paths:{char:["None","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","e10","e11","e12","e13","e14","e15"],wep:["None","a1","a2","a3","a4","a5","e6","a7","a8","a9","a10","a11","a12","a13","a14","a15"]},pity:{pitySSR:_.length},default:0};function ut(t){let a=!0;for(let e=0;e<t.length-1;e++){let n=!0;for(const r of t[e].states)r>0&&(n=!1,a=!1);t[e].isEmpty=n}return a}const C=1e-10;function pt(t,a,e){const n=t.length-2;for(let r=n;r>=0;r--){const i=t[r];i.isEmpty||ht(a,r,t,e,i.type,0)}}function ht(t,a,e,n,r,i){const o=e[a].states.length;let l=1/3;if(r==="char"){const s=e[a].states,c=e[a+1].states;for(let u=o-1;u>=0;u--){const b=s[u];let p=0;u>=n*2?p=2:u>=n&&(p=1);const g=t[u-n*p],d=b*g,S=b-d;let h=d;if(h>C&&(p!=2&&(h*=l),c[i]+=h),p===0){let y=d*(1-l);y>C&&(s[n]+=y)}else if(p===1){let y=d*(1-l);y>C&&(s[n*2]+=y)}let f=S;f>C&&(s[u+1]+=f),s[u]=0}}else if(r==="wep"){const s=e[a].states,c=e[a+1].states;for(let u=o-1;u>=0;u--){const b=s[u],p=u>=n,g=t[u-n*p],d=b*g,S=b-d;let h=d;if(h>C&&(p||(h*=l),c[i]+=h),!p){let y=d*(1-l);y>C&&(s[n]+=y)}let f=S;f>C&&(s[u+1]+=f),s[u]=0}}}function dt(t,a,e){if(!Array.isArray(t.SSR.pullPlan))throw new Error("Invalid pull plan");const{pullPlan:n}=t.SSR,r=[];for(let o=0;o<n.length;o++)n[o].type==="char"?r.push({states:Array.from({length:e.char},()=>new Map),isEmpty:!0,type:n[o].type,bannerCount:n[o].bannerCount}):n[o].type==="wep"&&r.push({states:Array.from({length:e.wep},()=>new Map),isEmpty:!0,type:n[o].type,bannerCount:n[o].bannerCount});return r.push({states:Array.from({length:1},()=>new Map)}),i(a),r;function i(o){r[0].states[o[0]].set(0,{prob:1}),r[0].isEmpty=!1}}function yt(t,a){let e=!1,n=!1,r=0,i=0;const o=[];r+=t.SSR.pity.char,r+=t.SSR.guarantee.char*a.pitySSR,i+=t.SSR.pity.wep,i+=t.SSR.guarantee.wep*a.pitySSR;for(const l of t.SSR.pullPlan)l.type==="char"&&!e?(e=!0,o.push(r)):l.type==="wep"&&!n?(n=!0,o.push(i)):o.push(0);return o.push(0),o}function bt(t){let a=[],e=!1,n={char:v.pity.pitySSR*3,wep:v.pity.pitySSR*2};const r=yt(t,v.pity);let i=dt(t,r,n),o=0;const l=10;for(J(i);!e;)o++,pt(i,_,v.pity.pitySSR),o===l&&K(i),a.push(Q(i)),e=ut(i);return{chartData:a}}document.addEventListener("DOMContentLoaded",()=>{const t={gachaConfig:v,runCalcFn:bt,updateTableFn:Z};new ct(t).initialize()});
