import{c as G,D as q,C as Y,r as j,a as V,u as X,g as J,b as K,d as Q,e as Z,i as tt,f as et,h as O,j as it,k as P,l as L,s as I,m as st}from"./solvers-CbfgVQJ-.js";/* empty css               */import{c as at,W as rt,g as nt,a as ot}from"./cashback-AJXKrhPS.js";const x=[.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.066,.126,.186,.246,.306,.366,.426,.486,.546,.606,.666,.726,.786,.846,.906,.966,1],E=[.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.077,.147,.217,.287,.357,.427,.497,.567,.637,.707,.777,.847,.917,.987,1],A=[.051,.051,.051,.051,.051,.051,.051,.051,.561,1],b={maxCharacterConstelation:6,rateUpCharacterSR:3,rateUpWeaponSR:5,poolStandardCharSSR:8,poolCharSR:43,configSR:{maxType:7,regularPoints:.4,specialPoints:1},configSSR:{maxType:7,regularPoints:2,specialPoints:5},configWep:{pointsSR:.4,pointsSSR:2},paths:{char:["None","c0","c1","c2","c3","c4","c5","c6"],wep:["None","r1","r2","r3","r4","r5"]},pity:{pitySSRChar:x.length,pitySSRWep:E.length,pitySRChar:A.length,pitySRWep:A.length},default:0},lt=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"c0",text:"C0"},{value:"c1",text:"C1"},{value:"c2",text:"C2"},{value:"c3",text:"C3"},{value:"c4",text:"C4"},{value:"c5",text:"C5"},{value:"c6",text:"C6"}],T={none:0,c0:1,c1:2,c2:3,c3:4,c4:5,c5:6,c6:7},U=new Set(["dehya","diluc","jean","keqing","mona","qiqi","tighnari","yumemizuki_mizuki"]),$=new Set(["barbara","beidou","bennett","candace","charlotte","chevreuse","chongyun","collei","dahlia","diona","dori","faruzan","fischl","freminet","gaming","gorou","iansan","ifa","kachina","kaveh","kirara","kujou_sara","kuki_shinobu","lan_yan","layla","lynette","mika","ningguang","noelle","ororon","razor","rosaria","sayu","sethos","shikanoin_heizou","sucrose","thoma","xiangling","xingqiu","xinyan","yanfei","yaoyao","yun_jin"]),ct=new Set(["amos_bow","aquila_favonia","lost_prayer_to_the_sacred_winds","primordial_jade_winged-spear","skyward_atlas","skyward_blade","skyward_harp","skyward_pride","skyward_spine","wolfs_gravestone"]),ht=new Set(["dragons_bane","eye_of_perception","favonius_codex","favonius_greatsword","favonius_lance","favonius_sword","favonius_warbow","lions_roar","rainslasher","rust","sacrificial_bow","sacrificial_fragments","sacrificial_greatsword","sacrificial_sword","the_bell","the_flute","the_stringless","the_widsith","akuoumaru","alley_hunter","flower-wreathed_feathers","fruitful_hook","lithic_blade","lithic_spear","makhaira_aquamarine","mitternachts_waltz","mountain-bracing_bolt","mouuns_moon","portable_power_saw","prospectors_drill","range_gauge","sturdy_bone","the_alley_flash","the_dockhands_assistant","wandering_evenstar","wavebreakers_fin","waveriding_whirl","wine_and_song","xiphos_moonlight"]),pt=new Set(["black_tassel","bloodtainted_greatsword","cool_steel","debate_club","emerald_orb","ferrous_shadow","harbinger_of_dawn","magic_guide","raven_bow","sharpshooters_oath","skyrider_sword","slingshot","thrilling_tales_of_dragon_slayers","white_tassel"]);function ut(i){if(!i||!i.characters||!i["wish-counter-character-event"])return console.error("Imported data is missing key Paimon.moe properties."),null;console.log("Paimon.moe data format detected. Running adapter...");const t=i["wish-counter-character-event"]?.pulls||[],s=i["wish-counter-weapon-event"]?.pulls||[],a=N(t,"character"),e=N(s,"weapon"),r=[{banner:"character",...a,caprad:"0",epPath:"0"},{banner:"weapon",...e,caprad:"0",epPath:"0"}],o=dt(i.characters);return{pity:r,constellation:o}}function N(i,t){let s=0,a=0,e=!1,r=!1,o=!1,n=!1;const c=l=>$.has(l)?{type:"character",rarity:4}:ht.has(l)?{type:"weapon",rarity:4}:pt.has(l)?{type:"weapon",rarity:3}:U.has(l)?{type:"character",rarity:5,standard:!0}:ct.has(l)?{type:"weapon",rarity:5,standard:!0}:{type:"unknown",rarity:5,standard:!1};for(let l=i.length-1;l>=0;l--){const h=i[l],p=c(h.id);p.rarity===5?o||(e=h.rate===0,o=!0):o||s++,p.rarity===4?n||(t==="character"&&(r=p.type==="weapon"),n=!0):n||a++}return{pity4:String(a),pity5:String(s),guarantee4:r,guarantee5:e}}function dt(i){const t=new Array(Object.keys(T).length).fill(0),s=new Array(Object.keys(T).length).fill(0);let a=0,e=0;for(const l in i){let h=0;if($.has(l)?h=4:U.has(l)&&(h=5),h===0)continue;const p=i[l],u=(p.default||0)+(p.wish||0)+(p.manual||0);if(u>0){h===4?a++:h===5&&e++;const d=Math.min(u-1,6),f=T[`c${d}`];f!==void 0&&(h===4?t[f]++:h===5&&s[f]++)}}const r=b.poolCharSR,o=b.poolStandardCharSSR,n=r-a,c=o-e;return t[0]=Math.max(0,n),s[0]=Math.max(0,c),{0:s.map(String),1:t.map(String)}}class ft{constructor(t){this.tutorialSteps=[],this.currentStepIndex=0,this.isTourActive=!1,this.isShowingHelp=!1,this.pausedTourStepIndex=-1,this.currentTargetElement=null,this.observers=null,this.boundHandleWindowResize=this.handleReposition.bind(this),this.boundHandleHighlightUpdate=this.handleHighlightUpdate.bind(this),this.container=document.createElement("div"),this.container.id="chibi-container",this.container.innerHTML=`
            <div class="chibi-tutorial-overlay-piece" data-overlay="top"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="bottom"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="left"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="right"></div>
        `,this.container.innerHTML+=t,document.body.appendChild(this.container),this.overlays={top:this.container.querySelector('[data-overlay="top"]'),bottom:this.container.querySelector('[data-overlay="bottom"]'),left:this.container.querySelector('[data-overlay="left"]'),right:this.container.querySelector('[data-overlay="right"]')},this.chibiGroup=this.container.querySelector(".chibi-group"),this.bubbleText=this.container.querySelector(".bubble-text"),this.nextButton=this.container.querySelector(".btn--tutorial_next"),this.endButton=this.container.querySelector(".btn--tutorial_end"),this.handleNext=this.handleNext.bind(this),this.hide=this.hide.bind(this),this.handleReposition=this.handleReposition.bind(this),this.nextButton.addEventListener("click",this.handleNext),this.endButton.addEventListener("click",this.hide)}startTour(t){if(!t||t.length===0){console.error("ChibiTutorial: No steps provided for the tour.");return}this.tutorialSteps=t,this.pausedTourStepIndex===-1?this.currentStepIndex=0:(this.currentStepIndex=this.pausedTourStepIndex,this.pausedTourStepIndex=-1),this.isTourActive=!0,this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block",this.#a(),this.showStep(this.currentStepIndex)}showStep(t){if(t>=this.tutorialSteps.length){this.hide();return}const s=this.tutorialSteps[t];this.show(s)}show(t){this.#e(),this.chibiGroup.classList.remove("chibi-on-left"),t.chibiSide==="left"&&this.chibiGroup.classList.add("chibi-on-left"),this.bubbleText.innerHTML=t.text,this.container.style.display="block",this.container.style.height=`${document.documentElement.scrollHeight}px`;let s=null,a=!1;if(t.clickTab){const e=document.querySelector(t.clickTab);e?(e.dispatchEvent(new Event("click",{bubbles:!0})),a=!0):console.warn(`ChibiTutorial: Tab button not found for selector "${t.clickTab}".`)}if(t.action==="click"){const e=document.querySelector(t.element);e?(e.dispatchEvent(new Event("click",{bubbles:!0})),a=!0):console.error(`ChibiTutorial: Element not found for selector "${t.element}" to perform action "${t.action}".`)}if(t.element){if(s=document.querySelector(t.element),!s){console.error(`ChibiTutorial: Element not found for selector "${t.element}". Skipping step.`),this.isTourActive&&this.handleNext();return}if(a)s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentTargetElement=s,this.currentTargetElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentTargetElement),this.#t(this.currentTargetElement)},50);else{const e=s.getBoundingClientRect();e.top<0||e.bottom>window.innerHeight||e.left<0||e.right>window.innerWidth?(s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentTargetElement=s,this.currentTargetElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentTargetElement),this.#t(this.currentTargetElement)},50)):(this.currentTargetElement=s,this.currentTargetElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentTargetElement),this.#t(this.currentTargetElement))}}else this.#s(null),this.chibiGroup.style.top="50%",this.chibiGroup.style.left="50%",this.chibiGroup.style.transform="translate(-50%, -50%)"}hide(){this.container.style.display="none",this.chibiGroup.classList.remove("chibi-on-left"),this.#e(),this.#r(),this.isShowingHelp||(this.isTourActive=!1,this.currentStepIndex=0,this.pausedTourStepIndex=-1),this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block"}#e(){this.currentTargetElement&&(this.observers&&this.observers.targetObserver&&this.observers.targetObserver.unobserve(this.currentTargetElement),this.currentTargetElement.classList.remove("chibi-tutorial-focused-element"),this.currentTargetElement=null)}handleNext(){this.isTourActive?(this.currentStepIndex++,this.showStep(this.currentStepIndex)):this.isShowingHelp?(this.hide(),this.pausedTourStepIndex!==-1&&this.startTour(this.tutorialSteps)):this.hide()}showHelp(t,s=null){if(!t){console.warn("ChibiTutorial: No help configuration provided.");return}let a=null;if(t.tourStepId){const e=this.tutorialSteps.findIndex(r=>r&&r.id===t.tourStepId);if(e!==-1)a={...this.tutorialSteps[e]};else if(console.warn(`ChibiTutorial: Tour step with ID '${t.tourStepId}' not found.`),t.text)a={text:t.text,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||"big"};else return}else t.text&&(a={text:t.text,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||"big"});a&&(this.isTourActive&&(this.pausedTourStepIndex=this.currentStepIndex,this.isTourActive=!1),this.isShowingHelp=!0,this.nextButton.textContent="OK",this.endButton.style.display="none",this.show(a))}handleHighlightUpdate(){window.requestAnimationFrame(()=>{if(!this.currentTargetElement||!this.isTourActive&&!this.isShowingHelp)return;this.container.style.height=`${document.documentElement.scrollHeight}px`;const t=this.currentTargetElement.getBoundingClientRect(),s={top:t.top+window.scrollY,bottom:t.bottom+window.scrollY,left:t.left+window.scrollX,right:t.right+window.scrollX,width:t.width,height:t.height};this.#s(s)})}handleReposition(){window.requestAnimationFrame(()=>{!this.currentTargetElement||!this.isTourActive&&!this.isShowingHelp||(this.container.style.height=`${document.documentElement.scrollHeight}px`,this.#t(this.currentTargetElement))})}#t(t){this.container.style.height=`${document.documentElement.scrollHeight}px`;const s=t.getBoundingClientRect(),a={top:s.top+window.scrollY,bottom:s.bottom+window.scrollY,left:s.left+window.scrollX,right:s.right+window.scrollX,width:s.width,height:s.height};this.#s(a),this.#i(a)}#i(t){let s;this.isTourActive?s=this.tutorialSteps[this.currentStepIndex]:this.isShowingHelp&&this.pausedTourStepIndex!==-1?s=this.tutorialSteps[this.pausedTourStepIndex]||{position:"bottom"}:this.isShowingHelp?s={position:"bottom"}:(console.warn("ChibiTutorial: #positionChibi called unexpectedly."),s={position:"bottom"});const a=this.chibiGroup.getBoundingClientRect(),e=s.position||"bottom",r=20;let o,n;switch(e){case"top":o=t.top-a.height-r,n=t.left+t.width/2-a.width/2;break;case"right":o=t.top+t.height/2-a.height/2,n=t.right+r;break;case"left":o=t.top+t.height/2-a.height/2,n=t.left-a.width-r;break;default:o=t.bottom+r,n=t.left+t.width/2-a.width/2;break}this.chibiGroup.style.top=`${o}px`,this.chibiGroup.style.left=`${n}px`,this.chibiGroup.style.transform=""}#s(t){if(!t){this.overlays.top.style.cssText="width: 100%; height: 100%;",this.overlays.bottom.style.cssText="width: 0; height: 0;",this.overlays.left.style.cssText="width: 0; height: 0;",this.overlays.right.style.cssText="width: 0; height: 0;";return}this.overlays.left.style.cssText=`top: 0; left: 0; width: ${t.left}px; height: 100%;`,this.overlays.right.style.cssText=`top: 0; left: ${t.right}px; width: calc(100% - ${t.right}px); height: 100%;`,this.overlays.top.style.cssText=`top: 0; left: ${t.left}px; width: ${t.width}px; height: ${t.top}px;`,this.overlays.bottom.style.cssText=`top: ${t.bottom}px; left: ${t.left}px; width: ${t.width}px; height: calc(100% - ${t.bottom}px);`}#a(){this.observers={targetObserver:new ResizeObserver(this.boundHandleHighlightUpdate),bodyObserver:new ResizeObserver(this.boundHandleHighlightUpdate),mutationObserver:new MutationObserver(this.boundHandleHighlightUpdate)},this.observers.bodyObserver&&this.observers.bodyObserver.observe(document.body),this.observers.mutationObserver&&this.observers.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0})}#r(){this.observers&&(this.observers.targetObserver&&this.observers.targetObserver.disconnect(),this.observers.bodyObserver&&this.observers.bodyObserver.disconnect(),this.observers.mutationObserver&&this.observers.mutationObserver.disconnect(),this.observers=null)}}const bt=`
    <div class="chibi-group">
        <div class="bubble-wrapper bubble-wrapper--big">
            <svg class="bubble-svg-background" viewBox="0 0 2352 856" xmlns="http://www.w3.org/2000/svg">
                <path style="fill:#232338; stroke:none;"
                    d="M2118 618C2072.09 632.557 2020.82 642.525 1974 627.975C1949.06 620.225 1928.07 604.761 1904 596C1928.15 574.906 1950.38 552.246 1966.14 524C1978.13 502.501 1986.34 479.266 1990.41 455C1993.94 433.973 1995.23 412.213 1992.71 391C1990.01 368.189 1984.63 346.161 1975.57 325C1936.75 234.287 1839 185.01 1751 153.692C1680.79 128.705 1606.59 113.569 1533 102.728C1418.45 85.8546 1303.52 78.8151 1188 75.9854C983.191 70.9684 772.755 73.2407 571 113.6C479.224 131.959 386.934 156.236 306 204.8C255.006 235.399 208.898 279.148 188.053 336C180.074 357.763 177.006 379.135 174.83 402C173.006 421.169 174.62 441.101 178.4 460C208.383 609.934 376.221 669.932 507 702.627C677.331 745.209 853.685 750.744 1028 755.015C1226.65 759.881 1430.98 752.259 1626 710.789C1662.97 702.929 1698.61 691.625 1735 681.735C1745.17 678.971 1757.98 684.363 1768 686.576C1789.92 691.417 1811.81 696.134 1834 699.576C1897.86 709.479 1968.19 712.102 2028 683.68C2042.89 676.602 2055.69 666.243 2069 656.71C2080.1 648.757 2091.06 640.547 2102 632.374C2107.6 628.192 2114.64 624.297 2118 618z" />
            </svg>
            <div class="bubble-text"> </div>
        </div>
        <img src="/images/37_chibi.png" alt="Tutorial Assistant" class="tutorial-chibi">
        <div class="prompt-buttons">
            <button class="btn btn--tutorial_next">Next</button>
            <button class="btn btn--tutorial_end">Maybe later</button>
        </div>
    </div>`,yt=[{text:"<p>Welcome to the Gacha Calculator! Let me show you around.</p>",size:"big"},{id:"pity-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>First, you can input your current pity and guarantees here. You can also import data from paimon.moe</p>",position:"right",size:"big"},{id:"constellation-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>Owned characters constellations are needed for accurate cashback.</p>",position:"right",size:"big"},{id:"pull-plan-step",element:".pull-plan-section",text:"<p>Next, build your pull plan here. Add all the characters and weapons you want to get.</p>",position:"left",chibiSide:"left",size:"big"},{id:"calculate-button-step",element:"#calculate-btn",text:"<p>Once your plan is set, press Calculate!</p>",position:"top",size:"small"},{element:".chart-wrapper",text:"<p>You'll get a chart showing the probability of success for each number of pulls.</p>",position:"top"},{element:"#probability-table",text:"<p>And down here, you can see a detailed table with cashback estimates. Good luck!</p>",position:"top"}],H={"pity-input-step":{tourStepId:"pity-input-step"},"constellation-input-step":{tourStepId:"constellation-input-step"},"pull-plan-step":{tourStepId:"pull-plan-step"},"calculate-button-step":{tourStepId:"calculate-button-step"},"import-paimon-help":{text:'<p>You can import your pity data directly from <a href="https://paimon.moe/" target="_blank">paimon.moe</a>. Click the "Import from paimon.moe" button and paste the exported JSON data.</p>'},"target-character-help":{text:"<p>Select the characters you are aiming to pull. You can specify the desired constellation level for each.</p>"},"target-weapon-help":{text:"<p>Select the weapons you are aiming to pull. You can specify the desired refinement level for each.</p>"}},z={CHARACTER:"character",WEAPON:"weapon"},R={PITY_ROW:"[data-banner]",CONSTELLATION_ROW:"[data-rarity]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},B={pitySettings:{[z.CHARACTER]:{pity4:0,pity5:0,caprad:1},[z.WEAPON]:{pity4:0,pity5:0,epPath:0}},isCharacter:!0,isWeapon:!0,isCapRad:!0,isEpitPath:!0,constellationColumns:8},W={probability:70,pulls:119};class St{constructor(t){this.parts=t,this.persistence=G("genshin",R);const s=at({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn}),a={getPageConfiguration:Z,getLabels:Q,getPullPlan:K,getTarget:J,updateChart:X,convertToChartData:V,recalcInputs:j,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:R,INITIAL_CONFIG:B},postCalculationHooks:[s],persistence:this.persistence};this.validator=new q(this.parts.CONSTELLATION_MAP),this.calculationHandler=new Y(a),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn"),this.tutorial=new ft(bt)}initialize(){this.validator.initialize(),tt(this.persistence,this.parts.gachaConfig,this.validator,B,lt,R),et(),O(),this.#e(),this.#i()}#e(){this.calculateBtn&&this.calculateBtn.addEventListener("click",async()=>{this.#t()&&await this.calculationHandler.runCalculation()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>it(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(yt)}),O(this.persistence,ut,this.validator),document.querySelectorAll(".help-btn").forEach(s=>{s.addEventListener("click",a=>{a.preventDefault();const e=s.getAttribute("data-help-key")||s.getAttribute("data-tour-step-id");if(e&&H[e]){const r=H[e];this.tutorial.showHelp(r,s)}else console.warn(`ChibiTutorial: No help configuration found for key '${e}'.`,s)})})}#t(){if(document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll();const t=document.querySelectorAll(".is-invalid"),s=new Set;t.forEach(e=>{const r=e.closest(".tab-pane");if(r){const o=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);o&&s.add(o)}e.classList.add("flicker"),e.addEventListener("animationend",()=>e.classList.remove("flicker"),{once:!0})}),s.forEach(e=>{e.classList.add("is-invalid","flicker"),e.addEventListener("animationend",()=>e.classList.remove("flicker"),{once:!0})});const a=Array.from(s)[0];return a&&a.click(),setTimeout(()=>{t[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#i(){const t=this.persistence.loadCalculation(),s=t?t.input:null;t?(P(this.parts.gachaConfig.paths,s),L(W,t),I(t.persistInput)):(P(this.parts.gachaConfig.paths),L(W),I()),this.calculationHandler.runCalculation()}}function gt(i,t){let s=!0;const a=4;if(t)for(let e=0;e<i.length-1;e++){let r=!0;for(let o=0;o<a;o++){for(const n of i[e][o].states)n>0&&(r=!1,s=!1);i[e][o].isEmpty=r}i[e].isEmpty=r}else for(let e=0;e<i.length-1;e++){let r=!0;for(let o=0;o<a;o++){for(const n of i[e][o].states)n.size>0&&(r=!1,s=!1);i[e][o].isEmpty=r}i[e].isEmpty=r}return s}function mt(i){const t=[];if(Array.isArray(i[0]))for(let e=0;e<i.length;e++){let r="None";e>0&&e<=i.length&&i[e-1]&&(r=i[e-1][0].type||"None");let o={offRates:new Map,type:r};for(let n=0;n<4;n++){const c=i[e][n].states;for(const l of c)l.size>0&&s(o.offRates,l)}t.push(o)}else for(let a=0;a<i.length;a++){const e=i[a].states;let r="None";a>0&&a<=i.length&&i[a-1]&&(r=i[a-1].type||"None");let o={offRates:new Map,type:r};for(const n of e)n.size>0&&s(o.offRates,n);t.push(o)}return t;function s(a,e){for(const[r,o]of e)a.has(r)?a.get(r).prob+=o.prob:a.set(r,{...o})}}function vt(i){const t=new Array(i.length),s=4;for(let a=0;a<i.length;a++){let e=0;for(let r=0;r<s;r++){const o=i[a][r].states;for(let n=0;n<o.length;n++)e+=o[n]}t[a]=e}return t}function wt(i){const t=[];for(let s=0;s<i.length;s++){const a=i[s];let e=0;for(let r=0;r<a.length;r++){const o=a[r].states;for(let n=0;n<o.length;n++)for(const[c,l]of o[n])e+=l.prob}t.push(e)}return t}function Tt(i){let a=0;for(let e=0,r=i.length;e<r;e++)for(let o=0;o<4;o++){const n=i[e][o].states;for(let c=0,l=n.length;c<l;c++)n[c]>0&&n[c]<=1e-10&&(a+=n[c],n[c]=0)}if(a>0){const e=1/(1-a);for(let r=0,o=i.length;r<o;r++)for(let n=0;n<4;n++){const c=i[r][n].states;for(let l=0,h=c.length;l<h;l++)c[l]!=0&&(c[l]*=e)}}}function Ct(i){for(let s=0;s<i.length;s++)for(let a=0;a<4;a++){const e=i[s][a].states;for(let r=0;r<e.length;r++){const o=e[r];let n=0;for(const c of o.values())n+=c.prob;e[r]=n}}}function _t(i,t,s){if(!Array.isArray(i.SSR.pullPlan))throw new Error("Invalid pull plan");const a={CHARACTER:0},{pullPlan:e}=i.SSR,r=[];for(const[n,c]of e.entries())c===a.CHARACTER?(r.push(Array.from({length:3},()=>({states:Array.from({length:s.CHARACTER_SSR_5050},()=>new Map),type:"Character",isEmpty:!0}))),r[n].push({states:Array.from({length:s.CHARACTER_SSR_GUARANTEED},()=>new Map),type:"Character",isEmpty:!0})):r.push(Array.from({length:4},()=>({states:Array.from({length:s.WEAPON_SSR},()=>new Map),type:"Weapon",isEmpty:!0})));return r.push(Array.from({length:4},()=>({states:Array.from({length:1},()=>new Map)}))),o(t),{distributionSSR:r};function o(n){let c=0;n[0].type==="firstChar"&&(c=n[0].special),r[0][c].states[n[0].pity].set(0,{prob:1}),r[0][c].isEmpty=!1}}function Rt(i,t){let s=!1,a=!1,e=0,r=0;const o=[];e+=i.SSR.pity.char,e+=i.SSR.guarantee.char*t.pitySSRChar,r+=i.SSR.pity.wep,r+=i.SSR.special.epitPath===0?i.SSR.guarantee.wep*t.pitySSRWep:2*t.pitySSRWep;for(const n of i.SSR.pullPlan)n===0&&!s?(s=!0,o.push({type:"firstChar",pity:e,special:i.SSR.special.capRad})):n===1&&!a?(a=!0,o.push({pity:r})):o.push({pity:0});return o.push({pity:0}),o}function xt(i,t){const a=(t.SR-1)/2,e=[{states:Array.from({length:t.SR},()=>new Map)}],r=[{states:Array.from({length:t.SR},()=>new Map)}],o=i.SR.guarantee.char*a+i.SR.pity.char,n=i.SR.guarantee.wep*a+i.SR.pity.wep;c(e[0].states[o]),c(r[0].states[n]);function c(l){l.set(0,{prob:1})}return{distributionCharSR:e,distributionWepSR:r}}const v=1e-10;function Et(i,t,s,a,e,r){const o=i.length-2;for(let n=o;n>=0;n--){const c=r[n+1],l=c.pity;let h=null;if(c.type==="firstChar"&&(h=c.special),!i[n].isEmpty)for(let p=0;p<4;p++){const u=i[n][p];if(!u.isEmpty)if(u.type==="Character")At(t,n,i,a,l,p);else if(u.type==="Weapon")kt(s,n,i,e,l,p,h);else throw new Error(`Unknown SSR array type: ${u.type}`)}}}function At(i,t,s,a,e,r){const o=Math.floor(r/2),n=s[t][r].states;if(r!=3){const c=s[t][r].states.length;let l=.5;r===2&&(l=.55);const h=s[t+1][o].states,p=s[t+1][r+1].states;for(let u=c-2;u>=0;u--){const d=n[u],f=u>=a,g=i[u-a*f],y=d*g,C=d-y;let m=y;if(m>v){let S=p;f||(m*=l,S=h),S[e]+=m}if(!f){let S=y*(1-l);S>v&&(n[a]+=S)}let w=C;w>v&&(n[u+1]+=w),n[u]=0}}else{const c=s[t+1][o].states,l=s[t][r].states.length;for(let h=l-2;h>=0;h--){const p=n[h],u=i[h],d=p*u,f=p-d;let g=d;g>v&&(c[e]+=g);let y=f;y>v&&(n[h+1]+=y),n[h]=0}}}function kt(i,t,s,a,e,r,o){let n=r;o!=null&&(n=o);const c=s[t][r].states.length,l=.375,h=.625,p=s[t][r].states,u=s[t+1][n].states;for(let d=c-2;d>=0;d--){const f=p[d],g=d>=2*a;let y=!1;g||(y=d>=a);const C=i[d-a*y-a*g*2],m=f*C,w=f-m;let S=m;if(S>v&&(g||(y?S*=h:S*=l),u[e]+=S),!g){let _=m*(1-l);y&&(_=m*(1-h)),_>v&&(p[a*2]+=_)}let k=w;k>v&&(p[d+1]+=k),p[d]=0}}const Ot="genshin",M=b.pity.pitySSRChar,D=b.pity.pitySSRWep,Pt=b.pity.pitySRChar,F={CHARACTER_SSR_5050:b.pity.pitySSRChar*2+1,CHARACTER_SSR_GUARANTEED:b.pity.pitySSRChar+1,WEAPON_SSR:b.pity.pitySSRWep*3+1,SR:b.pity.pitySRChar*2+1},Lt={distributionArrays:{makeSSR:(i,t)=>_t(i,t,F),makeSR:i=>xt(i,F),sortPity:i=>Rt(i,b.pity)},pullLogic:{rankUpSSRCheap:(i,t)=>Et(i,x,E,M,D,t)},workerManager:new rt,contexts:{contextSSR:{ODDS_CHARACTER_SSR:x,ODDS_WEAPON_SSR:E,SSR_CHAR_PITY:M,SSR_WEP_PITY:D},contextSR:{ODDS_SR:A,SR_PITY:Pt},moduleType:Ot},helpers:{consolidateDistributionForCashback:mt,consolidateProbabilitiesCheap:vt,consolidateProbabilities:wt,simplifyDistribution:Ct,normalizeCheap:Tt,checkIsEmpty:gt}};function It(i,t){return new nt(b,Lt).runGachaCalculation(i,t)}document.addEventListener("DOMContentLoaded",()=>{const i={gachaConfig:b,CONSTELLATION_MAP:T,runCalcFn:It,cashbackFn:ot,updateTableFn:st};new St(i).initialize()});
