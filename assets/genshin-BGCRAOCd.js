/* empty css               */(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&e(l)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();const G={CHARACTER:"character",WEAPON:"weapon"},I={PITY_ROW:"[data-banner]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},nt={pitySettings:{[G.CHARACTER]:{pity4:0,pity5:0,caprad:1},[G.WEAPON]:{pity4:0,pity5:0,epPath:0}},constellationColumns:8},T=(n,t=!1)=>n?t?n.checked:parseInt(n.value)||0:null;function dt(n,t){const a=document.getElementById("pity-panel"),e=document.getElementById("constellation-panel"),o=t.paths;if(!a||!e)return console.error("Required tab panels not found. Cannot get page configuration."),null;const r=(p,u)=>{if(!u)return[];const m=u.querySelector("#constellation-table");if(!m)return console.warn("Could not find the constellation table inside the panel:",u),[];const i=m.querySelectorAll(`tr[data-rarity="${p}"] .custom-input`);return Array.from(i).map(c=>parseInt(c.value)||0)},l=a.querySelector(`${I.PITY_ROW}[data-banner="character"]`),s=a.querySelector(`${I.PITY_ROW}[data-banner="weapon"]`),h=mt(o);return!l||!s?(console.error("Pity rows for character or weapon not found inside #pity-panel."),null):{SSR:{pity:{char:T(l.querySelector('[data-control="pity-5"]')),wep:T(s.querySelector('[data-control="pity-5"]'))},guarantee:{char:T(l.querySelector(".guarantee-5"),!0),wep:T(s.querySelector(".guarantee-5"),!0)},special:{capRad:T(l.querySelector('[data-control="capRad"]')),epitPath:T(s.querySelector('[data-control="epPath"]'))},consCountStandard:r(5,e),pullPlan:h.typeArray,cashbackRoadmap:h.cashbackArray},SR:{pity:{char:T(l.querySelector('[data-control="pity-4"]')),wep:T(s.querySelector('[data-control="pity-4"]'))},guarantee:{char:T(l.querySelector(".guarantee-4"),!0),wep:T(s.querySelector(".guarantee-4"),!0)},rateUps:gt(n),consCount:r(4,e)}}}function yt(){const n=document.querySelectorAll(".row"),t=[];return Array.from(n).slice(1).forEach(e=>{const o=e.dataset.group,r=e.querySelector(".type-selector")?.value||"char",l=e.querySelector(".first-select")?.value||"None",s=e.querySelector(".second-select")?.value||"None";t.push({group:o,type:r,from:l,to:s})}),t}function mt(n){const t=document.querySelectorAll(".row"),a=[],e=[];return Array.from(t).slice(1).forEach(r=>{const l=r.querySelector(".type-selector")?.value||"char",s=r.querySelector(".first-select")?.value||"None",h=r.querySelector(".second-select")?.value||"None",p=l==="char"?n.char:n.wep,u=p.indexOf(s),m=p.indexOf(h);if(u===-1||m===-1||u>=m)return;const i=m-u;let c=u,f=0;for(let y=0;y<i;y++)l==="char"?(c===0?f="none":f="regular",a.push(0)):(f="regular",a.push(1)),e.push(f),c++}),{typeArray:a,cashbackArray:e}}function St(n){const t=document.querySelectorAll(".row"),a=Array.from(t).slice(1);let e=["None"];const o=n.char,r=n.wep;return a.forEach(l=>{const s=l.querySelector(".type-selector")?.value||"char",h=l.querySelector(".first-select")?.value||"None",p=l.querySelector(".second-select")?.value||"None",u=s==="char"?o:r,m=u.indexOf(h),i=u.indexOf(p);if(m===-1||i===-1||m>=i)return;const c=u.slice(m+1,i+1);e.push(...c)}),e}function gt(n){const t=document.querySelectorAll("#rate-up-table select.custom-select");let a=new Array(Object.keys(n).length).fill(0);return t.length===0?(console.error("Could not find any rate-up select elements."),[]):(t.forEach(e=>{const o=e.value;if(o==="unknown")return;const r=n[o];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${o}"`)}),a)}let x=null;function bt(n,t,a){const e=document.getElementById("myChart").getContext("2d");x&&x.destroy();const o=n.length,r=a.slice(1);return x=new Chart(e,{type:"line",data:{labels:t,datasets:n.map((l,s)=>{const h=s===0?"#2196F3":s===1?"#4CAF50":vt(s);return{label:r[s],data:l,borderColor:h,backgroundColor:s===0?"rgba(33, 150, 243, 0.1)":s===1?"rgba(76, 175, 80, 0.1)":Ct(s),fill:!0,tension:.4,order:o-s,borderWidth:5,pointRadius:0}})},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:function(l){return(l*100).toFixed(0)+"%"}},beginAtZero:!0,min:0,max:1}},plugins:{legend:{labels:{sort:(l,s)=>l.datasetIndex-s.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(l){let s=l.dataset.label||"";return s&&(s+=": "),s+=(l.parsed.y*100).toFixed(2)+"%",s}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}}),x}function vt(n){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[n%t.length]}function Ct(n){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(n-2)%t.length]}function At(n,t,a){return bt(n,t,a)}function Et(n){let t=[],a=[0];for(let e=1;e<n[0].length;e++)t.push(Array(n.length+1).fill(0));for(let e=0;e<n.length;e++){for(let o=1;o<n[e].length;o++){let r=0;for(let l=0;l<n[e][o].length;l++)r+=n[e][o][l].totalSum;for(let l=0;l<o;l++)t[l][e+1]+=r}a.push(e+1)}return{data:t,labels:a}}function Pt(n){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=wt(n,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=Tt(n,parseInt(document.querySelector('[data-control="pulls"]').value))}function wt(n,t){t===100&&(t=99.9);let a=n.length-1,e=!0,o=0,r=0;for(;e;)n[a][r]>t/100&&(o=r,e=!1),r++;return o}function Tt(n,t){let a=n.length-1;return n[a].length<=t?100:Math.round(n[a][t]*100)}function It(n,t){return function(){const e=dt(n.calculatorConfig.CONSTELLATION_MAP,n.calculatorConfig.gachaConfig),o=St(n.calculatorConfig.gachaConfig.paths),r=n.calculatorFunction(e),l=Et(r.SSR);At(l.data,l.labels,o),Pt(l.data);const s={results:r,inputConfig:e,chartLabels:o,gachaConfig:n.calculatorConfig.gachaConfig};if(n.postCalculationHooks&&n.postCalculationHooks.forEach(h=>h(s)),t){const h=parseInt(document.querySelector('[data-control="pulls"]').value);t.saveCalculation({input:yt(),targetProb:e.targetProb,targetPull:h,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")})}}}const rt=[.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.066,.126,.186,.246,.306,.366,.426,.486,.546,.606,.666,.726,.786,.846,.906,.966,1],ot=[.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.077,.147,.217,.287,.357,.427,.497,.567,.637,.707,.777,.847,.917,.987,1],M=[.051,.051,.051,.051,.051,.051,.051,.051,.561,1],W={maxCharacterConstelation:6,rateUpCharacterSR:3,rateUpWeaponSR:5,poolStandardCharSSR:8,poolCharSR:43,configSR:{maxType:7,regularPoints:.4,specialPoints:1},configSSR:{maxType:7,regularPoints:2,specialPoints:5},configWep:{pointsSR:.4,pointsSSR:2},paths:{char:["None","c0","c1","c2","c3","c4","c5","c6"],wep:["None","r1","r2","r3","r4","r5"]},pity:{pitySSRChar:rt.length,pitySSRWep:ot.length,pitySRChar:M.length,pitySRWep:M.length},default:0},_t=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"c0",text:"C0"},{value:"c1",text:"C1"},{value:"c2",text:"C2"},{value:"c3",text:"C3"},{value:"c4",text:"C4"},{value:"c5",text:"C5"},{value:"c6",text:"C6"}],N={none:0,c0:1,c1:2,c2:3,c3:4,c4:5,c5:6,c6:7},lt=new Set(["dehya","diluc","jean","keqing","mona","qiqi","tighnari","yumemizuki_mizuki"]),st=new Set(["barbara","beidou","bennett","candace","charlotte","chevreuse","chongyun","collei","dahlia","diona","dori","faruzan","fischl","freminet","gaming","gorou","iansan","ifa","kachina","kaveh","kirara","kujou_sara","kuki_shinobu","lan_yan","layla","lynette","mika","ningguang","noelle","ororon","razor","rosaria","sayu","sethos","shikanoin_heizou","sucrose","thoma","xiangling","xingqiu","xinyan","yanfei","yaoyao","yun_jin"]),Rt=new Set(["amos_bow","aquila_favonia","lost_prayer_to_the_sacred_winds","primordial_jade_winged-spear","skyward_atlas","skyward_blade","skyward_harp","skyward_pride","skyward_spine","wolfs_gravestone"]),Lt=new Set(["dragons_bane","eye_of_perception","favonius_codex","favonius_greatsword","favonius_lance","favonius_sword","favonius_warbow","lions_roar","rainslasher","rust","sacrificial_bow","sacrificial_fragments","sacrificial_greatsword","sacrificial_sword","the_bell","the_flute","the_stringless","the_widsith","akuoumaru","alley_hunter","flower-wreathed_feathers","fruitful_hook","lithic_blade","lithic_spear","makhaira_aquamarine","mitternachts_waltz","mountain-bracing_bolt","mouuns_moon","portable_power_saw","prospectors_drill","range_gauge","sturdy_bone","the_alley_flash","the_dockhands_assistant","wandering_evenstar","wavebreakers_fin","waveriding_whirl","wine_and_song","xiphos_moonlight"]),kt=new Set(["black_tassel","bloodtainted_greatsword","cool_steel","debate_club","emerald_orb","ferrous_shadow","harbinger_of_dawn","magic_guide","raven_bow","sharpshooters_oath","skyrider_sword","slingshot","thrilling_tales_of_dragon_slayers","white_tassel"]);function qt(n,t,a){Ot(t.pity),xt(t),Ut();const e=n.loadTables();e&&(ct(e.pity),it(e.constellation),Dt(e.rateUps),a.validateAll()),n.init()}function Ot(n){const t=document.getElementById("pity-row-template"),a=document.querySelector(`${I.PITY_TABLE} tbody`);Object.entries(nt.pitySettings).forEach(([e,o])=>{const r=t.content.cloneNode(!0).querySelector("tr"),l=r.querySelector(".special-mechanic");r.dataset.validationType="individual";const s=r.querySelector('[data-control="pity-4"]'),h=r.querySelector('[data-control="pity-5"]');s&&(s.min=0,s.max=e.includes("Weapon")?n.pitySRWep-1:n.pitySRChar-1),h&&(h.min=0,h.max=e.includes("Weapon")?n.pitySSRWep-1:n.pitySSRChar-1),r.dataset.banner=e,r.querySelector(".banner-name").textContent=e,r.querySelector('[data-control="pity-4"]').value=o.pity4,r.querySelector('[data-control="pity-5"]').value=o.pity5,l&&(l.innerHTML=`
                <div class="mechanic-stack">
                    <div class="character-only">
                        <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                               value="${o.caprad??""}">
                    </div>
                    <div class="weapon-only">
                        <input type="number" data-control="epPath" class="custom-input" min="0" max="2" 
                               value="${o.epPath??""}">
                    </div>
                </div>
            `),a.appendChild(r)})}function xt(n){const t=document.getElementById("const-column-template"),a=document.querySelectorAll(`${I.CONSTELLATION_TABLE} tbody tr`),e=n.poolStandardCharSSR,o=n.poolCharSR;a.forEach(r=>{const l=document.createDocumentFragment(),h=r.querySelector("td:first-child")?.textContent.trim();r.dataset.validationType="row-sum",h==="5★"?(r.dataset.targetSum=n.poolStandardCharSSR,r.dataset.rarity="5"):(r.dataset.targetSum=n.poolCharSR,r.dataset.rarity="4");for(let p=0;p<nt.constellationColumns;p++){const u=t.content.cloneNode(!0);if(p===0){const m=u.querySelector("input");if(m){const i=h==="5★"?e:o;m.value=i}}l.appendChild(u)}r.appendChild(l)})}function Ut(){const n=document.querySelectorAll("#rate-up-table select");if(n.length===0)return;const t=_t.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");n.forEach(a=>{a.innerHTML=t,a.value="unknown"})}function Nt(n,t,a,e){const o=[];for(let l=0;l<n.SSR[a-1].length;l++){let s=0;for(let h of n.SSR[a-1][l])s+=h.totalSum;s=(s*100).toFixed(2),s>0&&o.push({name:t[l],probability:s,p10:e[l].p10,mean:e[l].mean,p90:e[l].p90,color:"#3498db"})}const r=document.querySelector("#probability-table tbody");r.innerHTML="",o.forEach(l=>{const s=document.createElement("tr"),h=l.probability;s.innerHTML=`
      <td>${l.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${h}%;background:${l.color}">
            <div class="progress-label">${l.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${l.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${l.mean.toFixed(1)}</td>
      <td class="cashback-value">${l.p90.toFixed(1)}</td>
    `,r.appendChild(s)})}function ct(n){n.forEach(t=>{const a=document.querySelector(`${I.PITY_TABLE} tr[data-banner="${t.banner}"]`);a&&(a.querySelector('[data-control="pity-4"]').value=t.pity4,a.querySelector('[data-control="pity-5"]').value=t.pity5,a.querySelector(".guarantee-4").checked=t.guarantee4,a.querySelector(".guarantee-5").checked=t.guarantee5,t.caprad&&a.querySelector('[data-control="capRad"]')&&(a.querySelector('[data-control="capRad"]').value=t.caprad),t.epPath&&a.querySelector('[data-control="epPath"]')&&(a.querySelector('[data-control="epPath"]').value=t.epPath))})}function it(n){document.querySelectorAll(`${I.CONSTELLATION_TABLE} tbody tr`).forEach((a,e)=>{const o=n[e];o&&a.querySelectorAll("td:nth-child(n+2) input").forEach((l,s)=>{o[s]!==void 0&&(l.value=o[s])})})}function Dt(n){if(!n||!Array.isArray(n))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,e)=>{n[e]!==void 0&&(a.value=n[e])})}function V(n,t,a){const e=document.getElementById("import-file-input");if(!e){console.error("Import file input not found!");return}const o=r=>Mt(r,n,t,a);e.removeEventListener("change",e.__handleFile),e.addEventListener("change",o),e.__handleFile=o}async function Mt(n,t,a,e){const o=n.target.files[0];if(o)try{const r=await o.text(),l=JSON.parse(r);let s=null;l.exportFormat==="GachaCalculatorData"?s=l:a&&(s=a(l)),s?(Wt(s),e.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(r){console.error("File import error:",r)}finally{n.target.value=""}}function Wt(n){n.pity&&ct(n.pity),n.constellation&&it(n.constellation)}function Bt(n){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:n.getPityData(),constellation:n.getConstellationData()},a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(e),r=document.createElement("a");r.href=o;const l=new Date().toISOString().slice(0,10);r.download=`gachaCalc-data-${l}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log("Data exported successfully.")}function K(n,t=null){let a=0;const e=new Map;t&&t.forEach(p=>{if(p.group&&!p.group.startsWith("unique")){const u=parseInt(p.group.replace(/\D/g,""));a=Math.max(a,u),e.set(p.group,F(u))}});const o=document.getElementById("row-template"),r=document.querySelector(".rows-container"),l=document.getElementById("add-btn");function s(p=null,u=null){const i=o.content.cloneNode(!0).querySelector(".row"),c=i.querySelector(".dropdown"),f=i.querySelector(".type-selector"),y=c.querySelector(".type-icon"),d=c.querySelector(".type-text");i.querySelectorAll(".dropdown__item").forEach(b=>{b.addEventListener("click",v=>{v.preventDefault();const A=b.dataset.value;f.value=A;const w=f.options[f.selectedIndex];y.src=w.dataset.icon,d.textContent=w.textContent,h(i,A),c.classList.remove("dropdown--open")})});const g=u?.type||"char";f.value=g;const C=f.options[f.selectedIndex];y.src=C.dataset.icon,d.textContent=C.textContent;let S;if(u){S=u.group;let b=e.get(S);if(b===void 0&&!S.startsWith("unique")){const v=parseInt(S.replace(/\D/g,""));b=F(v),e.set(S,b)}i.style.setProperty("--group-color",S.startsWith("unique")?"#f0f0f0":`hsl(${b}, 80%, 70%)`),h(i,g,u.from,u.to)}else if(p){const b=p.dataset.group,v=p.querySelector(".type-selector").value,A=p.querySelector(".second-select").value;if(b.startsWith("unique")){const R=Ft(e,a);S=`group${R}`;const q=F(R);i.style.setProperty("--group-color",`hsl(${q}, 80%, 70%)`),p.style.setProperty("--group-color",`hsl(${q}, 80%, 70%)`),p.dataset.group=S,e.set(S,q),R===a+1&&a++}else{S=b;const R=e.get(b);i.style.setProperty("--group-color",`hsl(${R}, 80%, 70%)`)}f.value=v;const w=f.options[f.selectedIndex];y.src=w.dataset.icon,d.textContent=w.textContent,h(i,v,A)}else S=`unique${g.charAt(0).toUpperCase()+g.slice(1)}`,i.style.setProperty("--group-color","#f0f0f0"),h(i,g);return i.dataset.group=S,c.addEventListener("click",b=>{b.stopPropagation(),c.classList.toggle("dropdown--open")}),document.addEventListener("click",b=>{c.contains(b.target)||c.classList.remove("dropdown--open")}),i.querySelectorAll(".dropdown__item").forEach(b=>{b.addEventListener("click",v=>{v.stopPropagation(),f.value=b.dataset.value;const A=f.options[f.selectedIndex];y.src=A.dataset.icon,d.textContent=A.textContent,c.classList.remove("dropdown--open"),h(i,f.value),i.dataset.group.startsWith("unique")||(i.dataset.group=`unique${f.value.charAt(0).toUpperCase()+f.value.slice(1)}`)})}),f.addEventListener("change",()=>{const b=f.options[f.selectedIndex];y.src=b.dataset.icon,d.textContent=b.textContent,h(i,f.value),c.classList.remove("dropdown--open"),i.dataset.group.startsWith("unique")||(i.dataset.group=`unique${f.value.charAt(0).toUpperCase()+f.value.slice(1)}`)}),i.querySelector(".btn--chainAdd").addEventListener("click",()=>{r.appendChild(s(i))}),i.querySelector(".btn--delete").addEventListener("click",()=>{const b=i.dataset.group;b.startsWith("unique")||Array.from(r.querySelectorAll(".row")).filter(A=>A.dataset.group===b).length===1&&e.delete(b),i.remove()}),i}function h(p,u,m=null,i=null){const c=p.querySelector(".first-select"),f=p.querySelector(".second-select");c.innerHTML="",f.innerHTML="";const y=n[u]||n.char;if(y.slice(0,-1).forEach(d=>{const g=document.createElement("option");g.value=d,g.textContent=d,c.appendChild(g)}),y.slice(1).forEach(d=>{const g=document.createElement("option");g.value=d,g.textContent=d,f.appendChild(g)}),m&&y.includes(m)){c.value=m;const d=y.indexOf(m);f.value=i&&y.includes(i)&&y.indexOf(i)>d?i:y[Math.min(d+1,y.length-1)]}else c.value=y[0],f.value=y[1]}r.innerHTML="",t?t.forEach(p=>{r.appendChild(s(null,p))}):r.appendChild(s()),l.addEventListener("click",()=>{r.appendChild(s())})}function F(n){const t=[0,120,240,60,180,300];return n<=t.length?t[n-1]:n*137.5%360}function Ft(n,t){const a=Array.from(n.keys()).map(e=>parseInt(e.replace(/\D/g,""))).sort((e,o)=>e-o);for(let e=1;e<=t;e++)if(!a.includes(e))return e;return++t}function J(n=null){const t={probability:90,pulls:155},a=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]');n?(a.value=n.targetProb||t.probability,e.value=n.targetPull||t.pulls):(a.value=t.probability,e.value=t.pulls)}function X(n=null){const t=document.querySelector('[data-control="probability"]'),a=document.querySelector('[data-control="pulls"]'),e=document.querySelectorAll(".mode-label");let o;n?o=n:o="probability",r(),e.forEach(s=>{s.addEventListener("click",function(){o=this.getAttribute("data-target"),r(),l()})}),t.addEventListener("input",function(){o="probability",r(),l()}),a.addEventListener("input",function(){o="pulls",r(),l()});function r(){e.forEach(s=>{const h=s.getAttribute("data-target")===o;s.classList.toggle("active",h)})}function l(){o==="probability"?parseFloat(t.value):parseInt(a.value)}}const $={TABLES:1,CALCULATIONS:1,PULL_PLANS:1};function $t(n){const t={TABLES:`gacha_tables_${n}_v1`,CALCULATIONS:`gacha_calc_${n}_v1`,PULL_PLANS:`gacha_plans_${n}_v1`};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(a){this._save(t.CALCULATIONS,{_schema:$.CALCULATIONS,...a})},loadCalculation(){return this._validate(this._load(t.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(t.TABLES,{_schema:$.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(t.TABLES),"TABLES")},getPityData(){return Array.from(document.querySelectorAll(`${I.PITY_TABLE} tbody tr`)).map(a=>({banner:a.dataset.banner,pity4:a.querySelector('[data-control="pity-4"]').value,pity5:a.querySelector('[data-control="pity-5"]').value,guarantee4:a.querySelector(".guarantee-4").checked,guarantee5:a.querySelector(".guarantee-5").checked,...a.querySelector('[data-control="capRad"]')&&{caprad:a.querySelector('[data-control="capRad"]').value},...a.querySelector('[data-control="epPath"]')&&{epPath:a.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${I.CONSTELLATION_TABLE} tbody tr`)).map(a=>Array.from(a.querySelectorAll("td:nth-child(n+2) input")).map(e=>e.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(a=>a.value)},setupTableListeners(){const a=[`${I.PITY_TABLE} input`,`${I.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(a).forEach(e=>{e.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(a,e){try{localStorage.setItem(a,JSON.stringify(e))}catch(o){console.error("Storage error:",o),this._handleStorageError()}},_load(a){try{const e=localStorage.getItem(a);return e?JSON.parse(e):null}catch(e){return console.error("Load error:",e),null}},_validate(a,e){return a?typeof a._schema>"u"?a:a._schema!==$[e]?(console.warn(`Schema version mismatch for ${e}`),null):a:null},_handleStorageError(){Object.values(t).forEach(a=>{try{localStorage.removeItem(a)}catch(e){console.error("Cleanup failed:",e)}})}}}class Ht{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",a=>{if(a.target.matches('input[type="number"]'))try{a.target.select()}catch(e){console.warn("Could not select text in input.",e)}},{capture:!0}),t.addEventListener("keydown",a=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(a.key)||(a.ctrlKey||a.metaKey)&&["a","c","v","x"].includes(a.key.toLowerCase())||/^\d$/.test(a.key)||a.preventDefault()}),t.addEventListener("input",a=>{const e=a.target;e.matches('input[type="number"]')&&this.validateIndividualInput(e);const o=e.closest("table");if(o)switch(o.id){case"constellation-table":{const r=e.closest("tr");r&&this.validateRowSum(r),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#pity-table");t&&t.querySelectorAll('tbody tr input[type="number"]').forEach(e=>this.validateIndividualInput(e));const a=document.querySelector("#constellation-table");a&&a.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(e=>{e.querySelectorAll('input[type="number"]').forEach((o,r)=>{t[r]+=parseInt(o.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(a=>{const e=this.constellationMap[a.value];e!==void 0&&t[e]++}),t}validateIndividualInput(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),o=parseInt(t.max,10);if((!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=o)){t.classList.remove("is-invalid");return}}t.classList.add("is-invalid")}validateRowSum(t){if(!t.dataset.targetSum)return;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let o=0;e.forEach(r=>o+=parseFloat(r.value)||0),e.forEach(r=>r.classList.toggle("is-invalid",o!==a))}validateRateUpEligibility(){const t=this.getRateUpUsage(),a=this.availableConstellationCounts.map((e,o)=>t[o]>e);document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const o=this.constellationMap[e.value],r=o!==void 0&&a[o];e.classList.toggle("is-invalid",r)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const e of t)if(!this.isIndividualInputValid(e))return!1;const a=document.querySelectorAll("#constellation-table tbody tr");for(const e of a)if(!this.isRowSumValid(e))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),o=parseInt(t.max,10);return(!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=o)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let o=0;return e.forEach(r=>o+=parseFloat(r.value)||0),o===a}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((a,e)=>t[e]>a)}}function Yt(n){if(!n||!n.characters||!n["wish-counter-character-event"])return console.error("Imported data is missing key Paimon.moe properties."),null;console.log("Paimon.moe data format detected. Running adapter...");const t=n["wish-counter-character-event"]?.pulls||[],a=n["wish-counter-weapon-event"]?.pulls||[],e=Z(t,"character"),o=Z(a,"weapon"),r=[{banner:"character",...e,caprad:"0",epPath:"0"},{banner:"weapon",...o,caprad:"0",epPath:"0"}],l=jt(n.characters);return{pity:r,constellation:l}}function Z(n,t){let a=0,e=0,o=!1,r=!1,l=!1,s=!1;const h=p=>st.has(p)?{type:"character",rarity:4}:Lt.has(p)?{type:"weapon",rarity:4}:kt.has(p)?{type:"weapon",rarity:3}:lt.has(p)?{type:"character",rarity:5,standard:!0}:Rt.has(p)?{type:"weapon",rarity:5,standard:!0}:{type:"unknown",rarity:5,standard:!1};for(let p=n.length-1;p>=0;p--){const u=n[p],m=h(u.id);m.rarity===5?l||(o=u.rate===0,l=!0):l||a++,m.rarity===4?s||(t==="character"&&(r=m.type==="weapon"),s=!0):s||e++}return{pity4:String(e),pity5:String(a),guarantee4:r,guarantee5:o}}function jt(n){const t=new Array(Object.keys(N).length).fill(0),a=new Array(Object.keys(N).length).fill(0);let e=0,o=0;for(const p in n){let u=0;if(st.has(p)?u=4:lt.has(p)&&(u=5),u===0)continue;const m=n[p],i=(m.default||0)+(m.wish||0)+(m.manual||0);if(i>0){u===4?e++:u===5&&o++;const c=Math.min(i-1,6),f=N[`c${c}`];f!==void 0&&(u===4?t[f]++:u===5&&a[f]++)}}const r=W.poolCharSR,l=W.poolStandardCharSSR,s=r-e,h=l-o;return t[0]=Math.max(0,s),a[0]=Math.max(0,h),{0:a.map(String),1:t.map(String)}}function zt(n){const{cashbackCalculator:t,uiUpdater:a}=n;return function(o){const{results:r,inputConfig:l,chartLabels:s,gachaConfig:h}=o,p=parseInt(document.querySelector('[data-control="pulls"]').value),u=Math.min(p,r.SSR.length-1),m=t(l,h,r.SSR[u],r.CharSR[u],r.WepSR[u],l.SR.rateUps);a(r,s,u,m)}}function Gt(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",a=>{if(!a.target.matches(".tab-link[data-tab-target]"))return;const e=a.target,o=e.closest(".tab-panel-card"),r=e.dataset.tabTarget,l=o.querySelector(r);if(!l){console.error(`Tab target not found: ${r}`);return}o.querySelectorAll(".tab-link").forEach(s=>s.classList.remove("active")),o.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),e.classList.add("active"),l.classList.add("active")})})}class Vt{constructor(t){this.parts=t,this.persistence=$t("genshin");const a=zt({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn}),e={calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},postCalculationHooks:[a]};this.validator=new Ht(this.parts.CONSTELLATION_MAP),this.calculationHandler=It(e,this.persistence),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn")}initialize(){this.validator.initialize(),qt(this.persistence,this.parts.gachaConfig,this.validator),Gt(),V(),this.#t(),this.#a()}#t(){if(!this.calculateBtn){console.error("Calculate button not found!");return}this.calculateBtn.addEventListener("click",()=>{this.#e()&&this.calculationHandler()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>Bt(this.persistence)),V(this.persistence,Yt,this.validator)}#e(){if(document.querySelectorAll(".is-invalid").forEach(o=>o.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll();const t=document.querySelectorAll(".is-invalid"),a=new Set;t.forEach(o=>{const r=o.closest(".tab-pane");if(r){const l=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);l&&a.add(l)}o.classList.add("flicker"),o.addEventListener("animationend",()=>o.classList.remove("flicker"),{once:!0})}),a.forEach(o=>{o.classList.add("is-invalid","flicker"),o.addEventListener("animationend",()=>o.classList.remove("flicker"),{once:!0})});const e=Array.from(a)[0];return e&&e.click(),setTimeout(()=>{t[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const t=this.persistence.loadCalculation(),a=t?t.input:null;t?(K(this.parts.gachaConfig.paths,a),J(t),X(t.persistInput)):(K(this.parts.gachaConfig.paths),J(),X()),this.calculationHandler()}}class B{constructor(t,a,e){this.states=t,this.rankUps=a,this.totalSum=e}}function Kt(n,t){if(!Array.isArray(n.SSR.pullPlan))throw new Error("Invalid pull plan");if(!(Number.isInteger(n.SSR.special.capRad)&&n.SSR.special.capRad>=0&&n.SSR.special.capRad<=3))throw new Error("Invalid Capturing Radiance Value");if(!Array.isArray(t))throw new Error("Invalid pity data");const a={CHARACTER:0},e={CHARACTER:{DEFAULT:181,GUARANTEE:91},WEAPON:232,FINAL:1},o={LAST:3,MAX:4},{pullPlan:r}=n.SSR,{capRad:l}=n.SSR.special;let s=0;const h=[];for(const[f,y]of r.entries()){const d=y===a.CHARACTER;h.push([]),d?(p(f,s),s++):u(f,s)}return m(),i(t,l),{distributionSSR:h};function p(f,y){for(let d=0;d<=y;d++){const g=[];for(let C=0;C<o.MAX;C++){const S=C!==o.LAST?e.CHARACTER.DEFAULT:e.CHARACTER.GUARANTEE,b=C<o.LAST?[0,0,0]:[0];g.push(c(S,b))}h[f].push(g)}}function u(f,y){for(let d=0;d<=y;d++){const g=[];for(let C=0;C<o.MAX;C++)g.push(c(e.WEAPON,[0,0]));h[f].push(g)}}function m(){const f=Array.from({length:s+1},()=>Array(o.MAX).fill().map(()=>c(e.FINAL)));h.push(f)}function i(f,y){const d=h[0][0][y];d.states[f[0]]=1,d.totalSum=1}function c(f,y){return new B(Array(f).fill(0),y,0)}}function Jt(n){let e=!1,o=!1,r=0,l=0;const s=[];r+=n.SSR.pity.char,r+=n.SSR.guarantee.char*90,l+=n.SSR.pity.wep,l+=n.SSR.special.epitPath===0?n.SSR.guarantee.wep*77:2*77;for(const h of n.SSR.pullPlan)h==0&&!e?(e=!0,s.push(r)):h==1&&!o?(o=!0,s.push(l)):s.push(0);return s.push(0),s}function Xt(n){let t=[[new B(Array(21).fill(0),[0,0],1)]],a=[[new B(Array(21).fill(0),[0,0],1)]];const e=n.SR.guarantee.char*10+n.SR.pity.char,o=n.SR.guarantee.wep*10+n.SR.pity.wep;return t[0][0].states[e]=1,a[0][0].states[o]=1,{distributionCharSR:t,distributionWepSR:a}}function U(n){const t=[];for(let a=0;a<n.length;a++){const e=n[a],o=[];for(let r=0;r<e.length;r++){const l=e[r];let s=0,h=0,p;const u=Array.isArray(l)?l:[l];for(let m=0;m<u.length;m++)if(p=u[m].states.length,u[m].totalSum>1e-8){if(p===181)for(let i=90;i<181;i++)h+=u[m].states[i];else if(p===232)for(let i=154;i<232;i++)h+=u[m].states[i];else if(p===21)for(let i=10;i<21;i++)h+=u[m].states[i];s+=u[m].totalSum}o.push({lostSum:h}),o[r].totalSum=s}t.push(o)}return t}function H(n,t){if(!Number.isInteger(n)||n<0)throw new Error("Number of trials (n) must be a non-negative integer.");if(typeof t!="number"||t<0||t>1)throw new Error("Probability of success (probability) must be a number between 0 and 1 inclusive.");let a=0,e=0,o=[],r=1;for(;a<=n;)e=r*Math.pow(t,a)*Math.pow(1-t,n-a),o.push(e),a++,r=r*(n+1-a)/a;return o}function Zt(n){return n.map(t=>t.reduce((a,e)=>a+e,0))}function Qt(n,t){let a=[],e=n.length,o=new Array(e).fill(0);o[0]+=n[0];for(let r=1;r<e;r++){a=H(r,1/t);for(let l=0;l<a.length;l++)o[l]+=a[l]*n[r]}return o}const k=1e-8;function te(n,t,a,e,o,r){if(!Array.isArray(e)||!Array.isArray(o))throw new Error("All input parameters except currentPull must be arrays.");const{charPullsSum:l,wepPullsSum:s}=u(n,o);r.char.pullsSum=l,r.wep.pullsSum=s;for(let c=0;c<n.length-1;c++){const f=o[c]===0,y=n[c].length-1;for(let d=0;d<=y;d++)for(let g=0;g<4;g++){const C=n[c][d][g],S=f?t:a;C.totalSum>k&&(n[c][d][g].states=ut(S,C.states,C.rankUps,g))}}const{charRankUps:h,wepRankUps:p}=i(n,o);r.char.rankUps=h,r.wep.rankUps=p;for(let c=0;c<n.length-1;c++){const f=n[c].length-1,y=o[c]===0;for(let d=0;d<=f;d++){const g=e[c+1];for(let C=0;C<4;C++)m(n,c,d,C,y,g)}}function u(c,f){const y=[0,0];for(let g=0;g<c.length-1;g++){const C=f[g]===0?0:1;for(let S of c[g])for(let b of S)if(b.totalSum>k)for(let v of b.states)v>1&&(v=1),y[C]+=v}const d=1/(y[0]+y[1]);return y[0]*=d,y[1]*=d,{charPullsSum:y[0],wepPullsSum:y[1]}}function m(c,f,y,d,g,C){if(g){if(c[f][y][d].rankUps[0]>k){c[f][y][d].rankUps[0];const S=Math.floor(d/2);c[f+1][y][S].states[C]+=c[f][y][d].rankUps[0],c[f+1][y][S].totalSum+=c[f][y][d].rankUps[0],c[f][y][d].totalSum-=c[f][y][d].rankUps[0]}d!==3&&c[f][y][d].rankUps[1]>k&&(c[f+1][y+1][d+1].states[C]+=c[f][y][d].rankUps[1],c[f+1][y+1][d+1].totalSum+=c[f][y][d].rankUps[1],c[f][y][d].totalSum-=c[f][y][d].rankUps[1])}else c[f][y][d].rankUps[0]>k&&(c[f+1][y][d].states[C]+=c[f][y][d].rankUps[0],c[f+1][y][d].totalSum+=c[f][y][d].rankUps[0],c[f][y][d].totalSum-=c[f][y][d].rankUps[0]);c[f][y][d].rankUps[0]=0,c[f][y][d].rankUps[1]=0}function i(c,f){const y=[0,0];for(let d=0;d<c.length-1;d++){const g=f[d]===0?0:1;for(let C of c[d])for(let S of C){for(let b of S.rankUps)y[g]+=b;S.rankUps[2]=0}}return{charRankUps:y[0],wepRankUps:y[1]}}}function Q(n,t,a){let e=!1;for(let r=0;r<t.length;r++){const l=r===t.length-1,s=t[r].length-1;for(let h=0;h<=s;h++){const p=t[r][h];if(p.totalSum>k&&(t[r][h].states=ut(a,p.states,p.rankUps,0,n),l))for(let u of p.rankUps)u>k&&(e=!0)}}if(e){let r=[];for(let l=0;l<=t.length;l++)r.push(new B(Array(21).fill(0),[0,0],0));t.push(r)}for(let r=0;r<t.length-1;r++){const l=t[r].length-1;for(let s=0;s<=l;s++)t[r+1][s].states[0]+=t[r][s].rankUps[0],t[r+1][s].totalSum+=t[r][s].rankUps[0],t[r][s].totalSum-=t[r][s].rankUps[0],t[r][s].rankUps[0]=0,t[r+1][s+1].states[0]+=t[r][s].rankUps[1],t[r+1][s+1].totalSum+=t[r][s].rankUps[1],t[r][s].totalSum-=t[r][s].rankUps[1],t[r][s].rankUps[1]=0}const o=t[t.length-1].length-1;for(let r=0;r<=o;r++)t[t.length-1][r].rankUps[0]=0,t[t.length-1][r].rankUps[1]=0}function ut(n,t,a,e,o){const r=t.length,l=r===232,s=r===181,h=r===91,p=r===21,u=Array(r).fill(0);if(s||p){const m=o!==void 0?o.pullsSum:1,i=o!==void 0?o.rankUps:0,c=p?10:90,f=e===2?.45:.5,y=e===2?.55:.5;for(let d=1;d<r;d++)if(d===c||d===c*2)for(let g=0;g<d;g++){const C=g<c?d===c?f:y:1;if(u[d]+=n[g%c]*t[g]*(m-i)*C,s&&d===c&&(a[2]+=n[g%c]*t[g]*(m-i)*C),g===9||g===19?u[g]+=t[g]*(1-(m-i))*C:(u[g+1]+=n[g%c]*t[g]*i*C,u[g]+=t[g]*(1-m)*C),d==c*2&&(g===c-1||g===c*2-1)){const S=g===c*2-1?1:0;a[S]=u[d],u[d]=0}}else u[d]+=(1-n[d%c-1])*t[d-1]*m}else if(l)for(let i=1;i<r;i++){if(i===77*2||i===77*3){const c=i===154?.625:.375;for(let f=0;f<i;f++){const y=f<77?c:f<154?.5:1;u[i]+=n[f%77]*t[f]*y}}else i!==77&&(u[i]+=(1-n[i%77-1])*t[i-1]);i===77*2&&(a[1]=u[i]),i===77*3&&(a[0]=u[i],u[i]=0)}else if(h){let m=90;for(let i=1;i<r;i++){if(i===m)for(let c=0;c<i;c++)u[i]+=n[c%m]*t[c];else u[i]+=(1-n[i%m-1])*t[i-1];i===r-1&&(a[0]=u[i],u[i]=0)}}else throw new Error("Incorrect size for distribution SSR");return u}function ee(n){const t=Jt(n);let a={char:{},wep:{}};const{distributionSSR:e}=Kt(n,t),{distributionCharSR:o,distributionWepSR:r}=Xt(n);let l=[],s=[],h=[],p=0;for(;p<.999;){te(e,rt,ot,t,n.SSR.pullPlan,a),Q(a.char,o,M),Q(a.wep,r,M);let c=0;for(let f of e[e.length-1])for(let y of f)c+=y.totalSum;p=c,l.push(U(e)),s.push(U(r)),h.push(U(o))}const u=U(o);let m=Zt(u);return m=Qt(m,W.rateUpCharacterSR),{SSR:l,WepSR:s,CharSR:h}}function ae(n,t){if(t<0||t>n)return 0;if(t===0||t===n)return 1;t=Math.min(t,n-t);let a=1;for(let e=1;e<=t;e++)a*=(n-t+e)/e;return a}function ne(n,t){for(const a of n){const e=pt(a.rateUps);if(!re(e,t)){a.probability=0;continue}const o=ft(e,t),r=oe(n,t);a.probability=r===0?0:o/r}}function pt(n){const t={};for(let a=0;a<n.length;a++){const e=n[a];e>0&&(t[a]=e)}return t}function re(n,t){return Object.entries(n).every(([a,e])=>t[a]>=e)}function ft(n,t){return Object.entries(n).reduce((a,[e,o])=>a*ae(t[e],o),1)}function oe(n,t){return n.reduce((a,e)=>{const o=pt(e.rateUps),r=ft(o,t);return a+r},0)}function le(n){const t=se(n.points,n.probabilities);return{p10:tt(t,.1),p90:tt(t,.9)}}function se(n,t){let a=0;return n.map((e,o)=>({value:e,probability:t[o]})).sort((e,o)=>e.value-o.value).map(e=>(a+=e.probability,{value:e.value,cumulativeProbability:a}))}function tt(n,t){if(n.length===0)return 0;if(t<=0)return n[0].value;if(t>=1)return n[n.length-1].value;for(let a=0;a<n.length;a++)if(n[a].cumulativeProbability>=t)return ce(n,a,t);return n[n.length-1].value}function ce(n,t,a){if(t===0)return n[0].value;const e=n[t-1],o=n[t],r=o.cumulativeProbability-e.cumulativeProbability,l=(a-e.cumulativeProbability)/r;return e.value+l*(o.value-e.value)}class j{constructor(t,a,e){this.rateUps=t,this.offRates=a,this.probability=e}}class P{constructor(t,a,e){this.mean=t,this.p10=a,this.p90=e}}function ie(n,t,a){const e=[],o=new Array(a).fill(0);function r(l,s){if(l===a){if(s===t){const p=ht(o,n);e.push(new j([...o],p))}return}const h=Math.min(n[l],t-s);for(let p=0;p<=h;p++)o[l]=p,r(l+1,s+p),o[l]=0}return r(0,0),e}function ht(n,t){const a=[...t];for(let e=0;e<n.length;e++)a[e]-=n[e];return a}function ue(n,t,a){const e=n.length,o=a.reduce((p,u)=>p+u,0),r=t-o;if(r<0)return console.error("Error: More items are known than the total required."),[];const l=new Array(e);for(let p=0;p<e;p++)if(l[p]=n[p]-a[p],l[p]<0)return console.error(`Error: Known picks for constellation ${p} exceed its capacity.`),[];return ie(l,r,e).map(p=>{const u=p.rateUps.map((i,c)=>i+a[c]),m=ht(u,n);return new j(u,m)})}function pe(n,t,a){const e=t.map((l,s)=>l-a[s]),o=new Map;for(const l of n){const s=l.rateUps.map((p,u)=>p-a[u]);if(s.some(p=>p<0)){l.probability=0;continue}const h=new j(s,[]);o.set(h,l)}const r=Array.from(o.keys());r.length>0&&ne(r,e);for(const[l,s]of o.entries())s.probability=l.probability}class fe{constructor(t={}){this.maxType=t.maxType??7,this.regularPoints=t.regularPoints??2,this.specialPoints=t.specialPoints??5}}class he{constructor(t,a,e){this.expected=[...t],this.totalItems=a,this.config=e,this.mean=0,this.variance=0}computeStep(){let t=0;const a=new Array(this.expected.length).fill(0),{maxType:e,regularPoints:o,specialPoints:r}=this.config;this.expected.forEach((l,s)=>{const h=l/this.totalItems;s>=1&&s<e&&(t+=o*h),s===e&&(t+=r*h)}),a[0]=this.expected[0]*(this.totalItems-1)/this.totalItems;for(let l=1;l<e;l++)a[l]=this.expected[l]*(this.totalItems-1)/this.totalItems+this.expected[l-1]/this.totalItems;a[e]=this.expected[e]+this.expected[e-1]/this.totalItems,this.mean+=t,this.variance+=this.calculateVariance()-t**2,this.expected=a}calculateVariance(){const{regularPoints:t,specialPoints:a,maxType:e}=this.config;return(t**2*this.expected.slice(1,e).reduce((o,r)=>o+r,0)+a**2*this.expected[e])/this.totalItems}getPercentiles(){const t=Math.sqrt(this.variance);return{mean:this.mean,p10:this.mean-1.28*t,p90:this.mean+1.28*t}}}class de{constructor(t,a,e){this.states=new Map,this.totalItems=a,this.config=e,this.initializeState(Array.from(t))}initializeState(t){const a={counts:t,totalPoints:0};this.states.set(JSON.stringify(a),1)}computeStep(t=1e-8){const a=new Map;for(const[e,o]of this.states){const{counts:r,totalPoints:l}=JSON.parse(e);this.processState(r,l,o,a)}this.pruneStates(a,t)}processState(t,a,e,o){const r=t.reduce((l,s)=>l+s,0);t.forEach((l,s)=>{if(l===0)return;const h=e*(l/r),{newCounts:p,newTotalPoints:u}=this.calculateNewState(t,s,a);this.updateStateMap(o,p,u,h)})}calculateNewState(t,a,e){const{maxType:o,regularPoints:r,specialPoints:l}=this.config,s=a===0?0:a<o?r:l,h=[...t];return a<o&&(h[a]--,h[a+1]++),{newCounts:h,newTotalPoints:e+s}}updateStateMap(t,a,e,o){const r=JSON.stringify({counts:a,totalPoints:e});t.set(r,(t.get(r)||0)+o)}pruneStates(t,a){let e=0;const o=new Map;for(const[r,l]of t)l>=a&&(o.set(r,l),e+=l);if(e>0)for(const[r,l]of o)o.set(r,l/e);this.states=o}getDistribution(){const t=new Map;for(const[o,r]of this.states){const{totalPoints:l}=JSON.parse(o);t.set(l,(t.get(l)||0)+r)}const a=Array.from(t.keys()).sort((o,r)=>o-r),e=a.map(o=>t.get(o));return{points:a,probabilities:e}}}class D{constructor(t,a,e,o=20){this.initialState=Array.from(t),this.totalItems=a,this.config=new fe(e),this.dpThreshold=o}solve(t,a=1e-8){return t<this.dpThreshold?this.solveWithDP(t,a):this.solveWithIterative(t)}solveWithDP(t,a){const e=new de(this.initialState,this.totalItems,this.config);for(let s=0;s<t;s++)e.computeStep(a);const o=e.getDistribution(),r=this.calculateMean(o),l=le(o);return{mean:r,...l}}solveWithIterative(t){const a=new he(this.initialState,this.totalItems,this.config);for(let e=0;e<t;e++)a.computeStep();return{...a.getPercentiles()}}calculateMean(t){return t.points.reduce((a,e,o)=>a+e*t.probabilities[o],0)}}const _=["mean","p10","p90"],et=.5,at=1e-8,Y=20;function ye(n,t,a,e,o){const r=t[t.length-1].length,l=a[a.length-1].length;let s=new Array(r).fill(0),h=new Array(l).fill(0),p=new P(0,0,0),u=new P(0,0,0),m=new P(0,0,0),i=[],c=[],f=0;n.length===1?f=15:f=7;for(const S of t){let b=0;for(let v=0;v<S.length;v++)b+=S[v].totalSum,s[v]+=S[v].totalSum,v>=1&&(s[v]+=S[v-1].lostSum);i.push(b)}for(const S of n){let b=new P(0,0,0),v=new P(0,0,0),A=new P(0,0,0);const w=new D(S.rateUps,e.rateUpCharacterSR,e.configSR,Y);for(let E=0;E<i.length;E++)if(i[E]>at){let O=w.solve(E);_.forEach(L=>{v[L]+=O[L]*i[E]})}const R=new D(S.offRates,e.poolCharSR-e.rateUpCharacterSR,e.configSR,f);let q=[];for(let E=0;E<s.length;E++){q.push(R.solve(E));let O=H(E,et);for(let L=0;L<O.length;L++)_.forEach(z=>{A[z]+=q[L][z]*O[L]*s[E]})}_.forEach(E=>{b[E]=v[E]+A[E],p[E]+=b[E]*S.probability})}for(const S of a){let b=0;for(let v=0;v<S.length;v++)b+=S[v].totalSum,h[v]+=S[v].totalSum,v>=1&&(h[v]+=S[v-1].lostSum);c.push(b)}let y=new P(0,0,0),d=new P(0,0,0);for(let S=0;S<c.length;S++)if(c[S]>at){let b=S*e.configWep.pointsSR,v=new P(b,b,b);_.forEach(A=>{y[A]+=v[A]*c[S]})}const g=new D(o.SR.consCount,e.poolCharSR,e.configSR,Y);let C=[];for(let S=0;S<h.length;S++)if(h[S]>0){C.push(g.solve(S));let b=H(S,et);for(let v=0;v<b.length;v++){let A=(S-v)*e.configWep.pointsSR;_.forEach(w=>{d[w]+=(C[v][w]+A)*b[v]*h[S]})}}return _.forEach(S=>{u[S]=y[S]+d[S],m[S]=p[S]+u[S]}),m}function me(n,t,a,e,o){const r=new D(a,t,o.configSSR,Y),l=n[n.length-1][n[n.length-1].length]>0?n[n.length-1].length+1:n[n.length-1].length;let s=[],h=[],p=0;for(let u=0;u<l;u++)s.push(r.solve(u));for(let u=0;u<n.length;u++){u>0&&(e[u-1]==="none"?p+=0:e[u-1]==="regular"&&(p+=o.configSSR.regularPoints));let m=new P(0,0,0),i=0;for(let c=0;c<n[u].length;c++)i+=n[u][c].totalSum;if(i>0)for(let c=0;c<n[u].length;c++){const f=s[c];let y;c===0?y=n[u][c].totalSum/i:y=(n[u][c].totalSum+n[u][c-1].lostSum)/i,_.forEach(d=>{m[d]+=f[d]*y})}_.forEach(c=>{m[c]+=p}),h.push(m)}return h}function Se(n,t,a,e,o,r){let l=ue(n.SR.consCount,t.rateUpCharacterSR,r);pe(l,n.SR.consCount,r);let s=ye(l,e,o,t,n),h=me(a,t.poolStandardCharSSR,n.SSR.consCountStandard,n.SSR.cashbackRoadmap,t),p=[];for(const u of h){let m=new P(0,0,0);_.forEach(i=>{m[i]=u[i]+s[i]}),p.push(m)}return p}document.addEventListener("DOMContentLoaded",()=>{const n={gachaConfig:W,CONSTELLATION_MAP:N,runCalcFn:ee,cashbackFn:Se,updateTableFn:Nt};new Vt(n).initialize()});
