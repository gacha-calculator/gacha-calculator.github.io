import{p as V,q as j,I as w}from"./solvers-BhFii6kz.js";function pt(t){const{cashbackCalculator:r,uiUpdater:e}=t;return function(o){const{results:i,inputConfig:s,chartLabels:l,gachaConfig:p}=o,n=r(s,p,i.cashbackData.SSR,i.cashbackData.CharSR,i.cashbackData.WepSR,s.SR.rateUps);e(i.cashbackData.SSR,l,n)}}class mt{constructor(r,e={}){this.config=r,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...e}}async runGachaCalculation(r,e){this.adapters.contexts.contextSSR.target=e;let a=[],o={},i=!1,s=!1;const{ssrWorker:l,srWorker:p}=this.adapters.workerManager.getWorkers(),n=this.adapters.distributionArrays.sortPity(r);this.adapters.contexts.contextSSR.pities=n;let{distributionSSR:c}=this.adapters.distributionArrays.makeSSR(r,n),{distributionCharSR:f,distributionWepSR:h}=this.adapters.distributionArrays.makeSR(r);try{await z(l,p,this.adapters.contexts,c,{distributionCharSR:f,distributionWepSR:h},n)}catch(u){console.error("Failed to initialize workers:",u)}let m=await M(l);for(m.type==="IterationComplete"?o=m.lossData:(o=m.lossData,i=m.isTarget,s=m.isEmpty,a=m.allPullsDistributionSSR,c=m.distributionSSR);!s&&!i;)[m]=await Promise.all([M(l),F(p,o)]),m.type==="IterationComplete"?o=m.lossData:(o=m.lossData,i=m.isTarget,s=m.isEmpty,a=m.allPullsDistributionSSR,c=m.distributionSSR);let C=await N(p,o);this.adapters.workerManager.terminateWorkers(),f=C.distributionCharSR,h=C.distributionWepSR;const y={SSR:this.adapters.helpers.consolidateDistributionForCashback(c),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(h)};this.adapters.helpers.simplifyDistribution(c),f=null,h=null;let D=0;const B=10;for(;!s;)i&&(D++,this.adapters.pullLogic.rankUpSSRCheap(c,n),D===B&&this.adapters.helpers.normalizeCheap(c),a.push(this.adapters.helpers.consolidateProbabilitiesCheap(c)),s=this.adapters.helpers.checkIsEmpty(c,i));return{chartData:a,cashbackData:y};async function z(u,b,k,R,{distributionCharSR:d,distributionWepSR:H}){return new Promise((q,K)=>{let g=!1,v=!1,W=!1;function I(){!W&&g&&v&&q()}function O(S){W||(W=!0,K(S))}u.onerror=S=>{console.error("Worker error:",S),O(S)},b.onerror=S=>{O(S)},u.onmessage=function(S){switch(S.data.type){case"InitComplete":g=!0,I();break;default:console.warn("Unknown message type")}},b.onmessage=function(S){switch(S.data.type){case"InitComplete":v=!0,I();break;default:console.warn("Unknown message type")}},u.postMessage({type:"Initiate",distribution:R,context:k}),b.postMessage({type:"Initiate",distribution:{distributionCharSR:d,distributionWepSR:H},context:k})})}function M(u){return new Promise((b,k)=>{u.onmessage=R=>{switch(R.data.type){case"IterationComplete":b(R.data);break;case"LastIteration":b(R.data);break}},u.onerror=k,u.postMessage({type:"Iterate"})})}function F(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k()},u.onerror=R,u.postMessage({type:"Iterate",lossData:b})})}function N(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k(d.data)},u.onerror=R,u.postMessage({type:"IterateLast",lossData:b})})}}}function Y(t){return new Worker("/assets/ssr-worker-D4YCWSXa.js",{type:"module",name:t?.name})}function G(t){return new Worker("/assets/sr-worker-Bs6jCU2D.js",{type:"module",name:t?.name})}class ft{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new Y),this.srWorker||(this.srWorker=new G),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class U{constructor(r,e,a){this.rateUps=r,this.offRates=e,this.probability=a}}function $(t,r,e){const a=[],o=new Array(e).fill(0);function i(s,l){if(s===e){if(l===r){const n=P(o,t);a.push(new U([...o],n))}return}const p=Math.min(t[s],r-l);for(let n=0;n<=p;n++)o[s]=n,i(s+1,l+n),o[s]=0}return i(0,0),a}function P(t,r){const e=[...r];for(let a=0;a<t.length;a++)e[a]-=t[a];return e}function X(t,r,e){const a=t.length,o=e.reduce((n,c)=>n+c,0),i=r-o;if(i<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(a);for(let n=0;n<a;n++)if(s[n]=t[n]-e[n],s[n]<0)return console.error(`Error: Known picks for constellation ${n} exceed its capacity.`),[];return $(s,i,a).map(n=>{const c=n.rateUps.map((h,m)=>h+e[m]),f=P(c,t);return new U(c,f)})}function J(t,r,e){const a=r.map((s,l)=>s-e[l]),o=new Map;for(const s of t){const l=s.rateUps.map((n,c)=>n-e[c]);if(l.some(n=>n<0)){s.probability=0;continue}const p=new U(l,[]);o.set(p,s)}const i=Array.from(o.keys());i.length>0&&V(i,a);for(const[s,l]of o.entries())l.probability=s.probability}function A(t,r,e,a){return Array.from({length:t+1},(o,i)=>{const s=j(i,a);let l=0,p=0;for(let n=0;n<=i;n++){const c=i-n,f=r[n],h=c*e,m=f.mean+h,C=f.variance+Math.pow(m,2);l+=m*s[n],p+=C*s[n]}return{mean:l,variance:Math.max(0,p-Math.pow(l,2))}})}function Q(t,r,e,a){let o=r[t.rateUpCount],i=e[t.charOffRateCount],s=t.wepOffRateCount*a;return{mean:o+i.mean+s,variance:i.variance}}function Z(t){const e=Math.sqrt(t.variance),a=1/Math.sqrt(.2);let o=t.mean-e*a;o<0&&(o=0);const i=t.mean+e*a,s=t.mean;return{LOWER_BOUND:o,MEAN:s,UPPER_BOUND:i}}function tt(t,r){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[i,s]of t[o].offRates.entries()){const l=Math.floor(i/100);s.prob>r&&(e.push({rateUpCount:o,charOffRateCount:l,wepOffRateCount:i%100,probability:s.prob}),a=Math.max(a,l))}return{combos:e,maxOffRateCount:a}}function x(t,r){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[i,s]of t[o].offRates.entries())s.prob>r&&(e.push({rateUpCount:o,offRateCount:i,probability:s.prob}),a=Math.max(a,i));return{combos:e,maxOffRateCount:a}}function T(t,r,e){let a=0,o=0;for(const{rateUpCount:i,offRateCount:s,probability:l}of t){const p=r[i],n=e[s],c=p.mean+n.mean,f=p.variance+n.variance+Math.pow(c,2);a+=l*c,o+=l*f}return{mean:a,variance:Math.max(0,o-Math.pow(a,2))}}function _(t){let r=0,e=0;for(const{probability:a,cashback:o}of t)r+=a*o.mean;for(const{probability:a,cashback:o}of t){const i=o.variance+Math.pow(o.mean,2);e+=a*i}return{mean:r,variance:Math.max(0,e-Math.pow(r,2))}}function et(...t){return t.reduce((r,e)=>({mean:r.mean+e.mean,variance:r.variance+e.variance}),{mean:0,variance:0})}const L=.5,E=1e-8;function ut(t,r,e,a,o,i){e=at(e);const s=X(t.SR.consCount,r.rateUpCharacterSR,i);J(s,t.SR.consCount,i);const l=ot(e,r.poolStandardCharSSR,t.SSR.consCountStandard,t.SSR.cashbackRoadmap,r),p=rt(s,a,o,r,t),n=l;for(let c=0;c<n.length;c++)n[c].mean+=p.mean,n[c].variance+=p.variance,n[c]=Z(n[c]);return n}function at(t){let r=0;for(const e of t)for(const[a,o]of e.offRates)r+=o.prob;for(const e of t)for(const[a,o]of e.offRates)o.prob/=r;return t}function ot(t,r,e,a,o){const{combos:i,maxOffRateCount:s}=tt(t,E),l=[0];let p=0;for(let c=0;c<t.length;c++)a[c-1]==="none"?l.push(p):a[c-1]==="regular"&&(p+=o.configSSR.regularPoints,l.push(p));const n=Array.from({length:t.length},()=>[]);for(const c of i){const f=c.rateUpCount,h=c.probability,C=new w(e,r,o.configSSR).runSteps(s),y=Q(c,l,C,o.configWep.pointsSSR);n[f].push({cashback:y,probability:h})}for(let c=0;c<n.length;c++){const f=it(n[c]);n[c]=_(f)}return n}function rt(t,r,e,a,o){const{combos:i,maxOffRateCount:s}=x(r,E),{combos:l,maxOffRateCount:p}=x(e,E),n=nt(t,i,s,a),c=st(l,p,a,o);return et(n,c)}function nt(t,r,e,a){const o=Math.max(...r.map(s=>s.rateUpCount)),i=[];for(const{rateUps:s,offRates:l,probability:p}of t){const c=new w(s,a.rateUpCharacterSR,a.configSR).runSteps(o),h=new w(l,a.poolCharSR-a.rateUpCharacterSR,a.configSR).runSteps(e),m=A(e,h,a.configWep.pointsSR,L),C=T(r,c,m);i.push({probability:p,cashback:C})}return _(i)}function st(t,r,e,a){const o=Math.max(...t.map(c=>c.rateUpCount)),i=n(o,e.configWep.pointsSR),l=new w(a.SR.consCount,e.poolCharSR,e.configSR).runSteps(r),p=A(r,l,e.configWep.pointsSR,L);return T(t,i,p);function n(c,f){return Array.from({length:c+1},(h,m)=>({mean:m*f,variance:0}))}}function it(t){let r=0;for(const e of t)r+=e.probability;for(const e of t)e.probability/=r;return t}export{ft as W,ut as a,pt as c,mt as g};
