import{x as y}from"./recalc-inputs-Cj0vOeQu.js";class S{constructor({getPageConfiguration:t,getLabels:i,getPullPlan:e,getTarget:a,updateChart:s,convertToChartData:n,recalcInputs:r,calculatorFunction:o,calculatorConfig:c,pageConfig:p,postCalculationHooks:d,persistence:f,chibi:m}){this.getPageConfiguration=t,this.getLabels=i,this.getPullPlan=e,this.getTarget=a,this.updateChart=s,this.convertToChartData=n,this.recalcInputs=r,this.calculatorFunction=o,this.calculatorConfig=c,this.pageConfig=p,this.postCalculationHooks=d||[],this.persistence=f,this.chibi=m}async runCalculation(){const t=this.getTarget(),i=this.getPageConfiguration(this.calculatorConfig.CONSTELLATION_MAP,this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),e=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(e.length>99){this.chibi.showError("Too many items! Even I can't calculate so quickly, maximum 99 items allowed.");return}const a=await this.calculatorFunction(i,t),s=this.convertToChartData(a.chartData);this.updateChart(s.data,s.labels,e),this.recalcInputs(s.data);const n={results:a,inputConfig:i,chartLabels:e,gachaConfig:this.calculatorConfig.gachaConfig,CONSTELLATION_MAP:this.calculatorConfig.CONSTELLATION_MAP};this.postCalculationHooks.forEach(r=>r(n)),this.persistence&&this.saveData()}saveData(){const t=parseInt(document.querySelector('[data-control="pulls"]').value),i=parseInt(document.querySelector('[data-control="probability"]').value);let a=document.querySelector(".row").querySelector(".dropdown .dropdown__header .type-text"),s;a&&(a=a.textContent,s=a.trim().toLowerCase().replace(/\s+/g,"_"));const n={input:this.getPullPlan(),targetProb:i,targetPull:t,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")};this.persistence.saveCalculation(n,s),this.persistence.saveButtons(),this.persistence.savePageType(a)}}class T{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document.querySelectorAll('input[type="number"]');t.forEach(i=>{i.addEventListener("focus",()=>{i.select()}),i.addEventListener("keydown",e=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","Home","End"].includes(e.key)||(e.ctrlKey||e.metaKey)&&["a","c","v","x"].includes(e.key.toLowerCase())||/^\d$/.test(e.key)||e.preventDefault()}),i.addEventListener("paste",e=>{const a=(e.clipboardData||window.clipboardData).getData("text");/^\d+$/.test(a)||e.preventDefault()}),i.addEventListener("drop",e=>{e.preventDefault()})}),t.forEach(i=>{i.addEventListener("input",e=>{const s=e.target.closest("table");if(s)switch(s.id){case"constellation-table":{this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}})}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(i=>i.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(i=>this.validateRowSum(i)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(e=>{e.querySelectorAll('input[type="number"]').forEach((a,s)=>{t[s]+=parseInt(a.value,10)||0})}),this.availableConstellationCounts=t}validateRateUpEligibility(){const t=this.getRateUpUsage(),i=this.availableConstellationCounts.map((e,a)=>t[a]>e);document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const a=this.constellationMap[e.value];a!==void 0&&i[a]&&(e.value="unknown")})}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(i=>{const e=this.constellationMap[i.value];e!==void 0&&t[e]++}),t}validateRowSum(t){if(!t.dataset.targetSum)return;const i=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let a=0;if(e.forEach(s=>a+=parseFloat(s.value)||0),i!=a){let s=i-a;const n=parseFloat(e[0].value)||0;if(s>0)e[0].value=n+s;else for(let r=e.length-1;r>=0;r--){s=Math.abs(s);let o=parseFloat(e[r].value);if(o>s){e[r].value=o-s;break}else e[r].value=0,s=s-o}}}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const e of t)if(!this.isIndividualInputValid(e))return!1;const i=document.querySelectorAll("#constellation-table tbody tr");for(const e of i)this.validateRowSum(e),y(e);return this.validateRateUpEligibility(),!0}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const i=parseInt(t.value,10),e=parseInt(t.min,10),a=parseInt(t.max,10);return(!t.hasAttribute("min")||i>=e)&&(!t.hasAttribute("max")||i<=a)}return!1}}function A(l,t){for(const i of l){const e=u(i.rateUps);if(!b(e,t)){i.probability=0;continue}const a=h(e,t),s=g(l,t);i.probability=s===0?0:a/s}}function u(l){const t={};for(let i=0;i<l.length;i++){const e=l[i];e>0&&(t[i]=e)}return t}function b(l,t){return Object.entries(l).every(([i,e])=>t[i]>=e)}function h(l,t){return Object.entries(l).reduce((i,[e,a])=>i*v(t[e],a),1)}function g(l,t){return l.reduce((i,e)=>{const a=u(e.rateUps),s=h(a,t);return i+s},0)}function v(l,t){if(t<0||t>l)return 0;if(t===0||t===l)return 1;t=Math.min(t,l-t);let i=1;for(let e=1;e<=t;e++)i*=(l-t+e)/e;return i}function w(l,t){if(!Number.isInteger(l)||l<0)throw new Error("Number of trials (n) must be a non-negative integer.");let i=0,e=0,a=[],s=1;for(;i<=l;)e=s*Math.pow(t,i)*Math.pow(1-t,l-i),a.push(e),i++,s=s*(l+1-i)/i;return a}class x{constructor(t,i,e){this.initialState=[...t],this.totalItems=i,this.config=e,this.maxType=e.maxType,this.nTypes=t.length,this.points=Array(this.nTypes).fill(0);for(let a=1;a<this.maxType;a++)this.points[a]=e.regularPoints;this.points[this.maxType]=e.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let t=0;t<this.nTypes;t++)for(let i=0;i<this.nTypes;i++)this.stateSecondMoments[t][i]=this.initialState[t]*this.initialState[i];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const t=this.totalItems;this.step++;let i=0,e=0;for(let o=0;o<this.nTypes;o++){const c=this.expected[o]/t;i+=this.points[o]*c,e+=this.points[o]**2*c}let a=0;for(let o=0;o<this.nTypes;o++)a+=this.points[o]*this.pointStateCrossMoments[o];a/=t;const s=this.secondMoment+2*a+e,n=this.mean+i,r=s-n**2;return this.results.push({mean:n,variance:r}),this.updateState(),this.secondMoment=s,this.mean=n,this.variance=r,{mean:n,variance:r,step:this.step}}updateState(){const t=this.totalItems,i=Array(this.nTypes).fill(0);for(let s=0;s<this.maxType;s++)i[s]=this.expected[s]*(t-1)/t;i[this.maxType]=this.expected[this.maxType];for(let s=0;s<this.maxType;s++)i[s+1]+=this.expected[s]/t;const e=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let s=0;s<this.nTypes;s++)for(let n=0;n<this.nTypes;n++)e[s][n]=this.stateSecondMoments[s][n];for(let s=0;s<this.maxType;s++){const n=Array(this.nTypes).fill(0);n[s]=-1,n[s+1]=1;for(let r=0;r<this.nTypes;r++)for(let o=0;o<this.nTypes;o++)e[r][o]+=1/t*(n[r]*this.stateSecondMoments[s][o]+n[o]*this.stateSecondMoments[r][s]+n[r]*n[o]*this.expected[s])}const a=Array(this.nTypes).fill(0);for(let s=0;s<this.nTypes;s++){let n=this.pointStateCrossMoments[s];s<this.maxType&&(n-=this.pointStateCrossMoments[s]/t),s>=1&&(n+=this.pointStateCrossMoments[s-1]/t);let r=0;for(let o=0;o<this.nTypes;o++)r+=this.points[o]*this.stateSecondMoments[s][o];n+=r/t,s<this.maxType&&(n-=this.points[s]*this.expected[s]/t),s>=1&&(n+=this.points[s-1]*this.expected[s-1]/t),a[s]=n}this.expected=i,this.stateSecondMoments=e,this.pointStateCrossMoments=a}runSteps(t){this.reset();for(let i=0;i<t;i++)this.computeStep();return this.results}}export{S as C,T as D,x as I,w as b,A as c};
