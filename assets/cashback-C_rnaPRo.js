import{q as j,t as G,I as w}from"./solvers-gGrm_kck.js";function ut(t){const{cashbackCalculator:r,uiUpdater:e}=t;return function(o){const{results:n,inputConfig:i,chartLabels:l,gachaConfig:p,CONSTELLATION_MAP:s}=o,c=r(i,p,n.cashbackData.SSR,n.cashbackData.CharSR,n.cashbackData.WepSR,i.SR.rateUps,s);e(n.cashbackData.SSR,l,c)}}class mt{constructor(r,e={}){this.config=r,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...e}}async runGachaCalculation(r,e){this.adapters.contexts.contextSSR.target=e;let a=[],o={},n=!1,i=!1;const{ssrWorker:l,srWorker:p}=this.adapters.workerManager.getWorkers(),s=this.adapters.distributionArrays.sortPity(r);this.adapters.contexts.contextSSR.pities=s;let{distributionSSR:c}=this.adapters.distributionArrays.makeSSR(r,s),{distributionCharSR:f,distributionWepSR:b}=this.adapters.distributionArrays.makeSR(r);try{await z(l,p,this.adapters.contexts,c,{distributionCharSR:f,distributionWepSR:b},s)}catch(m){console.error("Failed to initialize workers:",m)}let u=await D(l);for(u.type==="IterationComplete"?o=u.lossData:(o=u.lossData,n=u.isTarget,i=u.isEmpty,a=u.allPullsDistributionSSR,c=u.distributionSSR);!i&&!n;)K(o),[u]=await Promise.all([D(l),F(p,o)]),u.type==="IterationComplete"?o=u.lossData:(o=u.lossData,n=u.isTarget,i=u.isEmpty,a=u.allPullsDistributionSSR,c=u.distributionSSR);let C=await H(p,o);this.adapters.workerManager.terminateWorkers(),f=C.distributionCharSR,b=C.distributionWepSR;const y={SSR:this.adapters.helpers.consolidateDistributionForCashback(c),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(b)};this.adapters.helpers.simplifyDistribution(c),f=null,b=null;let M=0;const N=10;for(;!i;)n&&(M++,this.adapters.pullLogic.rankUpSSRCheap(c,s),M===N&&this.adapters.helpers.normalizeCheap(c),a.push(this.adapters.helpers.consolidateProbabilitiesCheap(c)),i=this.adapters.helpers.checkIsEmpty(c,n));return{chartData:a,cashbackData:y};async function z(m,h,k,R,{distributionCharSR:d,distributionWepSR:B}){return new Promise((V,q)=>{let I=!1,O=!1,W=!1;function v(){!W&&I&&O&&V()}function g(S){W||(W=!0,q(S))}m.onerror=S=>{console.error("Worker error:",S),g(S)},h.onerror=S=>{g(S)},m.onmessage=function(S){switch(S.data.type){case"InitComplete":I=!0,v();break;default:console.warn("Unknown message type")}},h.onmessage=function(S){switch(S.data.type){case"InitComplete":O=!0,v();break;default:console.warn("Unknown message type")}},m.postMessage({type:"Initiate",distribution:R,context:k}),h.postMessage({type:"Initiate",distribution:{distributionCharSR:d,distributionWepSR:B},context:k})})}function D(m){return new Promise((h,k)=>{m.onmessage=R=>{switch(R.data.type){case"IterationComplete":h(R.data);break;case"LastIteration":h(R.data);break}},m.onerror=k,m.postMessage({type:"Iterate"})})}function F(m,h){return new Promise((k,R)=>{m.onmessage=d=>{k()},m.onerror=R,m.postMessage({type:"Iterate",lossData:h})})}function H(m,h){return new Promise((k,R)=>{m.onmessage=d=>{k(d.data)},m.onerror=R,m.postMessage({type:"IterateLast",lossData:h})})}function K(m){const h=m.charRankUps.pullsSum+m.wepRankUps.pullsSum;Math.abs(h-1)>1e-5&&(m.charRankUps.pullsSum/=h,m.charRankUps.rankUps/=h,m.wepRankUps.pullsSum/=h,m.wepRankUps.rankUps/=h)}}}function Y(t){return new Worker("/assets/ssr-worker-C_SG_wKf.js",{type:"module",name:t?.name})}function $(t){return new Worker("/assets/sr-worker-CXkWv8LU.js",{type:"module",name:t?.name})}class ht{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new Y),this.srWorker||(this.srWorker=new $),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class E{constructor(r,e,a){this.rateUps=r,this.offRates=e,this.probability=a}}function Z(t,r,e){const a=[],o=new Array(e).fill(0);function n(i,l){if(i===e){if(l===r){const s=A(o,t);a.push(new E([...o],s))}return}const p=Math.min(t[i],r-l);for(let s=0;s<=p;s++)o[i]=s,n(i+1,l+s),o[i]=0}return n(0,0),a}function A(t,r){const e=[...r];for(let a=0;a<t.length;a++)e[a]-=t[a];return e}function X(t,r,e){const a=new Array(Object.keys(e).length).fill(0);for(const o of r)if(o==="new")t[0]++,a[0]++;else{const n=e[o];n!==void 0?a[n]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return a}function J(t,r,e){const a=t.length,o=e.reduce((s,c)=>s+c,0),n=r-o;if(n<0)return console.error("Error: More items are known than the total required."),[];const i=new Array(a);for(let s=0;s<a;s++)if(i[s]=t[s]-e[s],i[s]<0)return console.error(`Error: Known picks for constellation ${s} exceed its capacity.`),[];return Z(i,n,a).map(s=>{const c=s.rateUps.map((b,u)=>b+e[u]),f=A(c,t);return new E(c,f)})}function Q(t,r,e){const a=r.map((i,l)=>i-e[l]),o=new Map;for(const i of t){const l=i.rateUps.map((s,c)=>s-e[c]);if(l.some(s=>s<0)){i.probability=0;continue}const p=new E(l,[]);o.set(p,i)}const n=Array.from(o.keys());n.length>0&&j(n,a);for(const[i,l]of o.entries())l.probability=i.probability}function P(t,r,e,a){return Array.from({length:t+1},(o,n)=>{const i=G(n,a);let l=0,p=0;for(let s=0;s<=n;s++){const c=n-s,f=r[s],b=c*e,u=f.mean+b,C=f.variance+Math.pow(u,2);l+=u*i[s],p+=C*i[s]}return{mean:l,variance:Math.max(0,p-Math.pow(l,2))}})}function tt(t,r,e,a){let o=r[t.rateUpCount],n=e[t.charOffRateCount],i=t.wepOffRateCount*a;return{mean:o+n.mean+i,variance:n.variance}}function et(t){const e=Math.sqrt(t.variance),a=1/Math.sqrt(.2);let o=t.mean-e*a;o<0&&(o=0);const n=t.mean+e*a,i=t.mean;return{LOWER_BOUND:o,MEAN:i,UPPER_BOUND:n}}function at(t,r){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[n,i]of t[o].offRates.entries()){const l=Math.floor(n/100);i.prob>r&&(e.push({rateUpCount:o,charOffRateCount:l,wepOffRateCount:n%100,probability:i.prob}),a=Math.max(a,l))}return{combos:e,maxOffRateCount:a}}function x(t,r){const e=[];let a=0;for(let o=0;o<t.length;o++)for(const[n,i]of t[o].offRates.entries())i.prob>r&&(e.push({rateUpCount:o,offRateCount:n,probability:i.prob}),a=Math.max(a,n));return{combos:e,maxOffRateCount:a}}function T(t,r,e){let a=0,o=0;for(const{rateUpCount:n,offRateCount:i,probability:l}of t){const p=r[n],s=e[i],c=p.mean+s.mean,f=p.variance+s.variance+Math.pow(c,2);a+=l*c,o+=l*f}return{mean:a,variance:Math.max(0,o-Math.pow(a,2))}}function _(t){let r=0,e=0;for(const{probability:a,cashback:o}of t)r+=a*o.mean;for(const{probability:a,cashback:o}of t){const n=o.variance+Math.pow(o.mean,2);e+=a*n}return{mean:r,variance:Math.max(0,e-Math.pow(r,2))}}function ot(...t){return t.reduce((r,e)=>({mean:r.mean+e.mean,variance:r.variance+e.variance}),{mean:0,variance:0})}const L=.5,U=1e-8;function bt(t,r,e,a,o,n,i){e=rt(e),n=X(t.SR.consCount,n,i);const l=J(t.SR.consCount,r.rateUpCharacterSR,n);Q(l,t.SR.consCount,n);const p=nt(e,r.poolStandardCharSSR,t.SSR.consCountStandard,t.SSR.cashbackRoadmap,r),s=st(l,a,o,r,t),c=p;for(let f=0;f<c.length;f++)c[f].mean+=s.mean,c[f].variance+=s.variance,c[f]=et(c[f]);return c}function rt(t){let r=0;for(const e of t)for(const[a,o]of e.offRates)r+=o.prob;for(const e of t)for(const[a,o]of e.offRates)o.prob/=r;return t}function nt(t,r,e,a,o){const{combos:n,maxOffRateCount:i}=at(t,U),l=[0];let p=0;for(let c=0;c<t.length;c++)a[c-1]==="none"?l.push(p):a[c-1]==="regular"&&(p+=o.configSSR.regularPoints,l.push(p));const s=Array.from({length:t.length},()=>[]);for(const c of n){const f=c.rateUpCount,b=c.probability,C=new w(e,r,o.configSSR).runSteps(i),y=tt(c,l,C,o.configWep.pointsSSR);s[f].push({cashback:y,probability:b})}for(let c=0;c<s.length;c++){const f=lt(s[c]);s[c]=_(f)}return s}function st(t,r,e,a,o){const{combos:n,maxOffRateCount:i}=x(r,U),{combos:l,maxOffRateCount:p}=x(e,U),s=it(t,n,i,a),c=ct(l,p,a,o);return ot(s,c)}function it(t,r,e,a){const o=Math.max(...r.map(i=>i.rateUpCount)),n=[];for(const{rateUps:i,offRates:l,probability:p}of t){const c=new w(i,a.rateUpCharacterSR,a.configSR).runSteps(o),b=new w(l,a.poolCharSR-a.rateUpCharacterSR,a.configSR).runSteps(e),u=P(e,b,a.configWep.pointsSR,L),C=T(r,c,u);n.push({probability:p,cashback:C})}return _(n)}function ct(t,r,e,a){const o=Math.max(...t.map(c=>c.rateUpCount)),n=s(o,e.configWep.pointsSR),l=new w(a.SR.consCount,e.poolCharSR,e.configSR).runSteps(r),p=P(r,l,e.configWep.pointsSR,L);return T(t,n,p);function s(c,f){return Array.from({length:c+1},(b,u)=>({mean:u*f,variance:0}))}}function lt(t){let r=0;for(const e of t)r+=e.probability;for(const e of t)e.probability/=r;return t}export{ht as W,bt as a,ut as c,mt as g};
