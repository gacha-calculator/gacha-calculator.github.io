import{c as $,D as W,C as G,r as Y,a as j,u as J,g as Q,d as X,f as Z,j as tt,h as et,n as I,l as q,s as N,o as at,I as L,m as nt}from"./solvers-GF9CDpzm.js";/* empty css               */import{p as P,a as ot,e as rt,c as D,d as B,s as st,n as ct,b as lt}from"./common-helpers-BPUYLRbn.js";const M=[.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.04,.065,.09,.115,.14,.165,.19,.215,.24,1],it=.085,T={maxCharacterConstelation:5,rateUpCharacterSR:2,poolStandardCharSSR:38,poolCharSR:23,configSR:{maxType:6,regularPoints:.3,specialPoints:.7},configSSR:{maxType:6,regularPoints:1.2,specialPoints:2.8},paths:{char:["None","p0","p1","p2","p3","p4","p5"]},pity:{pitySSR:M.length,pitySR:10},default:0},ut=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"p0",text:"P0"},{value:"p1",text:"P1"},{value:"p2",text:"P2"},{value:"p3",text:"P3"},{value:"p4",text:"P4"},{value:"p5",text:"P5"}],pt={none:0,p0:1,p1:2,p2:3,p3:4,p4:5,p5:6},ft={CHARACTER:"character"},k={PITY_ROW:"[data-banner]",CONSTELLATION_ROW:"[data-rarity]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},O={pitySettings:{[ft.CHARACTER]:{pity4:0,pity5:0}},isCharacter:!0,isWeapon:!1,isSpecial:!1,constellationColumns:7},_={probability:70,pulls:76};function ht(t,o,a){bt(o.pity),dt(o),mt();const n=t.loadTables();n&&(St(n.pity),gt(n.constellation),Ct(n.rateUps),a.validateAll()),t.init()}function bt(t){const o=document.getElementById("pity-row-template"),a=document.querySelector(`${k.PITY_TABLE} tbody`);Object.entries(O.pitySettings).forEach(([e,r])=>{const s=o.content.cloneNode(!0).querySelector("tr");s.dataset.validationType="individual";const i=s.querySelector('[data-control="pity-5"]');i&&(i.min=0,i.max=t.pitySSR-1),s.dataset.banner=e,s.querySelector(".banner-name").textContent=e,s.querySelector('[data-control="pity-5"]').value=r.pity5,a.appendChild(s)});const n=document.querySelector("#pity-table");n&&n.querySelectorAll('tbody tr input[type="number"]').forEach(e=>e.addEventListener("input",function(){let r=this.value;r.length>1&&r.startsWith("0")&&(this.value=r.replace(/^0+/,""),this.value===""&&(this.value="0"));let s=parseInt(this.value)||0;s>e.max?(this.value=e.max,z(this)):s<e.min&&(this.value=e.min,z(this))}))}function z(t){t.style.borderColor="#a71919",t.style.outline="1px solid #a71919",t.classList.add("flicker"),setTimeout(()=>{t.classList.remove("flicker"),t.style.borderColor="",t.style.outline=""},500)}function dt(t){const o=document.getElementById("const-column-template"),a=document.querySelectorAll(`${k.CONSTELLATION_TABLE} tbody tr`),n=t.poolStandardCharSSR,e=t.poolCharSR;a.forEach(r=>{const s=document.createDocumentFragment(),i=r.dataset.rarity;r.dataset.validationType="row-sum",r.dataset.targetSum=i==="5"?n:e;for(let l=0;l<O.constellationColumns;l++){const c=o.content.cloneNode(!0),u=c.querySelector("input");if(l===O.constellationColumns-1){const p=i==="5"?n:e;u.value=p}u.addEventListener("input",()=>V(r)),s.appendChild(c)}r.appendChild(s),yt(r),V(r)})}function yt(t){const o=document.createElement("div");o.className="row-progress-bar",t.appendChild(o)}function V(t){const o=t.querySelectorAll("input"),a=parseInt(t.dataset.targetSum);let n=0;o.forEach(s=>{n+=parseInt(s.value)||0});const e=t.querySelector(".row-progress-bar"),r=Math.min(n/a*100,100);e.style.width=r+"%",r<60||n>a?e.style.background="rgba(244, 67, 54, 0.3)":r<80?e.style.background="rgba(241, 244, 54, 0.3)":e.style.background="rgba(54, 244, 79, 0.3)"}function mt(){const t=document.querySelectorAll("#rate-up-table select");if(t.length===0)return;const o=ut.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");t.forEach(a=>{a.innerHTML=o,a.value="unknown"})}function St(t){t.forEach(o=>{const a=document.querySelector(`${k.PITY_TABLE} tr[data-banner="${o.banner}"]`);a&&(a.querySelector('[data-control="pity-5"]').value=o.pity5,a.querySelector(".guarantee-5").checked=o.guarantee5)})}function gt(t){document.querySelectorAll(`${k.CONSTELLATION_TABLE} tbody tr`).forEach((a,n)=>{const e=t[n];e&&a.querySelectorAll("td:nth-child(n+2) input").forEach((s,i)=>{e[i]!==void 0&&(s.value=e[i])})})}function Ct(t){if(!t||!Array.isArray(t))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,n)=>{t[n]!==void 0&&(a.value=t[n])})}function Rt(t){const{cashbackCalculator:o,uiUpdater:a}=t;return function(e){const{results:r,inputConfig:s,chartLabels:i,gachaConfig:l}=e,c=o(s,l,r.cashbackData.SSR,r.cashbackData.SR,s.SR.rateUps);a(r.cashbackData.SSR,i,c)}}const E=(t,o=!1)=>t?o?t.checked:parseInt(t.value)||0:null;function vt(t,o,a,n){const e=document.getElementById("pity-panel"),r=document.getElementById("constellation-panel"),s=o.paths;if(!e||!r)return console.error("Required tab panels not found. Cannot get page configuration."),null;const i=(f,b)=>{if(!b)return[];const m=b.querySelector("#constellation-table");if(!m)return console.warn("Could not find the constellation table inside the panel:",b),[];const g=m.querySelectorAll(`tr[data-rarity="${f}"] .custom-input`);return Array.from(g).map(S=>parseInt(S.value)||0)},l=e.querySelector(`${a.PITY_ROW}[data-banner="character"]`),{planConfigs:c,pity4:u,guarantee4:p}=kt(s),y={},h={},d={};return n.isCharacter&&(y.char=E(l.querySelector('[data-control="pity-5"]')),h.char=E(l.querySelector(".guarantee-5"),!0)),{SSR:{pity:y,guarantee:h,special:d,consCountStandard:i(5,r),pullPlan:c.typeArray,cashbackRoadmap:c.cashbackArray},SR:{pity:u,guarantee:p,rateUps:Et(t),consCount:i(4,r)}}}function At(){const t=document.querySelectorAll(".row"),o=[],a=[],n=[];return Array.from(t).slice(1).forEach(r=>{const s=r.dataset.group,i=E(r.querySelector('[data-control="pity-4"]')),l=E(r.querySelector(".guarantee-4"),!0),c=r.querySelector(".type-selector")?.value||"char",u=r.querySelector(".first-select")?.value||"None",p=r.querySelector(".second-select")?.value||"None";a.push(i),n.push(l),o.push({group:s,type:c,from:u,to:p})}),{pullPlan:o,pity4:a,guarantee4:n}}function kt(t){const o=document.querySelectorAll(".row"),a={},n=[],e=[],r=[],s=[],i=Array.from(o).slice(1);let l=0;return i.forEach(c=>{const u=E(c.querySelector('[data-control="pity-4"]')),p=E(c.querySelector(".guarantee-4"),!0);r.push(u),s.push(p);const y=c.querySelector(".type-selector")?.value||"char",h=c.querySelector(".first-select")?.value||"None",d=c.querySelector(".second-select")?.value||"None",f=y==="char"?t.char:t.wep,b=f.indexOf(h),m=f.indexOf(d);if(b===-1||m===-1||b>=m)return;const g=m-b;let S=b,C=0;for(let R=0;R<g;R++)y==="char"&&S===0?C="none":C="regular",n.push({type:y,bannerCount:l}),e.push(C),S++;l++}),a.typeArray=n,a.cashbackArray=e,{planConfigs:a,pity4:r,guarantee4:s}}function Et(t){const o=document.querySelectorAll("#rate-up-table select.custom-select");let a=new Array(Object.keys(t).length).fill(0);return o.length===0?(console.error("Could not find any rate-up select elements."),[]):(o.forEach(n=>{const e=n.value;if(e==="unknown")return;const r=t[e];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${e}"`)}),a)}class Tt{constructor(o){this.parts=o,this.persistence=$("reverse",k);const a=Rt({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn}),n={getPageConfiguration:vt,getLabels:X,getPullPlan:At,getTarget:Q,updateChart:J,convertToChartData:j,recalcInputs:Y,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:k,INITIAL_CONFIG:O},postCalculationHooks:[a],persistence:this.persistence};this.validator=new W(this.parts.CONSTELLATION_MAP),this.calculationHandler=new G(n),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn")}initialize(){this.validator.initialize(),ht(this.persistence,this.parts.gachaConfig,this.validator),Z(),this.#t(),this.#a()}#t(){this.calculateBtn.addEventListener("click",()=>{this.#e()&&this.calculationHandler.runCalculation()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>tt(this.persistence)),et(this.persistence,null,this.validator)}#e(){if(document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll(),this.validator.isRowPityValid();const o=document.querySelectorAll(".is-invalid"),a=new Set;o.forEach(e=>{const r=e.closest(".tab-pane");if(r){const s=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);s&&a.add(s)}e.classList.add("flicker"),e.addEventListener("animationend",()=>e.classList.remove("flicker"),{once:!0})}),a.forEach(e=>{e.classList.add("is-invalid","flicker"),e.addEventListener("animationend",()=>e.classList.remove("flicker"),{once:!0})});const n=Array.from(a)[0];return n&&n.click(),setTimeout(()=>{o[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const o=this.persistence.loadCalculation(),a=o?o.input:null;o?(I(this.parts.gachaConfig.paths,a),q(_,o),N(o.persistInput)):(I(this.parts.gachaConfig.paths),q(_),N()),this.calculationHandler.runCalculation()}}const A=1e-10;function Pt(t,o,a){const n=t.length-2;let e=t.length-1,r=t[e-1].bannerCount+1,s=Array(r).fill(0),i=Array(r).fill(0);Ot(t,s);for(let l=n;l>=0;l--)t[l].isEmpty||(wt(o,l,t,a,0,i),Lt(s,i));return s}function Ot(t,o){for(let a=0;a<t.length-1;a++){let n=t[a].bannerCount,e=0;for(let r=0;r<t[a].states.length;r++)for(const[s,i]of t[a].states[r])e+=i.prob;o[n]+=e}}function Lt(t,o){for(let a=0;a<t.length;a++)t[a]-=o[a]}function Mt(t,o,a){const n=t.length-2;for(let e=n;e>=0;e--){const r=t[e];r.isEmpty||Ut(o,e,t,a,r.type)}}function wt(t,o,a,n,e,r){const s=a[o].states.length;let i=.5;const l=a[o].states,c=a[o].bannerCount,u=a[o+1].states;for(let p=s-2;p>=0;p--){const y=l[p],h=p>=n,d=t[p-n*h];for(const[f,b]of y){const m=b.prob*d,g=b.prob-m;let S=m;if(S>A){h||(S*=i);const R=u[e],v=R.get(f);v?v.prob+=S:R.set(f,{prob:S}),r[c]+=S}if(!h){let R=m*(1-i);if(R>A){let v=f+1;const x=l[n],U=x.get(v);U?U.prob+=R:x.set(v,{prob:R})}}let C=g;if(C>A){const R=l[p+1],v=R.get(f);v?v.prob+=C:R.set(f,{prob:C})}b.prob=0}}return r}function xt(t,o,a){let n;for(let e=0;e<t.length;e++){const r=a[e],s=o*r,i=t[e].length-1;for(let l=i;l>=0;l--){const c=t[e][l].states;for(let u=1;u>=0;u--){n=u===1;let p=s;n||(p*=.5);const y=c[u];if(y.length===10)for(let h=9;h>=0;h--)for(const[d,f]of y[h]){let b=!1;h===9&&(b=!0);let m=p;b&&(m=1);const g=f.prob*m;if(g>A){if(t[e][l+1]===void 0)t[e].push({states:Array.from({length:2},()=>new Map)}),t[e][l+1].states[0].set(d,{prob:g});else{const S=t[e][l+1].states[0],C=S.get(d);C?C.prob+=g:S.set(d,{prob:g})}if(n)f.prob-=g;else{let S=d+1;const C=c[1],R=C.get(S);R?R.prob+=g:C.set(S,{prob:g}),f.prob-=2*g}if(f.prob>0&&!b){const S=c[u][h+1],C=S.get(d);C?C.prob+=f.prob:S.set(d,{prob:f.prob}),f.prob=0}}}else for(const[h,d]of y){const f=d.prob*p;if(f>A){if(t[e][l+1]===void 0)t[e].push({states:Array.from({length:2},()=>new Map)}),t[e][l+1].states[0].set(h,{prob:f});else{const b=t[e][l+1].states[0],m=b.get(h);m?m.prob+=f:b.set(h,{prob:f})}if(n)d.prob-=f;else{let b=h+1;const m=c[1],g=m.get(b);g?g.prob+=f:m.set(b,{prob:f}),d.prob-=2*f}}}}}}}function Ut(t,o,a,n,e){const r=a[o].states.length;let s=.5;const i=a[o].states,l=a[o+1].states;for(let c=r-2;c>=0;c--){const u=i[c],p=c>=n,y=t[c-n*p],h=u*y,d=u-h;let f=h;if(f>A&&(p||(f*=s),l[e]+=f),!p){let m=h*(1-s);m>A&&(i[n]+=m)}let b=d;b>A&&(i[c+1]+=b),i[c]=0}}function It(t,o,a){if(!Array.isArray(t.SSR.pullPlan))throw new Error("Invalid pull plan");const{pullPlan:n}=t.SSR,e=[];for(let s=0;s<n.length;s++)e.push({states:Array.from({length:a},()=>new Map),isEmpty:!0,bannerCount:n[s].bannerCount});return e.push({states:Array.from({length:1},()=>new Map)}),r(o),e;function r(s){e[0].states[s].set(0,{prob:1}),e[0].isEmpty=!1}}function qt(t,o){return{SSR:t.SSR.pity.char+t.SSR.guarantee.char*o.pitySSR}}function Nt(t){const o=t.SSR.pullPlan,a=o.length-1,n=o[a].bannerCount;let e=[];for(let r=0;r<=n;r++){const s=t.SR.pity[r];let i=!0;s===10&&(i=!1);let l=0;t.SR.guarantee[r]&&(l=1),i?l?(e.push([{states:[new Map,Array.from({length:10},()=>new Map)]}]),e[r][0].states[l][s].set(0,{prob:1})):(e.push([{states:[Array.from({length:10},()=>new Map),new Map]}]),e[r][0].states[l][s].set(0,{prob:1})):(e.push([{states:[new Map,new Map]}]),e[r][0].states[l].set(0,{prob:1}))}return e}function Dt(t){let o=[];for(let a of t)for(let n=0;n<a.length;n++)for(let e=0;e<a[n].states.length;e++)if(Array.isArray(a[n].states[e]))for(let r=0;r<a[n].states[e].length;r++)for(let[s,i]of a[n].states[e][r])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(s,{prob:i.prob});else{const l=o[n].states[e],c=l.get(s);c?c.prob+=i.prob:l.set(s,{prob:i.prob})}else for(let[r,s]of a[n].states[e])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(r,{prob:s.prob});else{const i=o[n].states[e],l=i.get(r);l?l.prob+=s.prob:i.set(r,{prob:s.prob})}return o}function Bt(t,o){let a=[],n={},e=!1,r=!1,s=T.pity.pitySSR*2+1;const i=qt(t,T.pity);let l=It(t,i.SSR,s),c=Nt(t),u=0;const p=10;for(;!r&&!e;){if(n=Pt(l,M,T.pity.pitySSR),xt(c,it,n),u++,u===p){P(l);for(let d of c)P(d);u=0}a.push(ot(l)),e=rt(l,o,a.length),e||(r=D(l,e))}if(!u===p){P(l);for(let d of c)P(d)}c=Dt(c);const y={SSR:B(l),SR:B(c)};for(st(l),c=null;!r;)e&&(u++,Mt(l,M,T.pity.pitySSR),u===p&&ct(l),a.push(lt(l)),r=D(l,e));return{chartData:a,cashbackData:y}}class w{constructor(o,a,n){this.rateUps=o,this.offRates=a,this.probability=n}}function _t(t,o,a){const n=[],e=new Array(a).fill(0);function r(s,i){if(s===a){if(i===o){const c=F(e,t);n.push(new w([...e],c))}return}const l=Math.min(t[s],o-i);for(let c=0;c<=l;c++)e[s]=c,r(s+1,i+c),e[s]=0}return r(0,0),n}function F(t,o){const a=[...o];for(let n=0;n<t.length;n++)a[n]-=t[n];return a}function zt(t,o,a){const n=t.length,e=a.reduce((c,u)=>c+u,0),r=o-e;if(r<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(n);for(let c=0;c<n;c++)if(s[c]=t[c]-a[c],s[c]<0)return console.error(`Error: Known picks for constellation ${c} exceed its capacity.`),[];return _t(s,r,n).map(c=>{const u=c.rateUps.map((y,h)=>y+a[h]),p=F(u,t);return new w(u,p)})}function Vt(t,o,a){const n=o.map((s,i)=>s-a[i]),e=new Map;for(const s of t){const i=s.rateUps.map((c,u)=>c-a[u]);if(i.some(c=>c<0)){s.probability=0;continue}const l=new w(i,[]);e.set(l,s)}const r=Array.from(e.keys());r.length>0&&at(r,n);for(const[s,i]of e.entries())i.probability=s.probability}function Ft(t,o,a){let n=o[t.rateUpCount],e=a[t.charOffRateCount];return{mean:n+e.mean,variance:e.variance}}function Ht(t){const a=Math.sqrt(t.variance),n=1/Math.sqrt(.2);let e=t.mean-a*n;e<0&&(e=0);const r=t.mean+a*n,s=t.mean;return{LOWER_BOUND:e,MEAN:s,UPPER_BOUND:r}}function Kt(t,o){const a=[];let n=0;for(let e=0;e<t.length;e++)for(const[r,s]of t[e].offRates.entries()){const i=r;s.prob>o&&(a.push({rateUpCount:e,charOffRateCount:i,probability:s.prob}),n=Math.max(n,i))}return{combos:a,maxOffRateCount:n}}function $t(t,o){const a=[];let n=0;for(let e=0;e<t.length;e++)for(const[r,s]of t[e].offRates.entries())s.prob>o&&(a.push({rateUpCount:e,offRateCount:r,probability:s.prob}),n=Math.max(n,r));return{combos:a,maxOffRateCount:n}}function Wt(t,o,a){let n=0,e=0;for(const{rateUpCount:r,offRateCount:s,probability:i}of t){const l=o[r],c=a[s],u=l.mean+c.mean,p=l.variance+c.variance+Math.pow(u,2);n+=i*u,e+=i*p}return{mean:n,variance:Math.max(0,e-Math.pow(n,2))}}function H(t){let o=0,a=0;for(const{probability:n,cashback:e}of t)o+=n*e.mean;for(const{probability:n,cashback:e}of t){const r=e.variance+Math.pow(e.mean,2);a+=n*r}return{mean:o,variance:Math.max(0,a-Math.pow(o,2))}}const K=1e-8;function Gt(t,o,a,n,e){a=Yt(a);const r=zt(t.SR.consCount,o.rateUpCharacterSR,e);Vt(r,t.SR.consCount,e);const s=jt(a,o.poolStandardCharSSR,t.SSR.consCountStandard,t.SSR.cashbackRoadmap,o),i=Jt(r,n,o),l=s;for(let c=0;c<l.length;c++)l[c].mean+=i.mean,l[c].variance+=i.variance,l[c]=Ht(l[c]);return l}function Yt(t){let o=0;for(const a of t)for(const[n,e]of a.offRates)o+=e.prob;for(const a of t)for(const[n,e]of a.offRates)e.prob/=o;return t}function jt(t,o,a,n,e){const{combos:r,maxOffRateCount:s}=Kt(t,K),i=[0];let l=0;for(let u=0;u<t.length;u++)n[u-1]==="none"?i.push(l):n[u-1]==="regular"&&(l+=e.configSSR.regularPoints,i.push(l));const c=Array.from({length:t.length},()=>[]);for(const u of r){const p=u.rateUpCount,y=u.probability,d=new L(a,o,e.configSSR).runSteps(s),f=Ft(u,i,d);c[p].push({cashback:f,probability:y})}for(let u=0;u<c.length;u++){const p=Xt(c[u]);c[u]=H(p)}return c}function Jt(t,o,a){const{combos:n,maxOffRateCount:e}=$t(o,K);return Qt(t,n,e,a)}function Qt(t,o,a,n){const e=Math.max(...o.map(s=>s.rateUpCount)),r=[];for(const{rateUps:s,offRates:i,probability:l}of t){const u=new L(s,n.rateUpCharacterSR,n.configSR).runSteps(e),y=new L(i,n.poolCharSR-n.rateUpCharacterSR,n.configSR).runSteps(a),h=Wt(o,u,y);r.push({probability:l,cashback:h})}return H(r)}function Xt(t){let o=0;for(const a of t)o+=a.probability;for(const a of t)a.probability/=o;return t}document.addEventListener("DOMContentLoaded",()=>{const t={gachaConfig:T,CONSTELLATION_MAP:pt,runCalcFn:Bt,cashbackFn:Gt,updateTableFn:nt};new Tt(t).initialize()});
