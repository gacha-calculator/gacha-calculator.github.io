import{x as y}from"./recalc-inputs-pOLqUGMN.js";class S{constructor({getPageConfiguration:t,getLabels:s,getPullPlan:i,getTarget:a,updateChart:e,convertToChartData:o,recalcInputs:r,calculatorFunction:n,calculatorConfig:c,pageConfig:p,postCalculationHooks:d,persistence:f,chibi:m}){this.getPageConfiguration=t,this.getLabels=s,this.getPullPlan=i,this.getTarget=a,this.updateChart=e,this.convertToChartData=o,this.recalcInputs=r,this.calculatorFunction=n,this.calculatorConfig=c,this.pageConfig=p,this.postCalculationHooks=d||[],this.persistence=f,this.chibi=m}async runCalculation(){const t=this.getTarget(),s=this.getPageConfiguration(this.calculatorConfig.CONSTELLATION_MAP,this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),i=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(i.length>99){this.chibi.showError("Too many items! Even I can't calculate so quickly, maximum 99 items allowed.");return}const a=await this.calculatorFunction(s,t),e=this.convertToChartData(a.chartData);this.updateChart(e.data,e.labels,i),this.recalcInputs(e.data);const o={results:a,inputConfig:s,chartLabels:i,gachaConfig:this.calculatorConfig.gachaConfig,CONSTELLATION_MAP:this.calculatorConfig.CONSTELLATION_MAP};if(this.postCalculationHooks.forEach(r=>r(o)),this.persistence){const r=parseInt(document.querySelector('[data-control="pulls"]').value),n=parseInt(document.querySelector('[data-control="probability"]').value);this.persistence.saveCalculation({input:this.getPullPlan(),targetProb:n,targetPull:r,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")}),this.persistence.saveButtons()}}}class T{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document.querySelectorAll('input[type="number"]');t.forEach(s=>{s.addEventListener("focus",()=>{s.select()})}),t.forEach(s=>{s.addEventListener("keydown",i=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(i.key)||(i.ctrlKey||i.metaKey)&&["a","c","v","x"].includes(i.key.toLowerCase())||/^\d$/.test(i.key)||i.preventDefault()})}),t.forEach(s=>{s.addEventListener("input",i=>{const e=i.target.closest("table");if(e)switch(e.id){case"constellation-table":{this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}})}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(s=>s.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(s=>this.validateRowSum(s)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(i=>{i.querySelectorAll('input[type="number"]').forEach((a,e)=>{t[e]+=parseInt(a.value,10)||0})}),this.availableConstellationCounts=t}validateRateUpEligibility(){const t=this.getRateUpUsage(),s=this.availableConstellationCounts.map((i,a)=>t[a]>i);document.querySelectorAll("#rate-up-table select.custom-select").forEach(i=>{const a=this.constellationMap[i.value];a!==void 0&&s[a]&&(i.value="unknown")})}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(s=>{const i=this.constellationMap[s.value];i!==void 0&&t[i]++}),t}validateRowSum(t){if(!t.dataset.targetSum)return;const s=parseFloat(t.dataset.targetSum),i=t.querySelectorAll('input[type="number"]');let a=0;if(i.forEach(e=>a+=parseFloat(e.value)||0),s!=a){let e=s-a;const o=parseFloat(i[0].value)||0;if(e>0)i[0].value=o+e;else for(let r=i.length-1;r>=0;r--){e=Math.abs(e);let n=parseFloat(i[r].value);if(n>e){i[r].value=n-e;break}else i[r].value=0,e=e-n}}}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const i of t)if(!this.isIndividualInputValid(i))return!1;const s=document.querySelectorAll("#constellation-table tbody tr");for(const i of s)this.validateRowSum(i),y(i);return this.validateRateUpEligibility(),!0}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const s=parseInt(t.value,10),i=parseInt(t.min,10),a=parseInt(t.max,10);return(!t.hasAttribute("min")||s>=i)&&(!t.hasAttribute("max")||s<=a)}return!1}}function A(l,t){for(const s of l){const i=u(s.rateUps);if(!b(i,t)){s.probability=0;continue}const a=h(i,t),e=g(l,t);s.probability=e===0?0:a/e}}function u(l){const t={};for(let s=0;s<l.length;s++){const i=l[s];i>0&&(t[s]=i)}return t}function b(l,t){return Object.entries(l).every(([s,i])=>t[s]>=i)}function h(l,t){return Object.entries(l).reduce((s,[i,a])=>s*C(t[i],a),1)}function g(l,t){return l.reduce((s,i)=>{const a=u(i.rateUps),e=h(a,t);return s+e},0)}function C(l,t){if(t<0||t>l)return 0;if(t===0||t===l)return 1;t=Math.min(t,l-t);let s=1;for(let i=1;i<=t;i++)s*=(l-t+i)/i;return s}function I(l,t){if(!Number.isInteger(l)||l<0)throw new Error("Number of trials (n) must be a non-negative integer.");let s=0,i=0,a=[],e=1;for(;s<=l;)i=e*Math.pow(t,s)*Math.pow(1-t,l-s),a.push(i),s++,e=e*(l+1-s)/s;return a}class M{constructor(t,s,i){this.initialState=[...t],this.totalItems=s,this.config=i,this.maxType=i.maxType,this.nTypes=t.length,this.points=Array(this.nTypes).fill(0);for(let a=1;a<this.maxType;a++)this.points[a]=i.regularPoints;this.points[this.maxType]=i.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let t=0;t<this.nTypes;t++)for(let s=0;s<this.nTypes;s++)this.stateSecondMoments[t][s]=this.initialState[t]*this.initialState[s];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const t=this.totalItems;this.step++;let s=0,i=0;for(let n=0;n<this.nTypes;n++){const c=this.expected[n]/t;s+=this.points[n]*c,i+=this.points[n]**2*c}let a=0;for(let n=0;n<this.nTypes;n++)a+=this.points[n]*this.pointStateCrossMoments[n];a/=t;const e=this.secondMoment+2*a+i,o=this.mean+s,r=e-o**2;return this.results.push({mean:o,variance:r}),this.updateState(),this.secondMoment=e,this.mean=o,this.variance=r,{mean:o,variance:r,step:this.step}}updateState(){const t=this.totalItems,s=Array(this.nTypes).fill(0);for(let e=0;e<this.maxType;e++)s[e]=this.expected[e]*(t-1)/t;s[this.maxType]=this.expected[this.maxType];for(let e=0;e<this.maxType;e++)s[e+1]+=this.expected[e]/t;const i=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let e=0;e<this.nTypes;e++)for(let o=0;o<this.nTypes;o++)i[e][o]=this.stateSecondMoments[e][o];for(let e=0;e<this.maxType;e++){const o=Array(this.nTypes).fill(0);o[e]=-1,o[e+1]=1;for(let r=0;r<this.nTypes;r++)for(let n=0;n<this.nTypes;n++)i[r][n]+=1/t*(o[r]*this.stateSecondMoments[e][n]+o[n]*this.stateSecondMoments[r][e]+o[r]*o[n]*this.expected[e])}const a=Array(this.nTypes).fill(0);for(let e=0;e<this.nTypes;e++){let o=this.pointStateCrossMoments[e];e<this.maxType&&(o-=this.pointStateCrossMoments[e]/t),e>=1&&(o+=this.pointStateCrossMoments[e-1]/t);let r=0;for(let n=0;n<this.nTypes;n++)r+=this.points[n]*this.stateSecondMoments[e][n];o+=r/t,e<this.maxType&&(o-=this.points[e]*this.expected[e]/t),e>=1&&(o+=this.points[e-1]*this.expected[e-1]/t),a[e]=o}this.expected=s,this.stateSecondMoments=i,this.pointStateCrossMoments=a}runSteps(t){this.reset();for(let s=0;s<t;s++)this.computeStep();return this.results}}export{S as C,T as D,M as I,I as b,A as c};
