import{C as I,a as D,b as M,g as C,W,c as Y,d as x,e as H,f as z,T as B,h as G,i as V,j,k as w,l as X,m as v,n as L,s as _,O as q,o as $,p as N,u as J,q as K}from"./cashback-CU-XoPzW.js";/* empty css               */import{P as U,c as b,s as Q}from"./commonHelpers-CUrulWED.js";function Z(l){if(!l||!l.characters||!l["wish-counter-character-event"])return console.error("Imported data is missing key Paimon.moe properties."),null;console.log("Paimon.moe data format detected. Running adapter...");const t=l["wish-counter-character-event"]?.pulls||[],p=l["wish-counter-weapon-event"]?.pulls||[],u=O(t,"character"),c=O(p,"weapon"),a=[{banner:"character",...u,caprad:"0",epPath:"0"},{banner:"weapon",...c,caprad:"0",epPath:"0"}],S=tt(l.characters);return{pity:a,constellation:S}}function O(l,t){let p=0,u=0,c=!1,a=!1,S=!1,i=!1;const P=y=>D.has(y)?{type:"character",rarity:4}:W.has(y)?{type:"weapon",rarity:4}:Y.has(y)?{type:"weapon",rarity:3}:M.has(y)?{type:"character",rarity:5,standard:!0}:x.has(y)?{type:"weapon",rarity:5,standard:!0}:{type:"unknown",rarity:5,standard:!1};for(let y=l.length-1;y>=0;y--){const f=l[y],A=P(f.id);A.rarity===5?S||(c=f.rate===0,S=!0):S||p++,A.rarity===4?i||(t==="character"&&(a=A.type==="weapon"),i=!0):i||u++}return{pity4:String(u),pity5:String(p),guarantee4:a,guarantee5:c}}function tt(l){const t=new Array(Object.keys(I).length).fill(0),p=new Array(Object.keys(I).length).fill(0);let u=0,c=0;for(const y in l){let f=0;if(D.has(y)?f=4:M.has(y)&&(f=5),f===0)continue;const A=l[y],o=(A.default||0)+(A.wish||0)+(A.manual||0);if(o>0){f===4?u++:f===5&&c++;const e=Math.min(o-1,6),n=I[`c${e}`];n!==void 0&&(f===4?t[n]++:f===5&&p[n]++)}}const a=C.poolCharSR,S=C.poolStandardCharSSR,i=a-u,P=S-c;return t[0]=Math.max(0,i),p[0]=Math.max(0,P),{0:p.map(String),1:t.map(String)}}class et{constructor(t){this.parts=t,this.persistence=H("genshin");const p=z({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn}),u={calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},postCalculationHooks:[p]};this.validator=new B(this.parts.CONSTELLATION_MAP),this.calculationHandler=G(u,this.persistence),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn")}initialize(){this.validator.initialize(),V(this.persistence,this.parts.gachaConfig,this.validator),j(),w(),this.#t(),this.#a()}#t(){if(!this.calculateBtn){console.error("Calculate button not found!");return}this.calculateBtn.addEventListener("click",()=>{this.#e()&&this.calculationHandler()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>X(this.persistence)),w(this.persistence,Z,this.validator)}#e(){if(document.querySelectorAll(".is-invalid").forEach(c=>c.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll();const t=document.querySelectorAll(".is-invalid"),p=new Set;t.forEach(c=>{const a=c.closest(".tab-pane");if(a){const S=document.querySelector(`.tab-link[data-tab-target="#${a.id}"]`);S&&p.add(S)}c.classList.add("flicker"),c.addEventListener("animationend",()=>c.classList.remove("flicker"),{once:!0})}),p.forEach(c=>{c.classList.add("is-invalid","flicker"),c.addEventListener("animationend",()=>c.classList.remove("flicker"),{once:!0})});const u=Array.from(p)[0];return u&&u.click(),setTimeout(()=>{t[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const t=this.persistence.loadCalculation(),p=t?t.input:null;t?(v(this.parts.gachaConfig.paths,p),L(t),_(t.persistInput)):(v(this.parts.gachaConfig.paths),L(),_()),this.calculationHandler()}}function at(l,t){if(!Array.isArray(l.SSR.pullPlan))throw new Error("Invalid pull plan");if(!(Number.isInteger(l.SSR.special.capRad)&&l.SSR.special.capRad>=0&&l.SSR.special.capRad<=3))throw new Error("Invalid Capturing Radiance Value");if(!Array.isArray(t))throw new Error("Invalid pity data");const p={CHARACTER:0},u={CHARACTER:{DEFAULT:181,GUARANTEE:91},WEAPON:232,FINAL:1},c={LAST:3,MAX:4},{pullPlan:a}=l.SSR,{capRad:S}=l.SSR.special;let i=0;const P=[];for(const[n,s]of a.entries()){const r=s===p.CHARACTER;P.push([]),r?(y(n,i),i++):f(n,i)}return A(),o(t,S),{distributionSSR:P};function y(n,s){for(let r=0;r<=s;r++){const h=[];for(let m=0;m<c.MAX;m++){const k=m!==c.LAST?u.CHARACTER.DEFAULT:u.CHARACTER.GUARANTEE,g=m<c.LAST?[0,0,0]:[0];h.push(e(k,g))}P[n].push(h)}}function f(n,s){for(let r=0;r<=s;r++){const h=[];for(let m=0;m<c.MAX;m++)h.push(e(u.WEAPON,[0,0]));P[n].push(h)}}function A(){const n=Array.from({length:i+1},()=>Array(c.MAX).fill().map(()=>e(u.FINAL)));P.push(n)}function o(n,s){const r=P[0][0][s];r.states[n[0]]=1,r.totalSum=1}function e(n,s){return new U(Array(n).fill(0),s,0)}}function rt(l){let u=!1,c=!1,a=0,S=0;const i=[];a+=l.SSR.pity.char,a+=l.SSR.guarantee.char*90,S+=l.SSR.pity.wep,S+=l.SSR.special.epitPath===0?l.SSR.guarantee.wep*77:2*77;for(const P of l.SSR.pullPlan)P==0&&!u?(u=!0,i.push(a)):P==1&&!c?(c=!0,i.push(S)):i.push(0);return i.push(0),i}function lt(l){let t=[[new U(Array(21).fill(0),[0,0],1)]],p=[[new U(Array(21).fill(0),[0,0],1)]];const u=l.SR.guarantee.char*10+l.SR.pity.char,c=l.SR.guarantee.wep*10+l.SR.pity.wep;return t[0][0].states[u]=1,p[0][0].states[c]=1,{distributionCharSR:t,distributionWepSR:p}}function E(l){const t=[];for(let p=0;p<l.length;p++){const u=l[p],c=[];for(let a=0;a<u.length;a++){const S=u[a];let i=0,P=0,y;const f=Array.isArray(S)?S:[S];for(let A=0;A<f.length;A++)if(y=f[A].states.length,f[A].totalSum>1e-8){if(y===181)for(let o=90;o<181;o++)P+=f[A].states[o];else if(y===232)for(let o=154;o<232;o++)P+=f[A].states[o];else if(y===21)for(let o=10;o<21;o++)P+=f[A].states[o];i+=f[A].totalSum}c.push({lostSum:P}),c[a].totalSum=i}t.push(c)}return t}const T=1e-8;function nt(l,t,p,u,c,a){if(!Array.isArray(u)||!Array.isArray(c))throw new Error("All input parameters except currentPull must be arrays.");const{charPullsSum:S,wepPullsSum:i}=f(l,c);a.char.pullsSum=S,a.wep.pullsSum=i;for(let e=0;e<l.length-1;e++){const n=c[e]===0,s=l[e].length-1;for(let r=0;r<=s;r++)for(let h=0;h<4;h++){const m=l[e][r][h],k=n?t:p;m.totalSum>T&&(l[e][r][h].states=F(k,m.states,m.rankUps,h))}}const{charRankUps:P,wepRankUps:y}=o(l,c);a.char.rankUps=P,a.wep.rankUps=y;for(let e=0;e<l.length-1;e++){const n=l[e].length-1,s=c[e]===0;for(let r=0;r<=n;r++){const h=u[e+1];for(let m=0;m<4;m++)A(l,e,r,m,s,h)}}function f(e,n){const s=[0,0];for(let h=0;h<e.length-1;h++){const m=n[h]===0?0:1;for(let k of e[h])for(let g of k)if(g.totalSum>T)for(let R of g.states)R>1&&(R=1),s[m]+=R}const r=1/(s[0]+s[1]);return s[0]*=r,s[1]*=r,{charPullsSum:s[0],wepPullsSum:s[1]}}function A(e,n,s,r,h,m){if(h){if(e[n][s][r].rankUps[0]>T){e[n][s][r].rankUps[0];const k=Math.floor(r/2);e[n+1][s][k].states[m]+=e[n][s][r].rankUps[0],e[n+1][s][k].totalSum+=e[n][s][r].rankUps[0],e[n][s][r].totalSum-=e[n][s][r].rankUps[0]}r!==3&&e[n][s][r].rankUps[1]>T&&(e[n+1][s+1][r+1].states[m]+=e[n][s][r].rankUps[1],e[n+1][s+1][r+1].totalSum+=e[n][s][r].rankUps[1],e[n][s][r].totalSum-=e[n][s][r].rankUps[1])}else e[n][s][r].rankUps[0]>T&&(e[n+1][s][r].states[m]+=e[n][s][r].rankUps[0],e[n+1][s][r].totalSum+=e[n][s][r].rankUps[0],e[n][s][r].totalSum-=e[n][s][r].rankUps[0]);e[n][s][r].rankUps[0]=0,e[n][s][r].rankUps[1]=0}function o(e,n){const s=[0,0];for(let r=0;r<e.length-1;r++){const h=n[r]===0?0:1;for(let m of e[r])for(let k of m){for(let g of k.rankUps)s[h]+=g;k.rankUps[2]=0}}return{charRankUps:s[0],wepRankUps:s[1]}}}function d(l,t,p){let u=!1;for(let a=0;a<t.length;a++){const S=a===t.length-1,i=t[a].length-1;for(let P=0;P<=i;P++){const y=t[a][P];if(y.totalSum>T&&(t[a][P].states=F(p,y.states,y.rankUps,0,l),S))for(let f of y.rankUps)f>T&&(u=!0)}}if(u){let a=[];for(let S=0;S<=t.length;S++)a.push(new U(Array(21).fill(0),[0,0],0));t.push(a)}for(let a=0;a<t.length-1;a++){const S=t[a].length-1;for(let i=0;i<=S;i++)t[a+1][i].states[0]+=t[a][i].rankUps[0],t[a+1][i].totalSum+=t[a][i].rankUps[0],t[a][i].totalSum-=t[a][i].rankUps[0],t[a][i].rankUps[0]=0,t[a+1][i+1].states[0]+=t[a][i].rankUps[1],t[a+1][i+1].totalSum+=t[a][i].rankUps[1],t[a][i].totalSum-=t[a][i].rankUps[1],t[a][i].rankUps[1]=0}const c=t[t.length-1].length-1;for(let a=0;a<=c;a++)t[t.length-1][a].rankUps[0]=0,t[t.length-1][a].rankUps[1]=0}function F(l,t,p,u,c){const a=t.length,S=a===232,i=a===181,P=a===91,y=a===21,f=Array(a).fill(0);if(i||y){const A=c!==void 0?c.pullsSum:1,o=c!==void 0?c.rankUps:0,e=y?10:90,n=u===2?.45:.5,s=u===2?.55:.5;for(let r=1;r<a;r++)if(r===e||r===e*2)for(let h=0;h<r;h++){const m=h<e?r===e?n:s:1;if(f[r]+=l[h%e]*t[h]*(A-o)*m,i&&r===e&&(p[2]+=l[h%e]*t[h]*(A-o)*m),h===9||h===19?f[h]+=t[h]*(1-(A-o))*m:(f[h+1]+=l[h%e]*t[h]*o*m,f[h]+=t[h]*(1-A)*m),r==e*2&&(h===e-1||h===e*2-1)){const k=h===e*2-1?1:0;p[k]=f[r],f[r]=0}}else f[r]+=(1-l[r%e-1])*t[r-1]*A}else if(S)for(let o=1;o<a;o++){if(o===77*2||o===77*3){const e=o===154?.625:.375;for(let n=0;n<o;n++){const s=n<77?e:n<154?.5:1;f[o]+=l[n%77]*t[n]*s}}else o!==77&&(f[o]+=(1-l[o%77-1])*t[o-1]);o===77*2&&(p[1]=f[o]),o===77*3&&(p[0]=f[o],f[o]=0)}else if(P){let A=90;for(let o=1;o<a;o++){if(o===A)for(let e=0;e<o;e++)f[o]+=l[e%A]*t[e];else f[o]+=(1-l[o%A-1])*t[o-1];o===a-1&&(p[0]=f[o],f[o]=0)}}else throw new Error("Incorrect size for distribution SSR");return f}function st(l){const t=rt(l);let p={char:{},wep:{}};const{distributionSSR:u}=at(l,t),{distributionCharSR:c,distributionWepSR:a}=lt(l);let S=[],i=[],P=[],y=0;for(;y<.999;){nt(u,$,q,t,l.SSR.pullPlan,p),d(p.char,c,N),d(p.wep,a,N);let e=0;for(let n of u[u.length-1])for(let s of n)e+=s.totalSum;y=e,S.push(E(u)),i.push(E(a)),P.push(E(c))}const f=E(c);let A=b(f);return A=Q(A,C.rateUpCharacterSR),{SSR:S,WepSR:i,CharSR:P}}document.addEventListener("DOMContentLoaded",()=>{const l={gachaConfig:C,CONSTELLATION_MAP:I,runCalcFn:st,cashbackFn:K,updateTableFn:J};new et(l).initialize()});
