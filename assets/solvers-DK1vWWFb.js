(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const n of o)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function e(o){const n={};return o.integrity&&(n.integrity=o.integrity),o.referrerPolicy&&(n.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?n.credentials="include":o.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(o){if(o.ep)return;o.ep=!0;const n=e(o);fetch(o.href,n)}})();class Z{constructor({getPageConfiguration:t,getLabels:e,getPullPlan:i,getTarget:o,updateChart:n,convertToChartData:s,recalcInputs:a,calculatorFunction:l,calculatorConfig:u,pageConfig:c,postCalculationHooks:d,persistence:h,chibi:p}){this.getPageConfiguration=t,this.getLabels=e,this.getPullPlan=i,this.getTarget=o,this.updateChart=n,this.convertToChartData=s,this.recalcInputs=a,this.calculatorFunction=l,this.calculatorConfig=u,this.pageConfig=c,this.postCalculationHooks=d||[],this.persistence=h,this.chibi=p}async runCalculation(){const t=this.getTarget(),e=this.getPageConfiguration(this.calculatorConfig.CONSTELLATION_MAP,this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),i=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(i.length>99){this.chibi.showError("Too many items! Maximum 99 items allowed.");return}const o=await this.calculatorFunction(e,t),n=this.convertToChartData(o.chartData);this.updateChart(n.data,n.labels,i),this.recalcInputs(n.data);const s={results:o,inputConfig:e,chartLabels:i,gachaConfig:this.calculatorConfig.gachaConfig,CONSTELLATION_MAP:this.calculatorConfig.CONSTELLATION_MAP};if(this.postCalculationHooks.forEach(a=>a(s)),this.persistence){const a=parseInt(document.querySelector('[data-control="pulls"]').value),l=parseInt(document.querySelector('[data-control="probability"]').value);this.persistence.saveCalculation({input:this.getPullPlan(),targetProb:l,targetPull:a,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")}),this.persistence.saveButtons()}}}function tt(r,t,e,i,o,n){B(t.pity,i,n),R(t,i,n),N(o);const s=r.loadTables();s&&(q(s.pity,n),x(s.constellation,n),M(s.rateUps),e.validateAll()),r.init()}function et(r){const t=r.loadButtons();t&&t.isHidden&&k()}function B(r,t,e){const i=document.getElementById("pity-row-template"),o=document.querySelector(`${e.PITY_TABLE} tbody`);Object.entries(t.pitySettings).forEach(([n,s])=>{const a=i.content.cloneNode(!0).querySelector("tr"),l=a.querySelector(".special-mechanic");a.dataset.validationType="individual";const u=a.querySelector('[data-control="pity-4"]'),c=a.querySelector('[data-control="pity-5"]');if(u&&(u.min=0,u.max=n.includes("weapon")?r.pitySRWep-1:r.pitySRChar-1),c&&(c.min=0,c.max=n.includes("weapon")?r.pitySSRWep-1:r.pitySSRChar-1),a.dataset.banner=n,a.querySelector(".banner-name").textContent=n,a.querySelector('[data-control="pity-4"]').value=s.pity4,a.querySelector('[data-control="pity-5"]').value=s.pity5,l){let h="";n==="character"?h=`<div class="button-container">
            <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                   value="${s.caprad??0}">
                            <button class="help-btn" data-help-key="caprad-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`:n==="weapon"&&(h=`<div class="button-container">
            <input type="number" data-control="epPath" class="custom-input" min="0" max="1" 
                   value="${s.epPath??0}">
                            <button class="help-btn" data-help-key="eppath-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`),l.innerHTML=h}o.appendChild(a);const d=document.querySelector("#pity-table");d&&d.querySelectorAll('tbody tr input[type="number"]').forEach(h=>h.addEventListener("input",function(){let p=this.value;p.length>1&&p.startsWith("0")&&(this.value=p.replace(/^0+/,""),this.value===""&&(this.value="0"));let y=parseInt(this.value)||0;y>h.max?(this.value=h.max,T(this)):y<=h.min&&(this.value=h.min,T(this))}))})}function R(r,t,e){const i=document.getElementById("const-column-template"),o=document.querySelectorAll(`${e.CONSTELLATION_TABLE} tbody tr`),n=r.poolStandardCharSSR,s=r.poolCharSR;o.forEach(a=>{const l=document.createDocumentFragment(),u=a.dataset.rarity;a.dataset.validationType="row-sum",a.dataset.targetSum=u==="5"?n:s;for(let c=0;c<t.constellationColumns;c++){const d=i.content.cloneNode(!0),h=d.querySelector("input");if(c===t.constellationColumns-1){const p=u==="5"?n:s;h.value=p}h.addEventListener("input",()=>C(a)),h.addEventListener("input",function(){h.value.length>1&&h.value.startsWith("0")&&(h.value=h.value.replace(/^0+/,"")),h.value===""&&(h.value="0")}),l.appendChild(d)}a.appendChild(l),H(a),C(a)})}function H(r){const t=document.createElement("div");t.className="row-progress-bar",r.appendChild(t)}function C(r){const t=r.querySelectorAll("input"),e=parseInt(r.dataset.targetSum);let i=0;t.forEach(s=>{i+=parseInt(s.value)||0});const o=r.querySelector(".row-progress-bar"),n=Math.min(i/e*100,100);o.style.width=n+"%",n<60||i>e?o.style.background="rgba(244, 67, 54, 0.3)":n<80?o.style.background="rgba(241, 244, 54, 0.3)":o.style.background="rgba(54, 244, 79, 0.3)"}function N(r){const t=document.querySelectorAll("#rate-up-table select");if(t.length===0)return;const e=r.map(i=>`<option value="${i.value}">${i.text}</option>`).join("");t.forEach(i=>{i.innerHTML=e,i.value="unknown"})}function it(r,t=null){const e=document.querySelector('[data-control="probability"]'),i=document.querySelector('[data-control="pulls"]');t?(e.value=t.targetProb||r.probability,i.value=t.targetPull||r.pulls):(e.value=r.probability,i.value=r.pulls),e.addEventListener("input",function(){let o=this.value;o.length>1&&o.startsWith("0")&&(this.value=o.replace(/^0+/,""),this.value===""&&(this.value="0"));let n=parseInt(this.value)||0;n>100?(this.value="100",T(this)):n===0&&(this.value="0")}),i.addEventListener("input",function(){let o=this.value;o.length>1&&o.startsWith("0")&&(this.value=o.replace(/^0+/,""),this.value===""&&(this.value="0"));let n=parseInt(this.value)||0;n>9999?this.value="9999":n<1&&(this.value="1")})}function T(r){r.style.borderColor="#a71919",r.style.outline="1px solid #a71919",r.classList.add("flicker"),setTimeout(()=>{r.classList.remove("flicker"),r.style.borderColor="",r.style.outline=""},500)}function nt(r,t,e){const i=[];for(let n=0;n<r.length;n++){let s=0;for(const[a,l]of r[n].offRates)s+=l.prob;s=(s*100).toFixed(2),s>0&&i.push({name:t[n],probability:s,p10:e[n].LOWER_BOUND,mean:e[n].MEAN,p90:e[n].UPPER_BOUND,color:"#3498db"})}const o=document.querySelector("#probability-table tbody");o.innerHTML="",i.forEach(n=>{const s=document.createElement("tr"),a=n.probability;s.innerHTML=`
      <td>${n.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${a}%;background:${n.color}">
            <div class="progress-label">${n.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${n.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${n.mean.toFixed(1)}</td>
      <td class="cashback-value">${n.p90.toFixed(1)}</td>
    `,o.appendChild(s)})}function q(r,t){r.forEach(e=>{const i=document.querySelector(`${t.PITY_TABLE} tr[data-banner="${e.banner}"]`);i&&(i.querySelector('[data-control="pity-4"]').value=e.pity4,i.querySelector('[data-control="pity-5"]').value=e.pity5,i.querySelector(".guarantee-4").checked=e.guarantee4,i.querySelector(".guarantee-5").checked=e.guarantee5,e.caprad&&i.querySelector('[data-control="capRad"]')&&(i.querySelector('[data-control="capRad"]').value=e.caprad),e.epPath&&i.querySelector('[data-control="epPath"]')&&(i.querySelector('[data-control="epPath"]').value=e.epPath))})}function x(r,t){document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`).forEach((i,o)=>{const n=r[o];n&&i.querySelectorAll("td:nth-child(n+2) input").forEach((a,l)=>{n[l]!==void 0&&(a.value=n[l])})})}function M(r){if(!r||!Array.isArray(r))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((e,i)=>{r[i]!==void 0&&(e.value=r[i])})}function k(){document.querySelectorAll(".help-btn").forEach(t=>{t.classList.toggle("hidden")})}function ot(r,t,e,i){const o=document.getElementById("import-file-input");if(!o){console.error("Import file input not found!");return}const n=s=>U(s,r,t,e,i);o.removeEventListener("change",o.__handleFile),o.addEventListener("change",n),o.__handleFile=n}async function U(r,t,e,i,o){const n=r.target.files[0];if(n)try{const s=await n.text(),a=JSON.parse(s);let l=null;a.exportFormat==="GachaCalculatorData"?l=a:e&&(l=e(a)),l?($(l,o),i.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(s){console.error("File import error:",s)}finally{r.target.value=""}}function $(r,t){r.pity&&q(r.pity,t),r.constellation&&x(r.constellation,t)}function rt(r){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:r.getPityData(),constellation:r.getConstellationData()},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(i),n=document.createElement("a");n.href=o;const s=new Date().toISOString().slice(0,10);n.download=`gachaCalc-data-${s}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),console.log("Data exported successfully.")}function st(r,t=null){const e=new A(r,t);return e.initialize(),e}function at(r,t=null){return new _(r,t).initialize()}class A{constructor(t,e=null){this.pathsConfig=t,this.savedData=e,this.groupColorMap=new Map,this.rowsContainer=document.querySelector(".rows-container"),this.addButton=document.getElementById("add-btn"),this.COLORS={UNIQUE_GROUP:"#f0f0f0",PRESET_HUES:[0,120,240,60,180,300]}}initialize(){this.rowsContainer.innerHTML="",this.savedData&&this.savedData.pullPlan?this.savedData.pullPlan.forEach(t=>{this.rowsContainer.appendChild(this.createRow(null,t))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())})}createRow(t=null,e=null){const i=this.createRowElement();return this.setupRowEvents(i),this.initializeRowData(i,t,e),i}createRowElement(){return document.getElementById("row-template").content.cloneNode(!0).querySelector(".row")}setupRowEvents(t){const e=t.querySelector(".dropdown"),i=t.querySelector(".type-selector");this.setupDropdownHandler(t,e,i),this.setupTypeChangeHandler(t,i),this.setupButtonHandlers(t)}setupDropdownHandler(t,e,i){e.addEventListener("click",o=>{o.stopPropagation(),e.classList.toggle("dropdown--open")}),t.querySelectorAll(".dropdown__item").forEach(o=>{o.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation(),i.value=o.dataset.value,i.dispatchEvent(new Event("change")),e.classList.remove("dropdown--open")})}),document.addEventListener("click",o=>{e.contains(o.target)||e.classList.remove("dropdown--open")})}setupTypeChangeHandler(t,e){e.addEventListener("change",()=>{const i=e.options[e.selectedIndex],o=t.querySelector(".type-icon"),n=t.querySelector(".type-text");o.src=i.dataset.icon,n.textContent=i.textContent,this.updatePathSelector(t,e.value),this.handleTypeChangeGroupUpdate(t,e.value)})}handleTypeChangeGroupUpdate(t,e){const i=t.dataset.group;i&&!i.startsWith("unique")&&(t.dataset.group=`unique${e.charAt(0).toUpperCase()+e.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP))}setupButtonHandlers(t){t.querySelector(".btn--chainAdd").addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow(t))}),t.querySelector(".btn--delete").addEventListener("click",()=>{this.handleRowDeletion(t)})}handleRowDeletion(t){const e=t.dataset.group;e&&!e.startsWith("unique")&&Array.from(this.rowsContainer.querySelectorAll(".row")).filter(o=>o.dataset.group===e).length===1&&this.groupColorMap.delete(e),t.remove()}initializeRowData(t,e,i){i?this.initializeFromSavedData(t,i):e?this.initializeFromParent(t,e):this.initializeNewRow(t)}initializeFromSavedData(t,e){const i=t.querySelector(".type-selector");i.value=e.type||"char",this.updateVisualType(t,i.value),this.setGroupAndColor(t,e.group),this.updatePathSelector(t,i.value,e.from,e.to)}initializeFromParent(t,e){const i=e.dataset.group,o=e.querySelector(".type-selector").value,n=e.querySelector(".second-select").value,s=t.querySelector(".type-selector");s.value=o,this.updateVisualType(t,o),i.startsWith("unique")?this.convertToNewGroup(e,t):this.inheritExistingGroup(t,i),this.updatePathSelector(t,o,n)}convertToNewGroup(t,e){const i=this.generateNewGroupId(),o=this.getHueForGroup(i);[t,e].forEach(n=>{n.dataset.group=i,n.style.setProperty("--group-color",`hsl(${o}, 80%, 70%)`)}),this.groupColorMap.set(i,o)}inheritExistingGroup(t,e){t.dataset.group=e;const i=this.groupColorMap.get(e);i!==void 0&&t.style.setProperty("--group-color",`hsl(${i}, 80%, 70%)`)}initializeNewRow(t){const i=t.querySelector(".type-selector").value;t.dataset.group=`unique${i.charAt(0).toUpperCase()+i.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP),this.updatePathSelector(t,i)}updateVisualType(t,e){const i=t.querySelector(".type-selector"),o=i.options[i.selectedIndex],n=t.querySelector(".type-icon"),s=t.querySelector(".type-text");n.src=o.dataset.icon,s.textContent=o.textContent}updatePathSelector(t,e,i=null,o=null){const n=t.querySelector(".first-select"),s=t.querySelector(".second-select"),a=this.pathsConfig[e]||this.pathsConfig.char;this.populateSelect(n,a.slice(0,-1)),this.populateSelect(s,a.slice(1)),this.setInitialPathValues(n,s,a,i,o)}populateSelect(t,e){t.innerHTML="",e.forEach(i=>{const o=document.createElement("option");o.value=i,o.textContent=i,t.appendChild(o)})}setInitialPathValues(t,e,i,o,n){if(o&&i.includes(o)){t.value=o;const s=i.indexOf(o);e.value=n&&i.includes(n)&&i.indexOf(n)>s?n:i[Math.min(s+1,i.length-1)]}else t.value=i[0],e.value=i[1]}generateNewGroupId(){const t=Array.from(this.groupColorMap.keys()).map(e=>parseInt(e.replace(/\D/g,""))).filter(e=>!isNaN(e)).sort((e,i)=>e-i);for(let e=1;e<=t.length+1;e++)if(!t.includes(e))return`group${e}`;return`group${t.length+1}`}getHueForGroup(t){const e=parseInt(t.replace(/\D/g,""));return e<=this.COLORS.PRESET_HUES.length?this.COLORS.PRESET_HUES[e-1]:e*137.5%360}setGroupAndColor(t,e){if(t.dataset.group=e,e.startsWith("unique"))t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP);else{let i=this.groupColorMap.get(e);i===void 0&&(parseInt(e.replace(/\D/g,"")),i=this.getHueForGroup(e),this.groupColorMap.set(e,i)),t.style.setProperty("--group-color",`hsl(${i}, 80%, 70%)`)}}getState(){return Array.from(this.rowsContainer.querySelectorAll(".row")).map(e=>({type:e.querySelector(".type-selector").value,from:e.querySelector(".first-select").value,to:e.querySelector(".second-select").value,group:e.dataset.group}))}}class _ extends A{constructor(t,e=null){super(t,e||null)}initialize(){return this.rowsContainer.innerHTML="",this.savedData&&this.savedData.pullPlan?this.savedData.pullPlan.forEach((t,e)=>{const i={...t,pity:this.savedData.pity4?.[e]||0,guarantee:this.savedData.guarantee4?.[e]||!1};this.rowsContainer.appendChild(this.createRow(null,i))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())}),this}createRow(t=null,e=null){const i=super.createRow(t,e);return this.addPityGuaranteeToRow(i,e),i}addPityGuaranteeToRow(t,e){const i=t.querySelector('[data-control="pity-4"]'),o=t.querySelector(".guarantee-4");e&&(i&&e.pity!==void 0&&(i.value=e.pity),o&&e.guarantee!==void 0&&(o.checked=e.guarantee)),i.addEventListener("input",function(){let n=this.value;n.length>1&&n.startsWith("0")&&(this.value=n.replace(/^0+/,""),this.value===""&&(this.value="0"));let s=parseInt(this.value)||0;s>10?(this.value=10,E(this)):s<0&&(this.value=0,E(this))})}}function E(r){r.style.borderColor="#a71919",r.style.outline="1px solid #a71919",r.classList.add("flicker"),setTimeout(()=>{r.classList.remove("flicker"),r.style.borderColor="",r.style.outline=""},500)}function lt(r=null){const t=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]'),i=document.querySelectorAll(".mode-label");let o;r?o=r:o="probability",n(),i.forEach(s=>{s.addEventListener("click",function(){o=this.getAttribute("data-target"),n()})}),t.addEventListener("input",function(){o="probability",n()}),e.addEventListener("input",function(){o="pulls",n()});function n(){i.forEach(s=>{const a=s.getAttribute("data-target")===o;s.classList.toggle("active",a)})}}function ct(){const r=document.getElementById("expand-button"),t=document.getElementById("expandedMenu");let e=null;r&&r.addEventListener("click",()=>{r.classList.toggle("dropdown--open"),t.classList.toggle("active")});const i=document.querySelectorAll(".nav-button");i.forEach(n=>{n.addEventListener("dragstart",function(s){e=this;const a=this.getBoundingClientRect(),l=s.clientX-a.left,u=s.clientY-a.top;s.dataTransfer.setDragImage(this,l,u),setTimeout(()=>{this.classList.add("dragging")},0)}),n.addEventListener("dragend",function(){this.classList.remove("dragging"),e=null,i.forEach(s=>{s.classList.remove("drop-zone")})}),n.addEventListener("dragover",function(s){s.preventDefault(),e&&e!==this&&this.classList.add("drop-zone")}),n.addEventListener("dragleave",function(){this.classList.remove("drop-zone")}),n.addEventListener("drop",function(s){if(s.preventDefault(),this.classList.remove("drop-zone"),e&&e!==this){const a=e.parentNode,l=this.parentNode,u=document.createElement("div"),c=document.createElement("div");a.insertBefore(u,e),l.insertBefore(c,this),a.insertBefore(this,u),l.insertBefore(e,c),a.removeChild(u),l.removeChild(c),D()}})}),z();const o=document.querySelector(".nav-container");o.style.opacity="1"}function D(){const r=document.querySelector(".nav-list"),t=document.querySelector(".nav-container--expanded .nav-list"),e={main:Array.from(r.children).slice(0,-1).map(i=>i.querySelector(".nav-button").getAttribute("href")),expanded:Array.from(t.children).map(i=>i.querySelector(".nav-button").getAttribute("href"))};localStorage.setItem("navOrder",JSON.stringify(e))}function z(){const r=JSON.parse(localStorage.getItem("navOrder"));if(!r)return;const t=document.querySelector(".nav-list"),e=document.querySelector(".nav-container--expanded .nav-list"),i=t.lastElementChild,o=new Map;document.querySelectorAll("li").forEach(s=>{const a=s.querySelector(".nav-button");a&&o.set(a.getAttribute("href"),s)}),Array.from(t.children).slice(0,-1).forEach(s=>s.remove()),e.innerHTML="",r.main.forEach(s=>{const a=o.get(s);a&&t.insertBefore(a,i)}),r.expanded.forEach(s=>{const a=o.get(s);a&&e.appendChild(a)})}const v={TABLES:1,CALCULATIONS:1,PULL_PLANS:1,BUTTONS:1};function ut(r,t){if(!r)throw new Error("Persistence factory requires a namespace.");const e={TABLES:`gacha_tables_${r}_v1`,CALCULATIONS:`gacha_calc_${r}_v1`,PULL_PLANS:`gacha_plans_${r}_v1`,BUTTONS:"gacha_buttons_${namespace}_v1"};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(i){this._save(e.CALCULATIONS,{_schema:v.CALCULATIONS,...i})},loadCalculation(){return this._validate(this._load(e.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(e.TABLES,{_schema:v.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(e.TABLES),"TABLES")},saveButtons(){this._save(e.BUTTONS,{_schema:v.BUTTONS,isHidden:this.areButtonsHidden()})},loadButtons(){return this._load(e.BUTTONS)},getPityData(){return Array.from(document.querySelectorAll(`${t.PITY_TABLE} tbody tr`)).map(i=>({banner:i.dataset.banner,...i.querySelector('[data-control="pity-4"]')&&{pity4:i.querySelector('[data-control="pity-4"]').value},...i.querySelector('[data-control="pity-5"]')&&{pity5:i.querySelector('[data-control="pity-5"]').value},...i.querySelector(".guarantee-4")&&{guarantee4:i.querySelector(".guarantee-4").checked},...i.querySelector(".guarantee-5")&&{guarantee5:i.querySelector(".guarantee-5").checked},...i.querySelector('[data-control="capRad"]')&&{caprad:i.querySelector('[data-control="capRad"]').value},...i.querySelector('[data-control="epPath"]')&&{epPath:i.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`)).map(i=>Array.from(i.querySelectorAll("td:nth-child(n+2) input")).map(o=>o.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(i=>i.value)},areButtonsHidden(){return document.querySelector(".help-btn").classList.contains("hidden")},setupTableListeners(){const i=[`${t.PITY_TABLE} input`,`${t.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(i).forEach(o=>{o.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(i,o){try{localStorage.setItem(i,JSON.stringify(o))}catch(n){console.error("Storage error:",n),this._handleStorageError()}},_load(i){try{const o=localStorage.getItem(i);return o?JSON.parse(o):null}catch(o){return console.error("Load error:",o),null}},_validate(i,o){return i?typeof i._schema>"u"?i:i._schema!==v[o]?(console.warn(`Schema version mismatch for ${o}`),null):i:null},_handleStorageError(){Object.values(e).forEach(i=>{try{localStorage.removeItem(i)}catch(o){console.error("Cleanup failed:",o)}})}}}class ht{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",e=>{if(e.target.matches('input[type="number"]'))try{e.target.select()}catch(i){console.warn("Could not select text in input.",i)}},{capture:!0}),t.addEventListener("keydown",e=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(e.key)||(e.ctrlKey||e.metaKey)&&["a","c","v","x"].includes(e.key.toLowerCase())||/^\d$/.test(e.key)||e.preventDefault()}),t.addEventListener("input",e=>{const i=e.target,o=i.closest("table");if(o)switch(o.id){case"constellation-table":{const n=i.closest("tr");n&&this.validateRowSum(n),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(i=>{i.querySelectorAll('input[type="number"]').forEach((o,n)=>{t[n]+=parseInt(o.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const i=this.constellationMap[e.value];i!==void 0&&t[i]++}),t}validateRowSum(t){if(!t.dataset.targetSum)return;const e=parseFloat(t.dataset.targetSum),i=t.querySelectorAll('input[type="number"]');let o=0;i.forEach(n=>o+=parseFloat(n.value)||0),i.forEach(n=>n.classList.toggle("is-invalid",o!==e))}validateRateUpEligibility(){const t=this.getRateUpUsage(),e=this.availableConstellationCounts.map((i,o)=>t[o]>i);document.querySelectorAll("#rate-up-table select.custom-select").forEach(i=>{const o=this.constellationMap[i.value],n=o!==void 0&&e[o];i.classList.toggle("is-invalid",n)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const i of t)if(!this.isIndividualInputValid(i))return!1;const e=document.querySelectorAll("#constellation-table tbody tr");for(const i of e)if(!this.isRowSumValid(i))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const e=parseInt(t.value,10),i=parseInt(t.min,10),o=parseInt(t.max,10);return(!t.hasAttribute("min")||e>=i)&&(!t.hasAttribute("max")||e<=o)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const e=parseFloat(t.dataset.targetSum),i=t.querySelectorAll('input[type="number"]');let o=0;return i.forEach(n=>o+=parseFloat(n.value)||0),o===e}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((e,i)=>t[i]>e)}}function dt(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",e=>{if(!e.target.matches(".tab-link[data-tab-target]"))return;const i=e.target,o=i.closest(".tab-panel-card"),n=i.dataset.tabTarget,s=o.querySelector(n);if(!s){console.error(`Tab target not found: ${n}`);return}o.querySelectorAll(".tab-link").forEach(a=>a.classList.remove("active")),o.querySelectorAll(".tab-pane").forEach(a=>a.classList.remove("active")),i.classList.add("active"),s.classList.add("active")})})}class pt{constructor(t){this.tourSteps=[],this.currentTourStepIndex=0,this.isTourActive=!1,this.isShowingHelp=!1,this.pausedTourStepIndex=-1,this.currentHighlightedElement=null,this.observers=null,this.currentDisplayConfig=null,this.boundHandleWindowResize=this.handleReposition.bind(this),this.boundHandleHighlightUpdate=this.handleHighlightUpdate.bind(this),this.container=document.createElement("div"),this.container.id="chibi-container",this.container.innerHTML=`
            <div class="chibi-tutorial-overlay-piece" data-overlay="top"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="bottom"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="left"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="right"></div>
        `,this.container.innerHTML+=t,document.body.appendChild(this.container),this.overlays={top:this.container.querySelector('[data-overlay="top"]'),bottom:this.container.querySelector('[data-overlay="bottom"]'),left:this.container.querySelector('[data-overlay="left"]'),right:this.container.querySelector('[data-overlay="right"]')},this.chibiGroup=this.container.querySelector(".chibi-group"),this.bubbleText=this.container.querySelector(".bubble-text"),this.nextButton=this.container.querySelector(".btn--tutorial_next"),this.endButton=this.container.querySelector(".btn--tutorial_end"),this.handleNext=this.handleNext.bind(this),this.hide=this.hide.bind(this),this.handleReposition=this.handleReposition.bind(this),this.nextButton.addEventListener("click",this.handleNext),this.endButton.addEventListener("click",this.hide)}startTour(t){if(localStorage.setItem("tutorialSeen","true"),!t||t.length===0){console.error("ChibiTutorial: No steps provided for the tour.");return}this.tourSteps=t,this.pausedTourStepIndex===-1?this.currentTourStepIndex=0:(this.currentTourStepIndex=this.pausedTourStepIndex,this.pausedTourStepIndex=-1),this.isTourActive=!0,this.isShowingHelp=!1,this.nextButton.textContent=">>",this.endButton.style.display="inline-block",this.#r(),this.showTourStep(this.currentTourStepIndex)}showTourStep(t){if(t>=this.tourSteps.length){this.hide();return}const e=this.tourSteps[t];this.showDisplay(e)}showTutorialIfNeeded(t){localStorage.getItem("tutorialSeen")||this.startTour(t)}showDisplay(t){this.currentDisplayConfig=t,this.#i(),this.chibiGroup.classList.remove("chibi-on-left"),t.chibiSide==="left"&&this.chibiGroup.classList.add("chibi-on-left");const e=this.container.querySelector(".bubble-wrapper");e.classList.remove("bubble-wrapper--big","bubble-wrapper--small");const i=t.size;i&&e.classList.add(`bubble-wrapper--${i}`),this.bubbleText.innerHTML=t.text,this.container.style.display="block",this.container.style.height=`${document.documentElement.scrollHeight}px`;let o=null,n=!1;if(t.clickTab){const s=document.querySelector(t.clickTab);s?(s.dispatchEvent(new Event("click",{bubbles:!0})),n=!0):console.warn(`ChibiTutorial: Tab button not found for selector "${t.clickTab}".`)}if(t.action==="click"){const s=document.querySelector(t.element);s?(s.dispatchEvent(new Event("click",{bubbles:!0})),n=!0):console.error(`ChibiTutorial: Element not found for selector "${t.element}" to perform action "${t.action}".`)}if(t.element){o=document.querySelector(t.element);const s=document.querySelector(".tutorial-chibi");if(this.#t(o),!o){console.error(`ChibiTutorial: Element not found for selector "${t.element}". Skipping display.`),this.isTourActive&&this.handleNext();return}n&&setTimeout(()=>{this.currentHighlightedElement=o,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement)},50);const a=[o,this.chibiGroup,s];this.#n(a)}else this.#t(null),this.chibiGroup.scrollIntoView({behavior:"smooth",block:"nearest"});window.addEventListener("resize",this.boundHandleWindowResize)}#n(t){if(t.length===0)return;const e=this.getCombinedBoundingRect(t),i=document.createElement("div");i.style.cssText=`
        position: absolute;
        top: ${e.top}px;
        height: ${e.height}px;
        pointer-events: none;
        visibility: hidden;
    `,document.body.appendChild(i),i.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>{document.body.removeChild(i)},1e3)}getCombinedBoundingRect(t){const e=t.map(l=>l.getBoundingClientRect()),i=Math.min(...e.map(l=>l.left)),o=Math.min(...e.map(l=>l.top)),n=Math.max(...e.map(l=>l.right)),s=Math.max(...e.map(l=>l.bottom)),a=10;return{top:o+window.pageYOffset-a,left:i+window.pageXOffset-a,width:n-i+a*2,height:s-o+a*2,right:n+window.pageXOffset+a,bottom:s+window.pageYOffset+a}}hide(){this.container.style.display="none",this.chibiGroup.classList.remove("chibi-on-left"),this.#i(),this.#s(),this.currentDisplayConfig=null,this.isShowingHelp||(this.isTourActive=!1,this.currentTourStepIndex=0,this.pausedTourStepIndex=-1),this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block",window.removeEventListener("resize",this.boundHandleWindowResize)}#i(){this.currentHighlightedElement&&(this.observers&&this.observers.targetObserver&&this.observers.targetObserver.unobserve(this.currentHighlightedElement),this.currentHighlightedElement.classList.remove("chibi-tutorial-focused-element"),this.currentHighlightedElement=null)}handleNext(){this.isTourActive?(this.currentTourStepIndex++,this.showTourStep(this.currentTourStepIndex)):this.isShowingHelp?(this.hide(),this.pausedTourStepIndex!==-1&&this.startTour(this.tourSteps)):this.hide()}showHelp(t,e=null){if(!t){console.warn("ChibiTutorial: No help configuration provided.");return}let i=null;if(t.tourStepId){const o=this.tourSteps.findIndex(n=>n&&n.id===t.tourStepId);if(o!==-1)i={...this.tourSteps[o]};else if(console.warn(`ChibiTutorial: Tour step with ID '${t.tourStepId}' not found.`),t.text)i={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""};else return}else t.text&&(i={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""});!i.element&&e&&(i.element=e),i&&(this.isTourActive&&(this.pausedTourStepIndex=this.currentTourStepIndex,this.isTourActive=!1),this.isShowingHelp=!0,this.nextButton.textContent="OK",this.endButton.style.display="none",this.showDisplay(i))}handleHighlightUpdate(){window.requestAnimationFrame(()=>{if(!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp)return;this.container.style.height=`${document.documentElement.scrollHeight}px`;const t=this.currentHighlightedElement.getBoundingClientRect(),e={top:t.top+window.scrollY,bottom:t.bottom+window.scrollY,left:t.left+window.scrollX,right:t.right+window.scrollX,width:t.width,height:t.height};this.#e(e)})}handleReposition(){window.requestAnimationFrame(()=>{!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp||(this.container.style.height=`${document.documentElement.scrollHeight}px`,this.#t(this.currentHighlightedElement))})}#t(t){if(t===null){const e=window.innerWidth,i=window.innerHeight,o=window.scrollX||window.pageXOffset,n=window.scrollY||window.pageYOffset,s=this.chibiGroup.getBoundingClientRect(),a=s.width,l=s.height,u=o+(e-a)/2,c=n+(i-l)/2;this.chibiGroup.style.left=`${u}px`,this.chibiGroup.style.top=`${c}px`,this.chibiGroup.style.transform="",this.#e(t)}else{this.container.style.height=`${document.documentElement.scrollHeight}px`;const e=t.getBoundingClientRect(),i={top:e.top+window.scrollY,bottom:e.bottom+window.scrollY,left:e.left+window.scrollX,right:e.right+window.scrollX,width:e.width,height:e.height};this.#e(i),this.#o(i)}}#o(t){const e=this.currentDisplayConfig||{},i=document.querySelector(".tutorial-chibi"),o=this.chibiGroup.getBoundingClientRect(),n=i.getBoundingClientRect(),s=[this.chibiGroup,i],a=this.getCombinedBoundingRect(s),l=10;let u;window.innerWidth<900||window.innerWidth<620?e.position==="top"?u="top":u="bottom":u=e.position||"bottom";let c,d;switch(u){case"top":c=t.top-a.height+l,d=t.left+t.width/2-a.width/2;break;case"right":c=t.top+t.height/2-a.height/2+l/2,d=t.right+l;break;case"left":c=t.top+t.height/2-a.height/2+l/2,d=t.left-a.width+l;break;default:c=t.bottom+l,d=t.left+t.width/2-a.width/2;break}n.left<o.left&&(d=d-(n.left-o.left)),n.top<o.top&&(c=c-n.top+o.top),(d+a.width>window.innerWidth||d<l)&&(d=l),this.chibiGroup.style.left=`${d}px`,this.chibiGroup.style.top=`${c}px`,this.chibiGroup.style.transform=""}#e(t){if(!t){this.overlays.top.style.cssText="width: 100%; height: 100%;",this.overlays.bottom.style.cssText="width: 0; height: 0;",this.overlays.left.style.cssText="width: 0; height: 0;",this.overlays.right.style.cssText="width: 0; height: 0;";return}this.overlays.left.style.cssText=`top: 0; left: 0; width: ${t.left}px; height: 100%;`,this.overlays.right.style.cssText=`top: 0; left: ${t.right}px; width: calc(100% - ${t.right}px); height: 100%;`,this.overlays.top.style.cssText=`top: 0; left: ${t.left}px; width: ${t.width}px; height: ${t.top}px;`,this.overlays.bottom.style.cssText=`top: ${t.bottom}px; left: ${t.left}px; width: ${t.width}px; height: calc(100% - ${t.bottom}px);`}#r(){this.observers={targetObserver:new ResizeObserver(this.boundHandleHighlightUpdate),bodyObserver:new ResizeObserver(this.boundHandleHighlightUpdate),mutationObserver:new MutationObserver(this.boundHandleHighlightUpdate)},this.observers.bodyObserver&&this.observers.bodyObserver.observe(document.body),this.observers.mutationObserver&&this.observers.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0})}#s(){this.observers&&(this.observers.targetObserver&&this.observers.targetObserver.disconnect(),this.observers.bodyObserver&&this.observers.bodyObserver.disconnect(),this.observers.mutationObserver&&this.observers.mutationObserver.disconnect(),this.observers=null)}showError(t,e=".pull-plan-section"){const i={text:`<p style="color: #ff6b6b;">${t}</p>`,element:e,position:"left",chibiSide:"left",size:"small"};this.showHelp(i)}}const f=(r,t=!1)=>r?t?r.checked:parseInt(r.value)||0:null;function ft(r,t,e,i){const o=document.getElementById("pity-panel"),n=document.getElementById("constellation-panel"),s=t.paths;if(!o||!n)return console.error("Required tab panels not found. Cannot get page configuration."),null;const a=(b,S)=>{if(!S)return[];const w=S.querySelector("#constellation-table");if(!w)return console.warn("Could not find the constellation table inside the panel:",S),[];const P=w.querySelectorAll(`tr[data-rarity="${b}"] .custom-input`);return Array.from(P).map(O=>parseInt(O.value)||0)},l=o.querySelector(`${e.PITY_ROW}[data-banner="character"]`),u=o.querySelector(`${e.PITY_ROW}[data-banner="weapon"]`),c=G(s),d={},h={},p={},y={},m={};return i.isCharacter&&(d.char=f(l.querySelector('[data-control="pity-5"]')),h.char=f(l.querySelector('[data-control="pity-4"]')),p.char=f(l.querySelector(".guarantee-5"),!0),y.char=f(l.querySelector(".guarantee-4"),!0),i.isCapRad&&(m.capRad=f(l.querySelector('[data-control="capRad"]')))),i.isWeapon&&(d.wep=f(u.querySelector('[data-control="pity-5"]')),h.wep=f(u.querySelector('[data-control="pity-4"]')),p.wep=f(u.querySelector(".guarantee-5"),!0),y.wep=f(u.querySelector(".guarantee-4"),!0),i.isEpitPath&&(m.epitPath=f(u.querySelector('[data-control="epPath"]')))),{SSR:{pity:d,guarantee:p,special:m,consCountStandard:a(5,n),pullPlan:c.typeArray,cashbackRoadmap:c.cashbackArray},SR:{pity:h,guarantee:y,rateUps:W(),consCount:a(4,n)}}}function yt(){const r=document.querySelectorAll(".row"),t=[];return Array.from(r).slice(1).forEach(i=>{const o=i.dataset.group,n=i.querySelector(".type-selector")?.value||"char",s=i.querySelector(".first-select")?.value||"None",a=i.querySelector(".second-select")?.value||"None";t.push({group:o,type:n,from:s,to:a})}),{pullPlan:t}}function G(r){const t=document.querySelectorAll(".row"),e=[],i=[],o=Array.from(t).slice(1);let n=0;return o.forEach(s=>{const a=s.querySelector(".type-selector")?.value||"char",l=s.querySelector(".first-select")?.value||"None",u=s.querySelector(".second-select")?.value||"None",c=a==="char"?r.char:r.wep,d=c.indexOf(l),h=c.indexOf(u);if(d===-1||h===-1||d>=h)return;const p=h-d;let y=d,m=0;for(let b=0;b<p;b++)a==="char"&&y===0?m="none":m="regular",e.push({type:a,bannerCount:n}),i.push(m),y++;n++}),{typeArray:e,cashbackArray:i}}function mt(r){const t=document.querySelectorAll(".row"),e=Array.from(t).slice(1);let i=["None"];const o=r.char,n=r.wep;return e.forEach(s=>{const a=s.querySelector(".type-selector")?.value||"char",l=s.querySelector(".first-select")?.value||"None",u=s.querySelector(".second-select")?.value||"None",c=a==="char"?o:n,d=c.indexOf(l),h=c.indexOf(u);if(d===-1||h===-1||d>=h)return;const p=c.slice(d+1,h+1);i.push(...p)}),i}function W(){const r=document.querySelectorAll("#rate-up-table select.custom-select");let t=[];return r.length===0?(console.error("Could not find any rate-up select elements."),[]):(r.forEach(e=>{const i=e.value;i!=="unknown"&&(i!==void 0?t.push(i):console.warn(`Invalid or unhandled rate-up value found: "${i}"`))}),t)}function gt(){const r=document.querySelector(".mode-label.active").getAttribute("data-target");if(r==="probability")return{type:r,value:parseInt(document.querySelector('[data-control="probability"]').value)/100};if(r==="pulls")return{type:r,value:parseInt(document.querySelector('[data-control="pulls"]').value)}}let g=null;function F(){const r=document.getElementById("myChart").getContext("2d");g=new Chart(r,{type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{color:"#b8c2d0",callback:function(t){return(t*100).toFixed(0)+"%"}},grid:{color:"rgba(58, 58, 106, 0.5)"},beginAtZero:!0,min:0,max:1},x:{ticks:{color:"#b8c2d0"},grid:{color:"rgba(58, 58, 106, 0.5)"}}},plugins:{legend:{labels:{color:"#f5f5f5",sort:(t,e)=>t.datasetIndex-e.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(t){let e=t.dataset.label||"";return e&&(e+=": "),e+=(t.parsed.y*100).toFixed(2)+"%",e}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function V(r){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[r%t.length]}function j(r){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(r-2)%t.length]}function bt(r,t,e){g||F();const i=r.length,o=e.slice(1);g.data.labels=t,g.data.datasets=r.map((n,s)=>{const a=s===0?"#2196F3":s===1?"#4CAF50":V(s);return{label:o[s],data:n,borderColor:a,backgroundColor:s===0?"rgba(33, 150, 243, 0.1)":s===1?"rgba(76, 175, 80, 0.1)":j(s),fill:!0,tension:.4,order:i-s,borderWidth:3,pointRadius:0,pointHoverRadius:5}}),g.update()}function vt(r){let t=r[0].length,e=Array.from({length:t-1},()=>Array.from({length:r.length+1},()=>0)),i=[0];for(let o=0;o<r.length;o++){let n=0;for(const c of r[o])n+=c;let s=0;const a=o+1;i.push(a);const l=r[o],u=l.length-1;for(let c=u;c>0;c--)s+=l[c],e[c-1][a]=s/n}return{data:e,labels:i}}function St(r){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=Y(r,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=X(r,parseInt(document.querySelector('[data-control="pulls"]').value))}function Y(r,t){t===100&&(t=99.9);let e=r.length-1,i=!0,o=0,n=0;for(;i;)r[e][n]>t/100&&(o=n,i=!1),n++;return o}function X(r,t){let e=r.length-1;return r[e].length<=t?100:Math.round(r[e][t]*100)}function Tt(r,t){for(const e of r){const i=L(e.rateUps);if(!J(i,t)){e.probability=0;continue}const o=I(i,t),n=K(r,t);e.probability=n===0?0:o/n}}function L(r){const t={};for(let e=0;e<r.length;e++){const i=r[e];i>0&&(t[e]=i)}return t}function J(r,t){return Object.entries(r).every(([e,i])=>t[e]>=i)}function I(r,t){return Object.entries(r).reduce((e,[i,o])=>e*Q(t[i],o),1)}function K(r,t){return r.reduce((e,i)=>{const o=L(i.rateUps),n=I(o,t);return e+n},0)}function Q(r,t){if(t<0||t>r)return 0;if(t===0||t===r)return 1;t=Math.min(t,r-t);let e=1;for(let i=1;i<=t;i++)e*=(r-t+i)/i;return e}function wt(r,t){if(!Number.isInteger(r)||r<0)throw new Error("Number of trials (n) must be a non-negative integer.");let e=0,i=0,o=[],n=1;for(;e<=r;)i=n*Math.pow(t,e)*Math.pow(1-t,r-e),o.push(i),e++,n=n*(r+1-e)/e;return o}class Ct{constructor(t,e,i){this.initialState=[...t],this.totalItems=e,this.config=i,this.maxType=i.maxType,this.nTypes=t.length,this.points=Array(this.nTypes).fill(0);for(let o=1;o<this.maxType;o++)this.points[o]=i.regularPoints;this.points[this.maxType]=i.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let t=0;t<this.nTypes;t++)for(let e=0;e<this.nTypes;e++)this.stateSecondMoments[t][e]=this.initialState[t]*this.initialState[e];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const t=this.totalItems;this.step++;let e=0,i=0;for(let l=0;l<this.nTypes;l++){const u=this.expected[l]/t;e+=this.points[l]*u,i+=this.points[l]**2*u}let o=0;for(let l=0;l<this.nTypes;l++)o+=this.points[l]*this.pointStateCrossMoments[l];o/=t;const n=this.secondMoment+2*o+i,s=this.mean+e,a=n-s**2;return this.results.push({mean:s,variance:a}),this.updateState(),this.secondMoment=n,this.mean=s,this.variance=a,{mean:s,variance:a,step:this.step}}updateState(){const t=this.totalItems,e=Array(this.nTypes).fill(0);for(let n=0;n<this.maxType;n++)e[n]=this.expected[n]*(t-1)/t;e[this.maxType]=this.expected[this.maxType];for(let n=0;n<this.maxType;n++)e[n+1]+=this.expected[n]/t;const i=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let n=0;n<this.nTypes;n++)for(let s=0;s<this.nTypes;s++)i[n][s]=this.stateSecondMoments[n][s];for(let n=0;n<this.maxType;n++){const s=Array(this.nTypes).fill(0);s[n]=-1,s[n+1]=1;for(let a=0;a<this.nTypes;a++)for(let l=0;l<this.nTypes;l++)i[a][l]+=1/t*(s[a]*this.stateSecondMoments[n][l]+s[l]*this.stateSecondMoments[a][n]+s[a]*s[l]*this.expected[n])}const o=Array(this.nTypes).fill(0);for(let n=0;n<this.nTypes;n++){let s=this.pointStateCrossMoments[n];n<this.maxType&&(s-=this.pointStateCrossMoments[n]/t),n>=1&&(s+=this.pointStateCrossMoments[n-1]/t);let a=0;for(let l=0;l<this.nTypes;l++)a+=this.points[l]*this.stateSecondMoments[n][l];s+=a/t,n<this.maxType&&(s-=this.points[n]*this.expected[n]/t),n>=1&&(s+=this.points[n-1]*this.expected[n-1]/t),o[n]=s}this.expected=e,this.stateSecondMoments=i,this.pointStateCrossMoments=o}runSteps(t){this.reset();for(let e=0;e<t;e++)this.computeStep();return this.results}}export{pt as C,ht as D,Ct as I,Z as a,vt as b,ut as c,yt as d,mt as e,ft as f,gt as g,dt as h,tt as i,ot as j,et as k,rt as l,ct as m,st as n,it as o,nt as p,at as q,St as r,lt as s,Tt as t,bt as u,wt as v};
