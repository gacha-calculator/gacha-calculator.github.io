import{c as G,C as j,D as J,a as Z,r as Q,b as X,u as tt,g as et,e as at,m as nt,k as ot,p as B,n as q,s as D,q as rt,I,o as st}from"./solvers-CRsSns9y.js";/* empty css               */import{i as lt}from"./tabs-NGdgaCH9.js";import{p as O,a as it,e as ct,c as _,d as z,s as ut,n as pt,b as ft}from"./common-helpers-CPLJV1Gy.js";const M=[.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.04,.065,.09,.115,.14,.165,.19,.215,.24,1],ht=.085,x={maxCharacterConstelation:5,rateUpCharacterSR:2,poolStandardCharSSR:40,poolCharSR:23,configSR:{maxType:6,regularPoints:.3,specialPoints:.7},configSSR:{maxType:6,regularPoints:1.2,specialPoints:2.8},paths:{char:["None","p0","p1","p2","p3","p4","p5"]},pity:{pitySSR:M.length,pitySR:10},default:0},bt=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"p0",text:"P0"},{value:"p1",text:"P1"},{value:"p2",text:"P2"},{value:"p3",text:"P3"},{value:"p4",text:"P4"},{value:"p5",text:"P5"},{value:"new",text:"New Character"}],dt={none:0,p0:1,p1:2,p2:3,p3:4,p4:5,p5:6},yt={CHARACTER:"character"},T={PITY_ROW:"[data-banner]",CONSTELLATION_ROW:"[data-rarity]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},L={pitySettings:{[yt.CHARACTER]:{pity4:0,pity5:0}},isCharacter:!0,isWeapon:!1,isSpecial:!1,constellationColumns:7},H={probability:70,pulls:76};function mt(e,o,a){gt(o.pity),Ct(o),vt();const n=e.loadTables();n&&(kt(n.pity),Rt(n.constellation),wt(n.rateUps),a.validateAll()),e.init()}function gt(e){const o=document.getElementById("pity-row-template"),a=document.querySelector(`${T.PITY_TABLE} tbody`);Object.entries(L.pitySettings).forEach(([t,r])=>{const s=o.content.cloneNode(!0).querySelector("tr");s.dataset.validationType="individual";const i=s.querySelector('[data-control="pity-5"]');i&&(i.min=0,i.max=e.pitySSR-1),s.dataset.banner=t,s.querySelector(".banner-name").textContent=t,s.querySelector('[data-control="pity-5"]').value=r.pity5,a.appendChild(s)});const n=document.querySelector("#pity-table");n&&n.querySelectorAll('tbody tr input[type="number"]').forEach(t=>t.addEventListener("input",function(){let r=this.value;r.length>1&&r.startsWith("0")&&(this.value=r.replace(/^0+/,""),this.value===""&&(this.value="0"));let s=parseInt(this.value)||0;s>t.max?(this.value=t.max,F(this)):s<=t.min&&(this.value=t.min,F(this))}))}function F(e){e.style.borderColor="#a71919",e.style.outline="1px solid #a71919",e.classList.add("flicker"),setTimeout(()=>{e.classList.remove("flicker"),e.style.borderColor="",e.style.outline=""},500)}function Ct(e){const o=document.getElementById("const-column-template"),a=document.querySelectorAll(`${T.CONSTELLATION_TABLE} tbody tr`),n=e.poolStandardCharSSR,t=e.poolCharSR;a.forEach(r=>{const s=document.createDocumentFragment(),i=r.dataset.rarity;r.dataset.validationType="row-sum",r.dataset.targetSum=i==="5"?n:t;for(let u=0;u<L.constellationColumns;u++){const l=o.content.cloneNode(!0),c=l.querySelector("input");if(u===L.constellationColumns-1){const p=i==="5"?n:t;c.value=p}c.addEventListener("input",()=>V(r)),c.addEventListener("input",function(){c.value.length>1&&c.value.startsWith("0")&&(c.value=c.value.replace(/^0+/,"")),c.value===""&&(c.value="0")}),s.appendChild(l)}r.appendChild(s),St(r),V(r)})}function St(e){const o=document.createElement("div");o.className="row-progress-bar",e.appendChild(o)}function V(e){const o=e.querySelectorAll("input"),a=parseInt(e.dataset.targetSum);let n=0;o.forEach(s=>{n+=parseInt(s.value)||0});const t=e.querySelector(".row-progress-bar"),r=Math.min(n/a*100,100);t.style.width=r+"%",r<60||n>a?t.style.background="rgba(244, 67, 54, 0.3)":r<80?t.style.background="rgba(241, 244, 54, 0.3)":t.style.background="rgba(54, 244, 79, 0.3)"}function vt(){const e=document.querySelectorAll("#rate-up-table select");if(e.length===0)return;const o=bt.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");e.forEach(a=>{a.innerHTML=o,a.value="unknown"})}function kt(e){e.forEach(o=>{const a=document.querySelector(`${T.PITY_TABLE} tr[data-banner="${o.banner}"]`);a&&(a.querySelector('[data-control="pity-5"]').value=o.pity5,a.querySelector(".guarantee-5").checked=o.guarantee5)})}function Rt(e){document.querySelectorAll(`${T.CONSTELLATION_TABLE} tbody tr`).forEach((a,n)=>{const t=e[n];t&&a.querySelectorAll("td:nth-child(n+2) input").forEach((s,i)=>{t[i]!==void 0&&(s.value=t[i])})})}function wt(e){if(!e||!Array.isArray(e))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,n)=>{e[n]!==void 0&&(a.value=e[n])})}function At(e){const{cashbackCalculator:o,uiUpdater:a}=e;return function(t){const{results:r,inputConfig:s,chartLabels:i,gachaConfig:u,CONSTELLATION_MAP:l}=t,c=o(s,u,r.cashbackData.SSR,r.cashbackData.SR,s.SR.rateUps,l);a(r.cashbackData.SSR,i,c)}}const E=(e,o=!1)=>e?o?e.checked:parseInt(e.value)||0:null;function Tt(e,o,a,n){const t=document.getElementById("pity-panel"),r=document.getElementById("constellation-panel"),s=o.paths;if(!t||!r)return console.error("Required tab panels not found. Cannot get page configuration."),null;const i=(b,y)=>{if(!y)return[];const C=y.querySelector("#constellation-table");if(!C)return console.warn("Could not find the constellation table inside the panel:",y),[];const A=C.querySelectorAll(`tr[data-rarity="${b}"] .custom-input`);return Array.from(A).map(g=>parseInt(g.value)||0)},u=t.querySelector(`${a.PITY_ROW}[data-banner="character"]`),{planConfigs:l,pity4:c,guarantee4:p}=Pt(s),d={},f={},h={};return n.isCharacter&&(d.char=E(u.querySelector('[data-control="pity-5"]')),f.char=E(u.querySelector(".guarantee-5"),!0)),{SSR:{pity:d,guarantee:f,special:h,consCountStandard:i(5,r),pullPlan:l.typeArray,cashbackRoadmap:l.cashbackArray},SR:{pity:c,guarantee:p,rateUps:xt(),consCount:i(4,r)}}}function Et(){const e=document.querySelectorAll(".row"),o=[],a=[],n=[];return Array.from(e).slice(1).forEach(r=>{const s=r.dataset.group,i=E(r.querySelector('[data-control="pity-4"]')),u=E(r.querySelector(".guarantee-4"),!0),l=r.querySelector(".type-selector")?.value||"char",c=r.querySelector(".first-select")?.value||"None",p=r.querySelector(".second-select")?.value||"None";a.push(i),n.push(u),o.push({group:s,type:l,from:c,to:p})}),{pullPlan:o,pity4:a,guarantee4:n}}function Pt(e){const o=document.querySelectorAll(".row"),a={},n=[],t=[],r=[],s=[],i=Array.from(o).slice(1);let u=0;return i.forEach(l=>{const c=E(l.querySelector('[data-control="pity-4"]')),p=E(l.querySelector(".guarantee-4"),!0);r.push(c),s.push(p);const d=l.querySelector(".type-selector")?.value||"char",f=l.querySelector(".first-select")?.value||"None",h=l.querySelector(".second-select")?.value||"None",b=d==="char"?e.char:e.wep,y=b.indexOf(f),C=b.indexOf(h);if(y===-1||C===-1||y>=C)return;const A=C-y;let g=y,S=0;for(let m=0;m<A;m++)d==="char"&&g===0?S="none":S="regular",n.push({type:d,bannerCount:u}),t.push(S),g++;u++}),a.typeArray=n,a.cashbackArray=t,{planConfigs:a,pity4:r,guarantee4:s}}function xt(){const e=document.querySelectorAll("#rate-up-table select.custom-select");let o=[];return e.length===0?(console.error("Could not find any rate-up select elements."),[]):(e.forEach(a=>{const n=a.value;n!=="unknown"&&(n!==void 0?o.push(n):console.warn(`Invalid or unhandled rate-up value found: "${n}"`))}),o)}const Ot=`
    <div class="chibi-group">
        <div class="bubble-wrapper bubble-wrapper--big">
            <svg class="bubble-svg-background" viewBox="0 0 1820 858" xmlns="http://www.w3.org/2000/svg">
                <path style="fill:#232338; stroke:#0b091b; stroke-width: 1px"
                    d="M 787.500 1.005 C 640.632 4.659, 524.925 15.685, 414 36.596 C 305.731 57.006, 229.612 80.375, 165.037 113.026 C 88.008 151.975, 38.939 199.840, 15.519 258.874 C 8.496 276.575, 3.327 301.798, 0.941 330 C -2.027 365.084, 6.008 405.046, 22.959 439.500 C 43.249 480.744, 73.516 513.346, 120 544.028 C 209.228 602.924, 363.734 646.238, 553 665.416 C 650.260 675.270, 808.209 681.908, 948.500 682.035 C 999.011 682.081, 1061.358 683.505, 1068.623 684.778 C 1072.726 685.497, 1072.776 685.559, 1079.177 698 C 1096.318 731.313, 1116.859 760.237, 1136.746 779.061 C 1155.047 796.384, 1181.968 815.466, 1202.839 825.908 C 1232.446 840.721, 1273.797 852.517, 1310.770 856.698 C 1324.340 858.232, 1326.511 858.262, 1330.270 856.962 C 1332.596 856.158, 1334.500 855.138, 1334.500 854.696 C 1334.500 854.254, 1331.125 852.760, 1327 851.377 C 1314.484 847.179, 1287.809 833.665, 1277.295 826.195 C 1265.925 818.116, 1226.275 778.561, 1216.635 765.680 C 1206.358 751.947, 1188.566 715.606, 1185.906 702.916 C 1185.282 699.937, 1183.944 693.900, 1182.931 689.500 C 1181.919 685.100, 1180.809 679.883, 1180.464 677.906 L 1179.836 674.312 1189.168 673.673 C 1234.976 670.533, 1307.910 662.018, 1358.500 653.902 C 1387.862 649.192, 1405.290 645.828, 1437.500 638.654 C 1443.550 637.306, 1457.500 634.310, 1468.500 631.995 C 1491.435 627.169, 1506.239 623.528, 1520.500 619.205 C 1526 617.538, 1538.150 614.072, 1547.500 611.504 C 1604.081 595.961, 1658.813 573.047, 1691.807 551.088 C 1716.705 534.517, 1726.861 526.038, 1752.999 500 C 1782.013 471.097, 1799.115 442.990, 1810.458 405.568 C 1814.346 392.741, 1819 366.582, 1819 357.554 C 1819 354.499, 1819.450 352, 1820 352 C 1821.274 352, 1821.299 340.366, 1820.046 330.791 C 1819.521 326.781, 1818.582 319.225, 1817.959 314 C 1809.521 243.236, 1771.421 185.672, 1703 140.314 C 1640.860 99.120, 1548.917 64.910, 1443 43.576 C 1339.978 22.824, 1215.062 9.498, 1072 3.996 C 994.931 1.032, 848.352 -0.509, 787.500 1.005 M 776 4.600 C 771.325 4.777, 754 5.405, 737.500 5.995 C 561.542 12.295, 402.823 35.450, 277.947 73.040 C 210.624 93.305, 153.205 120.092, 109 151.857 C 80.401 172.408, 53.246 200.489, 37.044 226.269 C 19.796 253.711, 10.505 280.375, 6.026 315.288 C 1.913 347.340, 4.080 374.322, 13.106 403.467 C 26.641 447.170, 50.753 482.527, 90 516.224 C 101.716 526.283, 126.303 543.639, 138.425 550.406 C 140.926 551.802, 146.466 554.925, 150.736 557.345 C 194.368 582.071, 259.942 606.163, 334.540 624.875 C 473.407 659.708, 622.538 674.025, 888 678.008 C 1034.249 680.203, 1070.594 680.938, 1073.423 681.757 C 1075.031 682.222, 1076.681 683.255, 1077.088 684.051 C 1077.496 684.848, 1079.729 689.325, 1082.051 694 C 1091.185 712.393, 1108.924 740.328, 1121.008 755.350 C 1129.418 765.805, 1144.301 780.492, 1156.104 789.986 C 1170.999 801.967, 1195.222 817.726, 1208.500 824.072 C 1231.867 835.241, 1272.170 847.555, 1298 851.418 C 1323.491 855.230, 1327.055 855.493, 1319.528 853.009 C 1311.535 850.371, 1284.081 836.370, 1276.055 830.838 C 1260.944 820.423, 1225.667 785.179, 1211.929 766.772 C 1201.655 753.007, 1184.830 717.485, 1182.499 704.638 C 1181.787 700.712, 1180.261 693.675, 1179.109 689 C 1176.730 679.347, 1176.376 672.148, 1178.250 671.514 C 1178.938 671.282, 1190.300 670.164, 1203.500 669.029 C 1239.066 665.973, 1275.315 662.018, 1309.500 657.465 C 1360.426 650.682, 1388.027 645.725, 1449 632.411 C 1463.025 629.349, 1479.778 625.754, 1486.229 624.424 C 1492.681 623.093, 1501.906 620.694, 1506.729 619.093 C 1511.553 617.492, 1527.169 612.983, 1541.432 609.074 C 1573.458 600.295, 1586.835 595.827, 1618.030 583.493 C 1644.114 573.179, 1671.994 559.215, 1688.966 547.965 C 1703.153 538.560, 1722.730 523.374, 1729.500 516.522 C 1732.800 513.182, 1739.501 506.636, 1744.391 501.975 C 1758.521 488.506, 1771.430 473.645, 1779.115 462 C 1788.491 447.791, 1793.962 437.449, 1800.288 421.977 C 1815.087 385.778, 1819.761 344.986, 1813.433 307.269 C 1804.545 254.291, 1779.063 209.320, 1736.709 171.866 C 1691.153 131.580, 1625.043 98.185, 1538.202 71.592 C 1418.757 35.015, 1261.222 14.066, 1048 6.407 C 1008.502 4.988, 802.012 3.616, 776 4.600 M 0.355 344.500 C 0.352 349.450, 0.521 351.601, 0.731 349.280 C 0.940 346.959, 0.943 342.909, 0.736 340.280 C 0.530 337.651, 0.358 339.550, 0.355 344.500"
                </svg>
            <div class="bubble-text"> </div>
        <img src="/images/37_chibi.png" alt="Tutorial Assistant" class="tutorial-chibi">
        </div>
        <button class="btn btn--tutorial_next">>></button>
        <button class="btn btn--tutorial_end">x</button>
    </div>`,Lt=[{text:"<p>Welcome to the Gacha Calculator! Let me show you around.</p>",size:"small"},{id:"pity-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>First, you need to input your current pity and guarantees here.</p>",position:"right"},{id:"pull-plan-step",element:".pull-plan-section",text:"<p>Next, build your pull plan here. Add all the characters and weapons in order you want to get them.</p>",position:"left",chibiSide:"left"},{id:"target-step",element:".header-controls",text:"<p>Now you need to set your target, either the confidence level you want, for example 70% chance of getting all planned items, or your pull budget.</p>",position:"top",chibiSide:"left",size:"big"},{id:"calculate-button-step",element:"#calculate-btn",text:"<p>Once your plan and target are set, press Calculate!</p>",position:"right",size:"small"},{element:".chart-wrapper",text:"<p>You'll get a chart showing the probability of success for each number of pulls until 100%.</p>",position:"top"},{id:"constellation-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>Owned characters constellations are needed for accurate cashback, if you only need character pull chance you can leave it for now.</p>",position:"right"},{id:"rate-ups-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#rateup-panel"]',text:"<p>If you know the 4*, you can then check what constelation it has on your account, entering these will help cashback accuracy and reduce unneeded computation. If you know the banner you are going to pull will have a new 4* character(that isn't available now), use new character option.</p>",position:"right",size:"huge"},{element:"#probability-table",text:"<p>And down here, you can see a detailed table with cashback estimates. Good luck!</p>",position:"top"}],K={"pity-input-step":{tourStepId:"pity-input-step"},"constellation-input-step":{tourStepId:"constellation-input-step"},"pull-plan-step":{tourStepId:"pull-plan-step"},"calculate-button-step":{tourStepId:"calculate-button-step"},"import-help":{element:".tab-panel-card",text:'<p>Click the "Import Data" button and paste the exported JSON data.</p>',position:"right",size:"small"},"export-help":{element:".tab-panel-card",text:"<p>You can export your pity data as a JSON file to make a reserve copy or to carry over data when you are switching to a different browser/new device.</p>",position:"right",size:"big"},"pity-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>You can input your current pity and guarantees here, as well as Capturing Radiance and Epitomized Path points. You can import data from paimon.moe directly.</p>",position:"right",size:"big"},"constelation-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>You can insert how many characters of every constelation you have, it's necessary to provide accurate cashback prediction.</p>",position:"right",size:"big"},"rate-up-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#rateup-panel"]',text:"<p>If you know the 4*, you can then check what constelation it has on your account, entering these will help cashback accuracy and reduce unneeded computation. If you know the banner you are going to pull will have a new 4* character(that isn't available now), use new character option.</p>",position:"right",size:"huge"},"pull-plan-help":{element:".pull-plan-section",text:"<p>Build your pull plan here. Add all the characters and weapons in order you want to get them.</p>",position:"left",chibiSide:"left"},"target-help":{element:".header-controls",text:"<p>Here you need to set your target, either the confidence level you want, for example 70% chance of getting all planned items, or your pull budget.</p>",position:"top",chibiSide:"left",size:"big"},"cashback-help":{element:"#probability-table",text:"<p>Expected cashback for each 5* target reached with their respective probabilities, percentiles give you a reasonable range by cutting off extreme results(10% from each side).</p>",size:"big",chibiSide:"left",position:"top"}};class It{constructor(o){this.parts=o,this.persistence=G("reverse",T);const a=At({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn});this.tutorial=new j(Ot);const n={getPageConfiguration:Tt,getLabels:at,getPullPlan:Et,getTarget:et,updateChart:tt,convertToChartData:X,recalcInputs:Q,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:T,INITIAL_CONFIG:L},postCalculationHooks:[a],persistence:this.persistence,chibi:this.tutorial};this.validator=new J(this.parts.CONSTELLATION_MAP),this.calculationHandler=new Z(n),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn"),this.toggleButtonsBtn=document.getElementById("toggle-buttons-btn")}initialize(){this.validator.initialize(),mt(this.persistence,this.parts.gachaConfig,this.validator),lt(),this.#t(),this.#a()}#t(){nt(),this.calculateBtn&&this.calculateBtn.addEventListener("click",async()=>{this.#e()&&await this.calculationHandler.runCalculation()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>ot(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(Lt)}),document.querySelectorAll(".help-btn").forEach(a=>{a.addEventListener("click",n=>{n.preventDefault();const t=a.getAttribute("data-help-key")||a.getAttribute("data-tour-step-id");if(t&&K[t]){const r=K[t];this.tutorial.showHelp(r,a)}else console.warn(`ChibiTutorial: No help configuration found for key '${t}'.`,a)})}),this.toggleButtonsBtn&&this.toggleButtonsBtn.addEventListener("click",()=>{document.querySelectorAll(".help-btn").forEach(n=>{n.classList.toggle("hidden")}),this.persistence.saveButtons()})}#e(){if(document.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll(),this.validator.isRowPityValid();const o=document.querySelectorAll(".is-invalid"),a=new Set;o.forEach(t=>{const r=t.closest(".tab-pane");if(r){const s=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);s&&a.add(s)}t.classList.add("flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})}),a.forEach(t=>{t.classList.add("is-invalid","flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})});const n=Array.from(a)[0];return n&&n.click(),setTimeout(()=>{o[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const o=this.persistence.loadCalculation(),a=o?o.input:null;o?(B(this.parts.gachaConfig.paths,a),q(H,o),D(o.persistInput)):(B(this.parts.gachaConfig.paths),q(H),D()),this.calculationHandler.runCalculation()}}const w=1e-10;function Mt(e,o,a){const n=e.length-2;let t=e.length-1,r=e[t-1].bannerCount+1,s=Array.from({length:r},()=>({pullsSum:0,rankUpSum:0})),i=Array(r).fill(0);Ut(e,s);for(let u=n;u>=0;u--)e[u].isEmpty||(qt(o,u,e,a,0,i),Nt(s,i));return s}function Ut(e,o){for(let a=0;a<e.length-1;a++){let n=e[a].bannerCount,t=0;for(let r=0;r<e[a].states.length;r++)for(const[s,i]of e[a].states[r])t+=i.prob;o[n].pullsSum+=t}}function Nt(e,o){for(let a=0;a<e.length;a++)e[a].rankUpSum=o[a]}function Bt(e,o,a){const n=e.length-2;for(let t=n;t>=0;t--){const r=e[t];r.isEmpty||_t(o,t,e,a,r.type)}}function qt(e,o,a,n,t,r){const s=a[o].states.length;let i=.5;const u=a[o].states,l=a[o].bannerCount,c=a[o+1].states;for(let p=s-2;p>=0;p--){const d=u[p],f=p>=n,h=e[p-n*f];for(const[b,y]of d){const C=y.prob*h,A=y.prob-C;let g=C;if(g>w){f||(g*=i);const m=c[t],v=m.get(b);v?v.prob+=g:m.set(b,{prob:g}),r[l]+=g}if(!f){let m=C*(1-i);if(m>w){let v=b+1;const k=u[n],R=k.get(v);R?R.prob+=m:k.set(v,{prob:m})}}let S=A;if(S>w){const m=u[p+1],v=m.get(b);v?v.prob+=S:m.set(b,{prob:S})}y.prob=0}}return r}function Dt(e,o,a){let n;for(let t=0;t<e.length;t++){const r=a[t].pullsSum,s=a[t].rankUpSum,i=r-s,u=e[t].length-1;for(let l=u;l>=0;l--){const c=e[t][l].states;for(let p=1;p>=0;p--){n=p===1;let d=c[p];if(d.length===11){for(let f=9;f>=0;f--)for(const[h,b]of d[f]){const y=b.prob;if(y*r>w){b.prob=y*(1-r);let A=!1;f===9&&(A=!0);let g=o;A&&(g=1);const S=y*g*i,m=y*(1-g)*i,v=y*s;if(S>w){let k=S;if(n||(k*=.5),e[t][l+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][l+1].states[0].set(h,{prob:k});else{const R=e[t][l+1].states[0],P=R.get(h);P?P.prob+=k:R.set(h,{prob:k})}if(!n){let R=h+1;const P=c[1],N=P.get(R);N?N.prob+=k:P.set(R,{prob:k})}}if(m>w){const k=c[p][f+1],R=k.get(h);R?R.prob+=m:k.set(h,{prob:m})}if(v>w){const k=c[0][10],R=k.get(h);R?R.prob+=v:k.set(h,{prob:v})}}}d=d[10]}for(const[f,h]of d){const b=h.prob;if(b*r>w){const C=b*o*i,A=b*(1-o)*i+b*s;if(h.prob=b*(1-r)+A,C>w){let g=C;if(n||(g*=.5),e[t][l+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][l+1].states[0].set(f,{prob:g});else{const S=e[t][l+1].states[0],m=S.get(f);m?m.prob+=g:S.set(f,{prob:g})}if(!n){let S=f+1;const m=c[1],v=m.get(S);v?v.prob+=g:m.set(S,{prob:g})}}}}}}}}function _t(e,o,a,n,t){const r=a[o].states.length;let s=.5;const i=a[o].states,u=a[o+1].states;for(let l=r-2;l>=0;l--){const c=i[l],p=l>=n,d=e[l-n*p],f=c*d,h=c-f;let b=f;if(b>w&&(p||(b*=s),u[t]+=b),!p){let C=f*(1-s);C>w&&(i[n]+=C)}let y=h;y>w&&(i[l+1]+=y),i[l]=0}}function zt(e,o,a){if(!Array.isArray(e.SSR.pullPlan))throw new Error("Invalid pull plan");const{pullPlan:n}=e.SSR,t=[];for(let s=0;s<n.length;s++)t.push({states:Array.from({length:a},()=>new Map),isEmpty:!0,bannerCount:n[s].bannerCount});return t.push({states:Array.from({length:1},()=>new Map)}),r(o),t;function r(s){t[0].states[s].set(0,{prob:1}),t[0].isEmpty=!1}}function Ht(e,o){return{SSR:e.SSR.pity.char+e.SSR.guarantee.char*o.pitySSR}}function Ft(e){const o=e.SSR.pullPlan,a=o.length-1,n=o[a].bannerCount;let t=[];for(let r=0;r<=n;r++){const s=e.SR.pity[r];let i=!0;s===10&&(i=!1);let u=0;e.SR.guarantee[r]&&(u=1),i?u?(t.push([{states:[new Map,Array.from({length:11},()=>new Map)]}]),t[r][0].states[u][s].set(0,{prob:1})):(t.push([{states:[Array.from({length:11},()=>new Map),new Map]}]),t[r][0].states[u][s].set(0,{prob:1})):(t.push([{states:[new Map,new Map]}]),t[r][0].states[u].set(0,{prob:1}))}return t}function Vt(e){let o=[];for(let a of e)for(let n=0;n<a.length;n++)for(let t=0;t<a[n].states.length;t++)if(Array.isArray(a[n].states[t]))for(let r=0;r<a[n].states[t].length;r++)for(let[s,i]of a[n].states[t][r])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(s,{prob:i.prob});else{const u=o[n].states[t],l=u.get(s);l?l.prob+=i.prob:u.set(s,{prob:i.prob})}else for(let[r,s]of a[n].states[t])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(r,{prob:s.prob});else{const i=o[n].states[t],u=i.get(r);u?u.prob+=s.prob:i.set(r,{prob:s.prob})}return o}function Kt(e){let o=0;for(let t of e)o+=t.pullsSum;if(Math.abs(o-1)>1e-5)for(let t of e)t.pullsSum/=o,t.rankUps/=o}function Wt(e,o){let a=[],n={},t=!1,r=!1,s=x.pity.pitySSR*2+1;const i=Ht(e,x.pity);let u=zt(e,i.SSR,s),l=Ft(e),c=0;const p=10;for(;!r&&!t;){if(n=Mt(u,M,x.pity.pitySSR),Kt(n),Dt(l,ht,n),c++,c===p){O(u);for(let h of l)O(h);c=0}a.push(it(u)),t=ct(u,o,a.length),t||(r=_(u,t))}if(!c===p){O(u);for(let h of l)O(h)}l=Vt(l);const d={SSR:z(u),SR:z(l)};for(ut(u),l=null;!r;)t&&(c++,Bt(u,M,x.pity.pitySSR),c===p&&pt(u),a.push(ft(u)),r=_(u,t));return{chartData:a,cashbackData:d}}class U{constructor(o,a,n){this.rateUps=o,this.offRates=a,this.probability=n}}function $t(e,o,a){const n=[],t=new Array(a).fill(0);function r(s,i){if(s===a){if(i===o){const l=W(t,e);n.push(new U([...t],l))}return}const u=Math.min(e[s],o-i);for(let l=0;l<=u;l++)t[s]=l,r(s+1,i+l),t[s]=0}return r(0,0),n}function W(e,o){const a=[...o];for(let n=0;n<e.length;n++)a[n]-=e[n];return a}function Yt(e,o,a){const n=new Array(Object.keys(a).length).fill(0);for(const t of o)if(t==="new")e[0]++,n[0]++;else{const r=a[t];r!==void 0?n[r]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return n}function Gt(e,o,a){const n=e.length,t=a.reduce((l,c)=>l+c,0),r=o-t;if(r<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(n);for(let l=0;l<n;l++)if(s[l]=e[l]-a[l],s[l]<0)return console.error(`Error: Known picks for constellation ${l} exceed its capacity.`),[];return $t(s,r,n).map(l=>{const c=l.rateUps.map((d,f)=>d+a[f]),p=W(c,e);return new U(c,p)})}function jt(e,o,a){const n=o.map((s,i)=>s-a[i]),t=new Map;for(const s of e){const i=s.rateUps.map((l,c)=>l-a[c]);if(i.some(l=>l<0)){s.probability=0;continue}const u=new U(i,[]);t.set(u,s)}const r=Array.from(t.keys());r.length>0&&rt(r,n);for(const[s,i]of t.entries())i.probability=s.probability}function Jt(e,o,a){let n=o[e.rateUpCount],t=a[e.charOffRateCount];return{mean:n+t.mean,variance:t.variance}}function Zt(e){const a=Math.sqrt(e.variance),n=1/Math.sqrt(.2);let t=e.mean-a*n;t<0&&(t=0);const r=e.mean+a*n,s=e.mean;return{LOWER_BOUND:t,MEAN:s,UPPER_BOUND:r}}function Qt(e,o){const a=[];let n=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries()){const i=r;s.prob>o&&(a.push({rateUpCount:t,charOffRateCount:i,probability:s.prob}),n=Math.max(n,i))}return{combos:a,maxOffRateCount:n}}function Xt(e,o){const a=[];let n=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries())s.prob>o&&(a.push({rateUpCount:t,offRateCount:r,probability:s.prob}),n=Math.max(n,r));return{combos:a,maxOffRateCount:n}}function te(e,o,a){let n=0,t=0;for(const{rateUpCount:r,offRateCount:s,probability:i}of e){const u=o[r],l=a[s],c=u.mean+l.mean,p=u.variance+l.variance+Math.pow(c,2);n+=i*c,t+=i*p}return{mean:n,variance:Math.max(0,t-Math.pow(n,2))}}function $(e){let o=0,a=0;for(const{probability:n,cashback:t}of e)o+=n*t.mean;for(const{probability:n,cashback:t}of e){const r=t.variance+Math.pow(t.mean,2);a+=n*r}return{mean:o,variance:Math.max(0,a-Math.pow(o,2))}}const Y=1e-8;function ee(e,o,a,n,t,r){a=ae(a),t=Yt(e.SR.consCount,t,r);const s=Gt(e.SR.consCount,o.rateUpCharacterSR,t);jt(s,e.SR.consCount,t);const i=ne(a,o.poolStandardCharSSR,e.SSR.consCountStandard,e.SSR.cashbackRoadmap,o),u=oe(s,n,o),l=i;for(let c=0;c<l.length;c++)l[c].mean+=u.mean,l[c].variance+=u.variance,l[c]=Zt(l[c]);return l}function ae(e){let o=0;for(const a of e)for(const[n,t]of a.offRates)o+=t.prob;for(const a of e)for(const[n,t]of a.offRates)t.prob/=o;return e}function ne(e,o,a,n,t){const{combos:r,maxOffRateCount:s}=Qt(e,Y),i=[0];let u=0;for(let c=0;c<e.length;c++)n[c-1]==="none"?i.push(u):n[c-1]==="regular"&&(u+=t.configSSR.regularPoints,i.push(u));const l=Array.from({length:e.length},()=>[]);for(const c of r){const p=c.rateUpCount,d=c.probability,h=new I(a,o,t.configSSR).runSteps(s),b=Jt(c,i,h);l[p].push({cashback:b,probability:d})}for(let c=0;c<l.length;c++){const p=se(l[c]);l[c]=$(p)}return l}function oe(e,o,a){const{combos:n,maxOffRateCount:t}=Xt(o,Y);return re(e,n,t,a)}function re(e,o,a,n){const t=Math.max(...o.map(s=>s.rateUpCount)),r=[];for(const{rateUps:s,offRates:i,probability:u}of e){const c=new I(s,n.rateUpCharacterSR,n.configSR).runSteps(t),d=new I(i,n.poolCharSR-n.rateUpCharacterSR,n.configSR).runSteps(a),f=te(o,c,d);r.push({probability:u,cashback:f})}return $(r)}function se(e){let o=0;for(const a of e)o+=a.probability;for(const a of e)a.probability/=o;return e}document.addEventListener("DOMContentLoaded",()=>{const e={gachaConfig:x,CONSTELLATION_MAP:dt,runCalcFn:Wt,cashbackFn:ee,updateTableFn:st};new It(e).initialize()});
