import{c as F,b as z}from"./solvers-C1my91Sf.js";function j(a){const{cashbackCalculator:i,uiUpdater:r}=a;return function(t){const{results:o,inputConfig:n,chartLabels:c,gachaConfig:m,CONSTELLATION_MAP:s}=t,l=i(n,m,o.cashbackData.SSR,o.cashbackData.CharSR,o.cashbackData.WepSR,n.SR.rateUps,s);r(o.cashbackData.SSR,c,l)}}class q{constructor(i,r={}){this.config=i,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...r}}async runGachaCalculation(i,r){this.adapters.contexts.contextSSR.target=r;let e=[],t={},o=!1,n=!1;const{ssrWorker:c,srWorker:m}=this.adapters.workerManager.getWorkers(),s=this.adapters.distributionArrays.sortPity(i);this.adapters.contexts.contextSSR.pities=s;let{distributionSSR:l}=this.adapters.distributionArrays.makeSSR(i,s),{distributionCharSR:f,distributionWepSR:R}=this.adapters.distributionArrays.makeSR(i);console.profile();try{await x(c,m,this.adapters.contexts,l,{distributionCharSR:f,distributionWepSR:R},s)}catch(p){console.error("Failed to initialize workers:",p)}let u=await g(c);for(u.type==="IterationComplete"?t=u.lossData:(t=u.lossData,o=u.isTarget,n=u.isEmpty,e=u.allPullsDistributionSSR,l=u.distributionSSR);!n&&!o;)E(t),[u]=await Promise.all([g(c),A(m,t)]),u.type==="IterationComplete"?t=u.lossData:(t=u.lossData,o=u.isTarget,n=u.isEmpty,e=u.allPullsDistributionSSR,l=u.distributionSSR);E(t);let S=await P(m,t);this.adapters.workerManager.terminateWorkers(),f=S.distributionCharSR,R=S.distributionWepSR;const O={SSR:this.adapters.helpers.consolidateDistributionForCashback(l),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(R)};for(this.adapters.helpers.simplifyDistribution(l),n=this.adapters.helpers.checkIsEmpty(l,o),f=null,R=null;!n;)o&&(this.adapters.pullLogic.rankUpSSRCheap(l,s),this.adapters.helpers.normalizeCheap(l),e.push(this.adapters.helpers.consolidateProbabilitiesCheap(l)),n=this.adapters.helpers.checkIsEmpty(l,o));const v=e;return console.profileEnd(),{chartData:v,cashbackData:O};async function x(p,h,k,b,{distributionCharSR:w,distributionWepSR:T}){return new Promise((L,N)=>{let M=!1,W=!1,C=!1;function D(){!C&&M&&W&&L()}function I(d){C||(C=!0,N(d))}p.onerror=d=>{console.error("Worker error:",d),I(d)},h.onerror=d=>{I(d)},p.onmessage=function(d){switch(d.data.type){case"InitComplete":M=!0,D();break;default:console.warn("Unknown message type")}},h.onmessage=function(d){switch(d.data.type){case"InitComplete":W=!0,D();break;default:console.warn("Unknown message type")}},p.postMessage({type:"Initiate",distribution:b,context:k}),h.postMessage({type:"Initiate",distribution:{distributionCharSR:w,distributionWepSR:T},context:k})})}function g(p){return new Promise((h,k)=>{p.onmessage=b=>{switch(b.data.type){case"IterationComplete":h(b.data);break;case"LastIteration":h(b.data);break}},p.onerror=k,p.postMessage({type:"Iterate"})})}function A(p,h){return new Promise((k,b)=>{p.onmessage=w=>{k()},p.onerror=b,p.postMessage({type:"Iterate",lossData:h})})}function P(p,h){return new Promise((k,b)=>{p.onmessage=w=>{k(w.data)},p.onerror=b,p.postMessage({type:"IterateLast",lossData:h})})}function E(p){const h=p.charRankUps.pullsSum+p.wepRankUps.pullsSum;Math.abs(h-1)>1e-5&&(p.charRankUps.pullsSum/=h,p.charRankUps.rankUps/=h,p.wepRankUps.pullsSum/=h,p.wepRankUps.rankUps/=h)}}}function _(a){return new Worker("/assets/ssr-worker-CueXEJR2.js",{type:"module",name:a?.name})}function H(a){return new Worker("/assets/sr-worker--OdvKUzV.js",{type:"module",name:a?.name})}class G{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new _),this.srWorker||(this.srWorker=new H),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class y{constructor(i,r,e){this.rateUps=i,this.offRates=r,this.probability=e}}function K(a,i,r){const e=[],t=new Array(r).fill(0);function o(n,c){if(n===r){if(c===i){const s=U(t,a);e.push(new y([...t],s))}return}const m=Math.min(a[n],i-c);for(let s=0;s<=m;s++)t[n]=s,o(n+1,c+s),t[n]=0}return o(0,0),e}function U(a,i){const r=[...i];for(let e=0;e<a.length;e++)r[e]-=a[e];return r}function $(a,i,r){const e=new Array(Object.keys(r).length).fill(0);for(const t of i)if(t==="new")a[0]++,e[0]++;else{const o=r[t];o!==void 0?e[o]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return e}function Z(a,i,r){const e=a.length,t=r.reduce((s,l)=>s+l,0),o=i-t;if(o<0)return console.error("Error: More items are known than the total required."),[];const n=new Array(e);for(let s=0;s<e;s++)if(n[s]=a[s]-r[s],n[s]<0)return console.error(`Error: Known picks for constellation ${s} exceed its capacity.`),[];return K(n,o,e).map(s=>{const l=s.rateUps.map((R,u)=>R+r[u]),f=U(l,a);return new y(l,f)})}function J(a,i,r){const e=i.map((n,c)=>n-r[c]),t=new Map;for(const n of a){const c=n.rateUps.map((s,l)=>s-r[l]);if(c.some(s=>s<0)){n.probability=0;continue}const m=new y(c,[]);t.set(m,n)}const o=Array.from(t.keys());o.length>0&&F(o,e);for(const[n,c]of t.entries())c.probability=n.probability}function X(a,i,r,e){return Array.from({length:a+1},(t,o)=>{const n=z(o,e);let c=0,m=0;for(let s=0;s<=o;s++){const l=o-s,f=i[s],R=l*r,u=f.mean+R,S=f.variance+Math.pow(u,2);c+=u*n[s],m+=S*n[s]}return{mean:c,variance:Math.max(0,m-Math.pow(c,2))}})}function B(a,i,r,e){let t=i[a.rateUpCount],o=r[a.charOffRateCount],n=a.wepOffRateCount*e;return{mean:t+o.mean+n,variance:o.variance}}function Q(a){const r=Math.sqrt(a.variance),e=1/Math.sqrt(.2);let t=a.mean-r*e;t<0&&(t=0);const o=a.mean+r*e,n=a.mean;return{LOWER_BOUND:t,MEAN:n,UPPER_BOUND:o}}function Y(a,i){const r=[];let e=0;for(let t=0;t<a.length;t++)for(const[o,n]of a[t].offRates.entries()){const c=Math.floor(o/100);n.prob>i&&(r.push({rateUpCount:t,charOffRateCount:c,wepOffRateCount:o%100,probability:n.prob}),e=Math.max(e,c))}return{combos:r,maxOffRateCount:e}}function tt(a,i){const r=[];let e=0;for(let t=0;t<a.length;t++)for(const[o,n]of a[t].offRates.entries())n.prob>i&&(r.push({rateUpCount:t,offRateCount:o,probability:n.prob}),e=Math.max(e,o));return{combos:r,maxOffRateCount:e}}function et(a,i,r){let e=0,t=0;for(const{rateUpCount:o,offRateCount:n,probability:c}of a){const m=i[o],s=r[n],l=m.mean+s.mean,f=m.variance+s.variance+Math.pow(l,2);e+=c*l,t+=c*f}return{mean:e,variance:Math.max(0,t-Math.pow(e,2))}}function at(a){let i=0,r=0;for(const{probability:e,cashback:t}of a)i+=e*t.mean;for(const{probability:e,cashback:t}of a){const o=t.variance+Math.pow(t.mean,2);r+=e*o}return{mean:i,variance:Math.max(0,r-Math.pow(i,2))}}function rt(...a){return a.reduce((i,r)=>({mean:i.mean+r.mean,variance:i.variance+r.variance}),{mean:0,variance:0})}export{G as W,Z as a,J as b,j as c,Q as d,Y as e,B as f,q as g,at as h,tt as i,rt as j,X as k,et as l,$ as p};
