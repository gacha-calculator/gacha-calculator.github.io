import{z as F,E as z}from"./solvers-DD4qvpnR.js";function G(a){const{cashbackCalculator:i,uiUpdater:r}=a;return function(t){const{results:o,inputConfig:n,chartLabels:c,gachaConfig:m,CONSTELLATION_MAP:s}=t,p=i(n,m,o.cashbackData.SSR,o.cashbackData.CharSR,o.cashbackData.WepSR,n.SR.rateUps,s);r(o.cashbackData.SSR,c,p)}}class Z{constructor(i,r={}){this.config=i,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...r}}async runGachaCalculation(i,r){this.adapters.contexts.contextSSR.target=r;let e=[],t={},o=!1,n=!1;const{ssrWorker:c,srWorker:m}=this.adapters.workerManager.getWorkers(),s=this.adapters.distributionArrays.sortPity(i);this.adapters.contexts.contextSSR.pities=s;let{distributionSSR:p}=this.adapters.distributionArrays.makeSSR(i,s),{distributionCharSR:f,distributionWepSR:R}=this.adapters.distributionArrays.makeSR(i);try{await A(c,m,this.adapters.contexts,p,{distributionCharSR:f,distributionWepSR:R},s)}catch(l){console.error("Failed to initialize workers:",l)}let u=await E(c);for(u.type==="IterationComplete"?t=u.lossData:(t=u.lossData,o=u.isTarget,n=u.isEmpty,e=u.allPullsDistributionSSR,p=u.distributionSSR);!n&&!o;)M(t),[u]=await Promise.all([E(c),v(m,t)]),u.type==="IterationComplete"?t=u.lossData:(t=u.lossData,o=u.isTarget,n=u.isEmpty,e=u.allPullsDistributionSSR,p=u.distributionSSR);M(t);let w=await T(m,t);this.adapters.workerManager.terminateWorkers(),f=w.distributionCharSR,R=w.distributionWepSR;const P={SSR:this.adapters.helpers.consolidateDistributionForCashback(p),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(R)};this.adapters.helpers.simplifyDistribution(p),f=null,R=null;let g=0;const x=10;for(;!n;)o&&(g++,this.adapters.pullLogic.rankUpSSRCheap(p,s),g===x&&this.adapters.helpers.normalizeCheap(p),e.push(this.adapters.helpers.consolidateProbabilitiesCheap(p)),n=this.adapters.helpers.checkIsEmpty(p,o));return{chartData:e,cashbackData:P};async function A(l,h,k,b,{distributionCharSR:S,distributionWepSR:L}){return new Promise((N,_)=>{let W=!1,D=!1,C=!1;function I(){!C&&W&&D&&N()}function U(d){C||(C=!0,_(d))}l.onerror=d=>{console.error("Worker error:",d),U(d)},h.onerror=d=>{U(d)},l.onmessage=function(d){switch(d.data.type){case"InitComplete":W=!0,I();break;default:console.warn("Unknown message type")}},h.onmessage=function(d){switch(d.data.type){case"InitComplete":D=!0,I();break;default:console.warn("Unknown message type")}},l.postMessage({type:"Initiate",distribution:b,context:k}),h.postMessage({type:"Initiate",distribution:{distributionCharSR:S,distributionWepSR:L},context:k})})}function E(l){return new Promise((h,k)=>{l.onmessage=b=>{switch(b.data.type){case"IterationComplete":h(b.data);break;case"LastIteration":h(b.data);break}},l.onerror=k,l.postMessage({type:"Iterate"})})}function v(l,h){return new Promise((k,b)=>{l.onmessage=S=>{k()},l.onerror=b,l.postMessage({type:"Iterate",lossData:h})})}function T(l,h){return new Promise((k,b)=>{l.onmessage=S=>{k(S.data)},l.onerror=b,l.postMessage({type:"IterateLast",lossData:h})})}function M(l){const h=l.charRankUps.pullsSum+l.wepRankUps.pullsSum;Math.abs(h-1)>1e-5&&(l.charRankUps.pullsSum/=h,l.charRankUps.rankUps/=h,l.wepRankUps.pullsSum/=h,l.wepRankUps.rankUps/=h)}}}function H(a){return new Worker("/assets/ssr-worker-Cbw2YZw5.js",{type:"module",name:a?.name})}function K(a){return new Worker("/assets/sr-worker-BLJEHkIP.js",{type:"module",name:a?.name})}class ${constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new H),this.srWorker||(this.srWorker=new K),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class y{constructor(i,r,e){this.rateUps=i,this.offRates=r,this.probability=e}}function V(a,i,r){const e=[],t=new Array(r).fill(0);function o(n,c){if(n===r){if(c===i){const s=O(t,a);e.push(new y([...t],s))}return}const m=Math.min(a[n],i-c);for(let s=0;s<=m;s++)t[n]=s,o(n+1,c+s),t[n]=0}return o(0,0),e}function O(a,i){const r=[...i];for(let e=0;e<a.length;e++)r[e]-=a[e];return r}function Y(a,i,r){const e=new Array(Object.keys(r).length).fill(0);for(const t of i)if(t==="new")a[0]++,e[0]++;else{const o=r[t];o!==void 0?e[o]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return e}function B(a,i,r){const e=a.length,t=r.reduce((s,p)=>s+p,0),o=i-t;if(o<0)return console.error("Error: More items are known than the total required."),[];const n=new Array(e);for(let s=0;s<e;s++)if(n[s]=a[s]-r[s],n[s]<0)return console.error(`Error: Known picks for constellation ${s} exceed its capacity.`),[];return V(n,o,e).map(s=>{const p=s.rateUps.map((R,u)=>R+r[u]),f=O(p,a);return new y(p,f)})}function J(a,i,r){const e=i.map((n,c)=>n-r[c]),t=new Map;for(const n of a){const c=n.rateUps.map((s,p)=>s-r[p]);if(c.some(s=>s<0)){n.probability=0;continue}const m=new y(c,[]);t.set(m,n)}const o=Array.from(t.keys());o.length>0&&F(o,e);for(const[n,c]of t.entries())c.probability=n.probability}function Q(a,i,r,e){return Array.from({length:a+1},(t,o)=>{const n=z(o,e);let c=0,m=0;for(let s=0;s<=o;s++){const p=o-s,f=i[s],R=p*r,u=f.mean+R,w=f.variance+Math.pow(u,2);c+=u*n[s],m+=w*n[s]}return{mean:c,variance:Math.max(0,m-Math.pow(c,2))}})}function X(a,i,r,e){let t=i[a.rateUpCount],o=r[a.charOffRateCount],n=a.wepOffRateCount*e;return{mean:t+o.mean+n,variance:o.variance}}function tt(a){const r=Math.sqrt(a.variance),e=1/Math.sqrt(.2);let t=a.mean-r*e;t<0&&(t=0);const o=a.mean+r*e,n=a.mean;return{LOWER_BOUND:t,MEAN:n,UPPER_BOUND:o}}function et(a,i){const r=[];let e=0;for(let t=0;t<a.length;t++)for(const[o,n]of a[t].offRates.entries()){const c=Math.floor(o/100);n.prob>i&&(r.push({rateUpCount:t,charOffRateCount:c,wepOffRateCount:o%100,probability:n.prob}),e=Math.max(e,c))}return{combos:r,maxOffRateCount:e}}function at(a,i){const r=[];let e=0;for(let t=0;t<a.length;t++)for(const[o,n]of a[t].offRates.entries())n.prob>i&&(r.push({rateUpCount:t,offRateCount:o,probability:n.prob}),e=Math.max(e,o));return{combos:r,maxOffRateCount:e}}function rt(a,i,r){let e=0,t=0;for(const{rateUpCount:o,offRateCount:n,probability:c}of a){const m=i[o],s=r[n],p=m.mean+s.mean,f=m.variance+s.variance+Math.pow(p,2);e+=c*p,t+=c*f}return{mean:e,variance:Math.max(0,t-Math.pow(e,2))}}function ot(a){let i=0,r=0;for(const{probability:e,cashback:t}of a)i+=e*t.mean;for(const{probability:e,cashback:t}of a){const o=t.variance+Math.pow(t.mean,2);r+=e*o}return{mean:i,variance:Math.max(0,r-Math.pow(i,2))}}function nt(...a){return a.reduce((i,r)=>({mean:i.mean+r.mean,variance:i.variance+r.variance}),{mean:0,variance:0})}export{$ as W,B as a,J as b,G as c,tt as d,et as e,X as f,Z as g,ot as h,at as i,nt as j,Q as k,rt as l,Y as p};
