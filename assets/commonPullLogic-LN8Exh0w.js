function d(s,n,o,p,L,a){const{charPullsSum:R,wepPullsSum:c}=b(s),E={characters:0,weapons:0},f={charLoss:null,wepLoss:null},g=s.length-2;for(let t=g;t>=0;t--){const e=s[t],l=a[t+1];if(!e.isEmpty)if(e.type==="Character")N(n,t,s,p,E,e.type,l);else if(e.type==="Weapon")N(o,t,s,L,E,e.type,l);else throw new Error(`Unknown SSR array type: ${e.type}`)}const{charRankUps:S,wepRankUps:i}=y(R,c,E);return f.charLoss=S,f.wepLoss=i,f;function b(t){const e={charPullsSum:0,wepPullsSum:0};if(t.length<=1)return e;const l=t.length-1;for(let P=0;P<l;P++){const{type:U,states:m}=t[P];let r=0;for(const h of m)for(const{prob:u}of h.values())r+=u;switch(U){case"Character":e.charPullsSum+=r;break;case"Weapon":e.wepPullsSum+=r;break}}return e}function y(t,e,l){return{charRankUps:t-l.characters,wepRankUps:e-l.weapons}}}function k(s,n,o,p){const L=s.length-1;for(let a=L;a>=0;a--)s[a].isEmpty||_(o,a,s,p,n)}function O(s,n,o,p,L,a){const R=s.length-2;for(let c=R;c>=0;c--){const E=s[c],f=a[c+1];if(!E.isEmpty)if(E.type==="Character")V(n,c,s,p,E.type,f);else if(E.type==="Weapon")V(o,c,s,L,E.type,f);else throw new Error(`Unknown SSR array type: ${E.type}`)}}function N(s,n,o,p,L,a,R){const c=o[n].states.length,E=.5,f=.75;let g=.5;a==="Character"?g=E:a==="Weapon"&&(g=f);const S=o[n].states,i=o[n+1].states;for(let b=c-2;b>=0;b--){const y=S[b],t=b>=p,e=s[b-p*t];for(const[l,P]of y){const U=P.prob*e,m=P.prob-U;let r=U;if(r>1e-10){t||(r*=g);const u=i[R],w=u.get(l);w?w.prob+=r:u.set(l,{prob:r}),a==="Character"?L.characters+=r:a==="Weapon"&&(L.weapons+=r)}if(!t){let u=U*(1-g);if(u>1e-10){let w=l;a==="Character"?w+=100:a==="Weapon"&&w++;const W=S[p],C=W.get(w);C?C.prob+=u:W.set(w,{prob:u})}}let h=m;if(h>1e-10){const u=S[b+1],w=u.get(l);w?w.prob+=h:u.set(l,{prob:h})}P.prob=0}}}function _(s,n,o,p,L){const a=o[n].states.length,R=o[n].states;for(let c=a-1;c>=0;c--){const E=R[c],f=c>=p,g=s[c-p*f],S=.5;for(const[i,b]of E){const y=b.prob,t=y*L,e=y-t;if(b.prob=e,t>1e-10){const l=t*g,P=t-l;let U=l;if(U>1e-10){f||(U*=S),o[n+1]===void 0&&(o[n+1]={states:Array.from({length:o[n].states.length},()=>new Map)});const r=o[n+1].states[0],h=r.get(i);h?h.prob+=U:r.set(i,{prob:U})}if(!f){let r=l*(1-S);if(r>1e-10){let h=i;h++;const u=R[p],w=u.get(h);w?w.prob+=r:u.set(h,{prob:r})}}let m=P;if(m>1e-10){const r=R[c+1],h=r.get(i);h?h.prob+=m:r.set(i,{prob:m})}}}}}function V(s,n,o,p,L,a){const R=o[n].states.length,c=.5,E=.75;let f=.5;L==="Character"?f=c:L==="Weapon"&&(f=E);const g=o[n].states,S=o[n+1].states;for(let i=R-1;i>=0;i--){const b=g[i],y=i>=p,t=s[i-p*y],e=b*t,l=b-e;let P=e;if(P>1e-10&&(y||(P*=f),S[a]+=P),!y){let m=e*(1-f);m>1e-10&&(g[p]+=m)}let U=l;U>1e-10&&(g[i+1]+=U),g[i]=0}}export{k as rankUpSR,d as rankUpSSR,O as rankUpSSRCheap};
