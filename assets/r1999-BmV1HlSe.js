import{c as W,C as Y,D as G,a as j,r as J,b as Q,u as X,g as Z,e as tt,h as et,k as at,o as U,m as N,s as q,p as nt,I as P,n as ot}from"./solvers-BhFii6kz.js";/* empty css               */import{p as E,a as rt,e as st,c as B,d as D,s as lt,n as ct,b as it}from"./common-helpers-BPUYLRbn.js";const O=[.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.015,.04,.065,.09,.115,.14,.165,.19,.215,.24,1],ut=.085,w={maxCharacterConstelation:5,rateUpCharacterSR:2,poolStandardCharSSR:38,poolCharSR:23,configSR:{maxType:6,regularPoints:.3,specialPoints:.7},configSSR:{maxType:6,regularPoints:1.2,specialPoints:2.8},paths:{char:["None","p0","p1","p2","p3","p4","p5"]},pity:{pitySSR:O.length,pitySR:10},default:0},pt=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"p0",text:"P0"},{value:"p1",text:"P1"},{value:"p2",text:"P2"},{value:"p3",text:"P3"},{value:"p4",text:"P4"},{value:"p5",text:"P5"}],ft={none:0,p0:1,p1:2,p2:3,p3:4,p4:5,p5:6},ht={CHARACTER:"character"},k={PITY_ROW:"[data-banner]",CONSTELLATION_ROW:"[data-rarity]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},x={pitySettings:{[ht.CHARACTER]:{pity4:0,pity5:0}},isCharacter:!0,isWeapon:!1,isSpecial:!1,constellationColumns:7},_={probability:70,pulls:76};function bt(e,o,a){dt(o.pity),yt(o),gt();const n=e.loadTables();n&&(St(n.pity),Ct(n.constellation),vt(n.rateUps),a.validateAll()),e.init()}function dt(e){const o=document.getElementById("pity-row-template"),a=document.querySelector(`${k.PITY_TABLE} tbody`);Object.entries(x.pitySettings).forEach(([t,r])=>{const s=o.content.cloneNode(!0).querySelector("tr");s.dataset.validationType="individual";const i=s.querySelector('[data-control="pity-5"]');i&&(i.min=0,i.max=e.pitySSR-1),s.dataset.banner=t,s.querySelector(".banner-name").textContent=t,s.querySelector('[data-control="pity-5"]').value=r.pity5,a.appendChild(s)});const n=document.querySelector("#pity-table");n&&n.querySelectorAll('tbody tr input[type="number"]').forEach(t=>t.addEventListener("input",function(){let r=this.value;r.length>1&&r.startsWith("0")&&(this.value=r.replace(/^0+/,""),this.value===""&&(this.value="0"));let s=parseInt(this.value)||0;s>t.max?(this.value=t.max,z(this)):s<t.min&&(this.value=t.min,z(this))}))}function z(e){e.style.borderColor="#a71919",e.style.outline="1px solid #a71919",e.classList.add("flicker"),setTimeout(()=>{e.classList.remove("flicker"),e.style.borderColor="",e.style.outline=""},500)}function yt(e){const o=document.getElementById("const-column-template"),a=document.querySelectorAll(`${k.CONSTELLATION_TABLE} tbody tr`),n=e.poolStandardCharSSR,t=e.poolCharSR;a.forEach(r=>{const s=document.createDocumentFragment(),i=r.dataset.rarity;r.dataset.validationType="row-sum",r.dataset.targetSum=i==="5"?n:t;for(let c=0;c<x.constellationColumns;c++){const l=o.content.cloneNode(!0),u=l.querySelector("input");if(c===x.constellationColumns-1){const p=i==="5"?n:t;u.value=p}u.addEventListener("input",()=>F(r)),s.appendChild(l)}r.appendChild(s),mt(r),F(r)})}function mt(e){const o=document.createElement("div");o.className="row-progress-bar",e.appendChild(o)}function F(e){const o=e.querySelectorAll("input"),a=parseInt(e.dataset.targetSum);let n=0;o.forEach(s=>{n+=parseInt(s.value)||0});const t=e.querySelector(".row-progress-bar"),r=Math.min(n/a*100,100);t.style.width=r+"%",r<60||n>a?t.style.background="rgba(244, 67, 54, 0.3)":r<80?t.style.background="rgba(241, 244, 54, 0.3)":t.style.background="rgba(54, 244, 79, 0.3)"}function gt(){const e=document.querySelectorAll("#rate-up-table select");if(e.length===0)return;const o=pt.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");e.forEach(a=>{a.innerHTML=o,a.value="unknown"})}function St(e){e.forEach(o=>{const a=document.querySelector(`${k.PITY_TABLE} tr[data-banner="${o.banner}"]`);a&&(a.querySelector('[data-control="pity-5"]').value=o.pity5,a.querySelector(".guarantee-5").checked=o.guarantee5)})}function Ct(e){document.querySelectorAll(`${k.CONSTELLATION_TABLE} tbody tr`).forEach((a,n)=>{const t=e[n];t&&a.querySelectorAll("td:nth-child(n+2) input").forEach((s,i)=>{t[i]!==void 0&&(s.value=t[i])})})}function vt(e){if(!e||!Array.isArray(e))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,n)=>{e[n]!==void 0&&(a.value=e[n])})}function Rt(e){const{cashbackCalculator:o,uiUpdater:a}=e;return function(t){const{results:r,inputConfig:s,chartLabels:i,gachaConfig:c}=t,l=o(s,c,r.cashbackData.SSR,r.cashbackData.SR,s.SR.rateUps);a(r.cashbackData.SSR,i,l)}}const T=(e,o=!1)=>e?o?e.checked:parseInt(e.value)||0:null;function At(e,o,a,n){const t=document.getElementById("pity-panel"),r=document.getElementById("constellation-panel"),s=o.paths;if(!t||!r)return console.error("Required tab panels not found. Cannot get page configuration."),null;const i=(f,b)=>{if(!b)return[];const m=b.querySelector("#constellation-table");if(!m)return console.warn("Could not find the constellation table inside the panel:",b),[];const S=m.querySelectorAll(`tr[data-rarity="${f}"] .custom-input`);return Array.from(S).map(g=>parseInt(g.value)||0)},c=t.querySelector(`${a.PITY_ROW}[data-banner="character"]`),{planConfigs:l,pity4:u,guarantee4:p}=Tt(s),y={},h={},d={};return n.isCharacter&&(y.char=T(c.querySelector('[data-control="pity-5"]')),h.char=T(c.querySelector(".guarantee-5"),!0)),{SSR:{pity:y,guarantee:h,special:d,consCountStandard:i(5,r),pullPlan:l.typeArray,cashbackRoadmap:l.cashbackArray},SR:{pity:u,guarantee:p,rateUps:wt(e),consCount:i(4,r)}}}function kt(){const e=document.querySelectorAll(".row"),o=[],a=[],n=[];return Array.from(e).slice(1).forEach(r=>{const s=r.dataset.group,i=T(r.querySelector('[data-control="pity-4"]')),c=T(r.querySelector(".guarantee-4"),!0),l=r.querySelector(".type-selector")?.value||"char",u=r.querySelector(".first-select")?.value||"None",p=r.querySelector(".second-select")?.value||"None";a.push(i),n.push(c),o.push({group:s,type:l,from:u,to:p})}),{pullPlan:o,pity4:a,guarantee4:n}}function Tt(e){const o=document.querySelectorAll(".row"),a={},n=[],t=[],r=[],s=[],i=Array.from(o).slice(1);let c=0;return i.forEach(l=>{const u=T(l.querySelector('[data-control="pity-4"]')),p=T(l.querySelector(".guarantee-4"),!0);r.push(u),s.push(p);const y=l.querySelector(".type-selector")?.value||"char",h=l.querySelector(".first-select")?.value||"None",d=l.querySelector(".second-select")?.value||"None",f=y==="char"?e.char:e.wep,b=f.indexOf(h),m=f.indexOf(d);if(b===-1||m===-1||b>=m)return;const S=m-b;let g=b,C=0;for(let v=0;v<S;v++)y==="char"&&g===0?C="none":C="regular",n.push({type:y,bannerCount:c}),t.push(C),g++;c++}),a.typeArray=n,a.cashbackArray=t,{planConfigs:a,pity4:r,guarantee4:s}}function wt(e){const o=document.querySelectorAll("#rate-up-table select.custom-select");let a=new Array(Object.keys(e).length).fill(0);return o.length===0?(console.error("Could not find any rate-up select elements."),[]):(o.forEach(n=>{const t=n.value;if(t==="unknown")return;const r=e[t];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${t}"`)}),a)}const Et=`
    <div class="chibi-group">
        <div class="bubble-wrapper bubble-wrapper--big">
            <svg class="bubble-svg-background" viewBox="0 0 2352 856" xmlns="http://www.w3.org/2000/svg">
                <path style="fill:#232338; stroke:none;"
                    d="M2118 618C2072.09 632.557 2020.82 642.525 1974 627.975C1949.06 620.225 1928.07 604.761 1904 596C1928.15 574.906 1950.38 552.246 1966.14 524C1978.13 502.501 1986.34 479.266 1990.41 455C1993.94 433.973 1995.23 412.213 1992.71 391C1990.01 368.189 1984.63 346.161 1975.57 325C1936.75 234.287 1839 185.01 1751 153.692C1680.79 128.705 1606.59 113.569 1533 102.728C1418.45 85.8546 1303.52 78.8151 1188 75.9854C983.191 70.9684 772.755 73.2407 571 113.6C479.224 131.959 386.934 156.236 306 204.8C255.006 235.399 208.898 279.148 188.053 336C180.074 357.763 177.006 379.135 174.83 402C173.006 421.169 174.62 441.101 178.4 460C208.383 609.934 376.221 669.932 507 702.627C677.331 745.209 853.685 750.744 1028 755.015C1226.65 759.881 1430.98 752.259 1626 710.789C1662.97 702.929 1698.61 691.625 1735 681.735C1745.17 678.971 1757.98 684.363 1768 686.576C1789.92 691.417 1811.81 696.134 1834 699.576C1897.86 709.479 1968.19 712.102 2028 683.68C2042.89 676.602 2055.69 666.243 2069 656.71C2080.1 648.757 2091.06 640.547 2102 632.374C2107.6 628.192 2114.64 624.297 2118 618z" />
            </svg>
            <div class="bubble-text"> </div>
        </div>
        <img src="/images/37_chibi.png" alt="Tutorial Assistant" class="tutorial-chibi">
        <div class="prompt-buttons">
            <button class="btn btn--tutorial_next">Next</button>
            <button class="btn btn--tutorial_end">Maybe later</button>
        </div>
    </div>`,xt=[{text:"<p>Welcome to the Gacha Calculator! Let me show you around.</p>",size:"small"},{id:"pity-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>First, you need to input your current pity and guarantees here.</p>",position:"right"},{id:"pull-plan-step",element:".pull-plan-section",text:"<p>Next, build your pull plan here. Add all the characters and weapons you want to get in order.</p>",position:"left",chibiSide:"left"},{id:"target-step",element:".header-controls",text:"<p>Now you need to set your target, either the confidence level you want, for example 70% chance of getting all planned items, or your pull budget.</p>",position:"top",chibiSide:"left",size:"big"},{id:"calculate-button-step",element:"#calculate-btn",text:"<p>Once your plan and target are set, press Calculate!</p>",position:"right",size:"small"},{element:".chart-wrapper",text:"<p>You'll get a chart showing the probability of success for each number of pulls until 100%.</p>",position:"top"},{id:"constellation-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>Owned characters constellations are needed for accurate cashback, if you only need character pull chance you can leave it for now.</p>",position:"right"},{id:"rate-ups-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#rateup-panel"]',text:"<p>If you know 4* rate ups on the banner it will also help cashback accuracy and reduce unneeded computation</p>",position:"right"},{element:"#probability-table",text:"<p>And down here, you can see a detailed table with cashback estimates. Good luck!</p>",position:"top"}],H={"pity-input-step":{tourStepId:"pity-input-step"},"constellation-input-step":{tourStepId:"constellation-input-step"},"pull-plan-step":{tourStepId:"pull-plan-step"},"calculate-button-step":{tourStepId:"calculate-button-step"},"import-paimon-help":{text:'<p>You can import your pity data directly from <a href="https://paimon.moe/" target="_blank">paimon.moe</a>. Click the "Import Data" button and paste the exported JSON data.</p>'},"target-character-help":{text:"<p>Select the characters you are aiming to pull. You can specify the desired constellation level for each.</p>"},"target-weapon-help":{text:"<p>Select the weapons you are aiming to pull. You can specify the desired refinement level for each.</p>"}};class Pt{constructor(o){this.parts=o,this.persistence=W("reverse",k);const a=Rt({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn});this.tutorial=new Y(Et);const n={getPageConfiguration:At,getLabels:tt,getPullPlan:kt,getTarget:Z,updateChart:X,convertToChartData:Q,recalcInputs:J,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:k,INITIAL_CONFIG:x},postCalculationHooks:[a],persistence:this.persistence,chibi:this.tutorial};this.validator=new G(this.parts.CONSTELLATION_MAP),this.calculationHandler=new j(n),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn")}initialize(){this.validator.initialize(),bt(this.persistence,this.parts.gachaConfig,this.validator),et(),this.#t(),this.#a()}#t(){this.calculateBtn&&this.calculateBtn.addEventListener("click",async()=>{this.#e()&&await this.calculationHandler.runCalculation()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>at(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(xt)}),document.querySelectorAll(".help-btn").forEach(a=>{a.addEventListener("click",n=>{n.preventDefault();const t=a.getAttribute("data-help-key")||a.getAttribute("data-tour-step-id");if(t&&H[t]){const r=H[t];this.tutorial.showHelp(r,a)}else console.warn(`ChibiTutorial: No help configuration found for key '${t}'.`,a)})})}#e(){if(document.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll(),this.validator.isRowPityValid();const o=document.querySelectorAll(".is-invalid"),a=new Set;o.forEach(t=>{const r=t.closest(".tab-pane");if(r){const s=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);s&&a.add(s)}t.classList.add("flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})}),a.forEach(t=>{t.classList.add("is-invalid","flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})});const n=Array.from(a)[0];return n&&n.click(),setTimeout(()=>{o[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const o=this.persistence.loadCalculation(),a=o?o.input:null;o?(U(this.parts.gachaConfig.paths,a),N(_,o),q(o.persistInput)):(U(this.parts.gachaConfig.paths),N(_),q()),this.calculationHandler.runCalculation()}}const A=1e-10;function Ot(e,o,a){const n=e.length-2;let t=e.length-1,r=e[t-1].bannerCount+1,s=Array(r).fill(0),i=Array(r).fill(0);Lt(e,s);for(let c=n;c>=0;c--)e[c].isEmpty||(Ut(o,c,e,a,0,i),Mt(s,i));return s}function Lt(e,o){for(let a=0;a<e.length-1;a++){let n=e[a].bannerCount,t=0;for(let r=0;r<e[a].states.length;r++)for(const[s,i]of e[a].states[r])t+=i.prob;o[n]+=t}}function Mt(e,o){for(let a=0;a<e.length;a++)e[a]-=o[a]}function It(e,o,a){const n=e.length-2;for(let t=n;t>=0;t--){const r=e[t];r.isEmpty||qt(o,t,e,a,r.type)}}function Ut(e,o,a,n,t,r){const s=a[o].states.length;let i=.5;const c=a[o].states,l=a[o].bannerCount,u=a[o+1].states;for(let p=s-2;p>=0;p--){const y=c[p],h=p>=n,d=e[p-n*h];for(const[f,b]of y){const m=b.prob*d,S=b.prob-m;let g=m;if(g>A){h||(g*=i);const v=u[t],R=v.get(f);R?R.prob+=g:v.set(f,{prob:g}),r[l]+=g}if(!h){let v=m*(1-i);if(v>A){let R=f+1;const M=c[n],I=M.get(R);I?I.prob+=v:M.set(R,{prob:v})}}let C=S;if(C>A){const v=c[p+1],R=v.get(f);R?R.prob+=C:v.set(f,{prob:C})}b.prob=0}}return r}function Nt(e,o,a){let n;for(let t=0;t<e.length;t++){const r=a[t],s=o*r,i=e[t].length-1;for(let c=i;c>=0;c--){const l=e[t][c].states;for(let u=1;u>=0;u--){n=u===1;let p=s;n||(p*=.5);const y=l[u];if(y.length===10)for(let h=9;h>=0;h--)for(const[d,f]of y[h]){let b=!1;h===9&&(b=!0);let m=p;b&&(m=1);const S=f.prob*m;if(S>A){if(e[t][c+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][c+1].states[0].set(d,{prob:S});else{const g=e[t][c+1].states[0],C=g.get(d);C?C.prob+=S:g.set(d,{prob:S})}if(n)f.prob-=S;else{let g=d+1;const C=l[1],v=C.get(g);v?v.prob+=S:C.set(g,{prob:S}),f.prob-=2*S}if(f.prob>0&&!b){const g=l[u][h+1],C=g.get(d);C?C.prob+=f.prob:g.set(d,{prob:f.prob}),f.prob=0}}}else for(const[h,d]of y){const f=d.prob*p;if(f>A){if(e[t][c+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][c+1].states[0].set(h,{prob:f});else{const b=e[t][c+1].states[0],m=b.get(h);m?m.prob+=f:b.set(h,{prob:f})}if(n)d.prob-=f;else{let b=h+1;const m=l[1],S=m.get(b);S?S.prob+=f:m.set(b,{prob:f}),d.prob-=2*f}}}}}}}function qt(e,o,a,n,t){const r=a[o].states.length;let s=.5;const i=a[o].states,c=a[o+1].states;for(let l=r-2;l>=0;l--){const u=i[l],p=l>=n,y=e[l-n*p],h=u*y,d=u-h;let f=h;if(f>A&&(p||(f*=s),c[t]+=f),!p){let m=h*(1-s);m>A&&(i[n]+=m)}let b=d;b>A&&(i[l+1]+=b),i[l]=0}}function Bt(e,o,a){if(!Array.isArray(e.SSR.pullPlan))throw new Error("Invalid pull plan");const{pullPlan:n}=e.SSR,t=[];for(let s=0;s<n.length;s++)t.push({states:Array.from({length:a},()=>new Map),isEmpty:!0,bannerCount:n[s].bannerCount});return t.push({states:Array.from({length:1},()=>new Map)}),r(o),t;function r(s){t[0].states[s].set(0,{prob:1}),t[0].isEmpty=!1}}function Dt(e,o){return{SSR:e.SSR.pity.char+e.SSR.guarantee.char*o.pitySSR}}function _t(e){const o=e.SSR.pullPlan,a=o.length-1,n=o[a].bannerCount;let t=[];for(let r=0;r<=n;r++){const s=e.SR.pity[r];let i=!0;s===10&&(i=!1);let c=0;e.SR.guarantee[r]&&(c=1),i?c?(t.push([{states:[new Map,Array.from({length:10},()=>new Map)]}]),t[r][0].states[c][s].set(0,{prob:1})):(t.push([{states:[Array.from({length:10},()=>new Map),new Map]}]),t[r][0].states[c][s].set(0,{prob:1})):(t.push([{states:[new Map,new Map]}]),t[r][0].states[c].set(0,{prob:1}))}return t}function zt(e){let o=[];for(let a of e)for(let n=0;n<a.length;n++)for(let t=0;t<a[n].states.length;t++)if(Array.isArray(a[n].states[t]))for(let r=0;r<a[n].states[t].length;r++)for(let[s,i]of a[n].states[t][r])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(s,{prob:i.prob});else{const c=o[n].states[t],l=c.get(s);l?l.prob+=i.prob:c.set(s,{prob:i.prob})}else for(let[r,s]of a[n].states[t])if(o[n]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[n].states[0].set(r,{prob:s.prob});else{const i=o[n].states[t],c=i.get(r);c?c.prob+=s.prob:i.set(r,{prob:s.prob})}return o}function Ft(e,o){let a=[],n={},t=!1,r=!1,s=w.pity.pitySSR*2+1;const i=Dt(e,w.pity);let c=Bt(e,i.SSR,s),l=_t(e),u=0;const p=10;for(;!r&&!t;){if(n=Ot(c,O,w.pity.pitySSR),Nt(l,ut,n),u++,u===p){E(c);for(let d of l)E(d);u=0}a.push(rt(c)),t=st(c,o,a.length),t||(r=B(c,t))}if(!u===p){E(c);for(let d of l)E(d)}l=zt(l);const y={SSR:D(c),SR:D(l)};for(lt(c),l=null;!r;)t&&(u++,It(c,O,w.pity.pitySSR),u===p&&ct(c),a.push(it(c)),r=B(c,t));return{chartData:a,cashbackData:y}}class L{constructor(o,a,n){this.rateUps=o,this.offRates=a,this.probability=n}}function Ht(e,o,a){const n=[],t=new Array(a).fill(0);function r(s,i){if(s===a){if(i===o){const l=V(t,e);n.push(new L([...t],l))}return}const c=Math.min(e[s],o-i);for(let l=0;l<=c;l++)t[s]=l,r(s+1,i+l),t[s]=0}return r(0,0),n}function V(e,o){const a=[...o];for(let n=0;n<e.length;n++)a[n]-=e[n];return a}function Vt(e,o,a){const n=e.length,t=a.reduce((l,u)=>l+u,0),r=o-t;if(r<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(n);for(let l=0;l<n;l++)if(s[l]=e[l]-a[l],s[l]<0)return console.error(`Error: Known picks for constellation ${l} exceed its capacity.`),[];return Ht(s,r,n).map(l=>{const u=l.rateUps.map((y,h)=>y+a[h]),p=V(u,e);return new L(u,p)})}function Kt(e,o,a){const n=o.map((s,i)=>s-a[i]),t=new Map;for(const s of e){const i=s.rateUps.map((l,u)=>l-a[u]);if(i.some(l=>l<0)){s.probability=0;continue}const c=new L(i,[]);t.set(c,s)}const r=Array.from(t.keys());r.length>0&&nt(r,n);for(const[s,i]of t.entries())i.probability=s.probability}function $t(e,o,a){let n=o[e.rateUpCount],t=a[e.charOffRateCount];return{mean:n+t.mean,variance:t.variance}}function Wt(e){const a=Math.sqrt(e.variance),n=1/Math.sqrt(.2);let t=e.mean-a*n;t<0&&(t=0);const r=e.mean+a*n,s=e.mean;return{LOWER_BOUND:t,MEAN:s,UPPER_BOUND:r}}function Yt(e,o){const a=[];let n=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries()){const i=r;s.prob>o&&(a.push({rateUpCount:t,charOffRateCount:i,probability:s.prob}),n=Math.max(n,i))}return{combos:a,maxOffRateCount:n}}function Gt(e,o){const a=[];let n=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries())s.prob>o&&(a.push({rateUpCount:t,offRateCount:r,probability:s.prob}),n=Math.max(n,r));return{combos:a,maxOffRateCount:n}}function jt(e,o,a){let n=0,t=0;for(const{rateUpCount:r,offRateCount:s,probability:i}of e){const c=o[r],l=a[s],u=c.mean+l.mean,p=c.variance+l.variance+Math.pow(u,2);n+=i*u,t+=i*p}return{mean:n,variance:Math.max(0,t-Math.pow(n,2))}}function K(e){let o=0,a=0;for(const{probability:n,cashback:t}of e)o+=n*t.mean;for(const{probability:n,cashback:t}of e){const r=t.variance+Math.pow(t.mean,2);a+=n*r}return{mean:o,variance:Math.max(0,a-Math.pow(o,2))}}const $=1e-8;function Jt(e,o,a,n,t){a=Qt(a);const r=Vt(e.SR.consCount,o.rateUpCharacterSR,t);Kt(r,e.SR.consCount,t);const s=Xt(a,o.poolStandardCharSSR,e.SSR.consCountStandard,e.SSR.cashbackRoadmap,o),i=Zt(r,n,o),c=s;for(let l=0;l<c.length;l++)c[l].mean+=i.mean,c[l].variance+=i.variance,c[l]=Wt(c[l]);return c}function Qt(e){let o=0;for(const a of e)for(const[n,t]of a.offRates)o+=t.prob;for(const a of e)for(const[n,t]of a.offRates)t.prob/=o;return e}function Xt(e,o,a,n,t){const{combos:r,maxOffRateCount:s}=Yt(e,$),i=[0];let c=0;for(let u=0;u<e.length;u++)n[u-1]==="none"?i.push(c):n[u-1]==="regular"&&(c+=t.configSSR.regularPoints,i.push(c));const l=Array.from({length:e.length},()=>[]);for(const u of r){const p=u.rateUpCount,y=u.probability,d=new P(a,o,t.configSSR).runSteps(s),f=$t(u,i,d);l[p].push({cashback:f,probability:y})}for(let u=0;u<l.length;u++){const p=ee(l[u]);l[u]=K(p)}return l}function Zt(e,o,a){const{combos:n,maxOffRateCount:t}=Gt(o,$);return te(e,n,t,a)}function te(e,o,a,n){const t=Math.max(...o.map(s=>s.rateUpCount)),r=[];for(const{rateUps:s,offRates:i,probability:c}of e){const u=new P(s,n.rateUpCharacterSR,n.configSR).runSteps(t),y=new P(i,n.poolCharSR-n.rateUpCharacterSR,n.configSR).runSteps(a),h=jt(o,u,y);r.push({probability:c,cashback:h})}return K(r)}function ee(e){let o=0;for(const a of e)o+=a.probability;for(const a of e)a.probability/=o;return e}document.addEventListener("DOMContentLoaded",()=>{const e={gachaConfig:w,CONSTELLATION_MAP:ft,runCalcFn:Ft,cashbackFn:Jt,updateTableFn:ot};new Pt(e).initialize()});
