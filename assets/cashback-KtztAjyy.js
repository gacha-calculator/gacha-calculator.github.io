(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&e(l)}).observe(document,{childList:!0,subtree:!0});function a(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(o){if(o.ep)return;o.ep=!0;const r=a(o);fetch(o.href,r)}})();const $={CHARACTER:"character",WEAPON:"weapon"},q={PITY_ROW:"[data-banner]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},K={pitySettings:{[$.CHARACTER]:{pity4:0,pity5:0,caprad:1},[$.WEAPON]:{pity4:0,pity5:0,epPath:0}},constellationColumns:8},E=(n,t=!1)=>n?t?n.checked:parseInt(n.value)||0:null;function Q(n,t){const a=document.getElementById("pity-panel"),e=document.getElementById("constellation-panel"),o=t.paths;if(!a||!e)return console.error("Required tab panels not found. Cannot get page configuration."),null;const r=(c,i)=>{if(!i)return[];const y=i.querySelector("#constellation-table");if(!y)return console.warn("Could not find the constellation table inside the panel:",i),[];const p=y.querySelectorAll(`tr[data-rarity="${c}"] .custom-input`);return Array.from(p).map(f=>parseInt(f.value)||0)},l=a.querySelector(`${q.PITY_ROW}[data-banner="character"]`),s=a.querySelector(`${q.PITY_ROW}[data-banner="weapon"]`),u=tt(o);return!l||!s?(console.error("Pity rows for character or weapon not found inside #pity-panel."),null):{SSR:{pity:{char:E(l.querySelector('[data-control="pity-5"]')),wep:E(s.querySelector('[data-control="pity-5"]'))},guarantee:{char:E(l.querySelector(".guarantee-5"),!0),wep:E(s.querySelector(".guarantee-5"),!0)},special:{capRad:E(l.querySelector('[data-control="capRad"]')),epitPath:E(s.querySelector('[data-control="epPath"]'))},consCountStandard:r(5,e),pullPlan:u.typeArray,cashbackRoadmap:u.cashbackArray},SR:{pity:{char:E(l.querySelector('[data-control="pity-4"]')),wep:E(s.querySelector('[data-control="pity-4"]'))},guarantee:{char:E(l.querySelector(".guarantee-4"),!0),wep:E(s.querySelector(".guarantee-4"),!0)},rateUps:at(n),consCount:r(4,e)}}}function X(){const n=document.querySelectorAll(".row"),t=[];return Array.from(n).slice(1).forEach(e=>{const o=e.dataset.group,r=e.querySelector(".type-selector")?.value||"char",l=e.querySelector(".first-select")?.value||"None",s=e.querySelector(".second-select")?.value||"None";t.push({group:o,type:r,from:l,to:s})}),t}function tt(n){const t=document.querySelectorAll(".row"),a=[],e=[];return Array.from(t).slice(1).forEach(r=>{const l=r.querySelector(".type-selector")?.value||"char",s=r.querySelector(".first-select")?.value||"None",u=r.querySelector(".second-select")?.value||"None",c=l==="char"?n.char:n.wep,i=c.indexOf(s),y=c.indexOf(u);if(i===-1||y===-1||i>=y)return;const p=y-i;let f=i,S=0;for(let b=0;b<p;b++)l==="char"?(f===0?S="none":S="regular",a.push(0)):(S="regular",a.push(1)),e.push(S),f++}),{typeArray:a,cashbackArray:e}}function et(n){const t=document.querySelectorAll(".row"),a=Array.from(t).slice(1);let e=["None"];const o=n.char,r=n.wep;return a.forEach(l=>{const s=l.querySelector(".type-selector")?.value||"char",u=l.querySelector(".first-select")?.value||"None",c=l.querySelector(".second-select")?.value||"None",i=s==="char"?o:r,y=i.indexOf(u),p=i.indexOf(c);if(y===-1||p===-1||y>=p)return;const f=i.slice(y+1,p+1);e.push(...f)}),e}function at(n){const t=document.querySelectorAll("#rate-up-table select.custom-select");let a=new Array(Object.keys(n).length).fill(0);return t.length===0?(console.error("Could not find any rate-up select elements."),[]):(t.forEach(e=>{const o=e.value;if(o==="unknown")return;const r=n[o];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${o}"`)}),a)}let x=null;function nt(n,t,a){const e=document.getElementById("myChart").getContext("2d");x&&x.destroy();const o=n.length,r=a.slice(1);return x=new Chart(e,{type:"line",data:{labels:t,datasets:n.map((l,s)=>{const u=s===0?"#2196F3":s===1?"#4CAF50":ot(s);return{label:r[s],data:l,borderColor:u,backgroundColor:s===0?"rgba(33, 150, 243, 0.1)":s===1?"rgba(76, 175, 80, 0.1)":rt(s),fill:!0,tension:.4,order:o-s,borderWidth:5,pointRadius:0}})},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{callback:function(l){return(l*100).toFixed(0)+"%"}},beginAtZero:!0,min:0,max:1}},plugins:{legend:{labels:{sort:(l,s)=>l.datasetIndex-s.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(l){let s=l.dataset.label||"";return s&&(s+=": "),s+=(l.parsed.y*100).toFixed(2)+"%",s}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}}),x}function ot(n){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[n%t.length]}function rt(n){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(n-2)%t.length]}function lt(n,t,a){return nt(n,t,a)}function st(n){let t=[],a=[0];for(let e=1;e<n[0].length;e++)t.push(Array(n.length+1).fill(0));for(let e=0;e<n.length;e++){for(let o=1;o<n[e].length;o++){let r=0;for(let l=0;l<n[e][o].length;l++)r+=n[e][o][l].totalSum;for(let l=0;l<o;l++)t[l][e+1]+=r}a.push(e+1)}return{data:t,labels:a}}function ct(n){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=it(n,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=ut(n,parseInt(document.querySelector('[data-control="pulls"]').value))}function it(n,t){t===100&&(t=99.9);let a=n.length-1,e=!0,o=0,r=0;for(;e;)n[a][r]>t/100&&(o=r,e=!1),r++;return o}function ut(n,t){let a=n.length-1;return n[a].length<=t?100:Math.round(n[a][t]*100)}function Ut(n,t){return function(){const e=Q(n.calculatorConfig.CONSTELLATION_MAP,n.calculatorConfig.gachaConfig),o=et(n.calculatorConfig.gachaConfig.paths),r=n.calculatorFunction(e),l=st(r.SSR);lt(l.data,l.labels,o),ct(l.data);const s={results:r,inputConfig:e,chartLabels:o,gachaConfig:n.calculatorConfig.gachaConfig};if(n.postCalculationHooks&&n.postCalculationHooks.forEach(u=>u(s)),t){const u=parseInt(document.querySelector('[data-control="pulls"]').value);t.saveCalculation({input:X(),targetProb:e.targetProb,targetPull:u,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")})}}}const pt=[.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.066,.126,.186,.246,.306,.366,.426,.486,.546,.606,.666,.726,.786,.846,.906,.966,1],dt=[.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.077,.147,.217,.287,.357,.427,.497,.567,.637,.707,.777,.847,.917,.987,1],H=[.051,.051,.051,.051,.051,.051,.051,.051,.561,1],Dt={maxCharacterConstelation:6,rateUpCharacterSR:3,rateUpWeaponSR:5,poolStandardCharSSR:8,poolCharSR:43,configSR:{maxType:7,regularPoints:.4,specialPoints:1},configSSR:{maxType:7,regularPoints:2,specialPoints:5},configWep:{pointsSR:.4,pointsSSR:2},paths:{char:["None","c0","c1","c2","c3","c4","c5","c6"],wep:["None","r1","r2","r3","r4","r5"]},pity:{pitySSRChar:pt.length,pitySSRWep:dt.length,pitySRChar:H.length,pitySRWep:H.length},default:0},ft=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"c0",text:"C0"},{value:"c1",text:"C1"},{value:"c2",text:"C2"},{value:"c3",text:"C3"},{value:"c4",text:"C4"},{value:"c5",text:"C5"},{value:"c6",text:"C6"}],Mt={none:0,c0:1,c1:2,c2:3,c3:4,c4:5,c5:6,c6:7},Bt=new Set(["dehya","diluc","jean","keqing","mona","qiqi","tighnari","yumemizuki_mizuki"]),Wt=new Set(["barbara","beidou","bennett","candace","charlotte","chevreuse","chongyun","collei","dahlia","diona","dori","faruzan","fischl","freminet","gaming","gorou","iansan","ifa","kachina","kaveh","kirara","kujou_sara","kuki_shinobu","lan_yan","layla","lynette","mika","ningguang","noelle","ororon","razor","rosaria","sayu","sethos","shikanoin_heizou","sucrose","thoma","xiangling","xingqiu","xinyan","yanfei","yaoyao","yun_jin"]),$t=new Set(["amos_bow","aquila_favonia","lost_prayer_to_the_sacred_winds","primordial_jade_winged-spear","skyward_atlas","skyward_blade","skyward_harp","skyward_pride","skyward_spine","wolfs_gravestone"]),Ht=new Set(["dragons_bane","eye_of_perception","favonius_codex","favonius_greatsword","favonius_lance","favonius_sword","favonius_warbow","lions_roar","rainslasher","rust","sacrificial_bow","sacrificial_fragments","sacrificial_greatsword","sacrificial_sword","the_bell","the_flute","the_stringless","the_widsith","akuoumaru","alley_hunter","flower-wreathed_feathers","fruitful_hook","lithic_blade","lithic_spear","makhaira_aquamarine","mitternachts_waltz","mountain-bracing_bolt","mouuns_moon","portable_power_saw","prospectors_drill","range_gauge","sturdy_bone","the_alley_flash","the_dockhands_assistant","wandering_evenstar","wavebreakers_fin","waveriding_whirl","wine_and_song","xiphos_moonlight"]),jt=new Set(["black_tassel","bloodtainted_greatsword","cool_steel","debate_club","emerald_orb","ferrous_shadow","harbinger_of_dawn","magic_guide","raven_bow","sharpshooters_oath","skyrider_sword","slingshot","thrilling_tales_of_dragon_slayers","white_tassel"]);function Ft(n,t,a){ht(t.pity),yt(t),mt();const e=n.loadTables();e&&(V(e.pity),Y(e.constellation),St(e.rateUps),a.validateAll()),n.init()}function ht(n){const t=document.getElementById("pity-row-template"),a=document.querySelector(`${q.PITY_TABLE} tbody`);Object.entries(K.pitySettings).forEach(([e,o])=>{const r=t.content.cloneNode(!0).querySelector("tr"),l=r.querySelector(".special-mechanic");r.dataset.validationType="individual";const s=r.querySelector('[data-control="pity-4"]'),u=r.querySelector('[data-control="pity-5"]');s&&(s.min=0,s.max=e.includes("Weapon")?n.pitySRWep-1:n.pitySRChar-1),u&&(u.min=0,u.max=e.includes("Weapon")?n.pitySSRWep-1:n.pitySSRChar-1),r.dataset.banner=e,r.querySelector(".banner-name").textContent=e,r.querySelector('[data-control="pity-4"]').value=o.pity4,r.querySelector('[data-control="pity-5"]').value=o.pity5,l&&(l.innerHTML=`
                <div class="mechanic-stack">
                    <div class="character-only">
                        <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                               value="${o.caprad??""}">
                    </div>
                    <div class="weapon-only">
                        <input type="number" data-control="epPath" class="custom-input" min="0" max="2" 
                               value="${o.epPath??""}">
                    </div>
                </div>
            `),a.appendChild(r)})}function yt(n){const t=document.getElementById("const-column-template"),a=document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`),e=n.poolStandardCharSSR,o=n.poolCharSR;a.forEach(r=>{const l=document.createDocumentFragment(),u=r.querySelector("td:first-child")?.textContent.trim();r.dataset.validationType="row-sum",u==="5★"?(r.dataset.targetSum=n.poolStandardCharSSR,r.dataset.rarity="5"):(r.dataset.targetSum=n.poolCharSR,r.dataset.rarity="4");for(let c=0;c<K.constellationColumns;c++){const i=t.content.cloneNode(!0);if(c===0){const y=i.querySelector("input");if(y){const p=u==="5★"?e:o;y.value=p}}l.appendChild(i)}r.appendChild(l)})}function mt(){const n=document.querySelectorAll("#rate-up-table select");if(n.length===0)return;const t=ft.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");n.forEach(a=>{a.innerHTML=t,a.value="unknown"})}function zt(n,t,a,e){const o=[];for(let l=0;l<n.SSR[a-1].length;l++){let s=0;for(let u of n.SSR[a-1][l])s+=u.totalSum;s=(s*100).toFixed(2),s>0&&o.push({name:t[l],probability:s,p10:e[l].p10,mean:e[l].mean,p90:e[l].p90,color:"#3498db"})}const r=document.querySelector("#probability-table tbody");r.innerHTML="",o.forEach(l=>{const s=document.createElement("tr"),u=l.probability;s.innerHTML=`
      <td>${l.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${u}%;background:${l.color}">
            <div class="progress-label">${l.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${l.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${l.mean.toFixed(1)}</td>
      <td class="cashback-value">${l.p90.toFixed(1)}</td>
    `,r.appendChild(s)})}function V(n){n.forEach(t=>{const a=document.querySelector(`${q.PITY_TABLE} tr[data-banner="${t.banner}"]`);a&&(a.querySelector('[data-control="pity-4"]').value=t.pity4,a.querySelector('[data-control="pity-5"]').value=t.pity5,a.querySelector(".guarantee-4").checked=t.guarantee4,a.querySelector(".guarantee-5").checked=t.guarantee5,t.caprad&&a.querySelector('[data-control="capRad"]')&&(a.querySelector('[data-control="capRad"]').value=t.caprad),t.epPath&&a.querySelector('[data-control="epPath"]')&&(a.querySelector('[data-control="epPath"]').value=t.epPath))})}function Y(n){document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`).forEach((a,e)=>{const o=n[e];o&&a.querySelectorAll("td:nth-child(n+2) input").forEach((l,s)=>{o[s]!==void 0&&(l.value=o[s])})})}function St(n){if(!n||!Array.isArray(n))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,e)=>{n[e]!==void 0&&(a.value=n[e])})}function Kt(n,t,a){const e=document.getElementById("import-file-input");if(!e){console.error("Import file input not found!");return}const o=r=>bt(r,n,t,a);e.removeEventListener("change",e.__handleFile),e.addEventListener("change",o),e.__handleFile=o}async function bt(n,t,a,e){const o=n.target.files[0];if(o)try{const r=await o.text(),l=JSON.parse(r);let s=null;l.exportFormat==="GachaCalculatorData"?s=l:a&&(s=a(l)),s?(gt(s),e.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(r){console.error("File import error:",r)}finally{n.target.value=""}}function gt(n){n.pity&&V(n.pity),n.constellation&&Y(n.constellation)}function Vt(n){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:n.getPityData(),constellation:n.getConstellationData()},a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(e),r=document.createElement("a");r.href=o;const l=new Date().toISOString().slice(0,10);r.download=`gachaCalc-data-${l}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log("Data exported successfully.")}function Yt(n,t=null){let a=0;const e=new Map;t&&t.forEach(c=>{if(c.group&&!c.group.startsWith("unique")){const i=parseInt(c.group.replace(/\D/g,""));a=Math.max(a,i),e.set(c.group,N(i))}});const o=document.getElementById("row-template"),r=document.querySelector(".rows-container"),l=document.getElementById("add-btn");function s(c=null,i=null){const p=o.content.cloneNode(!0).querySelector(".row"),f=p.querySelector(".dropdown"),S=p.querySelector(".type-selector"),b=f.querySelector(".type-icon"),g=f.querySelector(".type-text");p.querySelectorAll(".dropdown__item").forEach(h=>{h.addEventListener("click",m=>{m.preventDefault();const v=h.dataset.value;S.value=v;const w=S.options[S.selectedIndex];b.src=w.dataset.icon,g.textContent=w.textContent,u(p,v),f.classList.remove("dropdown--open")})});const A=i?.type||"char";S.value=A;const L=S.options[S.selectedIndex];b.src=L.dataset.icon,g.textContent=L.textContent;let d;if(i){d=i.group;let h=e.get(d);if(h===void 0&&!d.startsWith("unique")){const m=parseInt(d.replace(/\D/g,""));h=N(m),e.set(d,h)}p.style.setProperty("--group-color",d.startsWith("unique")?"#f0f0f0":`hsl(${h}, 80%, 70%)`),u(p,A,i.from,i.to)}else if(c){const h=c.dataset.group,m=c.querySelector(".type-selector").value,v=c.querySelector(".second-select").value;if(h.startsWith("unique")){const R=vt(e,a);d=`group${R}`;const I=N(R);p.style.setProperty("--group-color",`hsl(${I}, 80%, 70%)`),c.style.setProperty("--group-color",`hsl(${I}, 80%, 70%)`),c.dataset.group=d,e.set(d,I),R===a+1&&a++}else{d=h;const R=e.get(h);p.style.setProperty("--group-color",`hsl(${R}, 80%, 70%)`)}S.value=m;const w=S.options[S.selectedIndex];b.src=w.dataset.icon,g.textContent=w.textContent,u(p,m,v)}else d=`unique${A.charAt(0).toUpperCase()+A.slice(1)}`,p.style.setProperty("--group-color","#f0f0f0"),u(p,A);return p.dataset.group=d,f.addEventListener("click",h=>{h.stopPropagation(),f.classList.toggle("dropdown--open")}),document.addEventListener("click",h=>{f.contains(h.target)||f.classList.remove("dropdown--open")}),p.querySelectorAll(".dropdown__item").forEach(h=>{h.addEventListener("click",m=>{m.stopPropagation(),S.value=h.dataset.value;const v=S.options[S.selectedIndex];b.src=v.dataset.icon,g.textContent=v.textContent,f.classList.remove("dropdown--open"),u(p,S.value),p.dataset.group.startsWith("unique")||(p.dataset.group=`unique${S.value.charAt(0).toUpperCase()+S.value.slice(1)}`)})}),S.addEventListener("change",()=>{const h=S.options[S.selectedIndex];b.src=h.dataset.icon,g.textContent=h.textContent,u(p,S.value),f.classList.remove("dropdown--open"),p.dataset.group.startsWith("unique")||(p.dataset.group=`unique${S.value.charAt(0).toUpperCase()+S.value.slice(1)}`)}),p.querySelector(".btn--chainAdd").addEventListener("click",()=>{r.appendChild(s(p))}),p.querySelector(".btn--delete").addEventListener("click",()=>{const h=p.dataset.group;h.startsWith("unique")||Array.from(r.querySelectorAll(".row")).filter(v=>v.dataset.group===h).length===1&&e.delete(h),p.remove()}),p}function u(c,i,y=null,p=null){const f=c.querySelector(".first-select"),S=c.querySelector(".second-select");f.innerHTML="",S.innerHTML="";const b=n[i]||n.char;if(b.slice(0,-1).forEach(g=>{const A=document.createElement("option");A.value=g,A.textContent=g,f.appendChild(A)}),b.slice(1).forEach(g=>{const A=document.createElement("option");A.value=g,A.textContent=g,S.appendChild(A)}),y&&b.includes(y)){f.value=y;const g=b.indexOf(y);S.value=p&&b.includes(p)&&b.indexOf(p)>g?p:b[Math.min(g+1,b.length-1)]}else f.value=b[0],S.value=b[1]}r.innerHTML="",t?t.forEach(c=>{r.appendChild(s(null,c))}):r.appendChild(s()),l.addEventListener("click",()=>{r.appendChild(s())})}function N(n){const t=[0,120,240,60,180,300];return n<=t.length?t[n-1]:n*137.5%360}function vt(n,t){const a=Array.from(n.keys()).map(e=>parseInt(e.replace(/\D/g,""))).sort((e,o)=>e-o);for(let e=1;e<=t;e++)if(!a.includes(e))return e;return++t}function Gt(n=null){const t={probability:90,pulls:155},a=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]');n?(a.value=n.targetProb||t.probability,e.value=n.targetPull||t.pulls):(a.value=t.probability,e.value=t.pulls)}function Jt(n=null){const t=document.querySelector('[data-control="probability"]'),a=document.querySelector('[data-control="pulls"]'),e=document.querySelectorAll(".mode-label");let o;n?o=n:o="probability",r(),e.forEach(s=>{s.addEventListener("click",function(){o=this.getAttribute("data-target"),r(),l()})}),t.addEventListener("input",function(){o="probability",r(),l()}),a.addEventListener("input",function(){o="pulls",r(),l()});function r(){e.forEach(s=>{const u=s.getAttribute("data-target")===o;s.classList.toggle("active",u)})}function l(){o==="probability"?parseFloat(t.value):parseInt(a.value)}}const U={TABLES:1,CALCULATIONS:1,PULL_PLANS:1};function Zt(n){if(!n)throw new Error("Persistence factory requires a namespace.");const t={TABLES:`gacha_tables_${n}_v1`,CALCULATIONS:`gacha_calc_${n}_v1`,PULL_PLANS:`gacha_plans_${n}_v1`};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(a){this._save(t.CALCULATIONS,{_schema:U.CALCULATIONS,...a})},loadCalculation(){return this._validate(this._load(t.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(t.TABLES,{_schema:U.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(t.TABLES),"TABLES")},getPityData(){return Array.from(document.querySelectorAll(`${q.PITY_TABLE} tbody tr`)).map(a=>({banner:a.dataset.banner,pity4:a.querySelector('[data-control="pity-4"]').value,pity5:a.querySelector('[data-control="pity-5"]').value,guarantee4:a.querySelector(".guarantee-4").checked,guarantee5:a.querySelector(".guarantee-5").checked,...a.querySelector('[data-control="capRad"]')&&{caprad:a.querySelector('[data-control="capRad"]').value},...a.querySelector('[data-control="epPath"]')&&{epPath:a.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`)).map(a=>Array.from(a.querySelectorAll("td:nth-child(n+2) input")).map(e=>e.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(a=>a.value)},setupTableListeners(){const a=[`${q.PITY_TABLE} input`,`${q.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(a).forEach(e=>{e.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(a,e){try{localStorage.setItem(a,JSON.stringify(e))}catch(o){console.error("Storage error:",o),this._handleStorageError()}},_load(a){try{const e=localStorage.getItem(a);return e?JSON.parse(e):null}catch(e){return console.error("Load error:",e),null}},_validate(a,e){return a?typeof a._schema>"u"?a:a._schema!==U[e]?(console.warn(`Schema version mismatch for ${e}`),null):a:null},_handleStorageError(){Object.values(t).forEach(a=>{try{localStorage.removeItem(a)}catch(e){console.error("Cleanup failed:",e)}})}}}class Qt{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",a=>{if(a.target.matches('input[type="number"]'))try{a.target.select()}catch(e){console.warn("Could not select text in input.",e)}},{capture:!0}),t.addEventListener("keydown",a=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(a.key)||(a.ctrlKey||a.metaKey)&&["a","c","v","x"].includes(a.key.toLowerCase())||/^\d$/.test(a.key)||a.preventDefault()}),t.addEventListener("input",a=>{const e=a.target;e.matches('input[type="number"]')&&this.validateIndividualInput(e);const o=e.closest("table");if(o)switch(o.id){case"constellation-table":{const r=e.closest("tr");r&&this.validateRowSum(r),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#pity-table");t&&t.querySelectorAll('tbody tr input[type="number"]').forEach(e=>this.validateIndividualInput(e));const a=document.querySelector("#constellation-table");a&&a.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(e=>{e.querySelectorAll('input[type="number"]').forEach((o,r)=>{t[r]+=parseInt(o.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(a=>{const e=this.constellationMap[a.value];e!==void 0&&t[e]++}),t}validateIndividualInput(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),o=parseInt(t.max,10);if((!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=o)){t.classList.remove("is-invalid");return}}t.classList.add("is-invalid")}validateRowSum(t){if(!t.dataset.targetSum)return;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let o=0;e.forEach(r=>o+=parseFloat(r.value)||0),e.forEach(r=>r.classList.toggle("is-invalid",o!==a))}validateRateUpEligibility(){const t=this.getRateUpUsage(),a=this.availableConstellationCounts.map((e,o)=>t[o]>e);document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const o=this.constellationMap[e.value],r=o!==void 0&&a[o];e.classList.toggle("is-invalid",r)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const e of t)if(!this.isIndividualInputValid(e))return!1;const a=document.querySelectorAll("#constellation-table tbody tr");for(const e of a)if(!this.isRowSumValid(e))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),o=parseInt(t.max,10);return(!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=o)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let o=0;return e.forEach(r=>o+=parseFloat(r.value)||0),o===a}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((a,e)=>t[e]>a)}}function Xt(n){const{cashbackCalculator:t,uiUpdater:a}=n;return function(o){const{results:r,inputConfig:l,chartLabels:s,gachaConfig:u}=o,c=parseInt(document.querySelector('[data-control="pulls"]').value),i=Math.min(c,r.SSR.length-1),y=t(l,u,r.SSR[i],r.CharSR[i],r.WepSR[i],l.SR.rateUps);a(r,s,i,y)}}function te(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",a=>{if(!a.target.matches(".tab-link[data-tab-target]"))return;const e=a.target,o=e.closest(".tab-panel-card"),r=e.dataset.tabTarget,l=o.querySelector(r);if(!l){console.error(`Tab target not found: ${r}`);return}o.querySelectorAll(".tab-link").forEach(s=>s.classList.remove("active")),o.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),e.classList.add("active"),l.classList.add("active")})})}class ee{constructor(t,a,e){this.states=t,this.rankUps=a,this.totalSum=e}}function D(n,t){if(!Number.isInteger(n)||n<0)throw new Error("Number of trials (n) must be a non-negative integer.");if(typeof t!="number"||t<0||t>1)throw new Error("Probability of success (probability) must be a number between 0 and 1 inclusive.");let a=0,e=0,o=[],r=1;for(;a<=n;)e=r*Math.pow(t,a)*Math.pow(1-t,n-a),o.push(e),a++,r=r*(n+1-a)/a;return o}function ae(n){const t=[];for(let a=0;a<n.length;a++){const e=n[a],o=[];for(let r=0;r<e.length;r++){const l=e[r];let s=0,u=0,c;const i=Array.isArray(l)?l:[l];for(let y=0;y<i.length;y++)if(c=i[y].states.length,i[y].totalSum>1e-8){for(let p=(c-1)/2;p<c;p++)u+=i[y].states[p];s+=i[y].totalSum}o.push({lostSum:u}),o[r].totalSum=s}t.push(o)}return t}function ne(n){return n.map(t=>t.reduce((a,e)=>a+e,0))}function oe(n,t){let a=[],e=n.length,o=new Array(e).fill(0);o[0]+=n[0];for(let r=1;r<e;r++){a=D(r,1/t);for(let l=0;l<a.length;l++)o[l]+=a[l]*n[r]}return o}function Ct(n,t){if(t<0||t>n)return 0;if(t===0||t===n)return 1;t=Math.min(t,n-t);let a=1;for(let e=1;e<=t;e++)a*=(n-t+e)/e;return a}function At(n,t){for(const a of n){const e=G(a.rateUps);if(!_t(e,t)){a.probability=0;continue}const o=J(e,t),r=wt(n,t);a.probability=r===0?0:o/r}}function G(n){const t={};for(let a=0;a<n.length;a++){const e=n[a];e>0&&(t[a]=e)}return t}function _t(n,t){return Object.entries(n).every(([a,e])=>t[a]>=e)}function J(n,t){return Object.entries(n).reduce((a,[e,o])=>a*Ct(t[e],o),1)}function wt(n,t){return n.reduce((a,e)=>{const o=G(e.rateUps),r=J(o,t);return a+r},0)}function Et(n){const t=qt(n.points,n.probabilities);return{p10:j(t,.1),p90:j(t,.9)}}function qt(n,t){let a=0;return n.map((e,o)=>({value:e,probability:t[o]})).sort((e,o)=>e.value-o.value).map(e=>(a+=e.probability,{value:e.value,cumulativeProbability:a}))}function j(n,t){if(n.length===0)return 0;if(t<=0)return n[0].value;if(t>=1)return n[n.length-1].value;for(let a=0;a<n.length;a++)if(n[a].cumulativeProbability>=t)return Tt(n,a,t);return n[n.length-1].value}function Tt(n,t,a){if(t===0)return n[0].value;const e=n[t-1],o=n[t],r=o.cumulativeProbability-e.cumulativeProbability,l=(a-e.cumulativeProbability)/r;return e.value+l*(o.value-e.value)}class B{constructor(t,a,e){this.rateUps=t,this.offRates=a,this.probability=e}}class _{constructor(t,a,e){this.mean=t,this.p10=a,this.p90=e}}function Rt(n,t,a){const e=[],o=new Array(a).fill(0);function r(l,s){if(l===a){if(s===t){const c=Z(o,n);e.push(new B([...o],c))}return}const u=Math.min(n[l],t-s);for(let c=0;c<=u;c++)o[l]=c,r(l+1,s+c),o[l]=0}return r(0,0),e}function Z(n,t){const a=[...t];for(let e=0;e<n.length;e++)a[e]-=n[e];return a}function Pt(n,t,a){const e=n.length,o=a.reduce((c,i)=>c+i,0),r=t-o;if(r<0)return console.error("Error: More items are known than the total required."),[];const l=new Array(e);for(let c=0;c<e;c++)if(l[c]=n[c]-a[c],l[c]<0)return console.error(`Error: Known picks for constellation ${c} exceed its capacity.`),[];return Rt(l,r,e).map(c=>{const i=c.rateUps.map((p,f)=>p+a[f]),y=Z(i,n);return new B(i,y)})}function It(n,t,a){const e=t.map((l,s)=>l-a[s]),o=new Map;for(const l of n){const s=l.rateUps.map((c,i)=>c-a[i]);if(s.some(c=>c<0)){l.probability=0;continue}const u=new B(s,[]);o.set(u,l)}const r=Array.from(o.keys());r.length>0&&At(r,e);for(const[l,s]of o.entries())s.probability=l.probability}class Lt{constructor(t={}){this.maxType=t.maxType??7,this.regularPoints=t.regularPoints??2,this.specialPoints=t.specialPoints??5}}class Ot{constructor(t,a,e){this.expected=[...t],this.totalItems=a,this.config=e,this.mean=0,this.variance=0}computeStep(){let t=0;const a=new Array(this.expected.length).fill(0),{maxType:e,regularPoints:o,specialPoints:r}=this.config;this.expected.forEach((l,s)=>{const u=l/this.totalItems;s>=1&&s<e&&(t+=o*u),s===e&&(t+=r*u)}),a[0]=this.expected[0]*(this.totalItems-1)/this.totalItems;for(let l=1;l<e;l++)a[l]=this.expected[l]*(this.totalItems-1)/this.totalItems+this.expected[l-1]/this.totalItems;a[e]=this.expected[e]+this.expected[e-1]/this.totalItems,this.mean+=t,this.variance+=this.calculateVariance()-t**2,this.expected=a}calculateVariance(){const{regularPoints:t,specialPoints:a,maxType:e}=this.config;return(t**2*this.expected.slice(1,e).reduce((o,r)=>o+r,0)+a**2*this.expected[e])/this.totalItems}getPercentiles(){const t=Math.sqrt(this.variance);return{mean:this.mean,p10:this.mean-1.28*t,p90:this.mean+1.28*t}}}class xt{constructor(t,a,e){this.states=new Map,this.totalItems=a,this.config=e,this.initializeState(Array.from(t))}initializeState(t){const a={counts:t,totalPoints:0};this.states.set(JSON.stringify(a),1)}computeStep(t=1e-8){const a=new Map;for(const[e,o]of this.states){const{counts:r,totalPoints:l}=JSON.parse(e);this.processState(r,l,o,a)}this.pruneStates(a,t)}processState(t,a,e,o){const r=t.reduce((l,s)=>l+s,0);t.forEach((l,s)=>{if(l===0)return;const u=e*(l/r),{newCounts:c,newTotalPoints:i}=this.calculateNewState(t,s,a);this.updateStateMap(o,c,i,u)})}calculateNewState(t,a,e){const{maxType:o,regularPoints:r,specialPoints:l}=this.config,s=a===0?0:a<o?r:l,u=[...t];return a<o&&(u[a]--,u[a+1]++),{newCounts:u,newTotalPoints:e+s}}updateStateMap(t,a,e,o){const r=JSON.stringify({counts:a,totalPoints:e});t.set(r,(t.get(r)||0)+o)}pruneStates(t,a){let e=0;const o=new Map;for(const[r,l]of t)l>=a&&(o.set(r,l),e+=l);if(e>0)for(const[r,l]of o)o.set(r,l/e);this.states=o}getDistribution(){const t=new Map;for(const[o,r]of this.states){const{totalPoints:l}=JSON.parse(o);t.set(l,(t.get(l)||0)+r)}const a=Array.from(t.keys()).sort((o,r)=>o-r),e=a.map(o=>t.get(o));return{points:a,probabilities:e}}}class k{constructor(t,a,e,o=20){this.initialState=Array.from(t),this.totalItems=a,this.config=new Lt(e),this.dpThreshold=o}solve(t,a=1e-8){return t<this.dpThreshold?this.solveWithDP(t,a):this.solveWithIterative(t)}solveWithDP(t,a){const e=new xt(this.initialState,this.totalItems,this.config);for(let s=0;s<t;s++)e.computeStep(a);const o=e.getDistribution(),r=this.calculateMean(o),l=Et(o);return{mean:r,...l}}solveWithIterative(t){const a=new Ot(this.initialState,this.totalItems,this.config);for(let e=0;e<t;e++)a.computeStep();return{...a.getPercentiles()}}calculateMean(t){return t.points.reduce((a,e,o)=>a+e*t.probabilities[o],0)}}const T=["mean","p10","p90"],F=.5,z=1e-8,M=20;function kt(n,t,a,e,o){const r=t[t.length-1].length,l=a[a.length-1].length;let s=new Array(r).fill(0),u=new Array(l).fill(0),c=new _(0,0,0),i=new _(0,0,0),y=new _(0,0,0),p=[],f=[],S=0;n.length===1?S=15:S=7;for(const d of t){let h=0;for(let m=0;m<d.length;m++)h+=d[m].totalSum,s[m]+=d[m].totalSum,m>=1&&(s[m]+=d[m-1].lostSum);p.push(h)}for(const d of n){let h=new _(0,0,0),m=new _(0,0,0),v=new _(0,0,0);const w=new k(d.rateUps,e.rateUpCharacterSR,e.configSR,M);for(let C=0;C<p.length;C++)if(p[C]>z){let O=w.solve(C);T.forEach(P=>{m[P]+=O[P]*p[C]})}const R=new k(d.offRates,e.poolCharSR-e.rateUpCharacterSR,e.configSR,S);let I=[];for(let C=0;C<s.length;C++){I.push(R.solve(C));let O=D(C,F);for(let P=0;P<O.length;P++)T.forEach(W=>{v[W]+=I[P][W]*O[P]*s[C]})}T.forEach(C=>{h[C]=m[C]+v[C],c[C]+=h[C]*d.probability})}for(const d of a){let h=0;for(let m=0;m<d.length;m++)h+=d[m].totalSum,u[m]+=d[m].totalSum,m>=1&&(u[m]+=d[m-1].lostSum);f.push(h)}let b=new _(0,0,0),g=new _(0,0,0);for(let d=0;d<f.length;d++)if(f[d]>z){let h=d*e.configWep.pointsSR,m=new _(h,h,h);T.forEach(v=>{b[v]+=m[v]*f[d]})}const A=new k(o.SR.consCount,e.poolCharSR,e.configSR,M);let L=[];for(let d=0;d<u.length;d++)if(u[d]>0){L.push(A.solve(d));let h=D(d,F);for(let m=0;m<h.length;m++){let v=(d-m)*e.configWep.pointsSR;T.forEach(w=>{g[w]+=(L[m][w]+v)*h[m]*u[d]})}}return T.forEach(d=>{i[d]=b[d]+g[d],y[d]=c[d]+i[d]}),y}function Nt(n,t,a,e,o){const r=new k(a,t,o.configSSR,M),l=n[n.length-1][n[n.length-1].length]>0?n[n.length-1].length+1:n[n.length-1].length;let s=[],u=[],c=0;for(let i=0;i<l;i++)s.push(r.solve(i));for(let i=0;i<n.length;i++){i>0&&(e[i-1]==="none"?c+=0:e[i-1]==="regular"&&(c+=o.configSSR.regularPoints));let y=new _(0,0,0),p=0;for(let f=0;f<n[i].length;f++)p+=n[i][f].totalSum;if(p>0)for(let f=0;f<n[i].length;f++){const S=s[f];let b;f===0?b=n[i][f].totalSum/p:b=(n[i][f].totalSum+n[i][f-1].lostSum)/p,T.forEach(g=>{y[g]+=S[g]*b})}T.forEach(f=>{y[f]+=c}),u.push(y)}return u}function re(n,t,a,e,o,r){let l=Pt(n.SR.consCount,t.rateUpCharacterSR,r);It(l,n.SR.consCount,r);let s=kt(l,e,o,t,n),u=Nt(a,t.poolStandardCharSSR,n.SSR.consCountStandard,n.SSR.cashbackRoadmap,t),c=[];for(const i of u){let y=new _(0,0,0);T.forEach(p=>{y[p]=i[p]+s[p]}),c.push(y)}return c}export{Mt as C,dt as O,ee as P,Qt as T,Ht as W,Wt as a,Bt as b,jt as c,$t as d,Zt as e,Xt as f,Dt as g,Ut as h,Ft as i,te as j,Kt as k,Vt as l,Yt as m,Gt as n,pt as o,ne as p,oe as q,H as r,Jt as s,re as t,zt as u,ae as v};
