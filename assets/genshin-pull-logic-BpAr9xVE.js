function z(b,s,o,p,N,g){const{charPullsSum:h,wepPullsSum:c}=f(b),U={characters:0,weapons:0},S={charLoss:null,wepLoss:null},P=b.length-2;for(let t=P;t>=0;t--){const n=g[t+1],L=n.pity;let u=null;if(n.type==="firstChar"&&(u=n.special),!b[t].isEmpty)for(let r=0;r<4;r++){const e=b[t][r];if(!e.isEmpty)if(e.type==="Character")O(s,t,b,p,U,L,r);else if(e.type==="Weapon")W(o,t,b,N,U,L,r,u);else throw new Error(`Unknown SSR array type: ${e.type}`)}}const{charRankUps:a,wepRankUps:l}=E(h,c,U);return S.charLoss=a,S.wepLoss=l,S;function f(t){const n={charPullsSum:0,wepPullsSum:0};if(t.length<=1)return n;const L=t.length-1,u=t[0].length;for(let r=0;r<L;r++){let e=0;const i=t[r][0].type;for(let w=0;w<u;w++){const{states:R}=t[r][w];for(const V of R)for(const{prob:y}of V.values())e+=y}switch(i){case"Character":n.charPullsSum+=e;break;case"Weapon":n.wepPullsSum+=e;break}}return n}function E(t,n,L){return{charRankUps:t-L.characters,wepRankUps:n-L.weapons}}}function A(b,s,o,p){const N=b.length-1;for(let g=N;g>=0;g--)b[g].isEmpty||C(o,g,b,p,s)}function G(b,s,o,p,N,g){const h=b.length-2;for(let c=h;c>=0;c--){const U=g[c+1],S=U.pity;let P=null;if(U.type==="firstChar"&&(P=U.special),!b[c].isEmpty)for(let a=0;a<4;a++){const l=b[c][a];if(!l.isEmpty)if(l.type==="Character")k(s,c,b,p,S,a);else if(l.type==="Weapon")x(o,c,b,N,S,a,P);else throw new Error(`Unknown SSR array type: ${l.type}`)}}}function O(b,s,o,p,N,g,h){const c=Math.floor(h/2),U=o[s][h].states;if(h!=3){const S=o[s][h].states.length;let P=.5;h===2&&(P=.55);const a=o[s+1][c].states,l=o[s+1][h+1].states;for(let f=S-2;f>=0;f--){const E=U[f],t=f>=p,n=b[f-p*t];for(const[L,u]of E){const r=u.prob*n,e=u.prob-r;let i=r;if(i>1e-10){let R=l;t||(i*=P,R=a);const V=R[g],y=V.get(L);y?y.prob+=i:V.set(L,{prob:i}),N.characters+=i}if(!t){let R=r*(1-P);if(R>1e-10){let V=L+100;const y=U[p],_=y.get(V);_?_.prob+=R:y.set(V,{prob:R})}}let w=e;if(w>1e-10){const R=U[f+1],V=R.get(L);V?V.prob+=w:R.set(L,{prob:w})}u.prob=0}}}else{const S=o[s+1][c].states,P=o[s][h].states.length;for(let a=P-2;a>=0;a--){const l=U[a],f=b[a];for(const[E,t]of l){const n=t.prob*f,L=t.prob-n;let u=n;if(u>1e-10){const e=S[g],i=e.get(E);i?i.prob+=u:e.set(E,{prob:u}),N.characters+=u}let r=L;if(r>1e-10){const e=U[a+1],i=e.get(E);i?i.prob+=r:e.set(E,{prob:r})}t.prob=0}}}}function W(b,s,o,p,N,g,h,c){let U=h;c!=null&&(U=c);const S=o[s][h].states.length,P=.375,a=.625,l=o[s][h].states,f=o[s+1][U].states;for(let E=S-2;E>=0;E--){const t=l[E],n=E>=2*p;let L=!1;n||(L=E>=p);const u=b[E-p*L-p*n*2];for(const[r,e]of t){const i=e.prob*u,w=e.prob-i;let R=i;if(R>1e-10){n||(L?R*=a:R*=P);const y=f[g],_=y.get(r);_?_.prob+=R:y.set(r,{prob:R}),N.weapons+=R}if(!n){let y=i*(1-P);if(L&&(y=i*(1-a)),y>1e-10){let _=r+1;const M=l[p*2],m=M.get(_);m?m.prob+=y:M.set(_,{prob:y})}}let V=w;if(V>1e-10){const y=l[E+1],_=y.get(r);_?_.prob+=V:y.set(r,{prob:V})}e.prob=0}}}function C(b,s,o,p,N){const g=o[s].states.length,h=o[s].states;for(let c=g-1;c>=0;c--){const U=h[c],S=c>=p,P=b[c-p*S],a=.5;for(const[l,f]of U){const E=f.prob,t=E*N,n=E-t;if(f.prob=n,t>1e-10){const L=t*P,u=t-L;let r=L;if(r>1e-10){S||(r*=a),o[s+1]===void 0&&(o[s+1]={states:Array.from({length:o[s].states.length},()=>new Map)});const i=o[s+1].states[0],w=i.get(l);w?w.prob+=r:i.set(l,{prob:r})}if(!S){let i=L*(1-a);if(i>1e-10){let w=l;w++;const R=h[p],V=R.get(w);V?V.prob+=i:R.set(w,{prob:i})}}let e=u;if(e>1e-10){const i=h[c+1],w=i.get(l);w?w.prob+=e:i.set(l,{prob:e})}}}}}function k(b,s,o,p,N,g){const h=Math.floor(g/2),c=o[s][g].states;if(g!=3){const U=o[s][g].states.length;let S=.5;g===2&&(S=.55);const P=o[s+1][h].states,a=o[s+1][g+1].states;for(let l=U-2;l>=0;l--){const f=c[l],E=l>=p,t=b[l-p*E],n=f*t,L=f-n;let u=n;if(u>1e-10){let e=a;E||(u*=S,e=P),e[N]+=u}if(!E){let e=n*(1-S);e>1e-10&&(c[p]+=e)}let r=L;r>1e-10&&(c[l+1]+=r),c[l]=0}}else{const U=o[s+1][h].states,S=o[s][g].states.length;for(let P=S-2;P>=0;P--){const a=c[P],l=b[P],f=a*l,E=a-f;let t=f;t>1e-10&&(U[N]+=t);let n=E;n>1e-10&&(c[P+1]+=n),c[P]=0}}}function x(b,s,o,p,N,g,h){let c=g;h!=null&&(c=h);const U=o[s][g].states.length,S=.375,P=.625,a=o[s][g].states,l=o[s+1][c].states;for(let f=U-2;f>=0;f--){const E=a[f],t=f>=2*p;let n=!1;t||(n=f>=p);const L=b[f-p*n-p*t*2],u=E*L,r=E-u;let e=u;if(e>1e-10&&(t||(n?e*=P:e*=S),l[N]+=e),!t){let w=u*(1-S);n&&(w=u*(1-P)),w>1e-10&&(a[p*2]+=w)}let i=r;i>1e-10&&(a[f+1]+=i),a[f]=0}}export{A as rankUpSR,z as rankUpSSR,G as rankUpSSRCheap};
