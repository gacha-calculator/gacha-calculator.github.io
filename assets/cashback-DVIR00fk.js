(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&e(l)}).observe(document,{childList:!0,subtree:!0});function a(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(n){if(n.ep)return;n.ep=!0;const r=a(n);fetch(n.href,r)}})();const $={CHARACTER:"character",WEAPON:"weapon"},q={PITY_ROW:"[data-banner]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},K={pitySettings:{[$.CHARACTER]:{pity4:0,pity5:0,caprad:1},[$.WEAPON]:{pity4:0,pity5:0,epPath:0}},constellationColumns:8},w=(o,t=!1)=>o?t?o.checked:parseInt(o.value)||0:null;function Q(o,t){const a=document.getElementById("pity-panel"),e=document.getElementById("constellation-panel"),n=t.paths;if(!a||!e)return console.error("Required tab panels not found. Cannot get page configuration."),null;const r=(c,i)=>{if(!i)return[];const S=i.querySelector("#constellation-table");if(!S)return console.warn("Could not find the constellation table inside the panel:",i),[];const d=S.querySelectorAll(`tr[data-rarity="${c}"] .custom-input`);return Array.from(d).map(f=>parseInt(f.value)||0)},l=a.querySelector(`${q.PITY_ROW}[data-banner="character"]`),s=a.querySelector(`${q.PITY_ROW}[data-banner="weapon"]`),u=tt(n);return!l||!s?(console.error("Pity rows for character or weapon not found inside #pity-panel."),null):{SSR:{pity:{char:w(l.querySelector('[data-control="pity-5"]')),wep:w(s.querySelector('[data-control="pity-5"]'))},guarantee:{char:w(l.querySelector(".guarantee-5"),!0),wep:w(s.querySelector(".guarantee-5"),!0)},special:{capRad:w(l.querySelector('[data-control="capRad"]')),epitPath:w(s.querySelector('[data-control="epPath"]'))},consCountStandard:r(5,e),pullPlan:u.typeArray,cashbackRoadmap:u.cashbackArray},SR:{pity:{char:w(l.querySelector('[data-control="pity-4"]')),wep:w(s.querySelector('[data-control="pity-4"]'))},guarantee:{char:w(l.querySelector(".guarantee-4"),!0),wep:w(s.querySelector(".guarantee-4"),!0)},rateUps:at(o),consCount:r(4,e)}}}function X(){const o=document.querySelectorAll(".row"),t=[];return Array.from(o).slice(1).forEach(e=>{const n=e.dataset.group,r=e.querySelector(".type-selector")?.value||"char",l=e.querySelector(".first-select")?.value||"None",s=e.querySelector(".second-select")?.value||"None";t.push({group:n,type:r,from:l,to:s})}),t}function tt(o){const t=document.querySelectorAll(".row"),a=[],e=[];return Array.from(t).slice(1).forEach(r=>{const l=r.querySelector(".type-selector")?.value||"char",s=r.querySelector(".first-select")?.value||"None",u=r.querySelector(".second-select")?.value||"None",c=l==="char"?o.char:o.wep,i=c.indexOf(s),S=c.indexOf(u);if(i===-1||S===-1||i>=S)return;const d=S-i;let f=i,m=0;for(let b=0;b<d;b++)l==="char"?(f===0?m="none":m="regular",a.push(0)):(m="regular",a.push(1)),e.push(m),f++}),{typeArray:a,cashbackArray:e}}function et(o){const t=document.querySelectorAll(".row"),a=Array.from(t).slice(1);let e=["None"];const n=o.char,r=o.wep;return a.forEach(l=>{const s=l.querySelector(".type-selector")?.value||"char",u=l.querySelector(".first-select")?.value||"None",c=l.querySelector(".second-select")?.value||"None",i=s==="char"?n:r,S=i.indexOf(u),d=i.indexOf(c);if(S===-1||d===-1||S>=d)return;const f=i.slice(S+1,d+1);e.push(...f)}),e}function at(o){const t=document.querySelectorAll("#rate-up-table select.custom-select");let a=new Array(Object.keys(o).length).fill(0);return t.length===0?(console.error("Could not find any rate-up select elements."),[]):(t.forEach(e=>{const n=e.value;if(n==="unknown")return;const r=o[n];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${n}"`)}),a)}let O=null;function ot(){const o=document.getElementById("myChart").getContext("2d");O=new Chart(o,{type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{color:"#b8c2d0",callback:function(t){return(t*100).toFixed(0)+"%"}},grid:{color:"rgba(58, 58, 106, 0.5)"},beginAtZero:!0,min:0,max:1},x:{ticks:{color:"#b8c2d0"},grid:{color:"rgba(58, 58, 106, 0.5)"}}},plugins:{legend:{labels:{color:"#f5f5f5",sort:(t,a)=>t.datasetIndex-a.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(t){let a=t.dataset.label||"";return a&&(a+=": "),a+=(t.parsed.y*100).toFixed(2)+"%",a}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function nt(o){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[o%t.length]}function rt(o){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(o-2)%t.length]}function lt(o,t,a){O||ot();const e=o.length,n=a.slice(1);O.data.labels=t,O.data.datasets=o.map((r,l)=>{const s=l===0?"#2196F3":l===1?"#4CAF50":nt(l);return{label:n[l],data:r,borderColor:s,backgroundColor:l===0?"rgba(33, 150, 243, 0.1)":l===1?"rgba(76, 175, 80, 0.1)":rt(l),fill:!0,tension:.4,order:e-l,borderWidth:3,pointRadius:0,pointHoverRadius:5}}),O.update()}function st(o){let t=[],a=[0];for(let e=1;e<o[0].length;e++)t.push(Array(o.length+1).fill(0));for(let e=0;e<o.length;e++){for(let n=1;n<o[e].length;n++){let r=0;for(let l=0;l<o[e][n].length;l++)r+=o[e][n][l].totalSum;for(let l=0;l<n;l++)t[l][e+1]+=r}a.push(e+1)}return{data:t,labels:a}}function ct(o){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=it(o,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=ut(o,parseInt(document.querySelector('[data-control="pulls"]').value))}function it(o,t){t===100&&(t=99.9);let a=o.length-1,e=!0,n=0,r=0;for(;e;)o[a][r]>t/100&&(n=r,e=!1),r++;return n}function ut(o,t){let a=o.length-1;return o[a].length<=t?100:Math.round(o[a][t]*100)}function Ut(o,t){return function(){const e=Q(o.calculatorConfig.CONSTELLATION_MAP,o.calculatorConfig.gachaConfig),n=et(o.calculatorConfig.gachaConfig.paths),r=o.calculatorFunction(e),l=st(r.SSR);lt(l.data,l.labels,n),ct(l.data);const s={results:r,inputConfig:e,chartLabels:n,gachaConfig:o.calculatorConfig.gachaConfig};if(o.postCalculationHooks&&o.postCalculationHooks.forEach(u=>u(s)),t){const u=parseInt(document.querySelector('[data-control="pulls"]').value);t.saveCalculation({input:X(),targetProb:e.targetProb,targetPull:u,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")})}}}const dt=[.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.066,.126,.186,.246,.306,.366,.426,.486,.546,.606,.666,.726,.786,.846,.906,.966,1],pt=[.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.077,.147,.217,.287,.357,.427,.497,.567,.637,.707,.777,.847,.917,.987,1],W=[.051,.051,.051,.051,.051,.051,.051,.051,.561,1],Dt={maxCharacterConstelation:6,rateUpCharacterSR:3,rateUpWeaponSR:5,poolStandardCharSSR:8,poolCharSR:43,configSR:{maxType:7,regularPoints:.4,specialPoints:1},configSSR:{maxType:7,regularPoints:2,specialPoints:5},configWep:{pointsSR:.4,pointsSSR:2},paths:{char:["None","c0","c1","c2","c3","c4","c5","c6"],wep:["None","r1","r2","r3","r4","r5"]},pity:{pitySSRChar:dt.length,pitySSRWep:pt.length,pitySRChar:W.length,pitySRWep:W.length},default:0},ft=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"c0",text:"C0"},{value:"c1",text:"C1"},{value:"c2",text:"C2"},{value:"c3",text:"C3"},{value:"c4",text:"C4"},{value:"c5",text:"C5"},{value:"c6",text:"C6"}],Mt={none:0,c0:1,c1:2,c2:3,c3:4,c4:5,c5:6,c6:7},Bt=new Set(["dehya","diluc","jean","keqing","mona","qiqi","tighnari","yumemizuki_mizuki"]),$t=new Set(["barbara","beidou","bennett","candace","charlotte","chevreuse","chongyun","collei","dahlia","diona","dori","faruzan","fischl","freminet","gaming","gorou","iansan","ifa","kachina","kaveh","kirara","kujou_sara","kuki_shinobu","lan_yan","layla","lynette","mika","ningguang","noelle","ororon","razor","rosaria","sayu","sethos","shikanoin_heizou","sucrose","thoma","xiangling","xingqiu","xinyan","yanfei","yaoyao","yun_jin"]),Wt=new Set(["amos_bow","aquila_favonia","lost_prayer_to_the_sacred_winds","primordial_jade_winged-spear","skyward_atlas","skyward_blade","skyward_harp","skyward_pride","skyward_spine","wolfs_gravestone"]),Ht=new Set(["dragons_bane","eye_of_perception","favonius_codex","favonius_greatsword","favonius_lance","favonius_sword","favonius_warbow","lions_roar","rainslasher","rust","sacrificial_bow","sacrificial_fragments","sacrificial_greatsword","sacrificial_sword","the_bell","the_flute","the_stringless","the_widsith","akuoumaru","alley_hunter","flower-wreathed_feathers","fruitful_hook","lithic_blade","lithic_spear","makhaira_aquamarine","mitternachts_waltz","mountain-bracing_bolt","mouuns_moon","portable_power_saw","prospectors_drill","range_gauge","sturdy_bone","the_alley_flash","the_dockhands_assistant","wandering_evenstar","wavebreakers_fin","waveriding_whirl","wine_and_song","xiphos_moonlight"]),Ft=new Set(["black_tassel","bloodtainted_greatsword","cool_steel","debate_club","emerald_orb","ferrous_shadow","harbinger_of_dawn","magic_guide","raven_bow","sharpshooters_oath","skyrider_sword","slingshot","thrilling_tales_of_dragon_slayers","white_tassel"]);function jt(o,t,a){ht(t.pity),yt(t),mt();const e=o.loadTables();e&&(V(e.pity),Y(e.constellation),St(e.rateUps),a.validateAll()),o.init()}function ht(o){const t=document.getElementById("pity-row-template"),a=document.querySelector(`${q.PITY_TABLE} tbody`);Object.entries(K.pitySettings).forEach(([e,n])=>{const r=t.content.cloneNode(!0).querySelector("tr"),l=r.querySelector(".special-mechanic");r.dataset.validationType="individual";const s=r.querySelector('[data-control="pity-4"]'),u=r.querySelector('[data-control="pity-5"]');if(s&&(s.min=0,s.max=e.includes("Weapon")?o.pitySRWep-1:o.pitySRChar-1),u&&(u.min=0,u.max=e.includes("Weapon")?o.pitySSRWep-1:o.pitySSRChar-1),r.dataset.banner=e,r.querySelector(".banner-name").textContent=e,r.querySelector('[data-control="pity-4"]').value=n.pity4,r.querySelector('[data-control="pity-5"]').value=n.pity5,l){let c="";e==="character"?c=`
            <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                   value="${n.caprad??0}"> 
        `:e==="weapon"&&(c=`
            <input type="number" data-control="epPath" class="custom-input" min="0" max="2" 
                   value="${n.epPath??0}">
        `),l.innerHTML=c}a.appendChild(r)})}function yt(o){const t=document.getElementById("const-column-template"),a=document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`),e=o.poolStandardCharSSR,n=o.poolCharSR;a.forEach(r=>{const l=document.createDocumentFragment(),u=r.querySelector("td:first-child")?.textContent.trim();r.dataset.validationType="row-sum",u==="5★"?(r.dataset.targetSum=o.poolStandardCharSSR,r.dataset.rarity="5"):(r.dataset.targetSum=o.poolCharSR,r.dataset.rarity="4");for(let c=0;c<K.constellationColumns;c++){const i=t.content.cloneNode(!0);if(c===0){const S=i.querySelector("input");if(S){const d=u==="5★"?e:n;S.value=d}}l.appendChild(i)}r.appendChild(l)})}function mt(){const o=document.querySelectorAll("#rate-up-table select");if(o.length===0)return;const t=ft.map(a=>`<option value="${a.value}">${a.text}</option>`).join("");o.forEach(a=>{a.innerHTML=t,a.value="unknown"})}function zt(o,t,a,e){const n=[];for(let l=0;l<o.SSR[a-1].length;l++){let s=0;for(let u of o.SSR[a-1][l])s+=u.totalSum;s=(s*100).toFixed(2),s>0&&n.push({name:t[l],probability:s,p10:e[l].p10,mean:e[l].mean,p90:e[l].p90,color:"#3498db"})}const r=document.querySelector("#probability-table tbody");r.innerHTML="",n.forEach(l=>{const s=document.createElement("tr"),u=l.probability;s.innerHTML=`
      <td>${l.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${u}%;background:${l.color}">
            <div class="progress-label">${l.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${l.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${l.mean.toFixed(1)}</td>
      <td class="cashback-value">${l.p90.toFixed(1)}</td>
    `,r.appendChild(s)})}function V(o){o.forEach(t=>{const a=document.querySelector(`${q.PITY_TABLE} tr[data-banner="${t.banner}"]`);a&&(a.querySelector('[data-control="pity-4"]').value=t.pity4,a.querySelector('[data-control="pity-5"]').value=t.pity5,a.querySelector(".guarantee-4").checked=t.guarantee4,a.querySelector(".guarantee-5").checked=t.guarantee5,t.caprad&&a.querySelector('[data-control="capRad"]')&&(a.querySelector('[data-control="capRad"]').value=t.caprad),t.epPath&&a.querySelector('[data-control="epPath"]')&&(a.querySelector('[data-control="epPath"]').value=t.epPath))})}function Y(o){document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`).forEach((a,e)=>{const n=o[e];n&&a.querySelectorAll("td:nth-child(n+2) input").forEach((l,s)=>{n[s]!==void 0&&(l.value=n[s])})})}function St(o){if(!o||!Array.isArray(o))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((a,e)=>{o[e]!==void 0&&(a.value=o[e])})}function Kt(o,t,a){const e=document.getElementById("import-file-input");if(!e){console.error("Import file input not found!");return}const n=r=>bt(r,o,t,a);e.removeEventListener("change",e.__handleFile),e.addEventListener("change",n),e.__handleFile=n}async function bt(o,t,a,e){const n=o.target.files[0];if(n)try{const r=await n.text(),l=JSON.parse(r);let s=null;l.exportFormat==="GachaCalculatorData"?s=l:a&&(s=a(l)),s?(gt(s),e.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(r){console.error("File import error:",r)}finally{o.target.value=""}}function gt(o){o.pity&&V(o.pity),o.constellation&&Y(o.constellation)}function Vt(o){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:o.getPityData(),constellation:o.getConstellationData()},a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(e),r=document.createElement("a");r.href=n;const l=new Date().toISOString().slice(0,10);r.download=`gachaCalc-data-${l}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n),console.log("Data exported successfully.")}function Yt(o,t=null){let a=0;const e=new Map;t&&t.forEach(c=>{if(c.group&&!c.group.startsWith("unique")){const i=parseInt(c.group.replace(/\D/g,""));a=Math.max(a,i),e.set(c.group,N(i))}});const n=document.getElementById("row-template"),r=document.querySelector(".rows-container"),l=document.getElementById("add-btn");function s(c=null,i=null){const d=n.content.cloneNode(!0).querySelector(".row"),f=d.querySelector(".dropdown"),m=d.querySelector(".type-selector"),b=f.querySelector(".type-icon"),g=f.querySelector(".type-text");d.querySelectorAll(".dropdown__item").forEach(h=>{h.addEventListener("click",y=>{y.preventDefault();const v=h.dataset.value;m.value=v;const E=m.options[m.selectedIndex];b.src=E.dataset.icon,g.textContent=E.textContent,u(d,v),f.classList.remove("dropdown--open")})});const A=i?.type||"char";m.value=A;const L=m.options[m.selectedIndex];b.src=L.dataset.icon,g.textContent=L.textContent;let p;if(i){p=i.group;let h=e.get(p);if(h===void 0&&!p.startsWith("unique")){const y=parseInt(p.replace(/\D/g,""));h=N(y),e.set(p,h)}d.style.setProperty("--group-color",p.startsWith("unique")?"#f0f0f0":`hsl(${h}, 80%, 70%)`),u(d,A,i.from,i.to)}else if(c){const h=c.dataset.group,y=c.querySelector(".type-selector").value,v=c.querySelector(".second-select").value;if(h.startsWith("unique")){const R=vt(e,a);p=`group${R}`;const I=N(R);d.style.setProperty("--group-color",`hsl(${I}, 80%, 70%)`),c.style.setProperty("--group-color",`hsl(${I}, 80%, 70%)`),c.dataset.group=p,e.set(p,I),R===a+1&&a++}else{p=h;const R=e.get(h);d.style.setProperty("--group-color",`hsl(${R}, 80%, 70%)`)}m.value=y;const E=m.options[m.selectedIndex];b.src=E.dataset.icon,g.textContent=E.textContent,u(d,y,v)}else p=`unique${A.charAt(0).toUpperCase()+A.slice(1)}`,d.style.setProperty("--group-color","#f0f0f0"),u(d,A);return d.dataset.group=p,f.addEventListener("click",h=>{h.stopPropagation(),f.classList.toggle("dropdown--open")}),document.addEventListener("click",h=>{f.contains(h.target)||f.classList.remove("dropdown--open")}),d.querySelectorAll(".dropdown__item").forEach(h=>{h.addEventListener("click",y=>{y.stopPropagation(),m.value=h.dataset.value;const v=m.options[m.selectedIndex];b.src=v.dataset.icon,g.textContent=v.textContent,f.classList.remove("dropdown--open"),u(d,m.value),d.dataset.group.startsWith("unique")||(d.dataset.group=`unique${m.value.charAt(0).toUpperCase()+m.value.slice(1)}`)})}),m.addEventListener("change",()=>{const h=m.options[m.selectedIndex];b.src=h.dataset.icon,g.textContent=h.textContent,u(d,m.value),f.classList.remove("dropdown--open"),d.dataset.group.startsWith("unique")||(d.dataset.group=`unique${m.value.charAt(0).toUpperCase()+m.value.slice(1)}`)}),d.querySelector(".btn--chainAdd").addEventListener("click",()=>{r.appendChild(s(d))}),d.querySelector(".btn--delete").addEventListener("click",()=>{const h=d.dataset.group;h.startsWith("unique")||Array.from(r.querySelectorAll(".row")).filter(v=>v.dataset.group===h).length===1&&e.delete(h),d.remove()}),d}function u(c,i,S=null,d=null){const f=c.querySelector(".first-select"),m=c.querySelector(".second-select");f.innerHTML="",m.innerHTML="";const b=o[i]||o.char;if(b.slice(0,-1).forEach(g=>{const A=document.createElement("option");A.value=g,A.textContent=g,f.appendChild(A)}),b.slice(1).forEach(g=>{const A=document.createElement("option");A.value=g,A.textContent=g,m.appendChild(A)}),S&&b.includes(S)){f.value=S;const g=b.indexOf(S);m.value=d&&b.includes(d)&&b.indexOf(d)>g?d:b[Math.min(g+1,b.length-1)]}else f.value=b[0],m.value=b[1]}r.innerHTML="",t?t.forEach(c=>{r.appendChild(s(null,c))}):r.appendChild(s()),l.addEventListener("click",()=>{r.appendChild(s())})}function N(o){const t=[0,120,240,60,180,300];return o<=t.length?t[o-1]:o*137.5%360}function vt(o,t){const a=Array.from(o.keys()).map(e=>parseInt(e.replace(/\D/g,""))).sort((e,n)=>e-n);for(let e=1;e<=t;e++)if(!a.includes(e))return e;return++t}function Gt(o=null){const t={probability:90,pulls:155},a=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]');o?(a.value=o.targetProb||t.probability,e.value=o.targetPull||t.pulls):(a.value=t.probability,e.value=t.pulls)}function Jt(o=null){const t=document.querySelector('[data-control="probability"]'),a=document.querySelector('[data-control="pulls"]'),e=document.querySelectorAll(".mode-label");let n;o?n=o:n="probability",r(),e.forEach(s=>{s.addEventListener("click",function(){n=this.getAttribute("data-target"),r(),l()})}),t.addEventListener("input",function(){n="probability",r(),l()}),a.addEventListener("input",function(){n="pulls",r(),l()});function r(){e.forEach(s=>{const u=s.getAttribute("data-target")===n;s.classList.toggle("active",u)})}function l(){n==="probability"?parseFloat(t.value):parseInt(a.value)}}const U={TABLES:1,CALCULATIONS:1,PULL_PLANS:1};function Zt(o){if(!o)throw new Error("Persistence factory requires a namespace.");const t={TABLES:`gacha_tables_${o}_v1`,CALCULATIONS:`gacha_calc_${o}_v1`,PULL_PLANS:`gacha_plans_${o}_v1`};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(a){this._save(t.CALCULATIONS,{_schema:U.CALCULATIONS,...a})},loadCalculation(){return this._validate(this._load(t.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(t.TABLES,{_schema:U.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(t.TABLES),"TABLES")},getPityData(){return Array.from(document.querySelectorAll(`${q.PITY_TABLE} tbody tr`)).map(a=>({banner:a.dataset.banner,pity4:a.querySelector('[data-control="pity-4"]').value,pity5:a.querySelector('[data-control="pity-5"]').value,guarantee4:a.querySelector(".guarantee-4").checked,guarantee5:a.querySelector(".guarantee-5").checked,...a.querySelector('[data-control="capRad"]')&&{caprad:a.querySelector('[data-control="capRad"]').value},...a.querySelector('[data-control="epPath"]')&&{epPath:a.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${q.CONSTELLATION_TABLE} tbody tr`)).map(a=>Array.from(a.querySelectorAll("td:nth-child(n+2) input")).map(e=>e.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(a=>a.value)},setupTableListeners(){const a=[`${q.PITY_TABLE} input`,`${q.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(a).forEach(e=>{e.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(a,e){try{localStorage.setItem(a,JSON.stringify(e))}catch(n){console.error("Storage error:",n),this._handleStorageError()}},_load(a){try{const e=localStorage.getItem(a);return e?JSON.parse(e):null}catch(e){return console.error("Load error:",e),null}},_validate(a,e){return a?typeof a._schema>"u"?a:a._schema!==U[e]?(console.warn(`Schema version mismatch for ${e}`),null):a:null},_handleStorageError(){Object.values(t).forEach(a=>{try{localStorage.removeItem(a)}catch(e){console.error("Cleanup failed:",e)}})}}}class Qt{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",a=>{if(a.target.matches('input[type="number"]'))try{a.target.select()}catch(e){console.warn("Could not select text in input.",e)}},{capture:!0}),t.addEventListener("keydown",a=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(a.key)||(a.ctrlKey||a.metaKey)&&["a","c","v","x"].includes(a.key.toLowerCase())||/^\d$/.test(a.key)||a.preventDefault()}),t.addEventListener("input",a=>{const e=a.target;e.matches('input[type="number"]')&&this.validateIndividualInput(e);const n=e.closest("table");if(n)switch(n.id){case"constellation-table":{const r=e.closest("tr");r&&this.validateRowSum(r),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#pity-table");t&&t.querySelectorAll('tbody tr input[type="number"]').forEach(e=>this.validateIndividualInput(e));const a=document.querySelector("#constellation-table");a&&a.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(e=>{e.querySelectorAll('input[type="number"]').forEach((n,r)=>{t[r]+=parseInt(n.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(a=>{const e=this.constellationMap[a.value];e!==void 0&&t[e]++}),t}validateIndividualInput(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),n=parseInt(t.max,10);if((!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=n)){t.classList.remove("is-invalid");return}}t.classList.add("is-invalid")}validateRowSum(t){if(!t.dataset.targetSum)return;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let n=0;e.forEach(r=>n+=parseFloat(r.value)||0),e.forEach(r=>r.classList.toggle("is-invalid",n!==a))}validateRateUpEligibility(){const t=this.getRateUpUsage(),a=this.availableConstellationCounts.map((e,n)=>t[n]>e);document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const n=this.constellationMap[e.value],r=n!==void 0&&a[n];e.classList.toggle("is-invalid",r)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const e of t)if(!this.isIndividualInputValid(e))return!1;const a=document.querySelectorAll("#constellation-table tbody tr");for(const e of a)if(!this.isRowSumValid(e))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const a=parseInt(t.value,10),e=parseInt(t.min,10),n=parseInt(t.max,10);return(!t.hasAttribute("min")||a>=e)&&(!t.hasAttribute("max")||a<=n)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const a=parseFloat(t.dataset.targetSum),e=t.querySelectorAll('input[type="number"]');let n=0;return e.forEach(r=>n+=parseFloat(r.value)||0),n===a}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((a,e)=>t[e]>a)}}function Xt(o){const{cashbackCalculator:t,uiUpdater:a}=o;return function(n){const{results:r,inputConfig:l,chartLabels:s,gachaConfig:u}=n,c=parseInt(document.querySelector('[data-control="pulls"]').value),i=Math.min(c,r.SSR.length-1),S=t(l,u,r.SSR[i],r.CharSR[i],r.WepSR[i],l.SR.rateUps);a(r,s,i,S)}}function te(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",a=>{if(!a.target.matches(".tab-link[data-tab-target]"))return;const e=a.target,n=e.closest(".tab-panel-card"),r=e.dataset.tabTarget,l=n.querySelector(r);if(!l){console.error(`Tab target not found: ${r}`);return}n.querySelectorAll(".tab-link").forEach(s=>s.classList.remove("active")),n.querySelectorAll(".tab-pane").forEach(s=>s.classList.remove("active")),e.classList.add("active"),l.classList.add("active")})})}function H(o,t){if(!Number.isInteger(o)||o<0)throw new Error("Number of trials (n) must be a non-negative integer.");if(typeof t!="number"||t<0||t>1)throw new Error("Probability of success (probability) must be a number between 0 and 1 inclusive.");let a=0,e=0,n=[],r=1;for(;a<=o;)e=r*Math.pow(t,a)*Math.pow(1-t,o-a),n.push(e),a++,r=r*(o+1-a)/a;return n}function Ct(o,t){if(t<0||t>o)return 0;if(t===0||t===o)return 1;t=Math.min(t,o-t);let a=1;for(let e=1;e<=t;e++)a*=(o-t+e)/e;return a}function At(o,t){for(const a of o){const e=G(a.rateUps);if(!_t(e,t)){a.probability=0;continue}const n=J(e,t),r=Et(o,t);a.probability=r===0?0:n/r}}function G(o){const t={};for(let a=0;a<o.length;a++){const e=o[a];e>0&&(t[a]=e)}return t}function _t(o,t){return Object.entries(o).every(([a,e])=>t[a]>=e)}function J(o,t){return Object.entries(o).reduce((a,[e,n])=>a*Ct(t[e],n),1)}function Et(o,t){return o.reduce((a,e)=>{const n=G(e.rateUps),r=J(n,t);return a+r},0)}function wt(o){const t=qt(o.points,o.probabilities);return{p10:F(t,.1),p90:F(t,.9)}}function qt(o,t){let a=0;return o.map((e,n)=>({value:e,probability:t[n]})).sort((e,n)=>e.value-n.value).map(e=>(a+=e.probability,{value:e.value,cumulativeProbability:a}))}function F(o,t){if(o.length===0)return 0;if(t<=0)return o[0].value;if(t>=1)return o[o.length-1].value;for(let a=0;a<o.length;a++)if(o[a].cumulativeProbability>=t)return Tt(o,a,t);return o[o.length-1].value}function Tt(o,t,a){if(t===0)return o[0].value;const e=o[t-1],n=o[t],r=n.cumulativeProbability-e.cumulativeProbability,l=(a-e.cumulativeProbability)/r;return e.value+l*(n.value-e.value)}class M{constructor(t,a,e){this.rateUps=t,this.offRates=a,this.probability=e}}class _{constructor(t,a,e){this.mean=t,this.p10=a,this.p90=e}}function Rt(o,t,a){const e=[],n=new Array(a).fill(0);function r(l,s){if(l===a){if(s===t){const c=Z(n,o);e.push(new M([...n],c))}return}const u=Math.min(o[l],t-s);for(let c=0;c<=u;c++)n[l]=c,r(l+1,s+c),n[l]=0}return r(0,0),e}function Z(o,t){const a=[...t];for(let e=0;e<o.length;e++)a[e]-=o[e];return a}function Pt(o,t,a){const e=o.length,n=a.reduce((c,i)=>c+i,0),r=t-n;if(r<0)return console.error("Error: More items are known than the total required."),[];const l=new Array(e);for(let c=0;c<e;c++)if(l[c]=o[c]-a[c],l[c]<0)return console.error(`Error: Known picks for constellation ${c} exceed its capacity.`),[];return Rt(l,r,e).map(c=>{const i=c.rateUps.map((d,f)=>d+a[f]),S=Z(i,o);return new M(i,S)})}function It(o,t,a){const e=t.map((l,s)=>l-a[s]),n=new Map;for(const l of o){const s=l.rateUps.map((c,i)=>c-a[i]);if(s.some(c=>c<0)){l.probability=0;continue}const u=new M(s,[]);n.set(u,l)}const r=Array.from(n.keys());r.length>0&&At(r,e);for(const[l,s]of n.entries())s.probability=l.probability}class Lt{constructor(t={}){this.maxType=t.maxType??7,this.regularPoints=t.regularPoints??2,this.specialPoints=t.specialPoints??5}}class Ot{constructor(t,a,e){this.expected=[...t],this.totalItems=a,this.config=e,this.mean=0,this.variance=0}computeStep(){let t=0;const a=new Array(this.expected.length).fill(0),{maxType:e,regularPoints:n,specialPoints:r}=this.config;this.expected.forEach((l,s)=>{const u=l/this.totalItems;s>=1&&s<e&&(t+=n*u),s===e&&(t+=r*u)}),a[0]=this.expected[0]*(this.totalItems-1)/this.totalItems;for(let l=1;l<e;l++)a[l]=this.expected[l]*(this.totalItems-1)/this.totalItems+this.expected[l-1]/this.totalItems;a[e]=this.expected[e]+this.expected[e-1]/this.totalItems,this.mean+=t,this.variance+=this.calculateVariance()-t**2,this.expected=a}calculateVariance(){const{regularPoints:t,specialPoints:a,maxType:e}=this.config;return(t**2*this.expected.slice(1,e).reduce((n,r)=>n+r,0)+a**2*this.expected[e])/this.totalItems}getPercentiles(){const t=Math.sqrt(this.variance);return{mean:this.mean,p10:this.mean-1.28*t,p90:this.mean+1.28*t}}}class xt{constructor(t,a,e){this.states=new Map,this.totalItems=a,this.config=e,this.initializeState(Array.from(t))}initializeState(t){const a={counts:t,totalPoints:0};this.states.set(JSON.stringify(a),1)}computeStep(t=1e-8){const a=new Map;for(const[e,n]of this.states){const{counts:r,totalPoints:l}=JSON.parse(e);this.processState(r,l,n,a)}this.pruneStates(a,t)}processState(t,a,e,n){const r=t.reduce((l,s)=>l+s,0);t.forEach((l,s)=>{if(l===0)return;const u=e*(l/r),{newCounts:c,newTotalPoints:i}=this.calculateNewState(t,s,a);this.updateStateMap(n,c,i,u)})}calculateNewState(t,a,e){const{maxType:n,regularPoints:r,specialPoints:l}=this.config,s=a===0?0:a<n?r:l,u=[...t];return a<n&&(u[a]--,u[a+1]++),{newCounts:u,newTotalPoints:e+s}}updateStateMap(t,a,e,n){const r=JSON.stringify({counts:a,totalPoints:e});t.set(r,(t.get(r)||0)+n)}pruneStates(t,a){let e=0;const n=new Map;for(const[r,l]of t)l>=a&&(n.set(r,l),e+=l);if(e>0)for(const[r,l]of n)n.set(r,l/e);this.states=n}getDistribution(){const t=new Map;for(const[n,r]of this.states){const{totalPoints:l}=JSON.parse(n);t.set(l,(t.get(l)||0)+r)}const a=Array.from(t.keys()).sort((n,r)=>n-r),e=a.map(n=>t.get(n));return{points:a,probabilities:e}}}class k{constructor(t,a,e,n=20){this.initialState=Array.from(t),this.totalItems=a,this.config=new Lt(e),this.dpThreshold=n}solve(t,a=1e-8){return t<this.dpThreshold?this.solveWithDP(t,a):this.solveWithIterative(t)}solveWithDP(t,a){const e=new xt(this.initialState,this.totalItems,this.config);for(let s=0;s<t;s++)e.computeStep(a);const n=e.getDistribution(),r=this.calculateMean(n),l=wt(n);return{mean:r,...l}}solveWithIterative(t){const a=new Ot(this.initialState,this.totalItems,this.config);for(let e=0;e<t;e++)a.computeStep();return{...a.getPercentiles()}}calculateMean(t){return t.points.reduce((a,e,n)=>a+e*t.probabilities[n],0)}}const T=["mean","p10","p90"],j=.5,z=1e-8,D=20;function kt(o,t,a,e,n){const r=t[t.length-1].length,l=a[a.length-1].length;let s=new Array(r).fill(0),u=new Array(l).fill(0),c=new _(0,0,0),i=new _(0,0,0),S=new _(0,0,0),d=[],f=[],m=0;o.length===1?m=15:m=7;for(const p of t){let h=0;for(let y=0;y<p.length;y++)h+=p[y].totalSum,s[y]+=p[y].totalSum,y>=1&&(s[y]+=p[y-1].lostSum);d.push(h)}for(const p of o){let h=new _(0,0,0),y=new _(0,0,0),v=new _(0,0,0);const E=new k(p.rateUps,e.rateUpCharacterSR,e.configSR,D);for(let C=0;C<d.length;C++)if(d[C]>z){let x=E.solve(C);T.forEach(P=>{y[P]+=x[P]*d[C]})}const R=new k(p.offRates,e.poolCharSR-e.rateUpCharacterSR,e.configSR,m);let I=[];for(let C=0;C<s.length;C++){I.push(R.solve(C));let x=H(C,j);for(let P=0;P<x.length;P++)T.forEach(B=>{v[B]+=I[P][B]*x[P]*s[C]})}T.forEach(C=>{h[C]=y[C]+v[C],c[C]+=h[C]*p.probability})}for(const p of a){let h=0;for(let y=0;y<p.length;y++)h+=p[y].totalSum,u[y]+=p[y].totalSum,y>=1&&(u[y]+=p[y-1].lostSum);f.push(h)}let b=new _(0,0,0),g=new _(0,0,0);for(let p=0;p<f.length;p++)if(f[p]>z){let h=p*e.configWep.pointsSR,y=new _(h,h,h);T.forEach(v=>{b[v]+=y[v]*f[p]})}const A=new k(n.SR.consCount,e.poolCharSR,e.configSR,D);let L=[];for(let p=0;p<u.length;p++)if(u[p]>0){L.push(A.solve(p));let h=H(p,j);for(let y=0;y<h.length;y++){let v=(p-y)*e.configWep.pointsSR;T.forEach(E=>{g[E]+=(L[y][E]+v)*h[y]*u[p]})}}return T.forEach(p=>{i[p]=b[p]+g[p],S[p]=c[p]+i[p]}),S}function Nt(o,t,a,e,n){const r=new k(a,t,n.configSSR,D),l=o[o.length-1][o[o.length-1].length]>0?o[o.length-1].length+1:o[o.length-1].length;let s=[],u=[],c=0;for(let i=0;i<l;i++)s.push(r.solve(i));for(let i=0;i<o.length;i++){i>0&&(e[i-1]==="none"?c+=0:e[i-1]==="regular"&&(c+=n.configSSR.regularPoints));let S=new _(0,0,0),d=0;for(let f=0;f<o[i].length;f++)d+=o[i][f].totalSum;if(d>0)for(let f=0;f<o[i].length;f++){const m=s[f];let b;f===0?b=o[i][f].totalSum/d:b=(o[i][f].totalSum+o[i][f-1].lostSum)/d,T.forEach(g=>{S[g]+=m[g]*b})}T.forEach(f=>{S[f]+=c}),u.push(S)}return u}function ee(o,t,a,e,n,r){let l=Pt(o.SR.consCount,t.rateUpCharacterSR,r);It(l,o.SR.consCount,r);let s=kt(l,e,n,t,o),u=Nt(a,t.poolStandardCharSSR,o.SSR.consCountStandard,o.SSR.cashbackRoadmap,t),c=[];for(const i of u){let S=new _(0,0,0);T.forEach(d=>{S[d]=i[d]+s[d]}),c.push(S)}return c}export{Mt as C,pt as O,Qt as T,Ht as W,$t as a,Bt as b,Ft as c,Wt as d,Zt as e,Xt as f,Dt as g,Ut as h,jt as i,te as j,Kt as k,Vt as l,Yt as m,Gt as n,dt as o,W as p,ee as q,H as r,Jt as s,zt as u};
