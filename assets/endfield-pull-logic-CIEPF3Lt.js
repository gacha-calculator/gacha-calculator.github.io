function j(a,R,i,f=.5,p,l){let P,O;for(const K of a)if(K!==null){P=K.type==="Character",O=K.type==="Weapon";break}const M=[],v=l.maxItem,y=l.minItem;for(let K=v;K>=y;K--){const w=a[K];if(P)C(R,K,a,M,w.type,p,l);else if(O)C(i,K,a,M,w.type);else throw new Error(`Unknown SSR array type: ${w.type}`)}return u(a,p,l),void 0;function u(K,w,T){const B=T.minItem,L=T.maxItem;let g=!0,r=B,U=0;const x=1e-10;for(;g&&r<=L;){const m=K[r],Y=m.distribution,b=Y.length;for(let c=m.minIndex;c<b;c++){const G=Y[c];if(G>x){T.minItem=r,m.minIndex=c,g=!1;for(let N=b-1;N>=c;N--){const o=Y[N];if(o>x){m.maxIndex=N;break}else o>0&&(U+=o,Y[N]=0)}break}else G>0&&(U+=G,Y[c]=0)}g&&(K[r-1]==null?K[r].distribution=null:(K[r].minIndex=0,K[r].maxIndex=0),K[r+1].minIndex=0,K[r+1].maxIndex=0),r++}for(;r<=L;){const m=K[r],Y=m.distribution,b=Y.length;for(let c=0;c<b;c++){const G=Y[c];if(G>x){m.minIndex=c;for(let N=b-1;N>=c;N--){const o=Y[N];if(o>x){m.maxIndex=N;break}else o>0&&(U+=o,Y[N]=0)}break}else G>0&&(U+=G,Y[c]=0)}r++}w[0]+=U}function A(K,w,T){}}function J(a,R,i){if(a[0].states.length===0)return;const f=a.length-1;for(let p=f;p>=0;p--)a[p].isEmpty||D(i,p,a,R)}function $(a,R,i,f=.5){const p=a.length-2;for(let l=p;l>=0;l--){const P=a[l];if(P&&!P.isEmpty)if(P.type==="Character")F(R,l,a,P.type);else if(P.type==="Weapon")F(i,l,a,P.type);else throw new Error(`Unknown SSR array type: ${P.type}`)}}function C(a,R,i,f,p,l,P){const u=i[R],A=u.distribution,K=u.bannerCount,w=i[R+1],T=w.distribution,B=w.bannerCount!==K,L=R+3===i.length,g=i[R+2],r=g.distribution,U=g.bannerCount!==K,x=R+4===i.length,m=.5;let Y=!1,b=!1,c=!1;L||(x?c=!0:R===P.maxItem?(Y=!0,b=!0):R===P.maxItem-1&&(Y=!0));let G=u.maxIndex,N=u.minIndex,o=Math.floor(G/1600),h=G%1600,t=Math.floor(h/20),e=h%20,E=G;if(B){for(;c&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e]+=s,c=!1,P.maxItem=R+1;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,c=!1,P.maxItem=R+1}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(r[e]+=S,T[e+1]+=S,T[e+(t+1)*20]+=n,c=!1,P.maxItem=R+1):(T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,c=!1,P.maxItem=R+1)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;b&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e]+=s,b=!1,P.maxItem=R+1;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,b=!1,P.maxItem=R+1}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(r[e]+=S,T[e+1]+=S,T[e+(t+1)*20]+=n,x?(b=!1,P.maxItem=R+1):(b=!1,Y=!1,P.maxItem=R+2)):(T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,b=!1,P.maxItem=R+1)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;Y&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e]+=s;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(r[e]+=S,T[e+1]+=S,T[e+(t+1)*20]+=n,Y=!1,P.maxItem=R+2):(T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e]+=s;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(r[e]+=S,T[e+1]+=S,T[e+(t+1)*20]+=n):(T[e]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}}else{for(;c&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e+(o+120+1)*1600]+=s,c=!1,P.maxItem=R+1;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,c=!1,P.maxItem=R+1}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(U?r[e]+=S:r[e+120*1600]+=S,T[e+1+120*1600]+=S,T[e+(t+1)*20+120*1600]+=n,c=!1,P.maxItem=R+1):(T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,c=!1,P.maxItem=R+1)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;b&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e+(o+120+1)*1600]+=s,b=!1,P.maxItem=R+1;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,b=!1,P.maxItem=R+1}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(U?r[e]+=S:r[e+120*1600]+=S,T[e+1+120*1600]+=S,T[e+(t+1)*20+120*1600]+=n,x?(b=!1,P.maxItem=R+1):(b=!1,Y=!1,P.maxItem=R+2)):(T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n,b=!1,P.maxItem=R+1)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;Y&&E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e+(o+120+1)*1600]+=s;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(U?r[e]+=S:r[e+120*1600]+=S,Y=!1,P.maxItem=R+2,T[e+1+120*1600]+=S,T[e+(t+1)*20+120*1600]+=n):(T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}for(;E>=N;){const s=A[E];if(s<1e-10){s>0&&(l[0]+=s),A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--;continue}const W=o===359,V=o===119,k=o<120,_=a[t];if(k)if(V)f[0]+=s,T[e+(o+120+1)*1600]+=s;else{const S=s*_*m,n=s*(1-_);f[0]+=S,T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n}else{const S=s*_*m,n=s*(1-_);f[0]+=S,W?(U?r[e]+=S:r[e+120*1600]+=S,T[e+1+120*1600]+=S,T[e+(t+1)*20+120*1600]+=n):(T[e+(o+1)*1600]+=S,A[E+1-t*20+1600]+=S,A[E+20+1600]+=n)}A[E]=0,e--,e===-1&&(e=19,t--,t===-1&&(t=79,o--)),E--}}}function D(a,R,i,f){const p=i[0].states.length,l=i[R].states;f.rankUpFail=f.pullsSum-f.rankUps;let P=new Map;for(let O=p-1;O>=0;O--){const M=l[O],v=a[O];for(const[y,u]of M){const A=u.prob,K=A*f.pullsSum;if(K>1e-10){u.prob=A*(1-f.pullsSum);const w=A*v*f.rankUpFail,T=K*(1-v)*f.rankUpFail,B=A*f.rankUps;if(w>1e-10){const L=P,g=y+1,r=L.get(g);r?r.prob+=w:L.set(g,{prob:w})}if(T>1e-10){const L=l[O+1],g=L.get(y);g?g.prob+=T:L.set(y,{prob:T})}if(B>1e-10){const L=P,g=L.get(y);g?g.prob+=B:L.set(y,{prob:B})}}}}l[0]=P}function F(a,R,i,f){i[R].isEmpty=!0;for(let p=i[R].spark.length-1;p>=0;p--){const l=R+2===i.length,P=i[R].spark[p];if(P&&!P.isEmpty){P.isEmpty=!0;const O=P.pity.length;let M=f==="Weapon"?.25:.5,v=i[R].spark;const y=i[R+1].spark,u=i[R+1].bannerCount!==i[R].bannerCount;let A,K,w;l||(A=i[R+2].spark,K=i[R+2].bannerCount!==i[R].bannerCount,w=R+3===i.length);for(let T=O-1;T>=0;T--){const B=v[p].pity[T];for(const[L,g]of B){let r=L,U,x;f==="Character"?(p===119&&L===0?U=!0:U=!1,p===239?x=!0:x=!1):(U=r===80,r>1120&&(x=(r-1120)%160===0));let m=a[T];U&&(m=1,M=1);const Y=g.prob*m,b=g.prob-Y;let c=Y*M;if(c>1e-10){let o=L,h;u?o=0:U&&(o=1),l?h=y[0]:x?(w?h=A[0]:(h=A[0].pity[0],A[0].isEmpty=!1,i[R+2].isEmpty=!1),!u&&K&&(o=0)):(h=y[p+1].pity[0],y[p+1].isEmpty=!1,i[R+1].isEmpty=!1);const t=h.get(o);t?t.prob+=c:h.set(o,{prob:c})}let G=Y*(1-M);if(G>1e-10){let o=L,h;x?(l?h=y[0]:(h=y[0].pity[0],y[0].isEmpty=!1,i[R+1].isEmpty=!1),u&&(o=0)):(h=v[p+1].pity[0],v[p+1].isEmpty=!1,i[R].isEmpty=!1);const t=h.get(o);t?t.prob+=G:h.set(o,{prob:G})}let N=b;if(N>1e-10){let o,h=L;x?(u&&(h=0),l?o=y[0]:(o=y[0].pity[T+1],y[0].isEmpty=!1,i[R+1].isEmpty=!1)):(o=v[p+1].pity[T+1],v[p+1].isEmpty=!1,i[R].isEmpty=!1);const t=o.get(h);t?t.prob+=N:o.set(h,{prob:N})}g.prob=0}}}}}export{J as rankUpSR,j as rankUpSSR,$ as rankUpSSRCheap};
