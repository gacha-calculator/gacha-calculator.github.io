function F(S,s,l,R,A=.5,m,_){let I,V;for(const P of s)if(P!==null){I=P.type==="Character",V=P.type==="Weapon";break}const h=[],o=_.maxItem,U=_.minItem;for(let P=o;P>=U;P--){const i=S[P];if(I)M(l,P,S,s,h,m);else if(V)M(R,P,S,s,h,i.type);else throw new Error(`Unknown SSR array type: ${i.type}`)}let N=!1;return N=K(S,s,m,_),N;function K(P,i,w,T){const L=T.minItem;T.maxItem+3!==i.length&&(T.maxItem+4===i.length?T.maxItem+=1:T.maxItem+=2);const g=T.maxItem,b=i;let k=!0,r=L,E=0;const a=1e-10,f=80*360+361;for(;k&&r<=g;){let t;const n=b[r].maxIndex+f;if(r-1!==-1){const e=b[r-1].maxIndex+1;e>n?t=e:t=n}else t=n;const u=P[r],Y=i[r];for(let e=Y.minIndex;e<=t;e++){const y=u[e];if(y>a){T.minItem=r,Y.minIndex=e,k=!1;for(let G=t;G>=e;G--){const C=u[G];if(C>a){Y.maxIndex=G;break}else C>0&&(E+=C,u[G]=0)}break}else y>0&&(E+=y,u[e]=0)}if(k){if(P[r-1]==null){if(P[r]=null,r===P.length-3)return!0}else i[r].minIndex=0,i[r].maxIndex=0;i[r+1].minIndex=0,i[r+1].maxIndex=0}r++}for(;r<=g;){let t;const n=b[r].maxIndex+f;if(r-1!==-1){const e=b[r-1].maxIndex+1;e>n?t=e:t=n}else t=n;const u=P[r],Y=i[r];for(let e=0;e<=t;e++){const y=u[e];if(y>a){Y.minIndex=e;for(let G=t;G>=e;G--){const C=u[G];if(C>a){Y.maxIndex=G;break}else C>0&&(E+=C,u[G]=0)}break}else y>0&&(E+=y,u[e]=0)}r++}w[0]+=E}}function O(S,s,l){if(S[0].states.length===0)return;const R=S.length-1;for(let A=R;A>=0;A--)S[A].isEmpty||v(l,A,S,s)}function B(S,s,l,R=.5){const A=S.length-2;for(let m=A;m>=0;m--){const _=S[m];if(_&&!_.isEmpty)if(_.type==="Character")W(s,m,S,_.type);else if(_.type==="Weapon")W(l,m,S,_.type);else throw new Error(`Unknown SSR array type: ${_.type}`)}}function M(S,s,l,R,A,m){const o=l[s],U=R[s],N=U.bannerCount,K=l[s+1],i=R[s+1].bannerCount!==N,w=l[s+2],L=R[s+2].bannerCount!==N;let g=0,b=U.maxIndex,k=U.minIndex,r=b%28800,E=b-r,a=r/360|0,c=r%360,x=r-c,p=b,f=S[a]*.5,t=1-S[a];if(i)for(;p>=k;){const n=o[p];if(n<1e-10){n>0&&(m[0]+=n),o[p]=0,c--,c===-1&&(c=359,a--,a===-1?(a=79,x=79*360,E-=28800):x-=360,f=S[a]*.5,t=1-S[a]),p--;continue}if(c<120)if(c===119)g+=n,K[E]+=n;else{const e=n*f,y=n*t;g+=e,K[E]+=e,o[p+28800-x+1]+=e,o[p+361]+=y}else{const Y=c===359,e=n*f,y=n*t;g+=e,Y?(w[E]+=e,K[E+28800]+=e,K[E+x+360]+=y):(K[E]+=e,o[p+28800-x+1]+=e,o[p+361]+=y)}o[p]=0,c--,c===-1&&(c=359,a--,a===-1?(a=79,x=79*360,E-=28800):x-=360,f=S[a]*.5,t=1-S[a]),p--}else for(;p>=k;){const n=o[p];if(n<1e-10){n>0&&(m[0]+=n),o[p]=0,c--,c===-1&&(c=359,a--,a===-1?(a=79,x=79*360,E-=28800):x-=360,f=S[a]*.5,t=1-S[a]),p--;continue}if(c<120)if(c===119)g+=n,K[E+c+120+1]+=n;else{const e=n*f,y=n*t;g+=e,K[E+c+120+1]+=e,o[p+28800-x+1]+=e,o[p+361]+=y}else{const Y=c===359,e=n*f,y=n*t;g+=e,Y?(L?w[E]+=e:w[E+120]+=e,K[E+28800+120]+=e,K[E+x+360+120]+=y):(K[E+c+1]+=e,o[p+28800-x+1]+=e,o[p+361]+=y)}o[p]=0,c--,c===-1&&(c=359,a--,a===-1?(a=79,x=79*360,E-=28800):x-=360,f=S[a]*.5,t=1-S[a]),p--}A[0]+=g}function v(S,s,l,R){const A=l[0].states.length,m=l[s].states;R.rankUpFail=R.pullsSum-R.rankUps;let _=new Map;for(let I=A-1;I>=0;I--){const V=m[I],h=S[I];for(const[o,U]of V){const N=U.prob,K=N*R.pullsSum;if(K>1e-10){U.prob=N*(1-R.pullsSum);const P=N*h*R.rankUpFail,i=K*(1-h)*R.rankUpFail,w=N*R.rankUps;if(P>1e-10){const T=_,L=o+1,g=T.get(L);g?g.prob+=P:T.set(L,{prob:P})}if(i>1e-10){const T=m[I+1],L=T.get(o);L?L.prob+=i:T.set(o,{prob:i})}if(w>1e-10){const T=_,L=T.get(o);L?L.prob+=w:T.set(o,{prob:w})}}}}m[0]=_}function W(S,s,l,R){l[s].isEmpty=!0;for(let A=l[s].spark.length-1;A>=0;A--){const m=s+2===l.length,_=l[s].spark[A];if(_&&!_.isEmpty){_.isEmpty=!0;const I=_.pity.length;let V=R==="Weapon"?.25:.5,h=l[s].spark;const o=l[s+1].spark,U=l[s+1].bannerCount!==l[s].bannerCount;let N,K,P;m||(N=l[s+2].spark,K=l[s+2].bannerCount!==l[s].bannerCount,P=s+3===l.length);for(let i=I-1;i>=0;i--){const w=h[A].pity[i];for(const[T,L]of w){let g=T,b,k;R==="Character"?(A===119&&T===0?b=!0:b=!1,A===239?k=!0:k=!1):(b=g===80,g>1120&&(k=(g-1120)%160===0));let r=S[i];b&&(r=1,V=1);const E=L.prob*r,a=L.prob-E;let c=E*V;if(c>1e-10){let f=T,t;U?f=0:b&&(f=1),m?t=o[0]:k?(P?t=N[0]:(t=N[0].pity[0],N[0].isEmpty=!1,l[s+2].isEmpty=!1),!U&&K&&(f=0)):(t=o[A+1].pity[0],o[A+1].isEmpty=!1,l[s+1].isEmpty=!1);const n=t.get(f);n?n.prob+=c:t.set(f,{prob:c})}let x=E*(1-V);if(x>1e-10){let f=T,t;k?(m?t=o[0]:(t=o[0].pity[0],o[0].isEmpty=!1,l[s+1].isEmpty=!1),U&&(f=0)):(t=h[A+1].pity[0],h[A+1].isEmpty=!1,l[s].isEmpty=!1);const n=t.get(f);n?n.prob+=x:t.set(f,{prob:x})}let p=a;if(p>1e-10){let f,t=T;k?(U&&(t=0),m?f=o[0]:(f=o[0].pity[i+1],o[0].isEmpty=!1,l[s+1].isEmpty=!1)):(f=h[A+1].pity[i+1],h[A+1].isEmpty=!1,l[s].isEmpty=!1);const n=f.get(t);n?n.prob+=p:f.set(t,{prob:p})}L.prob=0}}}}}export{O as rankUpSR,F as rankUpSSR,B as rankUpSSRCheap};
