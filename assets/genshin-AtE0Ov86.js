import{C,a as M,b as F,g as I,W as H,c as Y,d as x,e as B,f as z,T as G,h as V,i as j,j as q,k as R,l as X,m as v,n as d,s as L,O as $,o as b,p as _,u as K,q as J}from"./cashback-D3emIPJs.js";/* empty css               */import{C as Q,c as Z,g as tt,h as N}from"./genshin_tutorial_config-CLPEu1zz.js";import{P as U,c as et,s as at}from"./commonHelpers-BPDag3E6.js";function rt(l){if(!l||!l.characters||!l["wish-counter-character-event"])return console.error("Imported data is missing key Paimon.moe properties."),null;console.log("Paimon.moe data format detected. Running adapter...");const t=l["wish-counter-character-event"]?.pulls||[],i=l["wish-counter-weapon-event"]?.pulls||[],u=O(t,"character"),o=O(i,"weapon"),a=[{banner:"character",...u,caprad:"0",epPath:"0"},{banner:"weapon",...o,caprad:"0",epPath:"0"}],S=lt(l.characters);return{pity:a,constellation:S}}function O(l,t){let i=0,u=0,o=!1,a=!1,S=!1,h=!1;const m=y=>M.has(y)?{type:"character",rarity:4}:H.has(y)?{type:"weapon",rarity:4}:Y.has(y)?{type:"weapon",rarity:3}:F.has(y)?{type:"character",rarity:5,standard:!0}:x.has(y)?{type:"weapon",rarity:5,standard:!0}:{type:"unknown",rarity:5,standard:!1};for(let y=l.length-1;y>=0;y--){const f=l[y],A=m(f.id);A.rarity===5?S||(o=f.rate===0,S=!0):S||i++,A.rarity===4?h||(t==="character"&&(a=A.type==="weapon"),h=!0):h||u++}return{pity4:String(u),pity5:String(i),guarantee4:a,guarantee5:o}}function lt(l){const t=new Array(Object.keys(C).length).fill(0),i=new Array(Object.keys(C).length).fill(0);let u=0,o=0;for(const y in l){let f=0;if(M.has(y)?f=4:F.has(y)&&(f=5),f===0)continue;const A=l[y],c=(A.default||0)+(A.wish||0)+(A.manual||0);if(c>0){f===4?u++:f===5&&o++;const e=Math.min(c-1,6),s=C[`c${e}`];s!==void 0&&(f===4?t[s]++:f===5&&i[s]++)}}const a=I.poolCharSR,S=I.poolStandardCharSSR,h=a-u,m=S-o;return t[0]=Math.max(0,h),i[0]=Math.max(0,m),{0:i.map(String),1:t.map(String)}}class st{constructor(t){this.parts=t,this.persistence=B("genshin");const i=z({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn}),u={calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},postCalculationHooks:[i]};this.validator=new G(this.parts.CONSTELLATION_MAP),this.calculationHandler=V(u,this.persistence),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn"),this.tutorial=new Q(Z)}initialize(){this.validator.initialize(),j(this.persistence,this.parts.gachaConfig,this.validator),q(),R(),this.#t(),this.#a()}#t(){this.calculateBtn&&this.calculateBtn.addEventListener("click",()=>{this.#e()&&this.calculationHandler()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>X(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(tt)}),R(this.persistence,rt,this.validator),document.querySelectorAll(".help-btn").forEach(i=>{i.addEventListener("click",u=>{u.preventDefault();const o=i.getAttribute("data-help-key")||i.getAttribute("data-tour-step-id");if(o&&N[o]){const a=N[o];this.tutorial.showHelp(a,i)}else console.warn(`ChibiTutorial: No help configuration found for key '${o}'.`,i)})})}#e(){if(document.querySelectorAll(".is-invalid").forEach(o=>o.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll();const t=document.querySelectorAll(".is-invalid"),i=new Set;t.forEach(o=>{const a=o.closest(".tab-pane");if(a){const S=document.querySelector(`.tab-link[data-tab-target="#${a.id}"]`);S&&i.add(S)}o.classList.add("flicker"),o.addEventListener("animationend",()=>o.classList.remove("flicker"),{once:!0})}),i.forEach(o=>{o.classList.add("is-invalid","flicker"),o.addEventListener("animationend",()=>o.classList.remove("flicker"),{once:!0})});const u=Array.from(i)[0];return u&&u.click(),setTimeout(()=>{t[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const t=this.persistence.loadCalculation(),i=t?t.input:null;t?(v(this.parts.gachaConfig.paths,i),d(t),L(t.persistInput)):(v(this.parts.gachaConfig.paths),d(),L()),this.calculationHandler()}}function nt(l,t){if(!Array.isArray(l.SSR.pullPlan))throw new Error("Invalid pull plan");if(!(Number.isInteger(l.SSR.special.capRad)&&l.SSR.special.capRad>=0&&l.SSR.special.capRad<=3))throw new Error("Invalid Capturing Radiance Value");if(!Array.isArray(t))throw new Error("Invalid pity data");const i={CHARACTER:0},u={CHARACTER:{DEFAULT:181,GUARANTEE:91},WEAPON:232,FINAL:1},o={LAST:3,MAX:4},{pullPlan:a}=l.SSR,{capRad:S}=l.SSR.special;let h=0;const m=[];for(const[s,n]of a.entries()){const r=n===i.CHARACTER;m.push([]),r?(y(s,h),h++):f(s,h)}return A(),c(t,S),{distributionSSR:m};function y(s,n){for(let r=0;r<=n;r++){const p=[];for(let P=0;P<o.MAX;P++){const k=P!==o.LAST?u.CHARACTER.DEFAULT:u.CHARACTER.GUARANTEE,g=P<o.LAST?[0,0,0]:[0];p.push(e(k,g))}m[s].push(p)}}function f(s,n){for(let r=0;r<=n;r++){const p=[];for(let P=0;P<o.MAX;P++)p.push(e(u.WEAPON,[0,0]));m[s].push(p)}}function A(){const s=Array.from({length:h+1},()=>Array(o.MAX).fill().map(()=>e(u.FINAL)));m.push(s)}function c(s,n){const r=m[0][0][n];r.states[s[0]]=1,r.totalSum=1}function e(s,n){return new U(Array(s).fill(0),n,0)}}function ot(l){let u=!1,o=!1,a=0,S=0;const h=[];a+=l.SSR.pity.char,a+=l.SSR.guarantee.char*90,S+=l.SSR.pity.wep,S+=l.SSR.special.epitPath===0?l.SSR.guarantee.wep*77:2*77;for(const m of l.SSR.pullPlan)m==0&&!u?(u=!0,h.push(a)):m==1&&!o?(o=!0,h.push(S)):h.push(0);return h.push(0),h}function ct(l){let t=[[new U(Array(21).fill(0),[0,0],1)]],i=[[new U(Array(21).fill(0),[0,0],1)]];const u=l.SR.guarantee.char*10+l.SR.pity.char,o=l.SR.guarantee.wep*10+l.SR.pity.wep;return t[0][0].states[u]=1,i[0][0].states[o]=1,{distributionCharSR:t,distributionWepSR:i}}function E(l){const t=[];for(let i=0;i<l.length;i++){const u=l[i],o=[];for(let a=0;a<u.length;a++){const S=u[a];let h=0,m=0,y;const f=Array.isArray(S)?S:[S];for(let A=0;A<f.length;A++)if(y=f[A].states.length,f[A].totalSum>1e-8){if(y===181)for(let c=90;c<181;c++)m+=f[A].states[c];else if(y===232)for(let c=154;c<232;c++)m+=f[A].states[c];else if(y===21)for(let c=10;c<21;c++)m+=f[A].states[c];h+=f[A].totalSum}o.push({lostSum:m}),o[a].totalSum=h}t.push(o)}return t}const T=1e-8;function it(l,t,i,u,o,a){if(!Array.isArray(u)||!Array.isArray(o))throw new Error("All input parameters except currentPull must be arrays.");const{charPullsSum:S,wepPullsSum:h}=f(l,o);a.char.pullsSum=S,a.wep.pullsSum=h;for(let e=0;e<l.length-1;e++){const s=o[e]===0,n=l[e].length-1;for(let r=0;r<=n;r++)for(let p=0;p<4;p++){const P=l[e][r][p],k=s?t:i;P.totalSum>T&&(l[e][r][p].states=W(k,P.states,P.rankUps,p))}}const{charRankUps:m,wepRankUps:y}=c(l,o);a.char.rankUps=m,a.wep.rankUps=y;for(let e=0;e<l.length-1;e++){const s=l[e].length-1,n=o[e]===0;for(let r=0;r<=s;r++){const p=u[e+1];for(let P=0;P<4;P++)A(l,e,r,P,n,p)}}function f(e,s){const n=[0,0];for(let p=0;p<e.length-1;p++){const P=s[p]===0?0:1;for(let k of e[p])for(let g of k)if(g.totalSum>T)for(let w of g.states)w>1&&(w=1),n[P]+=w}const r=1/(n[0]+n[1]);return n[0]*=r,n[1]*=r,{charPullsSum:n[0],wepPullsSum:n[1]}}function A(e,s,n,r,p,P){if(p){if(e[s][n][r].rankUps[0]>T){e[s][n][r].rankUps[0];const k=Math.floor(r/2);e[s+1][n][k].states[P]+=e[s][n][r].rankUps[0],e[s+1][n][k].totalSum+=e[s][n][r].rankUps[0],e[s][n][r].totalSum-=e[s][n][r].rankUps[0]}r!==3&&e[s][n][r].rankUps[1]>T&&(e[s+1][n+1][r+1].states[P]+=e[s][n][r].rankUps[1],e[s+1][n+1][r+1].totalSum+=e[s][n][r].rankUps[1],e[s][n][r].totalSum-=e[s][n][r].rankUps[1])}else e[s][n][r].rankUps[0]>T&&(e[s+1][n][r].states[P]+=e[s][n][r].rankUps[0],e[s+1][n][r].totalSum+=e[s][n][r].rankUps[0],e[s][n][r].totalSum-=e[s][n][r].rankUps[0]);e[s][n][r].rankUps[0]=0,e[s][n][r].rankUps[1]=0}function c(e,s){const n=[0,0];for(let r=0;r<e.length-1;r++){const p=s[r]===0?0:1;for(let P of e[r])for(let k of P){for(let g of k.rankUps)n[p]+=g;k.rankUps[2]=0}}return{charRankUps:n[0],wepRankUps:n[1]}}}function D(l,t,i){let u=!1;for(let a=0;a<t.length;a++){const S=a===t.length-1,h=t[a].length-1;for(let m=0;m<=h;m++){const y=t[a][m];if(y.totalSum>T&&(t[a][m].states=W(i,y.states,y.rankUps,0,l),S))for(let f of y.rankUps)f>T&&(u=!0)}}if(u){let a=[];for(let S=0;S<=t.length;S++)a.push(new U(Array(21).fill(0),[0,0],0));t.push(a)}for(let a=0;a<t.length-1;a++){const S=t[a].length-1;for(let h=0;h<=S;h++)t[a+1][h].states[0]+=t[a][h].rankUps[0],t[a+1][h].totalSum+=t[a][h].rankUps[0],t[a][h].totalSum-=t[a][h].rankUps[0],t[a][h].rankUps[0]=0,t[a+1][h+1].states[0]+=t[a][h].rankUps[1],t[a+1][h+1].totalSum+=t[a][h].rankUps[1],t[a][h].totalSum-=t[a][h].rankUps[1],t[a][h].rankUps[1]=0}const o=t[t.length-1].length-1;for(let a=0;a<=o;a++)t[t.length-1][a].rankUps[0]=0,t[t.length-1][a].rankUps[1]=0}function W(l,t,i,u,o){const a=t.length,S=a===232,h=a===181,m=a===91,y=a===21,f=Array(a).fill(0);if(h||y){const A=o!==void 0?o.pullsSum:1,c=o!==void 0?o.rankUps:0,e=y?10:90,s=u===2?.45:.5,n=u===2?.55:.5;for(let r=1;r<a;r++)if(r===e||r===e*2)for(let p=0;p<r;p++){const P=p<e?r===e?s:n:1;if(f[r]+=l[p%e]*t[p]*(A-c)*P,h&&r===e&&(i[2]+=l[p%e]*t[p]*(A-c)*P),p===9||p===19?f[p]+=t[p]*(1-(A-c))*P:(f[p+1]+=l[p%e]*t[p]*c*P,f[p]+=t[p]*(1-A)*P),r==e*2&&(p===e-1||p===e*2-1)){const k=p===e*2-1?1:0;i[k]=f[r],f[r]=0}}else f[r]+=(1-l[r%e-1])*t[r-1]*A}else if(S)for(let c=1;c<a;c++){if(c===77*2||c===77*3){const e=c===154?.625:.375;for(let s=0;s<c;s++){const n=s<77?e:s<154?.5:1;f[c]+=l[s%77]*t[s]*n}}else c!==77&&(f[c]+=(1-l[c%77-1])*t[c-1]);c===77*2&&(i[1]=f[c]),c===77*3&&(i[0]=f[c],f[c]=0)}else if(m){let A=90;for(let c=1;c<a;c++){if(c===A)for(let e=0;e<c;e++)f[c]+=l[e%A]*t[e];else f[c]+=(1-l[c%A-1])*t[c-1];c===a-1&&(i[0]=f[c],f[c]=0)}}else throw new Error("Incorrect size for distribution SSR");return f}function ht(l){const t=ot(l);let i={char:{},wep:{}};const{distributionSSR:u}=nt(l,t),{distributionCharSR:o,distributionWepSR:a}=ct(l);let S=[],h=[],m=[],y=0;for(;y<.999;){it(u,b,$,t,l.SSR.pullPlan,i),D(i.char,o,_),D(i.wep,a,_);let e=0;for(let s of u[u.length-1])for(let n of s)e+=n.totalSum;y=e,S.push(E(u)),h.push(E(a)),m.push(E(o))}const f=E(o);let A=et(f);return A=at(A,I.rateUpCharacterSR),{SSR:S,WepSR:h,CharSR:m}}document.addEventListener("DOMContentLoaded",()=>{const l={gachaConfig:I,CONSTELLATION_MAP:C,runCalcFn:ht,cashbackFn:J,updateTableFn:K};new st(l).initialize()});
