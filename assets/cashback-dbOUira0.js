(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function t(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=t(r);fetch(r.href,o)}})();const P={CHARACTER:"character",WEAPON:"weapon"},C={PITY_ROW:"[data-banner]",PITY_TABLE:"#pity-table",CONSTELLATION_TABLE:"#constellation-table"},N={pitySettings:{[P.CHARACTER]:{pity4:0,pity5:0,caprad:1},[P.WEAPON]:{pity4:0,pity5:0,epPath:0}},constellationColumns:8},v=(n,e=!1)=>n?e?n.checked:parseInt(n.value)||0:null;function G(n,e){const t=document.getElementById("pity-panel"),a=document.getElementById("constellation-panel"),r=e.paths;if(!t||!a)return console.error("Required tab panels not found. Cannot get page configuration."),null;const o=(c,u)=>{if(!u)return[];const f=u.querySelector("#constellation-table");if(!f)return console.warn("Could not find the constellation table inside the panel:",u),[];const p=f.querySelectorAll(`tr[data-rarity="${c}"] .custom-input`);return Array.from(p).map(h=>parseInt(h.value)||0)},s=t.querySelector(`${C.PITY_ROW}[data-banner="character"]`),l=t.querySelector(`${C.PITY_ROW}[data-banner="weapon"]`),i=K(r);return!s||!l?(console.error("Pity rows for character or weapon not found inside #pity-panel."),null):{SSR:{pity:{char:v(s.querySelector('[data-control="pity-5"]')),wep:v(l.querySelector('[data-control="pity-5"]'))},guarantee:{char:v(s.querySelector(".guarantee-5"),!0),wep:v(l.querySelector(".guarantee-5"),!0)},special:{capRad:v(s.querySelector('[data-control="capRad"]')),epitPath:v(l.querySelector('[data-control="epPath"]'))},consCountStandard:o(5,a),pullPlan:i.typeArray,cashbackRoadmap:i.cashbackArray},SR:{pity:{char:v(s.querySelector('[data-control="pity-4"]')),wep:v(l.querySelector('[data-control="pity-4"]'))},guarantee:{char:v(s.querySelector(".guarantee-4"),!0),wep:v(l.querySelector(".guarantee-4"),!0)},rateUps:X(n),consCount:o(4,a)}}}function Y(){const n=document.querySelectorAll(".row"),e=[];return Array.from(n).slice(1).forEach(a=>{const r=a.dataset.group,o=a.querySelector(".type-selector")?.value||"char",s=a.querySelector(".first-select")?.value||"None",l=a.querySelector(".second-select")?.value||"None";e.push({group:r,type:o,from:s,to:l})}),e}function K(n){const e=document.querySelectorAll(".row"),t=[],a=[];return Array.from(e).slice(1).forEach(o=>{const s=o.querySelector(".type-selector")?.value||"char",l=o.querySelector(".first-select")?.value||"None",i=o.querySelector(".second-select")?.value||"None",c=s==="char"?n.char:n.wep,u=c.indexOf(l),f=c.indexOf(i);if(u===-1||f===-1||u>=f)return;const p=f-u;let h=u,d=0;for(let y=0;y<p;y++)s==="char"?(h===0?d="none":d="regular",t.push(0)):(d="regular",t.push(1)),a.push(d),h++}),{typeArray:t,cashbackArray:a}}function J(n){const e=document.querySelectorAll(".row"),t=Array.from(e).slice(1);let a=["None"];const r=n.char,o=n.wep;return t.forEach(s=>{const l=s.querySelector(".type-selector")?.value||"char",i=s.querySelector(".first-select")?.value||"None",c=s.querySelector(".second-select")?.value||"None",u=l==="char"?r:o,f=u.indexOf(i),p=u.indexOf(c);if(f===-1||p===-1||f>=p)return;const h=u.slice(f+1,p+1);a.push(...h)}),a}function X(n){const e=document.querySelectorAll("#rate-up-table select.custom-select");let t=new Array(Object.keys(n).length).fill(0);return e.length===0?(console.error("Could not find any rate-up select elements."),[]):(e.forEach(a=>{const r=a.value;if(r==="unknown")return;const o=n[r];o!==void 0?t[o]++:console.warn(`Invalid or unhandled rate-up value found: "${r}"`)}),t)}function Z(){const n=document.querySelector(".mode-label.active").getAttribute("data-target");if(n==="probability")return{type:n,value:parseInt(document.querySelector('[data-control="probability"]').value)/100};if(n==="pulls")return{type:n,value:parseInt(document.querySelector('[data-control="pulls"]').value)}}let E=null;function Q(){const n=document.getElementById("myChart").getContext("2d");E=new Chart(n,{type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{color:"#b8c2d0",callback:function(e){return(e*100).toFixed(0)+"%"}},grid:{color:"rgba(58, 58, 106, 0.5)"},beginAtZero:!0,min:0,max:1},x:{ticks:{color:"#b8c2d0"},grid:{color:"rgba(58, 58, 106, 0.5)"}}},plugins:{legend:{labels:{color:"#f5f5f5",sort:(e,t)=>e.datasetIndex-t.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(e){let t=e.dataset.label||"";return t&&(t+=": "),t+=(e.parsed.y*100).toFixed(2)+"%",t}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function tt(n){const e=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return e[n%e.length]}function et(n){const e=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return e[(n-2)%e.length]}function at(n,e,t){E||Q();const a=n.length,r=t.slice(1);E.data.labels=e,E.data.datasets=n.map((o,s)=>{const l=s===0?"#2196F3":s===1?"#4CAF50":tt(s);return{label:r[s],data:o,borderColor:l,backgroundColor:s===0?"rgba(33, 150, 243, 0.1)":s===1?"rgba(76, 175, 80, 0.1)":et(s),fill:!0,tension:.4,order:a-s,borderWidth:3,pointRadius:0,pointHoverRadius:5}}),E.update()}function ot(n){let e=n[0].length,t=Array.from({length:e-1},()=>Array.from({length:n.length+1},()=>0)),a=[0];for(let r=0;r<n.length;r++){let o=0;for(const u of n[r])o+=u;let s=0;const l=r+1;a.push(l);const i=n[r],c=i.length-1;for(let u=c;u>0;u--)s+=i[u],t[u-1][l]=s/o}return{data:t,labels:a}}function nt(n){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=rt(n,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=st(n,parseInt(document.querySelector('[data-control="pulls"]').value))}function rt(n,e){e===100&&(e=99.9);let t=n.length-1,a=!0,r=0,o=0;for(;a;)n[t][o]>e/100&&(r=o,a=!1),o++;return r}function st(n,e){let t=n.length-1;return n[t].length<=e?100:Math.round(n[t][e]*100)}function Mt(n,e){return async function(){const a=Z(),r=G(n.calculatorConfig.CONSTELLATION_MAP,n.calculatorConfig.gachaConfig),o=J(n.calculatorConfig.gachaConfig.paths),s=await n.calculatorFunction(r,a),l=ot(s.chartData);at(l.data,l.labels,o),nt(l.data);const i={results:s,inputConfig:r,chartLabels:o,gachaConfig:n.calculatorConfig.gachaConfig};if(n.postCalculationHooks&&n.postCalculationHooks.forEach(c=>c(i)),e){const c=parseInt(document.querySelector('[data-control="pulls"]').value);e.saveCalculation({input:Y(),targetProb:r.targetProb,targetPull:c,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")})}}}const lt=[.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.006,.066,.126,.186,.246,.306,.366,.426,.486,.546,.606,.666,.726,.786,.846,.906,.966,1],ct=[.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.007,.077,.147,.217,.287,.357,.427,.497,.567,.637,.707,.777,.847,.917,.987,1],M=[.051,.051,.051,.051,.051,.051,.051,.051,.561,1],Ut={maxCharacterConstelation:6,rateUpCharacterSR:3,rateUpWeaponSR:5,poolStandardCharSSR:8,poolCharSR:43,configSR:{maxType:7,regularPoints:.4,specialPoints:1},configSSR:{maxType:7,regularPoints:2,specialPoints:5},configWep:{pointsSR:.4,pointsSSR:2},paths:{char:["None","c0","c1","c2","c3","c4","c5","c6"],wep:["None","r1","r2","r3","r4","r5"]},pity:{pitySSRChar:lt.length,pitySSRWep:ct.length,pitySRChar:M.length,pitySRWep:M.length},default:0},it=[{value:"unknown",text:"Unknown"},{value:"none",text:"Not Owned"},{value:"c0",text:"C0"},{value:"c1",text:"C1"},{value:"c2",text:"C2"},{value:"c3",text:"C3"},{value:"c4",text:"C4"},{value:"c5",text:"C5"},{value:"c6",text:"C6"}],Nt={none:0,c0:1,c1:2,c2:3,c3:4,c4:5,c5:6,c6:7},Dt=new Set(["dehya","diluc","jean","keqing","mona","qiqi","tighnari","yumemizuki_mizuki"]),Bt=new Set(["barbara","beidou","bennett","candace","charlotte","chevreuse","chongyun","collei","dahlia","diona","dori","faruzan","fischl","freminet","gaming","gorou","iansan","ifa","kachina","kaveh","kirara","kujou_sara","kuki_shinobu","lan_yan","layla","lynette","mika","ningguang","noelle","ororon","razor","rosaria","sayu","sethos","shikanoin_heizou","sucrose","thoma","xiangling","xingqiu","xinyan","yanfei","yaoyao","yun_jin"]),Wt=new Set(["amos_bow","aquila_favonia","lost_prayer_to_the_sacred_winds","primordial_jade_winged-spear","skyward_atlas","skyward_blade","skyward_harp","skyward_pride","skyward_spine","wolfs_gravestone"]),$t=new Set(["dragons_bane","eye_of_perception","favonius_codex","favonius_greatsword","favonius_lance","favonius_sword","favonius_warbow","lions_roar","rainslasher","rust","sacrificial_bow","sacrificial_fragments","sacrificial_greatsword","sacrificial_sword","the_bell","the_flute","the_stringless","the_widsith","akuoumaru","alley_hunter","flower-wreathed_feathers","fruitful_hook","lithic_blade","lithic_spear","makhaira_aquamarine","mitternachts_waltz","mountain-bracing_bolt","mouuns_moon","portable_power_saw","prospectors_drill","range_gauge","sturdy_bone","the_alley_flash","the_dockhands_assistant","wandering_evenstar","wavebreakers_fin","waveriding_whirl","wine_and_song","xiphos_moonlight"]),Ht=new Set(["black_tassel","bloodtainted_greatsword","cool_steel","debate_club","emerald_orb","ferrous_shadow","harbinger_of_dawn","magic_guide","raven_bow","sharpshooters_oath","skyrider_sword","slingshot","thrilling_tales_of_dragon_slayers","white_tassel"]);function Ft(n,e,t){ut(e.pity),pt(e),dt();const a=n.loadTables();a&&(D(a.pity),B(a.constellation),ft(a.rateUps),t.validateAll()),n.init()}function ut(n){const e=document.getElementById("pity-row-template"),t=document.querySelector(`${C.PITY_TABLE} tbody`);Object.entries(N.pitySettings).forEach(([a,r])=>{const o=e.content.cloneNode(!0).querySelector("tr"),s=o.querySelector(".special-mechanic");o.dataset.validationType="individual";const l=o.querySelector('[data-control="pity-4"]'),i=o.querySelector('[data-control="pity-5"]');if(l&&(l.min=0,l.max=a.includes("Weapon")?n.pitySRWep-1:n.pitySRChar-1),i&&(i.min=0,i.max=a.includes("Weapon")?n.pitySSRWep-1:n.pitySSRChar-1),o.dataset.banner=a,o.querySelector(".banner-name").textContent=a,o.querySelector('[data-control="pity-4"]').value=r.pity4,o.querySelector('[data-control="pity-5"]').value=r.pity5,s){let c="";a==="character"?c=`
            <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                   value="${r.caprad??0}"> 
        `:a==="weapon"&&(c=`
            <input type="number" data-control="epPath" class="custom-input" min="0" max="2" 
                   value="${r.epPath??0}">
        `),s.innerHTML=c}t.appendChild(o)})}function pt(n){const e=document.getElementById("const-column-template"),t=document.querySelectorAll(`${C.CONSTELLATION_TABLE} tbody tr`),a=n.poolStandardCharSSR,r=n.poolCharSR;t.forEach(o=>{const s=document.createDocumentFragment(),i=o.querySelector("td:first-child")?.textContent.trim();o.dataset.validationType="row-sum",i==="5★"?(o.dataset.targetSum=n.poolStandardCharSSR,o.dataset.rarity="5"):(o.dataset.targetSum=n.poolCharSR,o.dataset.rarity="4");for(let c=0;c<N.constellationColumns;c++){const u=e.content.cloneNode(!0);if(c===0){const f=u.querySelector("input");if(f){const p=i==="5★"?a:r;f.value=p}}s.appendChild(u)}o.appendChild(s)})}function dt(){const n=document.querySelectorAll("#rate-up-table select");if(n.length===0)return;const e=it.map(t=>`<option value="${t.value}">${t.text}</option>`).join("");n.forEach(t=>{t.innerHTML=e,t.value="unknown"})}function jt(n,e,t){const a=[];for(let o=0;o<n.length;o++){let s=0;for(const[l,i]of n[o].offRates)s+=i.prob;s=(s*100).toFixed(2),s>0&&a.push({name:e[o],probability:s,p10:t[o].LOWER_BOUND,mean:t[o].MEAN,p90:t[o].UPPER_BOUND,color:"#3498db"})}const r=document.querySelector("#probability-table tbody");r.innerHTML="",a.forEach(o=>{const s=document.createElement("tr"),l=o.probability;s.innerHTML=`
      <td>${o.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${l}%;background:${o.color}">
            <div class="progress-label">${o.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${o.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${o.mean.toFixed(1)}</td>
      <td class="cashback-value">${o.p90.toFixed(1)}</td>
    `,r.appendChild(s)})}function D(n){n.forEach(e=>{const t=document.querySelector(`${C.PITY_TABLE} tr[data-banner="${e.banner}"]`);t&&(t.querySelector('[data-control="pity-4"]').value=e.pity4,t.querySelector('[data-control="pity-5"]').value=e.pity5,t.querySelector(".guarantee-4").checked=e.guarantee4,t.querySelector(".guarantee-5").checked=e.guarantee5,e.caprad&&t.querySelector('[data-control="capRad"]')&&(t.querySelector('[data-control="capRad"]').value=e.caprad),e.epPath&&t.querySelector('[data-control="epPath"]')&&(t.querySelector('[data-control="epPath"]').value=e.epPath))})}function B(n){document.querySelectorAll(`${C.CONSTELLATION_TABLE} tbody tr`).forEach((t,a)=>{const r=n[a];r&&t.querySelectorAll("td:nth-child(n+2) input").forEach((s,l)=>{r[l]!==void 0&&(s.value=r[l])})})}function ft(n){if(!n||!Array.isArray(n))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((t,a)=>{n[a]!==void 0&&(t.value=n[a])})}function zt(n,e,t){const a=document.getElementById("import-file-input");if(!a){console.error("Import file input not found!");return}const r=o=>ht(o,n,e,t);a.removeEventListener("change",a.__handleFile),a.addEventListener("change",r),a.__handleFile=r}async function ht(n,e,t,a){const r=n.target.files[0];if(r)try{const o=await r.text(),s=JSON.parse(o);let l=null;s.exportFormat==="GachaCalculatorData"?l=s:t&&(l=t(s)),l?(mt(l),a.validateAll(),e.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(o){console.error("File import error:",o)}finally{n.target.value=""}}function mt(n){n.pity&&D(n.pity),n.constellation&&B(n.constellation)}function Vt(n){const e={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:n.getPityData(),constellation:n.getConstellationData()},t=JSON.stringify(e,null,2),a=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(a),o=document.createElement("a");o.href=r;const s=new Date().toISOString().slice(0,10);o.download=`gachaCalc-data-${s}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),console.log("Data exported successfully.")}function Gt(n,e=null){let t=0;const a=new Map;e&&e.forEach(c=>{if(c.group&&!c.group.startsWith("unique")){const u=parseInt(c.group.replace(/\D/g,""));t=Math.max(t,u),a.set(c.group,I(u))}});const r=document.getElementById("row-template"),o=document.querySelector(".rows-container"),s=document.getElementById("add-btn");function l(c=null,u=null){const p=r.content.cloneNode(!0).querySelector(".row"),h=p.querySelector(".dropdown"),d=p.querySelector(".type-selector"),y=h.querySelector(".type-icon"),b=h.querySelector(".type-text");p.querySelectorAll(".dropdown__item").forEach(m=>{m.addEventListener("click",A=>{A.preventDefault();const R=m.dataset.value;d.value=R;const _=d.options[d.selectedIndex];y.src=_.dataset.icon,b.textContent=_.textContent,i(p,R),h.classList.remove("dropdown--open")})});const S=u?.type||"char";d.value=S;const k=d.options[d.selectedIndex];y.src=k.dataset.icon,b.textContent=k.textContent;let g;if(u){g=u.group;let m=a.get(g);if(m===void 0&&!g.startsWith("unique")){const A=parseInt(g.replace(/\D/g,""));m=I(A),a.set(g,m)}p.style.setProperty("--group-color",g.startsWith("unique")?"#f0f0f0":`hsl(${m}, 80%, 70%)`),i(p,S,u.from,u.to)}else if(c){const m=c.dataset.group,A=c.querySelector(".type-selector").value,R=c.querySelector(".second-select").value;if(m.startsWith("unique")){const T=yt(a,t);g=`group${T}`;const w=I(T);p.style.setProperty("--group-color",`hsl(${w}, 80%, 70%)`),c.style.setProperty("--group-color",`hsl(${w}, 80%, 70%)`),c.dataset.group=g,a.set(g,w),T===t+1&&t++}else{g=m;const T=a.get(m);p.style.setProperty("--group-color",`hsl(${T}, 80%, 70%)`)}d.value=A;const _=d.options[d.selectedIndex];y.src=_.dataset.icon,b.textContent=_.textContent,i(p,A,R)}else g=`unique${S.charAt(0).toUpperCase()+S.slice(1)}`,p.style.setProperty("--group-color","#f0f0f0"),i(p,S);return p.dataset.group=g,h.addEventListener("click",m=>{m.stopPropagation(),h.classList.toggle("dropdown--open")}),document.addEventListener("click",m=>{h.contains(m.target)||h.classList.remove("dropdown--open")}),p.querySelectorAll(".dropdown__item").forEach(m=>{m.addEventListener("click",A=>{A.stopPropagation(),d.value=m.dataset.value;const R=d.options[d.selectedIndex];y.src=R.dataset.icon,b.textContent=R.textContent,h.classList.remove("dropdown--open"),i(p,d.value),p.dataset.group.startsWith("unique")||(p.dataset.group=`unique${d.value.charAt(0).toUpperCase()+d.value.slice(1)}`)})}),d.addEventListener("change",()=>{const m=d.options[d.selectedIndex];y.src=m.dataset.icon,b.textContent=m.textContent,i(p,d.value),h.classList.remove("dropdown--open"),p.dataset.group.startsWith("unique")||(p.dataset.group=`unique${d.value.charAt(0).toUpperCase()+d.value.slice(1)}`)}),p.querySelector(".btn--chainAdd").addEventListener("click",()=>{o.appendChild(l(p))}),p.querySelector(".btn--delete").addEventListener("click",()=>{const m=p.dataset.group;m.startsWith("unique")||Array.from(o.querySelectorAll(".row")).filter(R=>R.dataset.group===m).length===1&&a.delete(m),p.remove()}),p}function i(c,u,f=null,p=null){const h=c.querySelector(".first-select"),d=c.querySelector(".second-select");h.innerHTML="",d.innerHTML="";const y=n[u]||n.char;if(y.slice(0,-1).forEach(b=>{const S=document.createElement("option");S.value=b,S.textContent=b,h.appendChild(S)}),y.slice(1).forEach(b=>{const S=document.createElement("option");S.value=b,S.textContent=b,d.appendChild(S)}),f&&y.includes(f)){h.value=f;const b=y.indexOf(f);d.value=p&&y.includes(p)&&y.indexOf(p)>b?p:y[Math.min(b+1,y.length-1)]}else h.value=y[0],d.value=y[1]}o.innerHTML="",e?e.forEach(c=>{o.appendChild(l(null,c))}):o.appendChild(l()),s.addEventListener("click",()=>{o.appendChild(l())})}function I(n){const e=[0,120,240,60,180,300];return n<=e.length?e[n-1]:n*137.5%360}function yt(n,e){const t=Array.from(n.keys()).map(a=>parseInt(a.replace(/\D/g,""))).sort((a,r)=>a-r);for(let a=1;a<=e;a++)if(!t.includes(a))return a;return++e}function Yt(n=null){const e={probability:90,pulls:155},t=document.querySelector('[data-control="probability"]'),a=document.querySelector('[data-control="pulls"]');n?(t.value=n.targetProb||e.probability,a.value=n.targetPull||e.pulls):(t.value=e.probability,a.value=e.pulls)}function Kt(n=null){const e=document.querySelector('[data-control="probability"]'),t=document.querySelector('[data-control="pulls"]'),a=document.querySelectorAll(".mode-label");let r;n?r=n:r="probability",o(),a.forEach(l=>{l.addEventListener("click",function(){r=this.getAttribute("data-target"),o(),s()})}),e.addEventListener("input",function(){r="probability",o(),s()}),t.addEventListener("input",function(){r="pulls",o(),s()});function o(){a.forEach(l=>{const i=l.getAttribute("data-target")===r;l.classList.toggle("active",i)})}function s(){r==="probability"?parseFloat(e.value):parseInt(t.value)}}const x={TABLES:1,CALCULATIONS:1,PULL_PLANS:1};function Jt(n){if(!n)throw new Error("Persistence factory requires a namespace.");const e={TABLES:`gacha_tables_${n}_v1`,CALCULATIONS:`gacha_calc_${n}_v1`,PULL_PLANS:`gacha_plans_${n}_v1`};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(t){this._save(e.CALCULATIONS,{_schema:x.CALCULATIONS,...t})},loadCalculation(){return this._validate(this._load(e.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(e.TABLES,{_schema:x.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(e.TABLES),"TABLES")},getPityData(){return Array.from(document.querySelectorAll(`${C.PITY_TABLE} tbody tr`)).map(t=>({banner:t.dataset.banner,pity4:t.querySelector('[data-control="pity-4"]').value,pity5:t.querySelector('[data-control="pity-5"]').value,guarantee4:t.querySelector(".guarantee-4").checked,guarantee5:t.querySelector(".guarantee-5").checked,...t.querySelector('[data-control="capRad"]')&&{caprad:t.querySelector('[data-control="capRad"]').value},...t.querySelector('[data-control="epPath"]')&&{epPath:t.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${C.CONSTELLATION_TABLE} tbody tr`)).map(t=>Array.from(t.querySelectorAll("td:nth-child(n+2) input")).map(a=>a.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(t=>t.value)},setupTableListeners(){const t=[`${C.PITY_TABLE} input`,`${C.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(t).forEach(a=>{a.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(t,a){try{localStorage.setItem(t,JSON.stringify(a))}catch(r){console.error("Storage error:",r),this._handleStorageError()}},_load(t){try{const a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(a){return console.error("Load error:",a),null}},_validate(t,a){return t?typeof t._schema>"u"?t:t._schema!==x[a]?(console.warn(`Schema version mismatch for ${a}`),null):t:null},_handleStorageError(){Object.values(e).forEach(t=>{try{localStorage.removeItem(t)}catch(a){console.error("Cleanup failed:",a)}})}}}class Xt{constructor(e){this.constellationMap=e,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const e=document;e.addEventListener("focus",t=>{if(t.target.matches('input[type="number"]'))try{t.target.select()}catch(a){console.warn("Could not select text in input.",a)}},{capture:!0}),e.addEventListener("keydown",t=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(t.key)||(t.ctrlKey||t.metaKey)&&["a","c","v","x"].includes(t.key.toLowerCase())||/^\d$/.test(t.key)||t.preventDefault()}),e.addEventListener("input",t=>{const a=t.target;a.matches('input[type="number"]')&&this.validateIndividualInput(a);const r=a.closest("table");if(r)switch(r.id){case"constellation-table":{const o=a.closest("tr");o&&this.validateRowSum(o),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(a=>a.classList.remove("is-invalid")),this.updateAvailableCountsCache();const e=document.querySelector("#pity-table");e&&e.querySelectorAll('tbody tr input[type="number"]').forEach(a=>this.validateIndividualInput(a));const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(a=>this.validateRowSum(a)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const e=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(a=>{a.querySelectorAll('input[type="number"]').forEach((r,o)=>{e[o]+=parseInt(r.value,10)||0})}),this.availableConstellationCounts=e}getRateUpUsage(){const e=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(t=>{const a=this.constellationMap[t.value];a!==void 0&&e[a]++}),e}validateIndividualInput(e){if(e.value===""||/^\d+$/.test(e.value)){const t=parseInt(e.value,10),a=parseInt(e.min,10),r=parseInt(e.max,10);if((!e.hasAttribute("min")||t>=a)&&(!e.hasAttribute("max")||t<=r)){e.classList.remove("is-invalid");return}}e.classList.add("is-invalid")}validateRowSum(e){if(!e.dataset.targetSum)return;const t=parseFloat(e.dataset.targetSum),a=e.querySelectorAll('input[type="number"]');let r=0;a.forEach(o=>r+=parseFloat(o.value)||0),a.forEach(o=>o.classList.toggle("is-invalid",r!==t))}validateRateUpEligibility(){const e=this.getRateUpUsage(),t=this.availableConstellationCounts.map((a,r)=>e[r]>a);document.querySelectorAll("#rate-up-table select.custom-select").forEach(a=>{const r=this.constellationMap[a.value],o=r!==void 0&&t[r];a.classList.toggle("is-invalid",o)})}isDataValid(){const e=document.querySelectorAll('#pity-table input[type="number"]');for(const a of e)if(!this.isIndividualInputValid(a))return!1;const t=document.querySelectorAll("#constellation-table tbody tr");for(const a of t)if(!this.isRowSumValid(a))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(e){if(e.value===""||/^\d+$/.test(e.value)){const t=parseInt(e.value,10),a=parseInt(e.min,10),r=parseInt(e.max,10);return(!e.hasAttribute("min")||t>=a)&&(!e.hasAttribute("max")||t<=r)}return!1}isRowSumValid(e){if(!e.dataset.targetSum)return!0;const t=parseFloat(e.dataset.targetSum),a=e.querySelectorAll('input[type="number"]');let r=0;return a.forEach(o=>r+=parseFloat(o.value)||0),r===t}isRateUpOverBudget(){const e=this.getRateUpUsage();return this.availableConstellationCounts.some((t,a)=>e[a]>t)}}function Zt(n){const{cashbackCalculator:e,uiUpdater:t}=n;return function(r){const{results:o,inputConfig:s,chartLabels:l,gachaConfig:i}=r,c=e(s,i,o.cashbackData.SSR,o.cashbackData.CharSR,o.cashbackData.WepSR,s.SR.rateUps);t(o.cashbackData.SSR,l,c)}}function Qt(){document.querySelectorAll(".tab-nav").forEach(e=>{e.addEventListener("click",t=>{if(!t.target.matches(".tab-link[data-tab-target]"))return;const a=t.target,r=a.closest(".tab-panel-card"),o=a.dataset.tabTarget,s=r.querySelector(o);if(!s){console.error(`Tab target not found: ${o}`);return}r.querySelectorAll(".tab-link").forEach(l=>l.classList.remove("active")),r.querySelectorAll(".tab-pane").forEach(l=>l.classList.remove("active")),a.classList.add("active"),s.classList.add("active")})})}function bt(n,e){if(!Number.isInteger(n)||n<0)throw new Error("Number of trials (n) must be a non-negative integer.");let t=0,a=0,r=[],o=1;for(;t<=n;)a=o*Math.pow(e,t)*Math.pow(1-e,n-t),r.push(a),t++,o=o*(n+1-t)/t;return r}function St(n,e){if(e<0||e>n)return 0;if(e===0||e===n)return 1;e=Math.min(e,n-e);let t=1;for(let a=1;a<=e;a++)t*=(n-e+a)/a;return t}function gt(n,e){for(const t of n){const a=W(t.rateUps);if(!vt(a,e)){t.probability=0;continue}const r=$(a,e),o=Ct(n,e);t.probability=o===0?0:r/o}}function W(n){const e={};for(let t=0;t<n.length;t++){const a=n[t];a>0&&(e[t]=a)}return e}function vt(n,e){return Object.entries(n).every(([t,a])=>e[t]>=a)}function $(n,e){return Object.entries(n).reduce((t,[a,r])=>t*St(e[a],r),1)}function Ct(n,e){return n.reduce((t,a)=>{const r=W(a.rateUps),o=$(r,e);return t+o},0)}class O{constructor(e,t,a){this.rateUps=e,this.offRates=t,this.probability=a}}function At(n,e,t){const a=[],r=new Array(t).fill(0);function o(s,l){if(s===t){if(l===e){const c=H(r,n);a.push(new O([...r],c))}return}const i=Math.min(n[s],e-l);for(let c=0;c<=i;c++)r[s]=c,o(s+1,l+c),r[s]=0}return o(0,0),a}function H(n,e){const t=[...e];for(let a=0;a<n.length;a++)t[a]-=n[a];return t}function Rt(n,e,t){const a=n.length,r=t.reduce((c,u)=>c+u,0),o=e-r;if(o<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(a);for(let c=0;c<a;c++)if(s[c]=n[c]-t[c],s[c]<0)return console.error(`Error: Known picks for constellation ${c} exceed its capacity.`),[];return At(s,o,a).map(c=>{const u=c.rateUps.map((p,h)=>p+t[h]),f=H(u,n);return new O(u,f)})}function _t(n,e,t){const a=e.map((s,l)=>s-t[l]),r=new Map;for(const s of n){const l=s.rateUps.map((c,u)=>c-t[u]);if(l.some(c=>c<0)){s.probability=0;continue}const i=new O(l,[]);r.set(i,s)}const o=Array.from(r.keys());o.length>0&&gt(o,a);for(const[s,l]of r.entries())l.probability=s.probability}function F(n,e,t,a){return Array.from({length:n+1},(r,o)=>{const s=bt(o,a);let l=0,i=0;for(let c=0;c<=o;c++){const u=o-c,f=e[c],p=u*t,h=f.mean+p,d=f.variance+Math.pow(h,2);l+=h*s[c],i+=d*s[c]}return{mean:l,variance:Math.max(0,i-Math.pow(l,2))}})}function Tt(n,e,t,a){let r=e[n.rateUpCount],o=t[n.charOffRateCount],s=n.wepOffRateCount*a;return{mean:r+o.mean+s,variance:o.variance}}function Et(n){const t=Math.sqrt(n.variance),a=1/Math.sqrt(.2),r=n.mean-t*a,o=n.mean+t*a,s=n.mean;return{LOWER_BOUND:r,MEAN:s,UPPER_BOUND:o}}function qt(n,e){const t=[];let a=0;for(let r=0;r<n.length;r++)for(const[o,s]of n[r].offRates.entries()){const l=Math.floor(o/100);s.prob>e&&(t.push({rateUpCount:r,charOffRateCount:l,wepOffRateCount:o%100,probability:s.prob}),a=Math.max(a,l))}return{combos:t,maxOffRateCount:a}}function U(n,e){const t=[];let a=0;for(let r=0;r<n.length;r++)for(const[o,s]of n[r].offRates.entries())s.prob>e&&(t.push({rateUpCount:r,offRateCount:o,probability:s.prob}),a=Math.max(a,o));return{combos:t,maxOffRateCount:a}}function j(n,e,t){let a=0,r=0;for(const{rateUpCount:o,offRateCount:s,probability:l}of n){const i=e[o],c=t[s],u=i.mean+c.mean,f=i.variance+c.variance+Math.pow(u,2);a+=l*u,r+=l*f}return{mean:a,variance:Math.max(0,r-Math.pow(a,2))}}function z(n){let e=0,t=0;for(const{probability:a,cashback:r}of n)e+=a*r.mean;for(const{probability:a,cashback:r}of n){const o=r.variance+Math.pow(r.mean,2);t+=a*o}return{mean:e,variance:Math.max(0,t-Math.pow(e,2))}}function wt(...n){return n.reduce((e,t)=>({mean:e.mean+t.mean,variance:e.variance+t.variance}),{mean:0,variance:0})}class q{constructor(e,t,a){this.initialState=[...e],this.totalItems=t,this.config=a,this.maxType=a.maxType,this.nTypes=e.length,this.points=Array(this.nTypes).fill(0);for(let r=1;r<this.maxType;r++)this.points[r]=a.regularPoints;this.points[this.maxType]=a.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let e=0;e<this.nTypes;e++)for(let t=0;t<this.nTypes;t++)this.stateSecondMoments[e][t]=this.initialState[e]*this.initialState[t];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const e=this.totalItems;this.step++;let t=0,a=0;for(let i=0;i<this.nTypes;i++){const c=this.expected[i]/e;t+=this.points[i]*c,a+=this.points[i]**2*c}let r=0;for(let i=0;i<this.nTypes;i++)r+=this.points[i]*this.pointStateCrossMoments[i];r/=e;const o=this.secondMoment+2*r+a,s=this.mean+t,l=o-s**2;return this.results.push({mean:s,variance:l}),this.updateState(),this.secondMoment=o,this.mean=s,this.variance=l,{mean:s,variance:l,step:this.step}}updateState(){const e=this.totalItems,t=Array(this.nTypes).fill(0);for(let o=0;o<this.maxType;o++)t[o]=this.expected[o]*(e-1)/e;t[this.maxType]=this.expected[this.maxType];for(let o=0;o<this.maxType;o++)t[o+1]+=this.expected[o]/e;const a=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let o=0;o<this.nTypes;o++)for(let s=0;s<this.nTypes;s++)a[o][s]=this.stateSecondMoments[o][s];for(let o=0;o<this.maxType;o++){const s=Array(this.nTypes).fill(0);s[o]=-1,s[o+1]=1;for(let l=0;l<this.nTypes;l++)for(let i=0;i<this.nTypes;i++)a[l][i]+=1/e*(s[l]*this.stateSecondMoments[o][i]+s[i]*this.stateSecondMoments[l][o]+s[l]*s[i]*this.expected[o])}const r=Array(this.nTypes).fill(0);for(let o=0;o<this.nTypes;o++){let s=this.pointStateCrossMoments[o];o<this.maxType&&(s-=this.pointStateCrossMoments[o]/e),o>=1&&(s+=this.pointStateCrossMoments[o-1]/e);let l=0;for(let i=0;i<this.nTypes;i++)l+=this.points[i]*this.stateSecondMoments[o][i];s+=l/e,o<this.maxType&&(s-=this.points[o]*this.expected[o]/e),o>=1&&(s+=this.points[o-1]*this.expected[o-1]/e),r[o]=s}this.expected=t,this.stateSecondMoments=a,this.pointStateCrossMoments=r}runSteps(e){this.reset();for(let t=0;t<e;t++)this.computeStep();return this.results}}const V=.5,L=1e-8;function te(n,e,t,a,r,o){t=It(t);const s=Rt(n.SR.consCount,e.rateUpCharacterSR,o);_t(s,n.SR.consCount,o);const l=xt(t,e.poolStandardCharSSR,n.SSR.consCountStandard,n.SSR.cashbackRoadmap,e),i=Lt(s,a,r,e,n),c=l;for(let u=0;u<c.length;u++)c[u].mean!=0&&(c[u].mean+=i.mean,c[u].variance+=i.variance,c[u]=Et(c[u]));return c}function It(n){let e=0;for(const t of n)for(const[a,r]of t.offRates)e+=r.prob;for(const t of n)for(const[a,r]of t.offRates)r.prob/=e;return n}function xt(n,e,t,a,r){const{combos:o,maxOffRateCount:s}=qt(n,L),l=[0];let i=0;for(let u=0;u<n.length;u++)a[u-1]==="none"?l.push(i):a[u-1]==="regular"&&(i+=r.configSSR.regularPoints,l.push(i));const c=Array.from({length:n.length},()=>[]);for(const u of o){const f=u.rateUpCount,p=u.probability,d=new q(t,e,r.configSSR).runSteps(s),y=Tt(u,l,d,r.configWep.pointsSSR);c[f].push({cashback:y,probability:p})}for(let u=0;u<c.length;u++){const f=Pt(c[u]);c[u]=z(f)}return c}function Lt(n,e,t,a,r){const{combos:o,maxOffRateCount:s}=U(e,L),{combos:l,maxOffRateCount:i}=U(t,L),c=Ot(n,o,s,a),u=kt(l,i,a,r);return wt(c,u)}function Ot(n,e,t,a){const r=Math.max(...e.map(s=>s.rateUpCount)),o=[];for(const{rateUps:s,offRates:l,probability:i}of n){const u=new q(s,a.rateUpCharacterSR,a.configSR).runSteps(r),p=new q(l,a.poolCharSR-a.rateUpCharacterSR,a.configSR).runSteps(t),h=F(t,p,a.configWep.pointsSR,V),d=j(e,u,h);o.push({probability:i,cashback:d})}return z(o)}function kt(n,e,t,a){const r=Math.max(...n.map(u=>u.rateUpCount)),o=c(r,t.configWep.pointsSR),l=new q(a.SR.consCount,t.poolCharSR,t.configSR).runSteps(e),i=F(e,l,t.configWep.pointsSR,V);return j(n,o,i);function c(u,f){return Array.from({length:u+1},(p,h)=>({mean:h*f,variance:0}))}}function Pt(n){let e=0;for(const t of n)e+=t.probability;for(const t of n)t.probability/=e;return n}export{Nt as C,M as O,Xt as T,$t as W,Bt as a,Dt as b,Ht as c,Wt as d,Jt as e,Zt as f,Ut as g,Mt as h,Ft as i,Qt as j,zt as k,Vt as l,Gt as m,Yt as n,ct as o,lt as p,te as q,Kt as s,jt as u};
