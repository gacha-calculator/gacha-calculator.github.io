function A(p,t,s,R,f,b,P=.5){const{charPullsSum:u,wepPullsSum:c}=M(p),g={characters:0,weapons:0},w={},E=p.length-2;for(let n=E;n>=0;n--){const a=p[n],r=b[n+1];if(!a.isEmpty)if(a.type==="Character")K(t,n,p,R,g,a.type,r);else if(a.type==="Weapon")K(s,n,p,f,g,a.type,r);else throw new Error(`Unknown SSR array type: ${a.type}`)}const{charRankUps:S,wepRankUps:L}=U(u,c,g);return w.charRankUps=S,w.wepRankUps=L,w;function M(n){const a={charPullsSum:0,wepPullsSum:0};if(n.length<=1)return a;const r=n.length-1;for(let o=0;o<r;o++){const{type:h,states:k}=n[o];let y=0;for(const m of k)for(const{prob:x}of m.values())y+=x;switch(h){case"Character":a.charPullsSum+=y;break;case"Weapon":a.wepPullsSum+=y;break}}return a}function U(n,a,r){let o=r.characters,h=r.weapons;return{charRankUps:{pullsSum:n,rankUps:o},wepRankUps:{pullsSum:a,rankUps:h}}}}function O(p,t,s,R){if(p[0].states.length===0)return;const f=p.length-1;for(let b=f;b>=0;b--)p[b].isEmpty||B(s,b,p,R,t)}function v(p,t,s,R,f,b){const P=p.length-2;for(let u=P;u>=0;u--){const c=p[u],g=b[u+1];if(!c.isEmpty)if(c.type==="Character")W(t,u,p,R,c.type,g);else if(c.type==="Weapon")W(s,u,p,f,c.type,g);else throw new Error(`Unknown SSR array type: ${c.type}`)}}function K(p,t,s,R,f,b,P){const u=s[t].states.length;let c=b==="Weapon"?.25:.5;const g=t+2===s.length;let w=s[t].states;const E=s[t+1].states,S=s[t+1].bannerCount!==s[t].bannerCount;let L,M;g||(L=s[t+2].states,M=s[t+2].bannerCount!==s[t].bannerCount);let U=new Map;for(let n=u-1;n>=0;n--){const a=w[n];for(const[r,o]of a){let h=r%1e4,k,y;b==="Character"?(k=h===120,h>1120&&(y=(h-1120)%240===0)):(k=h===80,h>1120&&(y=(h-1120)%160===0));let m=p[n];k&&(m=1,c=1);const x=o.prob*m,_=o.prob-x;let N=x*c;if(N>1e-10){let e=r+1,l=E[P];S?e=Math.trunc(e/1e4)*1e4:k&&(e+=1e3),y&&!g&&(l=L[P],S||(M?e=Math.trunc(e/1e4)*1e4:e=Math.trunc(e/1e3)*1e3+120));const C=l.get(e);C?C.prob+=N:l.set(e,{prob:N}),b==="Character"?f.characters+=N:b==="Weapon"&&(f.weapons+=N)}let V=x*(1-c);if(V>1e-10){let e=r+1;b==="Character"&&(e+=1e4);let l=U;y&&(l=E[0],S?e=Math.trunc(e/1e4)*1e4:e=Math.trunc(e/1e3)*1e3+120);const C=l.get(e);C?C.prob+=V:l.set(e,{prob:V})}let i=_;if(i>1e-10){let e=w[n+1],l=r+1;y&&(S?l=Math.trunc(l/1e4)*1e4:l=Math.trunc(l/1e3)*1e3+120,g?e=E[0]:e=E[n+1]);const C=e.get(l);C?C.prob+=i:e.set(l,{prob:i})}o.prob=0}n===0&&(w[0]=U)}}function B(p,t,s,R,f){const b=R,P=s[t].states;f.rankUpFail=f.pullsSum-f.rankUps;let u=new Map;for(let c=b-1;c>=0;c--){const g=P[c],w=p[c];for(const[E,S]of g){const L=S.prob,M=L*f.pullsSum;if(M>1e-10){S.prob=L*(1-f.pullsSum);const U=L*w*f.rankUpFail,n=M*(1-w)*f.rankUpFail,a=L*f.rankUps;if(U>1e-10){const r=u,o=E+1,h=r.get(o);h?h.prob+=U:r.set(o,{prob:U})}if(n>1e-10){const r=P[c+1],o=r.get(E);o?o.prob+=n:r.set(E,{prob:n})}if(a>1e-10){const r=u,o=r.get(E);o?o.prob+=a:r.set(E,{prob:a})}}}}P[0]=u}function W(p,t,s,R,f,b){const P=s[t].states.length;let u=f==="Weapon"?.25:.5;const c=t+2===s.length;let g=s[t].states;const w=s[t+1].states,E=s[t+1].bannerCount!==s[t].bannerCount;let S,L;c||(S=s[t+2].states,L=s[t+2].bannerCount!==s[t].bannerCount);let M=new Map;for(let U=P-1;U>=0;U--){const n=g[U];for(const[a,r]of n){let o=a,h,k;f==="Character"?(h=o===120,o>1120&&(k=(o-1120)%240===0)):(h=o===80,o>1120&&(k=(o-1120)%160===0));let y=p[U];h&&(y=1,u=1);const m=r.prob*y,x=r.prob-m;let _=m*u;if(_>1e-10){let i=a+1,e=w[b];E?i=0:h&&(i+=1e3),k&&!c&&(e=S[b],E||(L?i=0:i=1120));const l=e.get(i);l?l.prob+=_:e.set(i,{prob:_})}let N=m*(1-u);if(N>1e-10){let i=a+1,e=M;k&&(e=w[0],E?i=0:i=1120);const l=e.get(i);l?l.prob+=N:e.set(i,{prob:N})}let V=x;if(V>1e-10){let i=g[U+1],e=a+1;k&&(E?e=0:e=1120,c?i=w[0]:i=w[U+1]);const l=i.get(e);l?l.prob+=V:i.set(e,{prob:V})}r.prob=0}U===0&&(g[0]=M)}}export{O as rankUpSR,A as rankUpSSR,v as rankUpSSRCheap};
