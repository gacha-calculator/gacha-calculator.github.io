import{o as j,p as q,I as w}from"./solvers-D-av1cDx.js";function pt(t){const{cashbackCalculator:r,uiUpdater:e}=t;return function(a){const{results:i,inputConfig:s,chartLabels:l,gachaConfig:p}=a,n=r(s,p,i.cashbackData.SSR,i.cashbackData.CharSR,i.cashbackData.WepSR,s.SR.rateUps);e(i.cashbackData.SSR,l,n)}}class mt{constructor(r,e={}){this.config=r,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...e}}async runGachaCalculation(r,e){this.adapters.contexts.contextSSR.target=e;let o=[],a={},i=!1,s=!1;const{ssrWorker:l,srWorker:p}=this.adapters.workerManager.getWorkers(),n=this.adapters.distributionArrays.sortPity(r);this.adapters.contexts.contextSSR.pities=n;let{distributionSSR:c}=this.adapters.distributionArrays.makeSSR(r,n),{distributionCharSR:f,distributionWepSR:h}=this.adapters.distributionArrays.makeSR(r);try{await z(l,p,this.adapters.contexts,c,{distributionCharSR:f,distributionWepSR:h},n)}catch(u){console.error("Failed to initialize workers:",u)}let m=await M(l);for(m.type==="IterationComplete"?a=m.lossData:(a=m.lossData,i=m.isTarget,s=m.isEmpty,o=m.allPullsDistributionSSR,c=m.distributionSSR);!s&&!i;)[m]=await Promise.all([M(l),F(p,a)]),m.type==="IterationComplete"?a=m.lossData:(a=m.lossData,i=m.isTarget,s=m.isEmpty,o=m.allPullsDistributionSSR,c=m.distributionSSR);let C=await N(p,a);this.adapters.workerManager.terminateWorkers(),f=C.distributionCharSR,h=C.distributionWepSR;const y={SSR:this.adapters.helpers.consolidateDistributionForCashback(c),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(h)};this.adapters.helpers.simplifyDistribution(c),f=null,h=null;let D=0;const B=10;for(;!s;)i&&(D++,this.adapters.pullLogic.rankUpSSRCheap(c,n),D===B&&this.adapters.helpers.normalizeCheap(c),o.push(this.adapters.helpers.consolidateProbabilitiesCheap(c)),s=this.adapters.helpers.checkIsEmpty(c,i));return{chartData:o,cashbackData:y};async function z(u,b,k,R,{distributionCharSR:d,distributionWepSR:H}){return new Promise((K,V)=>{let g=!1,v=!1,W=!1;function I(){!W&&g&&v&&K()}function O(S){W||(W=!0,V(S))}u.onerror=S=>{console.error("Worker error:",S),O(S)},b.onerror=S=>{O(S)},u.onmessage=function(S){switch(S.data.type){case"InitComplete":g=!0,I();break;default:console.warn("Unknown message type")}},b.onmessage=function(S){switch(S.data.type){case"InitComplete":v=!0,I();break;default:console.warn("Unknown message type")}},u.postMessage({type:"Initiate",distribution:R,context:k}),b.postMessage({type:"Initiate",distribution:{distributionCharSR:d,distributionWepSR:H},context:k})})}function M(u){return new Promise((b,k)=>{u.onmessage=R=>{switch(R.data.type){case"IterationComplete":b(R.data);break;case"LastIteration":b(R.data);break}},u.onerror=k,u.postMessage({type:"Iterate"})})}function F(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k()},u.onerror=R,u.postMessage({type:"Iterate",lossData:b})})}function N(u,b){return new Promise((k,R)=>{u.onmessage=d=>{k(d.data)},u.onerror=R,u.postMessage({type:"IterateLast",lossData:b})})}}}function Y(t){return new Worker("/assets/ssr-worker-D4YCWSXa.js",{type:"module",name:t?.name})}function G(t){return new Worker("/assets/sr-worker-Bs6jCU2D.js",{type:"module",name:t?.name})}class ft{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new Y),this.srWorker||(this.srWorker=new G),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class U{constructor(r,e,o){this.rateUps=r,this.offRates=e,this.probability=o}}function $(t,r,e){const o=[],a=new Array(e).fill(0);function i(s,l){if(s===e){if(l===r){const n=P(a,t);o.push(new U([...a],n))}return}const p=Math.min(t[s],r-l);for(let n=0;n<=p;n++)a[s]=n,i(s+1,l+n),a[s]=0}return i(0,0),o}function P(t,r){const e=[...r];for(let o=0;o<t.length;o++)e[o]-=t[o];return e}function X(t,r,e){const o=t.length,a=e.reduce((n,c)=>n+c,0),i=r-a;if(i<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(o);for(let n=0;n<o;n++)if(s[n]=t[n]-e[n],s[n]<0)return console.error(`Error: Known picks for constellation ${n} exceed its capacity.`),[];return $(s,i,o).map(n=>{const c=n.rateUps.map((h,m)=>h+e[m]),f=P(c,t);return new U(c,f)})}function J(t,r,e){const o=r.map((s,l)=>s-e[l]),a=new Map;for(const s of t){const l=s.rateUps.map((n,c)=>n-e[c]);if(l.some(n=>n<0)){s.probability=0;continue}const p=new U(l,[]);a.set(p,s)}const i=Array.from(a.keys());i.length>0&&j(i,o);for(const[s,l]of a.entries())l.probability=s.probability}function A(t,r,e,o){return Array.from({length:t+1},(a,i)=>{const s=q(i,o);let l=0,p=0;for(let n=0;n<=i;n++){const c=i-n,f=r[n],h=c*e,m=f.mean+h,C=f.variance+Math.pow(m,2);l+=m*s[n],p+=C*s[n]}return{mean:l,variance:Math.max(0,p-Math.pow(l,2))}})}function Q(t,r,e,o){let a=r[t.rateUpCount],i=e[t.charOffRateCount],s=t.wepOffRateCount*o;return{mean:a+i.mean+s,variance:i.variance}}function Z(t){const e=Math.sqrt(t.variance),o=1/Math.sqrt(.2);let a=t.mean-e*o;a<0&&(a=0);const i=t.mean+e*o,s=t.mean;return{LOWER_BOUND:a,MEAN:s,UPPER_BOUND:i}}function tt(t,r){const e=[];let o=0;for(let a=0;a<t.length;a++)for(const[i,s]of t[a].offRates.entries()){const l=Math.floor(i/100);s.prob>r&&(e.push({rateUpCount:a,charOffRateCount:l,wepOffRateCount:i%100,probability:s.prob}),o=Math.max(o,l))}return{combos:e,maxOffRateCount:o}}function x(t,r){const e=[];let o=0;for(let a=0;a<t.length;a++)for(const[i,s]of t[a].offRates.entries())s.prob>r&&(e.push({rateUpCount:a,offRateCount:i,probability:s.prob}),o=Math.max(o,i));return{combos:e,maxOffRateCount:o}}function T(t,r,e){let o=0,a=0;for(const{rateUpCount:i,offRateCount:s,probability:l}of t){const p=r[i],n=e[s],c=p.mean+n.mean,f=p.variance+n.variance+Math.pow(c,2);o+=l*c,a+=l*f}return{mean:o,variance:Math.max(0,a-Math.pow(o,2))}}function _(t){let r=0,e=0;for(const{probability:o,cashback:a}of t)r+=o*a.mean;for(const{probability:o,cashback:a}of t){const i=a.variance+Math.pow(a.mean,2);e+=o*i}return{mean:r,variance:Math.max(0,e-Math.pow(r,2))}}function et(...t){return t.reduce((r,e)=>({mean:r.mean+e.mean,variance:r.variance+e.variance}),{mean:0,variance:0})}const L=.5,E=1e-8;function ut(t,r,e,o,a,i){e=ot(e);const s=X(t.SR.consCount,r.rateUpCharacterSR,i);J(s,t.SR.consCount,i);const l=at(e,r.poolStandardCharSSR,t.SSR.consCountStandard,t.SSR.cashbackRoadmap,r),p=rt(s,o,a,r,t),n=l;for(let c=0;c<n.length;c++)n[c].mean+=p.mean,n[c].variance+=p.variance,n[c]=Z(n[c]);return n}function ot(t){let r=0;for(const e of t)for(const[o,a]of e.offRates)r+=a.prob;for(const e of t)for(const[o,a]of e.offRates)a.prob/=r;return t}function at(t,r,e,o,a){const{combos:i,maxOffRateCount:s}=tt(t,E),l=[0];let p=0;for(let c=0;c<t.length;c++)o[c-1]==="none"?l.push(p):o[c-1]==="regular"&&(p+=a.configSSR.regularPoints,l.push(p));const n=Array.from({length:t.length},()=>[]);for(const c of i){const f=c.rateUpCount,h=c.probability,C=new w(e,r,a.configSSR).runSteps(s),y=Q(c,l,C,a.configWep.pointsSSR);n[f].push({cashback:y,probability:h})}for(let c=0;c<n.length;c++){const f=it(n[c]);n[c]=_(f)}return n}function rt(t,r,e,o,a){const{combos:i,maxOffRateCount:s}=x(r,E),{combos:l,maxOffRateCount:p}=x(e,E),n=nt(t,i,s,o),c=st(l,p,o,a);return et(n,c)}function nt(t,r,e,o){const a=Math.max(...r.map(s=>s.rateUpCount)),i=[];for(const{rateUps:s,offRates:l,probability:p}of t){const c=new w(s,o.rateUpCharacterSR,o.configSR).runSteps(a),h=new w(l,o.poolCharSR-o.rateUpCharacterSR,o.configSR).runSteps(e),m=A(e,h,o.configWep.pointsSR,L),C=T(r,c,m);i.push({probability:p,cashback:C})}return _(i)}function st(t,r,e,o){const a=Math.max(...t.map(c=>c.rateUpCount)),i=n(a,e.configWep.pointsSR),l=new w(o.SR.consCount,e.poolCharSR,e.configSR).runSteps(r),p=A(r,l,e.configWep.pointsSR,L);return T(t,i,p);function n(c,f){return Array.from({length:c+1},(h,m)=>({mean:m*f,variance:0}))}}function it(t){let r=0;for(const e of t)r+=e.probability;for(const e of t)e.probability/=r;return t}export{ft as W,ut as a,pt as c,mt as g};
