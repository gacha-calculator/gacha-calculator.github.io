class G{constructor(p,b={}){this.config=p,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...b}}async runGachaCalculation(p,b){this.adapters.contexts.contextSSR.target=b;let d=[],n={},k={},h=!1,c=!1;const{ssrWorker:y,srWorker:W}=this.adapters.workerManager.getWorkers(),S=this.adapters.distributionArrays.sortPity(p);this.adapters.contexts.contextSSR.pities=S;let{distributionSSR:i}=this.adapters.distributionArrays.makeSSR(p,S),{distributionCharSR:m,distributionWepSR:u}=this.adapters.distributionArrays.makeSR(p);try{await M(y,W,this.adapters.contexts,i,{distributionCharSR:m,distributionWepSR:u},S)}catch(t){console.error("Failed to initialize workers:",t)}let e=await g(y);for(e.type==="IterationComplete"?n=e.lossData:(n=e.lossData,h=e.isTarget,c=e.isEmpty,d=e.allPullsDistributionSSR);!c&&!h;)[e]=await Promise.all([g(y),z(W,n)]),e.type==="IterationComplete"?n=e.lossData:(n=e.lossData,h=e.isTarget,c=e.isEmpty,d=e.allPullsDistributionSSR,i=e.distributionSSR);let f=await L(W,n);this.adapters.workerManager.terminateWorkers(),m=f.distributionCharSR,u=f.distributionWepSR,k={SSR:this.adapters.helpers.consolidateDistributionForCashback(i),CharSR:this.adapters.helpers.consolidateDistributionForCashback(m),WepSR:this.adapters.helpers.consolidateDistributionForCashback(u)},this.adapters.helpers.simplifyDistribution(i),m=null,u=null;let C=0;const x=10;for(;!c;)h&&(C++,this.adapters.pullLogic.rankUpSSRCheap(i,S),C===x&&this.adapters.helpers.normalizeCheap(i),d.push(this.adapters.helpers.consolidateProbabilitiesCheap(i)),c=this.adapters.helpers.checkIsEmpty(i,h));const F=d;return Object.keys(k).length===0&&(k={SSR:this.adapters.helpers.consolidateDistributionForCashback(i),CharSR:this.adapters.helpers.consolidateDistributionForCashback(m),WepSR:this.adapters.helpers.consolidateDistributionForCashback(u)}),{chartData:F,cashbackData:k};async function M(t,r,o,a,{distributionCharSR:w,distributionWepSR:U}){return new Promise((T,A)=>{let D=!1,E=!1,R=!1;function I(){!R&&D&&E&&T()}function P(s){R||(R=!0,A(s))}t.onerror=s=>{console.error("Worker error:",s),P(s)},r.onerror=s=>{P(s)},t.onmessage=function(s){switch(s.data.type){case"InitComplete":D=!0,I();break;default:console.warn("Unknown message type")}},r.onmessage=function(s){switch(s.data.type){case"InitComplete":E=!0,I();break;default:console.warn("Unknown message type")}},t.postMessage({type:"Initiate",distribution:a,context:o}),r.postMessage({type:"Initiate",distribution:{distributionCharSR:w,distributionWepSR:U},context:o})})}function g(t){return new Promise((r,o)=>{t.onmessage=a=>{switch(a.data.type){case"IterationComplete":r(a.data);break;case"LastIteration":r(a.data);break}},t.onerror=o,t.postMessage({type:"Iterate"})})}function z(t,r){return new Promise((o,a)=>{t.onmessage=w=>{o()},t.onerror=a,t.postMessage({type:"Iterate",lossData:r})})}function L(t,r){return new Promise((o,a)=>{t.onmessage=w=>{o(w.data)},t.onerror=a,t.postMessage({type:"IterateLast",lossData:r})})}}}function j(l){return new Worker("/assets/ssr-worker-DlGgqkIx.js",{type:"module",name:l?.name})}function B(l){return new Worker("/assets/sr-worker-DPlwBTth.js",{type:"module",name:l?.name})}class N{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new j),this.srWorker||(this.srWorker=new B),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}export{N as W,G as g};
