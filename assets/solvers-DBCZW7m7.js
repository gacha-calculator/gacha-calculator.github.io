(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function e(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=e(o);fetch(o.href,i)}})();class K{constructor({getPageConfiguration:t,getLabels:e,getPullPlan:r,getTarget:o,updateChart:i,convertToChartData:n,recalcInputs:a,calculatorFunction:l,calculatorConfig:h,pageConfig:c,postCalculationHooks:d,persistence:u,chibi:p}){this.getPageConfiguration=t,this.getLabels=e,this.getPullPlan=r,this.getTarget=o,this.updateChart=i,this.convertToChartData=n,this.recalcInputs=a,this.calculatorFunction=l,this.calculatorConfig=h,this.pageConfig=c,this.postCalculationHooks=d||[],this.persistence=u,this.chibi=p}async runCalculation(){const t=this.getTarget(),e=this.getPageConfiguration(this.calculatorConfig.CONSTELLATION_MAP,this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),r=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(r.length>99){this.chibi.showError("Too many items! Maximum 99 items allowed.");return}const o=await this.calculatorFunction(e,t),i=this.convertToChartData(o.chartData);this.updateChart(i.data,i.labels,r),this.recalcInputs(i.data);const n={results:o,inputConfig:e,chartLabels:r,gachaConfig:this.calculatorConfig.gachaConfig};if(this.postCalculationHooks.forEach(a=>a(n)),this.persistence){const a=parseInt(document.querySelector('[data-control="pulls"]').value),l=parseInt(document.querySelector('[data-control="probability"]').value);this.persistence.saveCalculation({input:this.getPullPlan(),targetProb:l,targetPull:a,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")})}}}function X(s,t,e,r,o,i){H(t.pity,r,i),R(t,r,i),M(o);const n=s.loadTables();n&&(w(n.pity,i),x(n.constellation,i),U(n.rateUps),e.validateAll()),s.init()}function H(s,t,e){const r=document.getElementById("pity-row-template"),o=document.querySelector(`${e.PITY_TABLE} tbody`);Object.entries(t.pitySettings).forEach(([i,n])=>{const a=r.content.cloneNode(!0).querySelector("tr"),l=a.querySelector(".special-mechanic");a.dataset.validationType="individual";const h=a.querySelector('[data-control="pity-4"]'),c=a.querySelector('[data-control="pity-5"]');if(h&&(h.min=0,h.max=i.includes("Weapon")?s.pitySRWep-1:s.pitySRChar-1),c&&(c.min=0,c.max=i.includes("Weapon")?s.pitySSRWep-1:s.pitySSRChar-1),a.dataset.banner=i,a.querySelector(".banner-name").textContent=i,a.querySelector('[data-control="pity-4"]').value=n.pity4,a.querySelector('[data-control="pity-5"]').value=n.pity5,l){let u="";i==="character"?u=`<div class="button-container">
            <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                   value="${n.caprad??0}">
                            <button class="help-btn" data-help-key="caprad-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`:i==="weapon"&&(u=`<div class="button-container">
            <input type="number" data-control="epPath" class="custom-input" min="0" max="1" 
                   value="${n.epPath??0}">
                            <button class="help-btn" data-help-key="eppath-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`),l.innerHTML=u}o.appendChild(a);const d=document.querySelector("#pity-table");d&&d.querySelectorAll('tbody tr input[type="number"]').forEach(u=>u.addEventListener("input",function(){let p=this.value;p.length>1&&p.startsWith("0")&&(this.value=p.replace(/^0+/,""),this.value===""&&(this.value="0"));let f=parseInt(this.value)||0;f>u.max?(this.value=u.max,T(this)):f<u.min&&(this.value=u.min,T(this))}))})}function R(s,t,e){const r=document.getElementById("const-column-template"),o=document.querySelectorAll(`${e.CONSTELLATION_TABLE} tbody tr`),i=s.poolStandardCharSSR,n=s.poolCharSR;o.forEach(a=>{const l=document.createDocumentFragment(),h=a.dataset.rarity;a.dataset.validationType="row-sum",a.dataset.targetSum=h==="5"?i:n;for(let c=0;c<t.constellationColumns;c++){const d=r.content.cloneNode(!0),u=d.querySelector("input");if(c===t.constellationColumns-1){const p=h==="5"?i:n;u.value=p}u.addEventListener("input",()=>q(a)),l.appendChild(d)}a.appendChild(l),k(a),q(a)})}function k(s){const t=document.createElement("div");t.className="row-progress-bar",s.appendChild(t)}function q(s){const t=s.querySelectorAll("input"),e=parseInt(s.dataset.targetSum);let r=0;t.forEach(n=>{r+=parseInt(n.value)||0});const o=s.querySelector(".row-progress-bar"),i=Math.min(r/e*100,100);o.style.width=i+"%",i<60||r>e?o.style.background="rgba(244, 67, 54, 0.3)":i<80?o.style.background="rgba(241, 244, 54, 0.3)":o.style.background="rgba(54, 244, 79, 0.3)"}function M(s){const t=document.querySelectorAll("#rate-up-table select");if(t.length===0)return;const e=s.map(r=>`<option value="${r.value}">${r.text}</option>`).join("");t.forEach(r=>{r.innerHTML=e,r.value="unknown"})}function Q(s,t=null){const e=document.querySelector('[data-control="probability"]'),r=document.querySelector('[data-control="pulls"]');t?(e.value=t.targetProb||s.probability,r.value=t.targetPull||s.pulls):(e.value=s.probability,r.value=s.pulls),e.addEventListener("input",function(){let o=this.value;o.length>1&&o.startsWith("0")&&(this.value=o.replace(/^0+/,""),this.value===""&&(this.value="0")),(parseInt(this.value)||0)>100&&(this.value="100",T(this))}),r.addEventListener("input",function(){let o=this.value;o.length>1&&o.startsWith("0")&&(this.value=o.replace(/^0+/,""),this.value===""&&(this.value="0"));let i=parseInt(this.value)||0;i>9999?this.value="9999":i<1&&(this.value="1")})}function T(s){s.style.borderColor="#a71919",s.style.outline="1px solid #a71919",s.classList.add("flicker"),setTimeout(()=>{s.classList.remove("flicker"),s.style.borderColor="",s.style.outline=""},500)}function Z(s,t,e){const r=[];for(let i=0;i<s.length;i++){let n=0;for(const[a,l]of s[i].offRates)n+=l.prob;n=(n*100).toFixed(2),n>0&&r.push({name:t[i],probability:n,p10:e[i].LOWER_BOUND,mean:e[i].MEAN,p90:e[i].UPPER_BOUND,color:"#3498db"})}const o=document.querySelector("#probability-table tbody");o.innerHTML="",r.forEach(i=>{const n=document.createElement("tr"),a=i.probability;n.innerHTML=`
      <td>${i.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${a}%;background:${i.color}">
            <div class="progress-label">${i.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${i.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${i.mean.toFixed(1)}</td>
      <td class="cashback-value">${i.p90.toFixed(1)}</td>
    `,o.appendChild(n)})}function w(s,t){s.forEach(e=>{const r=document.querySelector(`${t.PITY_TABLE} tr[data-banner="${e.banner}"]`);r&&(r.querySelector('[data-control="pity-4"]').value=e.pity4,r.querySelector('[data-control="pity-5"]').value=e.pity5,r.querySelector(".guarantee-4").checked=e.guarantee4,r.querySelector(".guarantee-5").checked=e.guarantee5,e.caprad&&r.querySelector('[data-control="capRad"]')&&(r.querySelector('[data-control="capRad"]').value=e.caprad),e.epPath&&r.querySelector('[data-control="epPath"]')&&(r.querySelector('[data-control="epPath"]').value=e.epPath))})}function x(s,t){document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`).forEach((r,o)=>{const i=s[o];i&&r.querySelectorAll("td:nth-child(n+2) input").forEach((a,l)=>{i[l]!==void 0&&(a.value=i[l])})})}function U(s){if(!s||!Array.isArray(s))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((e,r)=>{s[r]!==void 0&&(e.value=s[r])})}function tt(s,t,e){const r=document.getElementById("import-file-input");if(!r){console.error("Import file input not found!");return}const o=i=>$(i,s,t,e);r.removeEventListener("change",r.__handleFile),r.addEventListener("change",o),r.__handleFile=o}async function $(s,t,e,r){const o=s.target.files[0];if(o)try{const i=await o.text(),n=JSON.parse(i);let a=null;n.exportFormat==="GachaCalculatorData"?a=n:e&&(a=e(n)),a?(B(a),r.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(i){console.error("File import error:",i)}finally{s.target.value=""}}function B(s){s.pity&&w(s.pity),s.constellation&&x(s.constellation)}function et(s){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:s.getPityData(),constellation:s.getConstellationData()},e=JSON.stringify(t,null,2),r=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(r),i=document.createElement("a");i.href=o;const n=new Date().toISOString().slice(0,10);i.download=`gachaCalc-data-${n}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o),console.log("Data exported successfully.")}function rt(s,t=null){const e=new A(s,t);return e.initialize(),e}function it(s,t=null){return new D(s,t).initialize()}class A{constructor(t,e=null){this.pathsConfig=t,this.savedData=e,this.groupColorMap=new Map,this.rowsContainer=document.querySelector(".rows-container"),this.addButton=document.getElementById("add-btn"),this.COLORS={UNIQUE_GROUP:"#f0f0f0",PRESET_HUES:[0,120,240,60,180,300]}}initialize(){this.rowsContainer.innerHTML="",this.savedData.pullPlan?this.savedData.pullPlan.forEach(t=>{this.rowsContainer.appendChild(this.createRow(null,t))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())})}createRow(t=null,e=null){const r=this.createRowElement();return this.setupRowEvents(r),this.initializeRowData(r,t,e),r}createRowElement(){return document.getElementById("row-template").content.cloneNode(!0).querySelector(".row")}setupRowEvents(t){const e=t.querySelector(".dropdown"),r=t.querySelector(".type-selector");this.setupDropdownHandler(t,e,r),this.setupTypeChangeHandler(t,r),this.setupButtonHandlers(t)}setupDropdownHandler(t,e,r){e.addEventListener("click",o=>{o.stopPropagation(),e.classList.toggle("dropdown--open")}),t.querySelectorAll(".dropdown__item").forEach(o=>{o.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),r.value=o.dataset.value,r.dispatchEvent(new Event("change")),e.classList.remove("dropdown--open")})}),document.addEventListener("click",o=>{e.contains(o.target)||e.classList.remove("dropdown--open")})}setupTypeChangeHandler(t,e){e.addEventListener("change",()=>{const r=e.options[e.selectedIndex],o=t.querySelector(".type-icon"),i=t.querySelector(".type-text");o.src=r.dataset.icon,i.textContent=r.textContent,this.updatePathSelector(t,e.value),this.handleTypeChangeGroupUpdate(t,e.value)})}handleTypeChangeGroupUpdate(t,e){const r=t.dataset.group;r&&!r.startsWith("unique")&&(t.dataset.group=`unique${e.charAt(0).toUpperCase()+e.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP))}setupButtonHandlers(t){t.querySelector(".btn--chainAdd").addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow(t))}),t.querySelector(".btn--delete").addEventListener("click",()=>{this.handleRowDeletion(t)})}handleRowDeletion(t){const e=t.dataset.group;e&&!e.startsWith("unique")&&Array.from(this.rowsContainer.querySelectorAll(".row")).filter(o=>o.dataset.group===e).length===1&&this.groupColorMap.delete(e),t.remove()}initializeRowData(t,e,r){r?this.initializeFromSavedData(t,r):e?this.initializeFromParent(t,e):this.initializeNewRow(t)}initializeFromSavedData(t,e){const r=t.querySelector(".type-selector");r.value=e.type||"char",this.updateVisualType(t,r.value),this.setGroupAndColor(t,e.group),this.updatePathSelector(t,r.value,e.from,e.to)}initializeFromParent(t,e){const r=e.dataset.group,o=e.querySelector(".type-selector").value,i=e.querySelector(".second-select").value,n=t.querySelector(".type-selector");n.value=o,this.updateVisualType(t,o),r.startsWith("unique")?this.convertToNewGroup(e,t):this.inheritExistingGroup(t,r),this.updatePathSelector(t,o,i)}convertToNewGroup(t,e){const r=this.generateNewGroupId(),o=this.getHueForGroup(r);[t,e].forEach(i=>{i.dataset.group=r,i.style.setProperty("--group-color",`hsl(${o}, 80%, 70%)`)}),this.groupColorMap.set(r,o)}inheritExistingGroup(t,e){t.dataset.group=e;const r=this.groupColorMap.get(e);r!==void 0&&t.style.setProperty("--group-color",`hsl(${r}, 80%, 70%)`)}initializeNewRow(t){const r=t.querySelector(".type-selector").value;t.dataset.group=`unique${r.charAt(0).toUpperCase()+r.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP),this.updatePathSelector(t,r)}updateVisualType(t,e){const r=t.querySelector(".type-selector"),o=r.options[r.selectedIndex],i=t.querySelector(".type-icon"),n=t.querySelector(".type-text");i.src=o.dataset.icon,n.textContent=o.textContent}updatePathSelector(t,e,r=null,o=null){const i=t.querySelector(".first-select"),n=t.querySelector(".second-select"),a=this.pathsConfig[e]||this.pathsConfig.char;this.populateSelect(i,a.slice(0,-1)),this.populateSelect(n,a.slice(1)),this.setInitialPathValues(i,n,a,r,o)}populateSelect(t,e){t.innerHTML="",e.forEach(r=>{const o=document.createElement("option");o.value=r,o.textContent=r,t.appendChild(o)})}setInitialPathValues(t,e,r,o,i){if(o&&r.includes(o)){t.value=o;const n=r.indexOf(o);e.value=i&&r.includes(i)&&r.indexOf(i)>n?i:r[Math.min(n+1,r.length-1)]}else t.value=r[0],e.value=r[1]}generateNewGroupId(){const t=Array.from(this.groupColorMap.keys()).map(e=>parseInt(e.replace(/\D/g,""))).filter(e=>!isNaN(e)).sort((e,r)=>e-r);for(let e=1;e<=t.length+1;e++)if(!t.includes(e))return`group${e}`;return`group${t.length+1}`}getHueForGroup(t){const e=parseInt(t.replace(/\D/g,""));return e<=this.COLORS.PRESET_HUES.length?this.COLORS.PRESET_HUES[e-1]:e*137.5%360}setGroupAndColor(t,e){if(t.dataset.group=e,e.startsWith("unique"))t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP);else{let r=this.groupColorMap.get(e);r===void 0&&(parseInt(e.replace(/\D/g,"")),r=this.getHueForGroup(e),this.groupColorMap.set(e,r)),t.style.setProperty("--group-color",`hsl(${r}, 80%, 70%)`)}}getState(){return Array.from(this.rowsContainer.querySelectorAll(".row")).map(e=>({type:e.querySelector(".type-selector").value,from:e.querySelector(".first-select").value,to:e.querySelector(".second-select").value,group:e.dataset.group}))}}class D extends A{constructor(t,e=null){super(t,e||null)}initialize(){return this.rowsContainer.innerHTML="",this.savedData.pullPlan?this.savedData.pullPlan.forEach((t,e)=>{const r={...t,pity:this.savedData.pity4?.[e]||0,guarantee:this.savedData.guarantee4?.[e]||!1};this.rowsContainer.appendChild(this.createRow(null,r))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())}),this}createRow(t=null,e=null){const r=super.createRow(t,e);return this.addPityGuaranteeToRow(r,e),r}addPityGuaranteeToRow(t,e){const r=t.querySelector('[data-control="pity-4"]'),o=t.querySelector(".guarantee-4");e&&(r&&e.pity!==void 0&&(r.value=e.pity),o&&e.guarantee!==void 0&&(o.checked=e.guarantee)),r.addEventListener("input",function(){let i=this.value;i.length>1&&i.startsWith("0")&&(this.value=i.replace(/^0+/,""),this.value===""&&(this.value="0"));let n=parseInt(this.value)||0;n>10?(this.value=10,E(this)):n<0&&(this.value=0,E(this))})}}function E(s){s.style.borderColor="#a71919",s.style.outline="1px solid #a71919",s.classList.add("flicker"),setTimeout(()=>{s.classList.remove("flicker"),s.style.borderColor="",s.style.outline=""},500)}function ot(s=null){const t=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]'),r=document.querySelectorAll(".mode-label");let o;s?o=s:o="probability",i(),r.forEach(n=>{n.addEventListener("click",function(){o=this.getAttribute("data-target"),i()})}),t.addEventListener("input",function(){o="probability",i()}),e.addEventListener("input",function(){o="pulls",i()});function i(){r.forEach(n=>{const a=n.getAttribute("data-target")===o;n.classList.toggle("active",a)})}}const S={TABLES:1,CALCULATIONS:1,PULL_PLANS:1};function st(s,t){if(!s)throw new Error("Persistence factory requires a namespace.");const e={TABLES:`gacha_tables_${s}_v1`,CALCULATIONS:`gacha_calc_${s}_v1`,PULL_PLANS:`gacha_plans_${s}_v1`};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(r){this._save(e.CALCULATIONS,{_schema:S.CALCULATIONS,...r})},loadCalculation(){return this._validate(this._load(e.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(e.TABLES,{_schema:S.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(e.TABLES),"TABLES")},getPityData(){return Array.from(document.querySelectorAll(`${t.PITY_TABLE} tbody tr`)).map(r=>({banner:r.dataset.banner,...r.querySelector('[data-control="pity-4"]')&&{pity4:r.querySelector('[data-control="pity-4"]').value},...r.querySelector('[data-control="pity-5"]')&&{pity5:r.querySelector('[data-control="pity-5"]').value},...r.querySelector(".guarantee-4")&&{guarantee4:r.querySelector(".guarantee-4").checked},...r.querySelector(".guarantee-5")&&{guarantee5:r.querySelector(".guarantee-5").checked},...r.querySelector('[data-control="capRad"]')&&{caprad:r.querySelector('[data-control="capRad"]').value},...r.querySelector('[data-control="epPath"]')&&{epPath:r.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`)).map(r=>Array.from(r.querySelectorAll("td:nth-child(n+2) input")).map(o=>o.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(r=>r.value)},setupTableListeners(){const r=[`${t.PITY_TABLE} input`,`${t.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(r).forEach(o=>{o.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(r,o){try{localStorage.setItem(r,JSON.stringify(o))}catch(i){console.error("Storage error:",i),this._handleStorageError()}},_load(r){try{const o=localStorage.getItem(r);return o?JSON.parse(o):null}catch(o){return console.error("Load error:",o),null}},_validate(r,o){return r?typeof r._schema>"u"?r:r._schema!==S[o]?(console.warn(`Schema version mismatch for ${o}`),null):r:null},_handleStorageError(){Object.values(e).forEach(r=>{try{localStorage.removeItem(r)}catch(o){console.error("Cleanup failed:",o)}})}}}class nt{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",e=>{if(e.target.matches('input[type="number"]'))try{e.target.select()}catch(r){console.warn("Could not select text in input.",r)}},{capture:!0}),t.addEventListener("keydown",e=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(e.key)||(e.ctrlKey||e.metaKey)&&["a","c","v","x"].includes(e.key.toLowerCase())||/^\d$/.test(e.key)||e.preventDefault()}),t.addEventListener("input",e=>{const r=e.target,o=r.closest("table");if(o)switch(o.id){case"constellation-table":{const i=r.closest("tr");i&&this.validateRowSum(i),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(r=>{r.querySelectorAll('input[type="number"]').forEach((o,i)=>{t[i]+=parseInt(o.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const r=this.constellationMap[e.value];r!==void 0&&t[r]++}),t}validateRowSum(t){if(!t.dataset.targetSum)return;const e=parseFloat(t.dataset.targetSum),r=t.querySelectorAll('input[type="number"]');let o=0;r.forEach(i=>o+=parseFloat(i.value)||0),r.forEach(i=>i.classList.toggle("is-invalid",o!==e))}validateRateUpEligibility(){const t=this.getRateUpUsage(),e=this.availableConstellationCounts.map((r,o)=>t[o]>r);document.querySelectorAll("#rate-up-table select.custom-select").forEach(r=>{const o=this.constellationMap[r.value],i=o!==void 0&&e[o];r.classList.toggle("is-invalid",i)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const r of t)if(!this.isIndividualInputValid(r))return!1;const e=document.querySelectorAll("#constellation-table tbody tr");for(const r of e)if(!this.isRowSumValid(r))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const e=parseInt(t.value,10),r=parseInt(t.min,10),o=parseInt(t.max,10);return(!t.hasAttribute("min")||e>=r)&&(!t.hasAttribute("max")||e<=o)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const e=parseFloat(t.dataset.targetSum),r=t.querySelectorAll('input[type="number"]');let o=0;return r.forEach(i=>o+=parseFloat(i.value)||0),o===e}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((e,r)=>t[r]>e)}}function at(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",e=>{if(!e.target.matches(".tab-link[data-tab-target]"))return;const r=e.target,o=r.closest(".tab-panel-card"),i=r.dataset.tabTarget,n=o.querySelector(i);if(!n){console.error(`Tab target not found: ${i}`);return}o.querySelectorAll(".tab-link").forEach(a=>a.classList.remove("active")),o.querySelectorAll(".tab-pane").forEach(a=>a.classList.remove("active")),r.classList.add("active"),n.classList.add("active")})})}class lt{constructor(t){this.tourSteps=[],this.currentTourStepIndex=0,this.isTourActive=!1,this.isShowingHelp=!1,this.pausedTourStepIndex=-1,this.currentHighlightedElement=null,this.observers=null,this.currentDisplayConfig=null,this.boundHandleWindowResize=this.handleReposition.bind(this),this.boundHandleHighlightUpdate=this.handleHighlightUpdate.bind(this),this.container=document.createElement("div"),this.container.id="chibi-container",this.container.innerHTML=`
            <div class="chibi-tutorial-overlay-piece" data-overlay="top"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="bottom"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="left"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="right"></div>
        `,this.container.innerHTML+=t,document.body.appendChild(this.container),this.overlays={top:this.container.querySelector('[data-overlay="top"]'),bottom:this.container.querySelector('[data-overlay="bottom"]'),left:this.container.querySelector('[data-overlay="left"]'),right:this.container.querySelector('[data-overlay="right"]')},this.chibiGroup=this.container.querySelector(".chibi-group"),this.bubbleText=this.container.querySelector(".bubble-text"),this.nextButton=this.container.querySelector(".btn--tutorial_next"),this.endButton=this.container.querySelector(".btn--tutorial_end"),this.handleNext=this.handleNext.bind(this),this.hide=this.hide.bind(this),this.handleReposition=this.handleReposition.bind(this),this.nextButton.addEventListener("click",this.handleNext),this.endButton.addEventListener("click",this.hide)}startTour(t){if(!t||t.length===0){console.error("ChibiTutorial: No steps provided for the tour.");return}this.tourSteps=t,this.pausedTourStepIndex===-1?this.currentTourStepIndex=0:(this.currentTourStepIndex=this.pausedTourStepIndex,this.pausedTourStepIndex=-1),this.isTourActive=!0,this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block",this.#o(),this.showTourStep(this.currentTourStepIndex)}showTourStep(t){if(t>=this.tourSteps.length){this.hide();return}const e=this.tourSteps[t];this.showDisplay(e)}showDisplay(t){this.currentDisplayConfig=t,this.#r(),this.chibiGroup.classList.remove("chibi-on-left"),t.chibiSide==="left"&&this.chibiGroup.classList.add("chibi-on-left");const e=this.container.querySelector(".bubble-wrapper");e.classList.remove("bubble-wrapper--big","bubble-wrapper--small","bubble-wrapper--huge");const r=t.size;r&&e.classList.add(`bubble-wrapper--${r}`),this.bubbleText.innerHTML=t.text,this.container.style.display="block",this.container.style.height=`${document.documentElement.scrollHeight}px`;let o=null,i=!1;if(t.clickTab){const n=document.querySelector(t.clickTab);n?(n.dispatchEvent(new Event("click",{bubbles:!0})),i=!0):console.warn(`ChibiTutorial: Tab button not found for selector "${t.clickTab}".`)}if(t.action==="click"){const n=document.querySelector(t.element);n?(n.dispatchEvent(new Event("click",{bubbles:!0})),i=!0):console.error(`ChibiTutorial: Element not found for selector "${t.element}" to perform action "${t.action}".`)}if(t.element){if(o=document.querySelector(t.element),!o){console.error(`ChibiTutorial: Element not found for selector "${t.element}". Skipping display.`),this.isTourActive&&this.handleNext();return}if(i)o.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentHighlightedElement=o,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement)},50);else{const n=o.getBoundingClientRect();n.top<0||n.bottom>window.innerHeight||n.left<0||n.right>window.innerWidth?(o.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentHighlightedElement=o,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement)},50)):(this.currentHighlightedElement=o,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement))}}else this.#e(null),this.chibiGroup.style.top="50%",this.chibiGroup.style.left="50%",this.chibiGroup.style.transform="translate(-50%, -50%)"}hide(){this.container.style.display="none",this.chibiGroup.classList.remove("chibi-on-left"),this.#r(),this.#s(),this.currentDisplayConfig=null,this.isShowingHelp||(this.isTourActive=!1,this.currentTourStepIndex=0,this.pausedTourStepIndex=-1),this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block"}#r(){this.currentHighlightedElement&&(this.observers&&this.observers.targetObserver&&this.observers.targetObserver.unobserve(this.currentHighlightedElement),this.currentHighlightedElement.classList.remove("chibi-tutorial-focused-element"),this.currentHighlightedElement=null)}handleNext(){this.isTourActive?(this.currentTourStepIndex++,this.showTourStep(this.currentTourStepIndex)):this.isShowingHelp?(this.hide(),this.pausedTourStepIndex!==-1&&this.startTour(this.tourSteps)):this.hide()}showHelp(t,e=null){if(!t){console.warn("ChibiTutorial: No help configuration provided.");return}let r=null;if(t.tourStepId){const o=this.tourSteps.findIndex(i=>i&&i.id===t.tourStepId);if(o!==-1)r={...this.tourSteps[o]};else if(console.warn(`ChibiTutorial: Tour step with ID '${t.tourStepId}' not found.`),t.text)r={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""};else return}else t.text&&(r={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""});!r.element&&e&&(r.element=e),r&&(this.isTourActive&&(this.pausedTourStepIndex=this.currentTourStepIndex,this.isTourActive=!1),this.isShowingHelp=!0,this.nextButton.textContent="OK",this.endButton.style.display="none",this.showDisplay(r))}handleHighlightUpdate(){window.requestAnimationFrame(()=>{if(!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp)return;this.container.style.height=`${document.documentElement.scrollHeight}px`;const t=this.currentHighlightedElement.getBoundingClientRect(),e={top:t.top+window.scrollY,bottom:t.bottom+window.scrollY,left:t.left+window.scrollX,right:t.right+window.scrollX,width:t.width,height:t.height};this.#e(e)})}handleReposition(){window.requestAnimationFrame(()=>{!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp||(this.container.style.height=`${document.documentElement.scrollHeight}px`,this.#t(this.currentHighlightedElement))})}#t(t){this.container.style.height=`${document.documentElement.scrollHeight}px`;const e=t.getBoundingClientRect(),r={top:e.top+window.scrollY,bottom:e.bottom+window.scrollY,left:e.left+window.scrollX,right:e.right+window.scrollX,width:e.width,height:e.height};this.#e(r),this.#i(r)}#i(t){const e=this.currentDisplayConfig||{},r=this.chibiGroup.getBoundingClientRect(),o=e.position||"bottom",i=20;let n,a;switch(o){case"top":n=t.top-r.height-i,a=t.left+t.width/2-r.width/2;break;case"right":n=t.top+t.height/2-r.height/2,a=t.right+i;break;case"left":n=t.top+t.height/2-r.height/2,a=t.left-r.width-i;break;default:n=t.bottom+i,a=t.left+t.width/2-r.width/2;break}this.chibiGroup.style.top=`${n}px`,this.chibiGroup.style.left=`${a}px`,this.chibiGroup.style.transform=""}#e(t){if(!t){this.overlays.top.style.cssText="width: 100%; height: 100%;",this.overlays.bottom.style.cssText="width: 0; height: 0;",this.overlays.left.style.cssText="width: 0; height: 0;",this.overlays.right.style.cssText="width: 0; height: 0;";return}this.overlays.left.style.cssText=`top: 0; left: 0; width: ${t.left}px; height: 100%;`,this.overlays.right.style.cssText=`top: 0; left: ${t.right}px; width: calc(100% - ${t.right}px); height: 100%;`,this.overlays.top.style.cssText=`top: 0; left: ${t.left}px; width: ${t.width}px; height: ${t.top}px;`,this.overlays.bottom.style.cssText=`top: ${t.bottom}px; left: ${t.left}px; width: ${t.width}px; height: calc(100% - ${t.bottom}px);`}#o(){this.observers={targetObserver:new ResizeObserver(this.boundHandleHighlightUpdate),bodyObserver:new ResizeObserver(this.boundHandleHighlightUpdate),mutationObserver:new MutationObserver(this.boundHandleHighlightUpdate)},this.observers.bodyObserver&&this.observers.bodyObserver.observe(document.body),this.observers.mutationObserver&&this.observers.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0})}#s(){this.observers&&(this.observers.targetObserver&&this.observers.targetObserver.disconnect(),this.observers.bodyObserver&&this.observers.bodyObserver.disconnect(),this.observers.mutationObserver&&this.observers.mutationObserver.disconnect(),this.observers=null)}showError(t,e=".pull-plan-section"){const r={text:`<p style="color: #ff6b6b;">${t}</p>`,element:e,position:"left",chibiSide:"left",size:"small"};this.showHelp(r)}}const y=(s,t=!1)=>s?t?s.checked:parseInt(s.value)||0:null;function ct(s,t,e,r){const o=document.getElementById("pity-panel"),i=document.getElementById("constellation-panel"),n=t.paths;if(!o||!i)return console.error("Required tab panels not found. Cannot get page configuration."),null;const a=(m,v)=>{if(!v)return[];const C=v.querySelector("#constellation-table");if(!C)return console.warn("Could not find the constellation table inside the panel:",v),[];const P=C.querySelectorAll(`tr[data-rarity="${m}"] .custom-input`);return Array.from(P).map(O=>parseInt(O.value)||0)},l=o.querySelector(`${e.PITY_ROW}[data-banner="character"]`),h=o.querySelector(`${e.PITY_ROW}[data-banner="weapon"]`),c=N(n),d={},u={},p={},f={},b={};return r.isCharacter&&(d.char=y(l.querySelector('[data-control="pity-5"]')),u.char=y(l.querySelector('[data-control="pity-4"]')),p.char=y(l.querySelector(".guarantee-5"),!0),f.char=y(l.querySelector(".guarantee-4"),!0),r.isCapRad&&(b.capRad=y(l.querySelector('[data-control="capRad"]')))),r.isWeapon&&(d.wep=y(h.querySelector('[data-control="pity-5"]')),u.wep=y(h.querySelector('[data-control="pity-4"]')),p.wep=y(h.querySelector(".guarantee-5"),!0),f.wep=y(h.querySelector(".guarantee-4"),!0),r.isEpitPath&&(b.epitPath=y(h.querySelector('[data-control="epPath"]')))),{SSR:{pity:d,guarantee:p,special:b,consCountStandard:a(5,i),pullPlan:c.typeArray,cashbackRoadmap:c.cashbackArray},SR:{pity:u,guarantee:f,rateUps:_(s),consCount:a(4,i)}}}function ut(){const s=document.querySelectorAll(".row"),t=[];return Array.from(s).slice(1).forEach(r=>{const o=r.dataset.group,i=r.querySelector(".type-selector")?.value||"char",n=r.querySelector(".first-select")?.value||"None",a=r.querySelector(".second-select")?.value||"None";t.push({group:o,type:i,from:n,to:a})}),{pullPlan:t}}function N(s){const t=document.querySelectorAll(".row"),e=[],r=[],o=Array.from(t).slice(1);let i=0;return o.forEach(n=>{const a=n.querySelector(".type-selector")?.value||"char",l=n.querySelector(".first-select")?.value||"None",h=n.querySelector(".second-select")?.value||"None",c=a==="char"?s.char:s.wep,d=c.indexOf(l),u=c.indexOf(h);if(d===-1||u===-1||d>=u)return;const p=u-d;let f=d,b=0;for(let m=0;m<p;m++)a==="char"&&f===0?b="none":b="regular",e.push({type:a,bannerCount:i}),r.push(b),f++;i++}),{typeArray:e,cashbackArray:r}}function ht(s){const t=document.querySelectorAll(".row"),e=Array.from(t).slice(1);let r=["None"];const o=s.char,i=s.wep;return e.forEach(n=>{const a=n.querySelector(".type-selector")?.value||"char",l=n.querySelector(".first-select")?.value||"None",h=n.querySelector(".second-select")?.value||"None",c=a==="char"?o:i,d=c.indexOf(l),u=c.indexOf(h);if(d===-1||u===-1||d>=u)return;const p=c.slice(d+1,u+1);r.push(...p)}),r}function _(s){const t=document.querySelectorAll("#rate-up-table select.custom-select");let e=new Array(Object.keys(s).length).fill(0);return t.length===0?(console.error("Could not find any rate-up select elements."),[]):(t.forEach(r=>{const o=r.value;if(o==="unknown")return;const i=s[o];i!==void 0?e[i]++:console.warn(`Invalid or unhandled rate-up value found: "${o}"`)}),e)}function dt(){const s=document.querySelector(".mode-label.active").getAttribute("data-target");if(s==="probability")return{type:s,value:parseInt(document.querySelector('[data-control="probability"]').value)/100};if(s==="pulls")return{type:s,value:parseInt(document.querySelector('[data-control="pulls"]').value)}}let g=null;function z(){const s=document.getElementById("myChart").getContext("2d");g=new Chart(s,{type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{color:"#b8c2d0",callback:function(t){return(t*100).toFixed(0)+"%"}},grid:{color:"rgba(58, 58, 106, 0.5)"},beginAtZero:!0,min:0,max:1},x:{ticks:{color:"#b8c2d0"},grid:{color:"rgba(58, 58, 106, 0.5)"}}},plugins:{legend:{labels:{color:"#f5f5f5",sort:(t,e)=>t.datasetIndex-e.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(t){let e=t.dataset.label||"";return e&&(e+=": "),e+=(t.parsed.y*100).toFixed(2)+"%",e}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function G(s){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[s%t.length]}function F(s){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(s-2)%t.length]}function pt(s,t,e){g||z();const r=s.length,o=e.slice(1);g.data.labels=t,g.data.datasets=s.map((i,n)=>{const a=n===0?"#2196F3":n===1?"#4CAF50":G(n);return{label:o[n],data:i,borderColor:a,backgroundColor:n===0?"rgba(33, 150, 243, 0.1)":n===1?"rgba(76, 175, 80, 0.1)":F(n),fill:!0,tension:.4,order:r-n,borderWidth:3,pointRadius:0,pointHoverRadius:5}}),g.update()}function yt(s){let t=s[0].length,e=Array.from({length:t-1},()=>Array.from({length:s.length+1},()=>0)),r=[0];for(let o=0;o<s.length;o++){let i=0;for(const c of s[o])i+=c;let n=0;const a=o+1;r.push(a);const l=s[o],h=l.length-1;for(let c=h;c>0;c--)n+=l[c],e[c-1][a]=n/i}return{data:e,labels:r}}function ft(s){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=W(s,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=V(s,parseInt(document.querySelector('[data-control="pulls"]').value))}function W(s,t){t===100&&(t=99.9);let e=s.length-1,r=!0,o=0,i=0;for(;r;)s[e][i]>t/100&&(o=i,r=!1),i++;return o}function V(s,t){let e=s.length-1;return s[e].length<=t?100:Math.round(s[e][t]*100)}function bt(s,t){for(const e of s){const r=L(e.rateUps);if(!j(r,t)){e.probability=0;continue}const o=I(r,t),i=Y(s,t);e.probability=i===0?0:o/i}}function L(s){const t={};for(let e=0;e<s.length;e++){const r=s[e];r>0&&(t[e]=r)}return t}function j(s,t){return Object.entries(s).every(([e,r])=>t[e]>=r)}function I(s,t){return Object.entries(s).reduce((e,[r,o])=>e*J(t[r],o),1)}function Y(s,t){return s.reduce((e,r)=>{const o=L(r.rateUps),i=I(o,t);return e+i},0)}function J(s,t){if(t<0||t>s)return 0;if(t===0||t===s)return 1;t=Math.min(t,s-t);let e=1;for(let r=1;r<=t;r++)e*=(s-t+r)/r;return e}function gt(s,t){if(!Number.isInteger(s)||s<0)throw new Error("Number of trials (n) must be a non-negative integer.");let e=0,r=0,o=[],i=1;for(;e<=s;)r=i*Math.pow(t,e)*Math.pow(1-t,s-e),o.push(r),e++,i=i*(s+1-e)/e;return o}class mt{constructor(t,e,r){this.initialState=[...t],this.totalItems=e,this.config=r,this.maxType=r.maxType,this.nTypes=t.length,this.points=Array(this.nTypes).fill(0);for(let o=1;o<this.maxType;o++)this.points[o]=r.regularPoints;this.points[this.maxType]=r.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let t=0;t<this.nTypes;t++)for(let e=0;e<this.nTypes;e++)this.stateSecondMoments[t][e]=this.initialState[t]*this.initialState[e];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const t=this.totalItems;this.step++;let e=0,r=0;for(let l=0;l<this.nTypes;l++){const h=this.expected[l]/t;e+=this.points[l]*h,r+=this.points[l]**2*h}let o=0;for(let l=0;l<this.nTypes;l++)o+=this.points[l]*this.pointStateCrossMoments[l];o/=t;const i=this.secondMoment+2*o+r,n=this.mean+e,a=i-n**2;return this.results.push({mean:n,variance:a}),this.updateState(),this.secondMoment=i,this.mean=n,this.variance=a,{mean:n,variance:a,step:this.step}}updateState(){const t=this.totalItems,e=Array(this.nTypes).fill(0);for(let i=0;i<this.maxType;i++)e[i]=this.expected[i]*(t-1)/t;e[this.maxType]=this.expected[this.maxType];for(let i=0;i<this.maxType;i++)e[i+1]+=this.expected[i]/t;const r=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let i=0;i<this.nTypes;i++)for(let n=0;n<this.nTypes;n++)r[i][n]=this.stateSecondMoments[i][n];for(let i=0;i<this.maxType;i++){const n=Array(this.nTypes).fill(0);n[i]=-1,n[i+1]=1;for(let a=0;a<this.nTypes;a++)for(let l=0;l<this.nTypes;l++)r[a][l]+=1/t*(n[a]*this.stateSecondMoments[i][l]+n[l]*this.stateSecondMoments[a][i]+n[a]*n[l]*this.expected[i])}const o=Array(this.nTypes).fill(0);for(let i=0;i<this.nTypes;i++){let n=this.pointStateCrossMoments[i];i<this.maxType&&(n-=this.pointStateCrossMoments[i]/t),i>=1&&(n+=this.pointStateCrossMoments[i-1]/t);let a=0;for(let l=0;l<this.nTypes;l++)a+=this.points[l]*this.stateSecondMoments[i][l];n+=a/t,i<this.maxType&&(n-=this.points[i]*this.expected[i]/t),i>=1&&(n+=this.points[i-1]*this.expected[i-1]/t),o[i]=n}this.expected=e,this.stateSecondMoments=r,this.pointStateCrossMoments=o}runSteps(t){this.reset();for(let e=0;e<t;e++)this.computeStep();return this.results}}export{lt as C,nt as D,mt as I,K as a,yt as b,st as c,ut as d,ht as e,ct as f,dt as g,at as h,X as i,tt as j,et as k,rt as l,Q as m,Z as n,it as o,bt as p,gt as q,ft as r,ot as s,pt as u};
