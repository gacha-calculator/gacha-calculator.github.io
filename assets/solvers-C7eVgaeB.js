(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class X{constructor({getPageConfiguration:t,getLabels:e,getPullPlan:i,getTarget:s,updateChart:r,convertToChartData:n,recalcInputs:a,calculatorFunction:l,calculatorConfig:h,pageConfig:c,postCalculationHooks:d,persistence:u,chibi:p}){this.getPageConfiguration=t,this.getLabels=e,this.getPullPlan=i,this.getTarget=s,this.updateChart=r,this.convertToChartData=n,this.recalcInputs=a,this.calculatorFunction=l,this.calculatorConfig=h,this.pageConfig=c,this.postCalculationHooks=d||[],this.persistence=u,this.chibi=p}async runCalculation(){const t=this.getTarget(),e=this.getPageConfiguration(this.calculatorConfig.CONSTELLATION_MAP,this.calculatorConfig.gachaConfig,this.pageConfig.SELECTORS,this.pageConfig.INITIAL_CONFIG),i=this.getLabels(this.calculatorConfig.gachaConfig.paths);if(i.length>99){this.chibi.showError("Too many items! Maximum 99 items allowed.");return}const s=await this.calculatorFunction(e,t),r=this.convertToChartData(s.chartData);this.updateChart(r.data,r.labels,i),this.recalcInputs(r.data);const n={results:s,inputConfig:e,chartLabels:i,gachaConfig:this.calculatorConfig.gachaConfig,CONSTELLATION_MAP:this.calculatorConfig.CONSTELLATION_MAP};if(this.postCalculationHooks.forEach(a=>a(n)),this.persistence){const a=parseInt(document.querySelector('[data-control="pulls"]').value),l=parseInt(document.querySelector('[data-control="probability"]').value);this.persistence.saveCalculation({input:this.getPullPlan(),targetProb:l,targetPull:a,persistInput:document.querySelector(".mode-label.active").getAttribute("data-target")}),this.persistence.saveButtons()}}}function Q(o,t,e,i,s,r){H(t.pity,i,r),R(t,i,r),B(s);const n=o.loadTables();n&&(w(n.pity,r),x(n.constellation,r),N(n.rateUps),e.validateAll()),o.init()}function Z(o){o.loadButtons().isHidden&&M()}function H(o,t,e){const i=document.getElementById("pity-row-template"),s=document.querySelector(`${e.PITY_TABLE} tbody`);Object.entries(t.pitySettings).forEach(([r,n])=>{const a=i.content.cloneNode(!0).querySelector("tr"),l=a.querySelector(".special-mechanic");a.dataset.validationType="individual";const h=a.querySelector('[data-control="pity-4"]'),c=a.querySelector('[data-control="pity-5"]');if(h&&(h.min=0,h.max=r.includes("weapon")?o.pitySRWep-1:o.pitySRChar-1),c&&(c.min=0,c.max=r.includes("weapon")?o.pitySSRWep-1:o.pitySSRChar-1),a.dataset.banner=r,a.querySelector(".banner-name").textContent=r,a.querySelector('[data-control="pity-4"]').value=n.pity4,a.querySelector('[data-control="pity-5"]').value=n.pity5,l){let u="";r==="character"?u=`<div class="button-container">
            <input type="number" data-control="capRad" class="custom-input" min="0" max="3" 
                   value="${n.caprad??0}">
                            <button class="help-btn" data-help-key="caprad-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`:r==="weapon"&&(u=`<div class="button-container">
            <input type="number" data-control="epPath" class="custom-input" min="0" max="1" 
                   value="${n.epPath??0}">
                            <button class="help-btn" data-help-key="eppath-help"
                                aria-label="Help for Importing Pity Data">
                                ?
                            </button>
                        </div>`),l.innerHTML=u}s.appendChild(a);const d=document.querySelector("#pity-table");d&&d.querySelectorAll('tbody tr input[type="number"]').forEach(u=>u.addEventListener("input",function(){let p=this.value;p.length>1&&p.startsWith("0")&&(this.value=p.replace(/^0+/,""),this.value===""&&(this.value="0"));let y=parseInt(this.value)||0;y>u.max?(this.value=u.max,T(this)):y<u.min&&(this.value=u.min,T(this))}))})}function R(o,t,e){const i=document.getElementById("const-column-template"),s=document.querySelectorAll(`${e.CONSTELLATION_TABLE} tbody tr`),r=o.poolStandardCharSSR,n=o.poolCharSR;s.forEach(a=>{const l=document.createDocumentFragment(),h=a.dataset.rarity;a.dataset.validationType="row-sum",a.dataset.targetSum=h==="5"?r:n;for(let c=0;c<t.constellationColumns;c++){const d=i.content.cloneNode(!0),u=d.querySelector("input");if(c===t.constellationColumns-1){const p=h==="5"?r:n;u.value=p}u.addEventListener("input",()=>q(a)),l.appendChild(d)}a.appendChild(l),k(a),q(a)})}function k(o){const t=document.createElement("div");t.className="row-progress-bar",o.appendChild(t)}function q(o){const t=o.querySelectorAll("input"),e=parseInt(o.dataset.targetSum);let i=0;t.forEach(n=>{i+=parseInt(n.value)||0});const s=o.querySelector(".row-progress-bar"),r=Math.min(i/e*100,100);s.style.width=r+"%",r<60||i>e?s.style.background="rgba(244, 67, 54, 0.3)":r<80?s.style.background="rgba(241, 244, 54, 0.3)":s.style.background="rgba(54, 244, 79, 0.3)"}function B(o){const t=document.querySelectorAll("#rate-up-table select");if(t.length===0)return;const e=o.map(i=>`<option value="${i.value}">${i.text}</option>`).join("");t.forEach(i=>{i.innerHTML=e,i.value="unknown"})}function tt(o,t=null){const e=document.querySelector('[data-control="probability"]'),i=document.querySelector('[data-control="pulls"]');t?(e.value=t.targetProb||o.probability,i.value=t.targetPull||o.pulls):(e.value=o.probability,i.value=o.pulls),e.addEventListener("input",function(){let s=this.value;s.length>1&&s.startsWith("0")&&(this.value=s.replace(/^0+/,""),this.value===""&&(this.value="0")),(parseInt(this.value)||0)>100&&(this.value="100",T(this))}),i.addEventListener("input",function(){let s=this.value;s.length>1&&s.startsWith("0")&&(this.value=s.replace(/^0+/,""),this.value===""&&(this.value="0"));let r=parseInt(this.value)||0;r>9999?this.value="9999":r<1&&(this.value="1")})}function T(o){o.style.borderColor="#a71919",o.style.outline="1px solid #a71919",o.classList.add("flicker"),setTimeout(()=>{o.classList.remove("flicker"),o.style.borderColor="",o.style.outline=""},500)}function et(o,t,e){const i=[];for(let r=0;r<o.length;r++){let n=0;for(const[a,l]of o[r].offRates)n+=l.prob;n=(n*100).toFixed(2),n>0&&i.push({name:t[r],probability:n,p10:e[r].LOWER_BOUND,mean:e[r].MEAN,p90:e[r].UPPER_BOUND,color:"#3498db"})}const s=document.querySelector("#probability-table tbody");s.innerHTML="",i.forEach(r=>{const n=document.createElement("tr"),a=r.probability;n.innerHTML=`
      <td>${r.name}</td>
      <td>
        <div class="progress-container">
          <div class="progress-bar" style="width:${a}%;background:${r.color}">
            <div class="progress-label">${r.probability}%</div>
          </div>
        </div>
      </td>
      <td class="cashback-value">${r.p10.toFixed(1)}</td>
      <td class="cashback-value highlight">${r.mean.toFixed(1)}</td>
      <td class="cashback-value">${r.p90.toFixed(1)}</td>
    `,s.appendChild(n)})}function w(o,t){o.forEach(e=>{const i=document.querySelector(`${t.PITY_TABLE} tr[data-banner="${e.banner}"]`);i&&(i.querySelector('[data-control="pity-4"]').value=e.pity4,i.querySelector('[data-control="pity-5"]').value=e.pity5,i.querySelector(".guarantee-4").checked=e.guarantee4,i.querySelector(".guarantee-5").checked=e.guarantee5,e.caprad&&i.querySelector('[data-control="capRad"]')&&(i.querySelector('[data-control="capRad"]').value=e.caprad),e.epPath&&i.querySelector('[data-control="epPath"]')&&(i.querySelector('[data-control="epPath"]').value=e.epPath))})}function x(o,t){document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`).forEach((i,s)=>{const r=o[s];r&&i.querySelectorAll("td:nth-child(n+2) input").forEach((a,l)=>{r[l]!==void 0&&(a.value=r[l])})})}function N(o){if(!o||!Array.isArray(o))return;document.querySelectorAll("#rate-up-table select.custom-select").forEach((e,i)=>{o[i]!==void 0&&(e.value=o[i])})}function M(){document.querySelectorAll(".help-btn").forEach(t=>{t.classList.toggle("hidden")})}function it(o,t,e,i){const s=document.getElementById("import-file-input");if(!s){console.error("Import file input not found!");return}const r=n=>U(n,o,t,e,i);s.removeEventListener("change",s.__handleFile),s.addEventListener("change",r),s.__handleFile=r}async function U(o,t,e,i,s){const r=o.target.files[0];if(r)try{const n=await r.text(),a=JSON.parse(n);let l=null;a.exportFormat==="GachaCalculatorData"?l=a:e&&(l=e(a)),l?(_(l,s),i.validateAll(),t.saveTables()):alert("Error: Invalid or unsupported file format.")}catch(n){console.error("File import error:",n)}finally{o.target.value=""}}function _(o,t){o.pity&&w(o.pity,t),o.constellation&&x(o.constellation,t)}function rt(o){const t={exportFormat:"GachaCalculatorData",version:"1.0",exportedAt:new Date().toISOString(),pity:o.getPityData(),constellation:o.getConstellationData()},e=JSON.stringify(t,null,2),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),r=document.createElement("a");r.href=s;const n=new Date().toISOString().slice(0,10);r.download=`gachaCalc-data-${n}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),console.log("Data exported successfully.")}function st(o,t=null){const e=new A(o,t);return e.initialize(),e}function ot(o,t=null){return new $(o,t).initialize()}class A{constructor(t,e=null){this.pathsConfig=t,this.savedData=e,this.groupColorMap=new Map,this.rowsContainer=document.querySelector(".rows-container"),this.addButton=document.getElementById("add-btn"),this.COLORS={UNIQUE_GROUP:"#f0f0f0",PRESET_HUES:[0,120,240,60,180,300]}}initialize(){this.rowsContainer.innerHTML="",this.savedData&&this.savedData.pullPlan?this.savedData.pullPlan.forEach(t=>{this.rowsContainer.appendChild(this.createRow(null,t))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())})}createRow(t=null,e=null){const i=this.createRowElement();return this.setupRowEvents(i),this.initializeRowData(i,t,e),i}createRowElement(){return document.getElementById("row-template").content.cloneNode(!0).querySelector(".row")}setupRowEvents(t){const e=t.querySelector(".dropdown"),i=t.querySelector(".type-selector");this.setupDropdownHandler(t,e,i),this.setupTypeChangeHandler(t,i),this.setupButtonHandlers(t)}setupDropdownHandler(t,e,i){e.addEventListener("click",s=>{s.stopPropagation(),e.classList.toggle("dropdown--open")}),t.querySelectorAll(".dropdown__item").forEach(s=>{s.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),i.value=s.dataset.value,i.dispatchEvent(new Event("change")),e.classList.remove("dropdown--open")})}),document.addEventListener("click",s=>{e.contains(s.target)||e.classList.remove("dropdown--open")})}setupTypeChangeHandler(t,e){e.addEventListener("change",()=>{const i=e.options[e.selectedIndex],s=t.querySelector(".type-icon"),r=t.querySelector(".type-text");s.src=i.dataset.icon,r.textContent=i.textContent,this.updatePathSelector(t,e.value),this.handleTypeChangeGroupUpdate(t,e.value)})}handleTypeChangeGroupUpdate(t,e){const i=t.dataset.group;i&&!i.startsWith("unique")&&(t.dataset.group=`unique${e.charAt(0).toUpperCase()+e.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP))}setupButtonHandlers(t){t.querySelector(".btn--chainAdd").addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow(t))}),t.querySelector(".btn--delete").addEventListener("click",()=>{this.handleRowDeletion(t)})}handleRowDeletion(t){const e=t.dataset.group;e&&!e.startsWith("unique")&&Array.from(this.rowsContainer.querySelectorAll(".row")).filter(s=>s.dataset.group===e).length===1&&this.groupColorMap.delete(e),t.remove()}initializeRowData(t,e,i){i?this.initializeFromSavedData(t,i):e?this.initializeFromParent(t,e):this.initializeNewRow(t)}initializeFromSavedData(t,e){const i=t.querySelector(".type-selector");i.value=e.type||"char",this.updateVisualType(t,i.value),this.setGroupAndColor(t,e.group),this.updatePathSelector(t,i.value,e.from,e.to)}initializeFromParent(t,e){const i=e.dataset.group,s=e.querySelector(".type-selector").value,r=e.querySelector(".second-select").value,n=t.querySelector(".type-selector");n.value=s,this.updateVisualType(t,s),i.startsWith("unique")?this.convertToNewGroup(e,t):this.inheritExistingGroup(t,i),this.updatePathSelector(t,s,r)}convertToNewGroup(t,e){const i=this.generateNewGroupId(),s=this.getHueForGroup(i);[t,e].forEach(r=>{r.dataset.group=i,r.style.setProperty("--group-color",`hsl(${s}, 80%, 70%)`)}),this.groupColorMap.set(i,s)}inheritExistingGroup(t,e){t.dataset.group=e;const i=this.groupColorMap.get(e);i!==void 0&&t.style.setProperty("--group-color",`hsl(${i}, 80%, 70%)`)}initializeNewRow(t){const i=t.querySelector(".type-selector").value;t.dataset.group=`unique${i.charAt(0).toUpperCase()+i.slice(1)}`,t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP),this.updatePathSelector(t,i)}updateVisualType(t,e){const i=t.querySelector(".type-selector"),s=i.options[i.selectedIndex],r=t.querySelector(".type-icon"),n=t.querySelector(".type-text");r.src=s.dataset.icon,n.textContent=s.textContent}updatePathSelector(t,e,i=null,s=null){const r=t.querySelector(".first-select"),n=t.querySelector(".second-select"),a=this.pathsConfig[e]||this.pathsConfig.char;this.populateSelect(r,a.slice(0,-1)),this.populateSelect(n,a.slice(1)),this.setInitialPathValues(r,n,a,i,s)}populateSelect(t,e){t.innerHTML="",e.forEach(i=>{const s=document.createElement("option");s.value=i,s.textContent=i,t.appendChild(s)})}setInitialPathValues(t,e,i,s,r){if(s&&i.includes(s)){t.value=s;const n=i.indexOf(s);e.value=r&&i.includes(r)&&i.indexOf(r)>n?r:i[Math.min(n+1,i.length-1)]}else t.value=i[0],e.value=i[1]}generateNewGroupId(){const t=Array.from(this.groupColorMap.keys()).map(e=>parseInt(e.replace(/\D/g,""))).filter(e=>!isNaN(e)).sort((e,i)=>e-i);for(let e=1;e<=t.length+1;e++)if(!t.includes(e))return`group${e}`;return`group${t.length+1}`}getHueForGroup(t){const e=parseInt(t.replace(/\D/g,""));return e<=this.COLORS.PRESET_HUES.length?this.COLORS.PRESET_HUES[e-1]:e*137.5%360}setGroupAndColor(t,e){if(t.dataset.group=e,e.startsWith("unique"))t.style.setProperty("--group-color",this.COLORS.UNIQUE_GROUP);else{let i=this.groupColorMap.get(e);i===void 0&&(parseInt(e.replace(/\D/g,"")),i=this.getHueForGroup(e),this.groupColorMap.set(e,i)),t.style.setProperty("--group-color",`hsl(${i}, 80%, 70%)`)}}getState(){return Array.from(this.rowsContainer.querySelectorAll(".row")).map(e=>({type:e.querySelector(".type-selector").value,from:e.querySelector(".first-select").value,to:e.querySelector(".second-select").value,group:e.dataset.group}))}}class $ extends A{constructor(t,e=null){super(t,e||null)}initialize(){return this.rowsContainer.innerHTML="",this.savedData&&this.savedData.pullPlan?this.savedData.pullPlan.forEach((t,e)=>{const i={...t,pity:this.savedData.pity4?.[e]||0,guarantee:this.savedData.guarantee4?.[e]||!1};this.rowsContainer.appendChild(this.createRow(null,i))}):this.rowsContainer.appendChild(this.createRow()),this.addButton.addEventListener("click",()=>{this.rowsContainer.appendChild(this.createRow())}),this}createRow(t=null,e=null){const i=super.createRow(t,e);return this.addPityGuaranteeToRow(i,e),i}addPityGuaranteeToRow(t,e){const i=t.querySelector('[data-control="pity-4"]'),s=t.querySelector(".guarantee-4");e&&(i&&e.pity!==void 0&&(i.value=e.pity),s&&e.guarantee!==void 0&&(s.checked=e.guarantee)),i.addEventListener("input",function(){let r=this.value;r.length>1&&r.startsWith("0")&&(this.value=r.replace(/^0+/,""),this.value===""&&(this.value="0"));let n=parseInt(this.value)||0;n>10?(this.value=10,E(this)):n<0&&(this.value=0,E(this))})}}function E(o){o.style.borderColor="#a71919",o.style.outline="1px solid #a71919",o.classList.add("flicker"),setTimeout(()=>{o.classList.remove("flicker"),o.style.borderColor="",o.style.outline=""},500)}function nt(o=null){const t=document.querySelector('[data-control="probability"]'),e=document.querySelector('[data-control="pulls"]'),i=document.querySelectorAll(".mode-label");let s;o?s=o:s="probability",r(),i.forEach(n=>{n.addEventListener("click",function(){s=this.getAttribute("data-target"),r()})}),t.addEventListener("input",function(){s="probability",r()}),e.addEventListener("input",function(){s="pulls",r()});function r(){i.forEach(n=>{const a=n.getAttribute("data-target")===s;n.classList.toggle("active",a)})}}const v={TABLES:1,CALCULATIONS:1,PULL_PLANS:1,BUTTONS:1};function at(o,t){if(!o)throw new Error("Persistence factory requires a namespace.");const e={TABLES:`gacha_tables_${o}_v1`,CALCULATIONS:`gacha_calc_${o}_v1`,PULL_PLANS:`gacha_plans_${o}_v1`,BUTTONS:"gacha_buttons_${namespace}_v1"};return{DEBOUNCE_TIME:1500,debug:!1,saveTimeout:null,init(){this.setupTableListeners(),window.addEventListener("beforeunload",()=>this.saveTables())},saveCalculation(i){this._save(e.CALCULATIONS,{_schema:v.CALCULATIONS,...i})},loadCalculation(){return this._validate(this._load(e.CALCULATIONS),"CALCULATIONS")},saveTables(){this._save(e.TABLES,{_schema:v.TABLES,pity:this.getPityData(),constellation:this.getConstellationData(),rateUps:this.getRateUpData()})},loadTables(){return this._validate(this._load(e.TABLES),"TABLES")},saveButtons(){this._save(e.BUTTONS,{_schema:v.BUTTONS,isHidden:this.areButtonsHidden()})},loadButtons(){return this._load(e.BUTTONS)},getPityData(){return Array.from(document.querySelectorAll(`${t.PITY_TABLE} tbody tr`)).map(i=>({banner:i.dataset.banner,...i.querySelector('[data-control="pity-4"]')&&{pity4:i.querySelector('[data-control="pity-4"]').value},...i.querySelector('[data-control="pity-5"]')&&{pity5:i.querySelector('[data-control="pity-5"]').value},...i.querySelector(".guarantee-4")&&{guarantee4:i.querySelector(".guarantee-4").checked},...i.querySelector(".guarantee-5")&&{guarantee5:i.querySelector(".guarantee-5").checked},...i.querySelector('[data-control="capRad"]')&&{caprad:i.querySelector('[data-control="capRad"]').value},...i.querySelector('[data-control="epPath"]')&&{epPath:i.querySelector('[data-control="epPath"]').value}}))},getConstellationData(){return Array.from(document.querySelectorAll(`${t.CONSTELLATION_TABLE} tbody tr`)).map(i=>Array.from(i.querySelectorAll("td:nth-child(n+2) input")).map(s=>s.value))},getRateUpData(){return Array.from(document.querySelectorAll("#rate-up-table select.custom-select")).map(i=>i.value)},areButtonsHidden(){return document.querySelector(".help-btn").classList.contains("hidden")},setupTableListeners(){const i=[`${t.PITY_TABLE} input`,`${t.CONSTELLATION_TABLE} input`,"#rate-up-table select"].join(",");document.querySelectorAll(i).forEach(s=>{s.addEventListener("input",()=>this.queueSave())})},queueSave(){clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveTables(),this.DEBOUNCE_TIME)},_save(i,s){try{localStorage.setItem(i,JSON.stringify(s))}catch(r){console.error("Storage error:",r),this._handleStorageError()}},_load(i){try{const s=localStorage.getItem(i);return s?JSON.parse(s):null}catch(s){return console.error("Load error:",s),null}},_validate(i,s){return i?typeof i._schema>"u"?i:i._schema!==v[s]?(console.warn(`Schema version mismatch for ${s}`),null):i:null},_handleStorageError(){Object.values(e).forEach(i=>{try{localStorage.removeItem(i)}catch(s){console.error("Cleanup failed:",s)}})}}}class lt{constructor(t){this.constellationMap=t,this.availableConstellationCounts=[],this.isInitialized=!1}initialize(){if(this.isInitialized)return;const t=document;t.addEventListener("focus",e=>{if(e.target.matches('input[type="number"]'))try{e.target.select()}catch(i){console.warn("Could not select text in input.",i)}},{capture:!0}),t.addEventListener("keydown",e=>{["Backspace","Delete","Tab","Escape","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End"].includes(e.key)||(e.ctrlKey||e.metaKey)&&["a","c","v","x"].includes(e.key.toLowerCase())||/^\d$/.test(e.key)||e.preventDefault()}),t.addEventListener("input",e=>{const i=e.target,s=i.closest("table");if(s)switch(s.id){case"constellation-table":{const r=i.closest("tr");r&&this.validateRowSum(r),this.updateAvailableCountsCache(),this.validateRateUpEligibility();break}case"rate-up-table":{this.validateRateUpEligibility();break}}}),this.isInitialized=!0}validateAll(){document.querySelectorAll(".is-invalid").forEach(e=>e.classList.remove("is-invalid")),this.updateAvailableCountsCache();const t=document.querySelector("#constellation-table");t&&t.querySelectorAll("tbody tr").forEach(e=>this.validateRowSum(e)),this.validateRateUpEligibility()}updateAvailableCountsCache(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);document.querySelectorAll('#constellation-table tbody tr[data-rarity="4"]').forEach(i=>{i.querySelectorAll('input[type="number"]').forEach((s,r)=>{t[r]+=parseInt(s.value,10)||0})}),this.availableConstellationCounts=t}getRateUpUsage(){const t=new Array(Object.keys(this.constellationMap).length).fill(0);return document.querySelectorAll("#rate-up-table select.custom-select").forEach(e=>{const i=this.constellationMap[e.value];i!==void 0&&t[i]++}),t}validateRowSum(t){if(!t.dataset.targetSum)return;const e=parseFloat(t.dataset.targetSum),i=t.querySelectorAll('input[type="number"]');let s=0;i.forEach(r=>s+=parseFloat(r.value)||0),i.forEach(r=>r.classList.toggle("is-invalid",s!==e))}validateRateUpEligibility(){const t=this.getRateUpUsage(),e=this.availableConstellationCounts.map((i,s)=>t[s]>i);document.querySelectorAll("#rate-up-table select.custom-select").forEach(i=>{const s=this.constellationMap[i.value],r=s!==void 0&&e[s];i.classList.toggle("is-invalid",r)})}isDataValid(){const t=document.querySelectorAll('#pity-table input[type="number"]');for(const i of t)if(!this.isIndividualInputValid(i))return!1;const e=document.querySelectorAll("#constellation-table tbody tr");for(const i of e)if(!this.isRowSumValid(i))return!1;return!this.isRateUpOverBudget()}isIndividualInputValid(t){if(t.value===""||/^\d+$/.test(t.value)){const e=parseInt(t.value,10),i=parseInt(t.min,10),s=parseInt(t.max,10);return(!t.hasAttribute("min")||e>=i)&&(!t.hasAttribute("max")||e<=s)}return!1}isRowSumValid(t){if(!t.dataset.targetSum)return!0;const e=parseFloat(t.dataset.targetSum),i=t.querySelectorAll('input[type="number"]');let s=0;return i.forEach(r=>s+=parseFloat(r.value)||0),s===e}isRateUpOverBudget(){const t=this.getRateUpUsage();return this.availableConstellationCounts.some((e,i)=>t[i]>e)}}function ct(){document.querySelectorAll(".tab-nav").forEach(t=>{t.addEventListener("click",e=>{if(!e.target.matches(".tab-link[data-tab-target]"))return;const i=e.target,s=i.closest(".tab-panel-card"),r=i.dataset.tabTarget,n=s.querySelector(r);if(!n){console.error(`Tab target not found: ${r}`);return}s.querySelectorAll(".tab-link").forEach(a=>a.classList.remove("active")),s.querySelectorAll(".tab-pane").forEach(a=>a.classList.remove("active")),i.classList.add("active"),n.classList.add("active")})})}class ut{constructor(t){this.tourSteps=[],this.currentTourStepIndex=0,this.isTourActive=!1,this.isShowingHelp=!1,this.pausedTourStepIndex=-1,this.currentHighlightedElement=null,this.observers=null,this.currentDisplayConfig=null,this.boundHandleWindowResize=this.handleReposition.bind(this),this.boundHandleHighlightUpdate=this.handleHighlightUpdate.bind(this),this.container=document.createElement("div"),this.container.id="chibi-container",this.container.innerHTML=`
            <div class="chibi-tutorial-overlay-piece" data-overlay="top"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="bottom"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="left"></div>
            <div class="chibi-tutorial-overlay-piece" data-overlay="right"></div>
        `,this.container.innerHTML+=t,document.body.appendChild(this.container),this.overlays={top:this.container.querySelector('[data-overlay="top"]'),bottom:this.container.querySelector('[data-overlay="bottom"]'),left:this.container.querySelector('[data-overlay="left"]'),right:this.container.querySelector('[data-overlay="right"]')},this.chibiGroup=this.container.querySelector(".chibi-group"),this.bubbleText=this.container.querySelector(".bubble-text"),this.nextButton=this.container.querySelector(".btn--tutorial_next"),this.endButton=this.container.querySelector(".btn--tutorial_end"),this.handleNext=this.handleNext.bind(this),this.hide=this.hide.bind(this),this.handleReposition=this.handleReposition.bind(this),this.nextButton.addEventListener("click",this.handleNext),this.endButton.addEventListener("click",this.hide)}startTour(t){if(!t||t.length===0){console.error("ChibiTutorial: No steps provided for the tour.");return}this.tourSteps=t,this.pausedTourStepIndex===-1?this.currentTourStepIndex=0:(this.currentTourStepIndex=this.pausedTourStepIndex,this.pausedTourStepIndex=-1),this.isTourActive=!0,this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block",this.#s(),this.showTourStep(this.currentTourStepIndex)}showTourStep(t){if(t>=this.tourSteps.length){this.hide();return}const e=this.tourSteps[t];this.showDisplay(e)}showDisplay(t){this.currentDisplayConfig=t,this.#i(),this.chibiGroup.classList.remove("chibi-on-left"),t.chibiSide==="left"&&this.chibiGroup.classList.add("chibi-on-left");const e=this.container.querySelector(".bubble-wrapper");e.classList.remove("bubble-wrapper--big","bubble-wrapper--small","bubble-wrapper--huge");const i=t.size;i&&e.classList.add(`bubble-wrapper--${i}`),this.bubbleText.innerHTML=t.text,this.container.style.display="block",this.container.style.height=`${document.documentElement.scrollHeight}px`;let s=null,r=!1;if(t.clickTab){const n=document.querySelector(t.clickTab);n?(n.dispatchEvent(new Event("click",{bubbles:!0})),r=!0):console.warn(`ChibiTutorial: Tab button not found for selector "${t.clickTab}".`)}if(t.action==="click"){const n=document.querySelector(t.element);n?(n.dispatchEvent(new Event("click",{bubbles:!0})),r=!0):console.error(`ChibiTutorial: Element not found for selector "${t.element}" to perform action "${t.action}".`)}if(t.element){if(s=document.querySelector(t.element),!s){console.error(`ChibiTutorial: Element not found for selector "${t.element}". Skipping display.`),this.isTourActive&&this.handleNext();return}if(r)s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentHighlightedElement=s,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement)},50);else{const n=s.getBoundingClientRect();n.top<0||n.bottom>window.innerHeight||n.left<0||n.right>window.innerWidth?(s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{this.currentHighlightedElement=s,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement)},50)):(this.currentHighlightedElement=s,this.currentHighlightedElement.classList.add("chibi-tutorial-focused-element"),this.observers&&this.observers.targetObserver&&this.observers.targetObserver.observe(this.currentHighlightedElement),this.#t(this.currentHighlightedElement))}}else this.#e(null),this.chibiGroup.style.top="50%",this.chibiGroup.style.left="50%",this.chibiGroup.style.transform="translate(-50%, -50%)"}hide(){this.container.style.display="none",this.chibiGroup.classList.remove("chibi-on-left"),this.#i(),this.#o(),this.currentDisplayConfig=null,this.isShowingHelp||(this.isTourActive=!1,this.currentTourStepIndex=0,this.pausedTourStepIndex=-1),this.isShowingHelp=!1,this.nextButton.textContent="Next",this.endButton.style.display="inline-block"}#i(){this.currentHighlightedElement&&(this.observers&&this.observers.targetObserver&&this.observers.targetObserver.unobserve(this.currentHighlightedElement),this.currentHighlightedElement.classList.remove("chibi-tutorial-focused-element"),this.currentHighlightedElement=null)}handleNext(){this.isTourActive?(this.currentTourStepIndex++,this.showTourStep(this.currentTourStepIndex)):this.isShowingHelp?(this.hide(),this.pausedTourStepIndex!==-1&&this.startTour(this.tourSteps)):this.hide()}showHelp(t,e=null){if(!t){console.warn("ChibiTutorial: No help configuration provided.");return}let i=null;if(t.tourStepId){const s=this.tourSteps.findIndex(r=>r&&r.id===t.tourStepId);if(s!==-1)i={...this.tourSteps[s]};else if(console.warn(`ChibiTutorial: Tour step with ID '${t.tourStepId}' not found.`),t.text)i={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""};else return}else t.text&&(i={text:t.text,element:t.element,clickTab:t.clickTab,position:t.position||"bottom",chibiSide:t.chibiSide||"right",size:t.size||""});!i.element&&e&&(i.element=e),i&&(this.isTourActive&&(this.pausedTourStepIndex=this.currentTourStepIndex,this.isTourActive=!1),this.isShowingHelp=!0,this.nextButton.textContent="OK",this.endButton.style.display="none",this.showDisplay(i))}handleHighlightUpdate(){window.requestAnimationFrame(()=>{if(!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp)return;this.container.style.height=`${document.documentElement.scrollHeight}px`;const t=this.currentHighlightedElement.getBoundingClientRect(),e={top:t.top+window.scrollY,bottom:t.bottom+window.scrollY,left:t.left+window.scrollX,right:t.right+window.scrollX,width:t.width,height:t.height};this.#e(e)})}handleReposition(){window.requestAnimationFrame(()=>{!this.currentHighlightedElement||!this.isTourActive&&!this.isShowingHelp||(this.container.style.height=`${document.documentElement.scrollHeight}px`,this.#t(this.currentHighlightedElement))})}#t(t){this.container.style.height=`${document.documentElement.scrollHeight}px`;const e=t.getBoundingClientRect(),i={top:e.top+window.scrollY,bottom:e.bottom+window.scrollY,left:e.left+window.scrollX,right:e.right+window.scrollX,width:e.width,height:e.height};this.#e(i),this.#r(i)}#r(t){const e=this.currentDisplayConfig||{},i=this.chibiGroup.getBoundingClientRect(),s=e.position||"bottom",r=20;let n,a;switch(s){case"top":n=t.top-i.height-r,a=t.left+t.width/2-i.width/2;break;case"right":n=t.top+t.height/2-i.height/2,a=t.right+r;break;case"left":n=t.top+t.height/2-i.height/2,a=t.left-i.width-r;break;default:n=t.bottom+r,a=t.left+t.width/2-i.width/2;break}this.chibiGroup.style.top=`${n}px`,this.chibiGroup.style.left=`${a}px`,this.chibiGroup.style.transform=""}#e(t){if(!t){this.overlays.top.style.cssText="width: 100%; height: 100%;",this.overlays.bottom.style.cssText="width: 0; height: 0;",this.overlays.left.style.cssText="width: 0; height: 0;",this.overlays.right.style.cssText="width: 0; height: 0;";return}this.overlays.left.style.cssText=`top: 0; left: 0; width: ${t.left}px; height: 100%;`,this.overlays.right.style.cssText=`top: 0; left: ${t.right}px; width: calc(100% - ${t.right}px); height: 100%;`,this.overlays.top.style.cssText=`top: 0; left: ${t.left}px; width: ${t.width}px; height: ${t.top}px;`,this.overlays.bottom.style.cssText=`top: ${t.bottom}px; left: ${t.left}px; width: ${t.width}px; height: calc(100% - ${t.bottom}px);`}#s(){this.observers={targetObserver:new ResizeObserver(this.boundHandleHighlightUpdate),bodyObserver:new ResizeObserver(this.boundHandleHighlightUpdate),mutationObserver:new MutationObserver(this.boundHandleHighlightUpdate)},this.observers.bodyObserver&&this.observers.bodyObserver.observe(document.body),this.observers.mutationObserver&&this.observers.mutationObserver.observe(document.body,{attributes:!0,childList:!0,subtree:!0})}#o(){this.observers&&(this.observers.targetObserver&&this.observers.targetObserver.disconnect(),this.observers.bodyObserver&&this.observers.bodyObserver.disconnect(),this.observers.mutationObserver&&this.observers.mutationObserver.disconnect(),this.observers=null)}showError(t,e=".pull-plan-section"){const i={text:`<p style="color: #ff6b6b;">${t}</p>`,element:e,position:"left",chibiSide:"left",size:"small"};this.showHelp(i)}}const f=(o,t=!1)=>o?t?o.checked:parseInt(o.value)||0:null;function ht(o,t,e,i){const s=document.getElementById("pity-panel"),r=document.getElementById("constellation-panel"),n=t.paths;if(!s||!r)return console.error("Required tab panels not found. Cannot get page configuration."),null;const a=(m,S)=>{if(!S)return[];const C=S.querySelector("#constellation-table");if(!C)return console.warn("Could not find the constellation table inside the panel:",S),[];const P=C.querySelectorAll(`tr[data-rarity="${m}"] .custom-input`);return Array.from(P).map(O=>parseInt(O.value)||0)},l=s.querySelector(`${e.PITY_ROW}[data-banner="character"]`),h=s.querySelector(`${e.PITY_ROW}[data-banner="weapon"]`),c=D(n),d={},u={},p={},y={},b={};return i.isCharacter&&(d.char=f(l.querySelector('[data-control="pity-5"]')),u.char=f(l.querySelector('[data-control="pity-4"]')),p.char=f(l.querySelector(".guarantee-5"),!0),y.char=f(l.querySelector(".guarantee-4"),!0),i.isCapRad&&(b.capRad=f(l.querySelector('[data-control="capRad"]')))),i.isWeapon&&(d.wep=f(h.querySelector('[data-control="pity-5"]')),u.wep=f(h.querySelector('[data-control="pity-4"]')),p.wep=f(h.querySelector(".guarantee-5"),!0),y.wep=f(h.querySelector(".guarantee-4"),!0),i.isEpitPath&&(b.epitPath=f(h.querySelector('[data-control="epPath"]')))),{SSR:{pity:d,guarantee:p,special:b,consCountStandard:a(5,r),pullPlan:c.typeArray,cashbackRoadmap:c.cashbackArray},SR:{pity:u,guarantee:y,rateUps:z(),consCount:a(4,r)}}}function dt(){const o=document.querySelectorAll(".row"),t=[];return Array.from(o).slice(1).forEach(i=>{const s=i.dataset.group,r=i.querySelector(".type-selector")?.value||"char",n=i.querySelector(".first-select")?.value||"None",a=i.querySelector(".second-select")?.value||"None";t.push({group:s,type:r,from:n,to:a})}),{pullPlan:t}}function D(o){const t=document.querySelectorAll(".row"),e=[],i=[],s=Array.from(t).slice(1);let r=0;return s.forEach(n=>{const a=n.querySelector(".type-selector")?.value||"char",l=n.querySelector(".first-select")?.value||"None",h=n.querySelector(".second-select")?.value||"None",c=a==="char"?o.char:o.wep,d=c.indexOf(l),u=c.indexOf(h);if(d===-1||u===-1||d>=u)return;const p=u-d;let y=d,b=0;for(let m=0;m<p;m++)a==="char"&&y===0?b="none":b="regular",e.push({type:a,bannerCount:r}),i.push(b),y++;r++}),{typeArray:e,cashbackArray:i}}function pt(o){const t=document.querySelectorAll(".row"),e=Array.from(t).slice(1);let i=["None"];const s=o.char,r=o.wep;return e.forEach(n=>{const a=n.querySelector(".type-selector")?.value||"char",l=n.querySelector(".first-select")?.value||"None",h=n.querySelector(".second-select")?.value||"None",c=a==="char"?s:r,d=c.indexOf(l),u=c.indexOf(h);if(d===-1||u===-1||d>=u)return;const p=c.slice(d+1,u+1);i.push(...p)}),i}function z(){const o=document.querySelectorAll("#rate-up-table select.custom-select");let t=[];return o.length===0?(console.error("Could not find any rate-up select elements."),[]):(o.forEach(e=>{const i=e.value;i!=="unknown"&&(i!==void 0?t.push(i):console.warn(`Invalid or unhandled rate-up value found: "${i}"`))}),t)}function ft(){const o=document.querySelector(".mode-label.active").getAttribute("data-target");if(o==="probability")return{type:o,value:parseInt(document.querySelector('[data-control="probability"]').value)/100};if(o==="pulls")return{type:o,value:parseInt(document.querySelector('[data-control="pulls"]').value)}}let g=null;function G(){const o=document.getElementById("myChart").getContext("2d");g=new Chart(o,{type:"line",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{ticks:{color:"#b8c2d0",callback:function(t){return(t*100).toFixed(0)+"%"}},grid:{color:"rgba(58, 58, 106, 0.5)"},beginAtZero:!0,min:0,max:1},x:{ticks:{color:"#b8c2d0"},grid:{color:"rgba(58, 58, 106, 0.5)"}}},plugins:{legend:{labels:{color:"#f5f5f5",sort:(t,e)=>t.datasetIndex-e.datasetIndex}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(t){let e=t.dataset.label||"";return e&&(e+=": "),e+=(t.parsed.y*100).toFixed(2)+"%",e}}}},interaction:{mode:"nearest",axis:"x",intersect:!1}}})}function F(o){const t=["#FF9800","#9C27B0","#E91E63","#00BCD4"];return t[o%t.length]}function W(o){const t=["rgba(255, 99, 132, 0.1)","rgba(255, 159, 64, 0.1)","rgba(255, 205, 86, 0.1)","rgba(75, 192, 192, 0.1)","rgba(153, 102, 255, 0.1)"];return t[(o-2)%t.length]}function yt(o,t,e){g||G();const i=o.length,s=e.slice(1);g.data.labels=t,g.data.datasets=o.map((r,n)=>{const a=n===0?"#2196F3":n===1?"#4CAF50":F(n);return{label:s[n],data:r,borderColor:a,backgroundColor:n===0?"rgba(33, 150, 243, 0.1)":n===1?"rgba(76, 175, 80, 0.1)":W(n),fill:!0,tension:.4,order:i-n,borderWidth:3,pointRadius:0,pointHoverRadius:5}}),g.update()}function bt(o){let t=o[0].length,e=Array.from({length:t-1},()=>Array.from({length:o.length+1},()=>0)),i=[0];for(let s=0;s<o.length;s++){let r=0;for(const c of o[s])r+=c;let n=0;const a=s+1;i.push(a);const l=o[s],h=l.length-1;for(let c=h;c>0;c--)n+=l[c],e[c-1][a]=n/r}return{data:e,labels:i}}function gt(o){document.querySelector(".mode-label.active").getAttribute("data-target")==="probability"?document.querySelector('.input-lock-container input[data-control="pulls"]').value=V(o,parseInt(document.querySelector('[data-control="probability"]').value)):document.querySelector('.input-lock-container input[data-control="probability"]').value=j(o,parseInt(document.querySelector('[data-control="pulls"]').value))}function V(o,t){t===100&&(t=99.9);let e=o.length-1,i=!0,s=0,r=0;for(;i;)o[e][r]>t/100&&(s=r,i=!1),r++;return s}function j(o,t){let e=o.length-1;return o[e].length<=t?100:Math.round(o[e][t]*100)}function mt(o,t){for(const e of o){const i=L(e.rateUps);if(!Y(i,t)){e.probability=0;continue}const s=I(i,t),r=J(o,t);e.probability=r===0?0:s/r}}function L(o){const t={};for(let e=0;e<o.length;e++){const i=o[e];i>0&&(t[e]=i)}return t}function Y(o,t){return Object.entries(o).every(([e,i])=>t[e]>=i)}function I(o,t){return Object.entries(o).reduce((e,[i,s])=>e*K(t[i],s),1)}function J(o,t){return o.reduce((e,i)=>{const s=L(i.rateUps),r=I(s,t);return e+r},0)}function K(o,t){if(t<0||t>o)return 0;if(t===0||t===o)return 1;t=Math.min(t,o-t);let e=1;for(let i=1;i<=t;i++)e*=(o-t+i)/i;return e}function vt(o,t){if(!Number.isInteger(o)||o<0)throw new Error("Number of trials (n) must be a non-negative integer.");let e=0,i=0,s=[],r=1;for(;e<=o;)i=r*Math.pow(t,e)*Math.pow(1-t,o-e),s.push(i),e++,r=r*(o+1-e)/e;return s}class St{constructor(t,e,i){this.initialState=[...t],this.totalItems=e,this.config=i,this.maxType=i.maxType,this.nTypes=t.length,this.points=Array(this.nTypes).fill(0);for(let s=1;s<this.maxType;s++)this.points[s]=i.regularPoints;this.points[this.maxType]=i.specialPoints,this.reset()}reset(){this.expected=[...this.initialState],this.mean=0,this.secondMoment=0,this.variance=0,this.stateSecondMoments=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let t=0;t<this.nTypes;t++)for(let e=0;e<this.nTypes;e++)this.stateSecondMoments[t][e]=this.initialState[t]*this.initialState[e];this.pointStateCrossMoments=Array(this.nTypes).fill(0),this.results=[{mean:0,variance:0}],this.step=0}computeStep(){const t=this.totalItems;this.step++;let e=0,i=0;for(let l=0;l<this.nTypes;l++){const h=this.expected[l]/t;e+=this.points[l]*h,i+=this.points[l]**2*h}let s=0;for(let l=0;l<this.nTypes;l++)s+=this.points[l]*this.pointStateCrossMoments[l];s/=t;const r=this.secondMoment+2*s+i,n=this.mean+e,a=r-n**2;return this.results.push({mean:n,variance:a}),this.updateState(),this.secondMoment=r,this.mean=n,this.variance=a,{mean:n,variance:a,step:this.step}}updateState(){const t=this.totalItems,e=Array(this.nTypes).fill(0);for(let r=0;r<this.maxType;r++)e[r]=this.expected[r]*(t-1)/t;e[this.maxType]=this.expected[this.maxType];for(let r=0;r<this.maxType;r++)e[r+1]+=this.expected[r]/t;const i=Array(this.nTypes).fill(0).map(()=>Array(this.nTypes).fill(0));for(let r=0;r<this.nTypes;r++)for(let n=0;n<this.nTypes;n++)i[r][n]=this.stateSecondMoments[r][n];for(let r=0;r<this.maxType;r++){const n=Array(this.nTypes).fill(0);n[r]=-1,n[r+1]=1;for(let a=0;a<this.nTypes;a++)for(let l=0;l<this.nTypes;l++)i[a][l]+=1/t*(n[a]*this.stateSecondMoments[r][l]+n[l]*this.stateSecondMoments[a][r]+n[a]*n[l]*this.expected[r])}const s=Array(this.nTypes).fill(0);for(let r=0;r<this.nTypes;r++){let n=this.pointStateCrossMoments[r];r<this.maxType&&(n-=this.pointStateCrossMoments[r]/t),r>=1&&(n+=this.pointStateCrossMoments[r-1]/t);let a=0;for(let l=0;l<this.nTypes;l++)a+=this.points[l]*this.stateSecondMoments[r][l];n+=a/t,r<this.maxType&&(n-=this.points[r]*this.expected[r]/t),r>=1&&(n+=this.points[r-1]*this.expected[r-1]/t),s[r]=n}this.expected=e,this.stateSecondMoments=i,this.pointStateCrossMoments=s}runSteps(t){this.reset();for(let e=0;e<t;e++)this.computeStep();return this.results}}export{ut as C,lt as D,St as I,X as a,bt as b,at as c,dt as d,pt as e,ht as f,ft as g,ct as h,Q as i,it as j,Z as k,rt as l,st as m,tt as n,et as o,ot as p,mt as q,gt as r,nt as s,vt as t,yt as u};
