import{B as W,U as N,q as O,t as x,c as $,S as T,C as J,D as X,a as Z,I as Q,r as tt,b as et,u as at,g as nt,e as ot,v as rt,h as st,k as it,m as lt,l as ct,j as ut,w as D,o as B,x as z,s as _,O as q,y as pt,z as ft,A as I,p as ht}from"./solvers-sityKouI.js";/* empty css               */import{p as M,a as bt,e as dt,c as H,d as F,s as mt,n as gt,b as yt}from"./common-helpers-CPLJV1Gy.js";function Ct(e){if(!e.pulls)throw new Error("Imported data is missing key Kornblume properties.");const o=JSON.parse(e.pulls),n=St(o.data,W);if(!o||!o.data)return console.error("Imported data is missing key Kornblume properties."),null;const a=[{banner:"character",...n}],t=kt(),r=vt(o.data,t);return{pity:a,constellation:r,game:"reverse"}}function St(e,o){let n=0,a=!1,t=!1;for(let r=0;r<e.length;r++){const s=e[r],c=s.ArcanistName,u=s.Rarity,i=s.BannerType,l=o[i].char;if(Object.hasOwn(o,i)&&(u===6?(t||(a=c!=l),t=!0):t||n++,t))break}return{pity5:String(n),guarantee5:a}}function kt(){const e=new Set([]),o=N.length-4;for(const[n,a]of Object.entries(W)){const t=N.indexOf(a.release);o>=t&&e.add(a.char)}return e}function vt(e,o){const n=new Array(Object.keys(O).length).fill(0),a=new Array(Object.keys(O).length).fill(0),t=new Map,r=new Map;for(let l of e){const p=l.Rarity,f=l.ArcanistName;p===6&&o.has(f)?r.set(f,(r.get(f)||0)+1):p===5&&t.set(f,(t.get(f)||0)+1)}for(const l of t.values()){const p=n.length-1;l>=p?n[p]++:n[l]++}for(const l of r.values()){const p=a.length-1;l>=p?a[p]++:a[l]++}const s=x.poolCharSR,c=x.poolStandardCharSSR,u=s-t.size,i=c-r.size;return n[0]=Math.max(0,u),a[0]=Math.max(0,i),{0:a.map(String),1:n.map(String)}}function Rt(e){const{cashbackCalculator:o,uiUpdater:n}=e;return function(t){const{results:r,inputConfig:s,chartLabels:c,gachaConfig:u,CONSTELLATION_MAP:i}=t,l=o(s,u,r.cashbackData.SSR,r.cashbackData.SR,s.SR.rateUps,i);n(r.cashbackData.SSR,c,l)}}const P=(e,o=!1)=>e?o?e.checked:parseInt(e.value)||0:null;function wt(e,o,n,a){const t=document.getElementById("pity-panel"),r=document.getElementById("constellation-panel"),s=o.paths;if(!t||!r)return console.error("Required tab panels not found. Cannot get page configuration."),null;const c=(d,m)=>{if(!m)return[];const C=m.querySelector("#constellation-table");if(!C)return console.warn("Could not find the constellation table inside the panel:",m),[];const A=C.querySelectorAll(`tr[data-rarity="${d}"] .custom-input`);return Array.from(A).map(y=>parseInt(y.value)||0)},u=t.querySelector(`${n.PITY_ROW}[data-banner="character"]`),{planConfigs:i,pity4:l,guarantee4:p}=xt(s),f={},h={},b={};return a.isCharacter&&(f.char=P(u.querySelector('[data-control="pity-5"]')),h.char=P(u.querySelector(".guarantee-5"),!0)),{SSR:{pity:f,guarantee:h,special:b,consCountStandard:c(5,r),pullPlan:i.typeArray,cashbackRoadmap:i.cashbackArray},SR:{pity:l,guarantee:p,rateUps:Pt(),consCount:c(4,r)}}}function At(){const e=document.querySelectorAll(".row"),o=[],n=[],a=[];return Array.from(e).slice(1).forEach(r=>{const s=r.dataset.group,c=P(r.querySelector('[data-control="pity-4"]')),u=P(r.querySelector(".guarantee-4"),!0),i=r.querySelector(".type-selector")?.value||"char",l=r.querySelector(".first-select")?.value||"None",p=r.querySelector(".second-select")?.value||"None";n.push(c),a.push(u),o.push({group:s,type:i,from:l,to:p})}),{pullPlan:o,pity4:n,guarantee4:a}}function xt(e){const o=document.querySelectorAll(".row"),n={},a=[],t=[],r=[],s=[],c=Array.from(o).slice(1);let u=0;return c.forEach(i=>{const l=P(i.querySelector('[data-control="pity-4"]')),p=P(i.querySelector(".guarantee-4"),!0);r.push(l),s.push(p);const f=i.querySelector(".type-selector")?.value||"char",h=i.querySelector(".first-select")?.value||"None",b=i.querySelector(".second-select")?.value||"None",d=f==="char"?e.char:e.wep,m=d.indexOf(h),C=d.indexOf(b);if(m===-1||C===-1||m>=C)return;const A=C-m;let y=m,S=0;for(let g=0;g<A;g++)f==="char"&&y===0?S="none":S="regular",a.push({type:f,bannerCount:u}),t.push(S),y++;u++}),n.typeArray=a,n.cashbackArray=t,{planConfigs:n,pity4:r,guarantee4:s}}function Pt(){const e=document.querySelectorAll("#rate-up-table select.custom-select");let o=[];return e.length===0?(console.error("Could not find any rate-up select elements."),[]):(e.forEach(n=>{const a=n.value;a!=="unknown"&&(a!==void 0?o.push(a):console.warn(`Invalid or unhandled rate-up value found: "${a}"`))}),o)}const Et=`
    <div class="chibi-group">
        <div class="bubble-wrapper bubble-wrapper--big">
            <svg class="bubble-svg-background" viewBox="0 0 1820 858" xmlns="http://www.w3.org/2000/svg">
                <path style="fill:#232338; stroke:#0b091b; stroke-width: 1px"
                    d="M 787.500 1.005 C 640.632 4.659, 524.925 15.685, 414 36.596 C 305.731 57.006, 229.612 80.375, 165.037 113.026 C 88.008 151.975, 38.939 199.840, 15.519 258.874 C 8.496 276.575, 3.327 301.798, 0.941 330 C -2.027 365.084, 6.008 405.046, 22.959 439.500 C 43.249 480.744, 73.516 513.346, 120 544.028 C 209.228 602.924, 363.734 646.238, 553 665.416 C 650.260 675.270, 808.209 681.908, 948.500 682.035 C 999.011 682.081, 1061.358 683.505, 1068.623 684.778 C 1072.726 685.497, 1072.776 685.559, 1079.177 698 C 1096.318 731.313, 1116.859 760.237, 1136.746 779.061 C 1155.047 796.384, 1181.968 815.466, 1202.839 825.908 C 1232.446 840.721, 1273.797 852.517, 1310.770 856.698 C 1324.340 858.232, 1326.511 858.262, 1330.270 856.962 C 1332.596 856.158, 1334.500 855.138, 1334.500 854.696 C 1334.500 854.254, 1331.125 852.760, 1327 851.377 C 1314.484 847.179, 1287.809 833.665, 1277.295 826.195 C 1265.925 818.116, 1226.275 778.561, 1216.635 765.680 C 1206.358 751.947, 1188.566 715.606, 1185.906 702.916 C 1185.282 699.937, 1183.944 693.900, 1182.931 689.500 C 1181.919 685.100, 1180.809 679.883, 1180.464 677.906 L 1179.836 674.312 1189.168 673.673 C 1234.976 670.533, 1307.910 662.018, 1358.500 653.902 C 1387.862 649.192, 1405.290 645.828, 1437.500 638.654 C 1443.550 637.306, 1457.500 634.310, 1468.500 631.995 C 1491.435 627.169, 1506.239 623.528, 1520.500 619.205 C 1526 617.538, 1538.150 614.072, 1547.500 611.504 C 1604.081 595.961, 1658.813 573.047, 1691.807 551.088 C 1716.705 534.517, 1726.861 526.038, 1752.999 500 C 1782.013 471.097, 1799.115 442.990, 1810.458 405.568 C 1814.346 392.741, 1819 366.582, 1819 357.554 C 1819 354.499, 1819.450 352, 1820 352 C 1821.274 352, 1821.299 340.366, 1820.046 330.791 C 1819.521 326.781, 1818.582 319.225, 1817.959 314 C 1809.521 243.236, 1771.421 185.672, 1703 140.314 C 1640.860 99.120, 1548.917 64.910, 1443 43.576 C 1339.978 22.824, 1215.062 9.498, 1072 3.996 C 994.931 1.032, 848.352 -0.509, 787.500 1.005 M 776 4.600 C 771.325 4.777, 754 5.405, 737.500 5.995 C 561.542 12.295, 402.823 35.450, 277.947 73.040 C 210.624 93.305, 153.205 120.092, 109 151.857 C 80.401 172.408, 53.246 200.489, 37.044 226.269 C 19.796 253.711, 10.505 280.375, 6.026 315.288 C 1.913 347.340, 4.080 374.322, 13.106 403.467 C 26.641 447.170, 50.753 482.527, 90 516.224 C 101.716 526.283, 126.303 543.639, 138.425 550.406 C 140.926 551.802, 146.466 554.925, 150.736 557.345 C 194.368 582.071, 259.942 606.163, 334.540 624.875 C 473.407 659.708, 622.538 674.025, 888 678.008 C 1034.249 680.203, 1070.594 680.938, 1073.423 681.757 C 1075.031 682.222, 1076.681 683.255, 1077.088 684.051 C 1077.496 684.848, 1079.729 689.325, 1082.051 694 C 1091.185 712.393, 1108.924 740.328, 1121.008 755.350 C 1129.418 765.805, 1144.301 780.492, 1156.104 789.986 C 1170.999 801.967, 1195.222 817.726, 1208.500 824.072 C 1231.867 835.241, 1272.170 847.555, 1298 851.418 C 1323.491 855.230, 1327.055 855.493, 1319.528 853.009 C 1311.535 850.371, 1284.081 836.370, 1276.055 830.838 C 1260.944 820.423, 1225.667 785.179, 1211.929 766.772 C 1201.655 753.007, 1184.830 717.485, 1182.499 704.638 C 1181.787 700.712, 1180.261 693.675, 1179.109 689 C 1176.730 679.347, 1176.376 672.148, 1178.250 671.514 C 1178.938 671.282, 1190.300 670.164, 1203.500 669.029 C 1239.066 665.973, 1275.315 662.018, 1309.500 657.465 C 1360.426 650.682, 1388.027 645.725, 1449 632.411 C 1463.025 629.349, 1479.778 625.754, 1486.229 624.424 C 1492.681 623.093, 1501.906 620.694, 1506.729 619.093 C 1511.553 617.492, 1527.169 612.983, 1541.432 609.074 C 1573.458 600.295, 1586.835 595.827, 1618.030 583.493 C 1644.114 573.179, 1671.994 559.215, 1688.966 547.965 C 1703.153 538.560, 1722.730 523.374, 1729.500 516.522 C 1732.800 513.182, 1739.501 506.636, 1744.391 501.975 C 1758.521 488.506, 1771.430 473.645, 1779.115 462 C 1788.491 447.791, 1793.962 437.449, 1800.288 421.977 C 1815.087 385.778, 1819.761 344.986, 1813.433 307.269 C 1804.545 254.291, 1779.063 209.320, 1736.709 171.866 C 1691.153 131.580, 1625.043 98.185, 1538.202 71.592 C 1418.757 35.015, 1261.222 14.066, 1048 6.407 C 1008.502 4.988, 802.012 3.616, 776 4.600 M 0.355 344.500 C 0.352 349.450, 0.521 351.601, 0.731 349.280 C 0.940 346.959, 0.943 342.909, 0.736 340.280 C 0.530 337.651, 0.358 339.550, 0.355 344.500" />
                </svg>
            <div class="bubble-text"> </div>
        <img src="/images/37_chibi.png" alt="Tutorial Assistant" class="tutorial-chibi">
        </div>
        <button class="btn btn--tutorial_next">>></button>
        <button class="btn btn--tutorial_end">x</button>
    </div>`,K=[{text:"<p>Welcome to the Gacha Calculator! Let me show you around.</p>",size:"small"},{id:"pity-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>First, input your current pity and guarantees here. You can import data from kornblume directly(press ? near respective elements to learn more)</p>",position:"right"},{id:"pull-plan-step",element:".pull-plan-section",text:"<p>Here add all the characters in the order you plan to obtain them and set pity for the 5* guarantee in the first 10 pulls on the banner, if not aplicable, set it to 10.</p>",position:"bottom",size:"big"},{id:"target-step",element:".header-controls",text:"<p>Now, set your target. This can be your desired confidence level(e.g., a 70% chance of getting all planned items) or your total pull budget.</p>",position:"top",chibiSide:"left",size:"big"},{id:"calculate-button-step",element:"#calculate-btn",text:"<p>Once your plan and target are set, click <strong>Calculate</strong> and I will calculate everything for you.</p>",position:"right",size:"small"},{element:".chart-wrapper",text:"<p>You'll get a chart showing the probability of success for each number of pulls until 100%.</p>",position:"top"},{id:"constellation-input-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>Input how many Standard 5* and non-standard 4* characters you have at each constellation level. This information is necessary for accurate cashback predictions, you can skip it if you don't need it.</p>",position:"right",size:"big"},{id:"rate-ups-step",element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#rateup-panel"]',text:"<p>If you know the rate-up 4-star characters, you can input their constellations on your account. This improves cashback accuracy and reduces unnecessary computation.</p>",position:"right",size:"huge"},{element:"#probability-table",text:"<p>And down here, you can see a detailed table with cashback estimates, for the given amount of pulls, it's only accurate if you inputed your data correctly.</p>",position:"top"}],V={"pity-input-step":{tourStepId:"pity-input-step"},"constellation-input-step":{tourStepId:"constellation-input-step"},"pull-plan-step":{tourStepId:"pull-plan-step"},"calculate-button-step":{tourStepId:"calculate-button-step"},"import-help":{element:".tab-panel-card",text:'<p>You can import your data directly from <a href="https://windbow27.github.io/kornblume/" target="_blank" rel="noopener noreferrer" class="soft-link">kornblume</a>. Click the "Import Data" button and paste the exported JSON data.</p>',position:"right"},"export-help":{element:".tab-panel-card",text:"<p>You can export your data as a JSON file to make backup or to carry over data when you are switching to a different browser/new device.</p>",position:"right",size:"big"},"pity-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#pity-panel"]',text:"<p>You can input your current pity and guarantees here, as well as Capturing Radiance and Epitomized Path points. You can import data from paimon.moe directly.</p>",position:"right",size:"big"},"constelation-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#constellation-panel"]',text:"<p>Input how many Standard 5* and non-standard 4* characters you have at each constellation level. This information is necessary for accurate cashback predictions.</p>",position:"right",size:"big"},"rate-up-help":{element:".tab-panel-card",clickTab:'.tab-link[data-tab-target="#rateup-panel"]',text:"<p>If you know the featured 4*, you can then check what constellation it has on your account. This improves cashback accuracy and reduces unnecessary computation.</p>",position:"right",size:"big"},"pull-plan-help":{element:".pull-plan-section",text:"<p>Here add all the characters in the order you plan to obtain them and set pity for the 5* guarantee in the first 10 pulls on the banner, if not aplicable, set it to 10.</p>",position:"bottom",size:"big"},"target-help":{element:".header-controls",text:"<p>Set your target here: either your desired confidence level(e.g., 70% chance of getting all planned items) or your total pull budget.</p>",position:"top",chibiSide:"left",size:"big"},"cashback-help":{element:"#probability-table",text:"<p>Expected cashback for each 5* target reached with their respective probabilities, percentiles give you a reasonable range by cutting off extreme results(10% from each side).</p>",size:"big",chibiSide:"left",position:"top"}};class Mt{constructor(o){this.parts=o,this.persistence=$("reverse",T);const n=Rt({cashbackCalculator:this.parts.cashbackFn,uiUpdater:this.parts.updateTableFn});this.tutorial=new J(Et);const a={getPageConfiguration:wt,getLabels:ot,getPullPlan:At,getTarget:nt,updateChart:at,convertToChartData:et,recalcInputs:tt,calculatorFunction:this.parts.runCalcFn,calculatorConfig:{gachaConfig:this.parts.gachaConfig,CONSTELLATION_MAP:this.parts.CONSTELLATION_MAP},pageConfig:{SELECTORS:T,INITIAL_CONFIG:Q},postCalculationHooks:[n],persistence:this.persistence,chibi:this.tutorial};this.validator=new X(this.parts.CONSTELLATION_MAP),this.calculationHandler=new Z(a),this.calculateBtn=document.getElementById("calculate-btn"),this.exportBtn=document.getElementById("export-btn"),this.startTourBtn=document.getElementById("start-tour-btn"),this.toggleButtonsBtn=document.getElementById("toggle-buttons-btn")}initialize(){this.validator.initialize(),rt(this.persistence,this.parts.gachaConfig,this.validator),st(),it(this.persistence),this.#t(),this.#a(),this.tutorial.showTutorialIfNeeded(K)}#t(){lt(),this.calculateBtn&&this.calculateBtn.addEventListener("click",async()=>{this.#e()&&await this.calculationHandler.runCalculation()}),this.exportBtn&&this.exportBtn.addEventListener("click",()=>ct(this.persistence)),this.startTourBtn&&this.startTourBtn.addEventListener("click",()=>{this.tutorial.startTour(K)}),ut(this.persistence,Ct,this.validator,T,this.tutorial),document.querySelectorAll(".help-btn").forEach(n=>{n.addEventListener("click",a=>{a.preventDefault();const t=n.getAttribute("data-help-key")||n.getAttribute("data-tour-step-id");if(t&&V[t]){const r=V[t];this.tutorial.showHelp(r,n)}else console.warn(`ChibiTutorial: No help configuration found for key '${t}'.`,n)})}),this.toggleButtonsBtn&&this.toggleButtonsBtn.addEventListener("click",()=>{document.querySelectorAll(".help-btn").forEach(a=>{a.classList.toggle("hidden")}),this.persistence.saveButtons()})}#e(){if(document.querySelectorAll(".is-invalid").forEach(t=>t.classList.remove("is-invalid")),this.validator.isDataValid())return!0;console.warn("Validation failed. Calculation blocked."),this.validator.validateAll(),this.validator.isRowPityValid();const o=document.querySelectorAll(".is-invalid"),n=new Set;o.forEach(t=>{const r=t.closest(".tab-pane");if(r){const s=document.querySelector(`.tab-link[data-tab-target="#${r.id}"]`);s&&n.add(s)}t.classList.add("flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})}),n.forEach(t=>{t.classList.add("is-invalid","flicker"),t.addEventListener("animationend",()=>t.classList.remove("flicker"),{once:!0})});const a=Array.from(n)[0];return a&&a.click(),setTimeout(()=>{o[0]?.scrollIntoView({behavior:"smooth",block:"center"})},100),!1}#a(){const o=this.persistence.loadCalculation(),n=o?o.input:null;o?(D(this.parts.gachaConfig.paths,n),B(z,o),_(o.persistInput)):(D(this.parts.gachaConfig.paths),B(z),_()),this.calculationHandler.runCalculation()}}const w=1e-10;function Tt(e,o,n){const a=e.length-2;let t=e.length-1,r=e[t-1].bannerCount+1,s=Array.from({length:r},()=>({pullsSum:0,rankUpSum:0})),c=Array(r).fill(0);Ot(e,s);for(let u=a;u>=0;u--)e[u].isEmpty||(Lt(o,u,e,n,0,c),It(s,c));return s}function Ot(e,o){for(let n=0;n<e.length-1;n++){let a=e[n].bannerCount,t=0;for(let r=0;r<e[n].states.length;r++)for(const[s,c]of e[n].states[r])t+=c.prob;o[a].pullsSum+=t}}function It(e,o){for(let n=0;n<e.length;n++)e[n].rankUpSum=o[n]}function Ut(e,o,n){const a=e.length-2;for(let t=a;t>=0;t--){const r=e[t];r.isEmpty||Dt(o,t,e,n,r.type)}}function Lt(e,o,n,a,t,r){const s=n[o].states.length;let c=.5;const u=n[o].states,i=n[o].bannerCount,l=n[o+1].states;for(let p=s-1;p>=0;p--){const f=u[p],h=p>=a,b=e[p-a*h];for(const[d,m]of f){const C=m.prob*b,A=m.prob-C;let y=C;if(y>w){h||(y*=c);const g=l[t],k=g.get(d);k?k.prob+=y:g.set(d,{prob:y}),r[i]+=y}if(!h){let g=C*(1-c);if(g>w){let k=d+1;const v=u[a],R=v.get(k);R?R.prob+=g:v.set(k,{prob:g})}}let S=A;if(S>w){const g=u[p+1],k=g.get(d);k?k.prob+=S:g.set(d,{prob:S})}m.prob=0}}return r}function Nt(e,o,n){let a;for(let t=0;t<e.length;t++){const r=n[t].pullsSum,s=n[t].rankUpSum,c=r-s,u=e[t].length-1;for(let i=u;i>=0;i--){const l=e[t][i].states;for(let p=1;p>=0;p--){a=p===1;let f=l[p];if(f.length===11){for(let h=9;h>=0;h--)for(const[b,d]of f[h]){const m=d.prob;if(m*r>w){d.prob=m*(1-r);let A=!1;h===9&&(A=!0);let y=o;A&&(y=1);const S=m*y*c,g=m*(1-y)*c,k=m*s;if(S>w){let v=S;if(a||(v*=.5),e[t][i+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][i+1].states[0].set(b,{prob:v});else{const R=e[t][i+1].states[0],E=R.get(b);E?E.prob+=v:R.set(b,{prob:v})}if(!a){let R=b+1;const E=l[1],L=E.get(R);L?L.prob+=v:E.set(R,{prob:v})}}if(g>w){const v=l[p][h+1],R=v.get(b);R?R.prob+=g:v.set(b,{prob:g})}if(k>w){const v=l[0][10],R=v.get(b);R?R.prob+=k:v.set(b,{prob:k})}}}f=f[10]}for(const[h,b]of f){const d=b.prob;if(d*r>w){const C=d*o*c,A=d*(1-o)*c+d*s;if(b.prob=d*(1-r)+A,C>w){let y=C;if(a||(y*=.5),e[t][i+1]===void 0)e[t].push({states:Array.from({length:2},()=>new Map)}),e[t][i+1].states[0].set(h,{prob:y});else{const S=e[t][i+1].states[0],g=S.get(h);g?g.prob+=y:S.set(h,{prob:y})}if(!a){let S=h+1;const g=l[1],k=g.get(S);k?k.prob+=y:g.set(S,{prob:y})}}}}}}}}function Dt(e,o,n,a,t){const r=n[o].states.length;let s=.5;const c=n[o].states,u=n[o+1].states;for(let i=r-1;i>=0;i--){const l=c[i],p=i>=a,f=e[i-a*p],h=l*f,b=l-h;let d=h;if(d>w&&(p||(d*=s),u[t]+=d),!p){let C=h*(1-s);C>w&&(c[a]+=C)}let m=b;m>w&&(c[i+1]+=m),c[i]=0}}function Bt(e,o,n){if(!Array.isArray(e.SSR.pullPlan))throw new Error("Invalid pull plan");const{pullPlan:a}=e.SSR,t=[];for(let s=0;s<a.length;s++)t.push({states:Array.from({length:n},()=>new Map),isEmpty:!0,bannerCount:a[s].bannerCount});return t.push({states:Array.from({length:1},()=>new Map)}),r(o),t;function r(s){t[0].states[s].set(0,{prob:1}),t[0].isEmpty=!1}}function zt(e,o){return{SSR:e.SSR.pity.char+e.SSR.guarantee.char*o.pitySSR}}function _t(e){const o=e.SSR.pullPlan,n=o.length-1,a=o[n].bannerCount;let t=[];for(let r=0;r<=a;r++){const s=e.SR.pity[r];let c=!0;s===10&&(c=!1);let u=0;e.SR.guarantee[r]&&(u=1),c?u?(t.push([{states:[new Map,Array.from({length:11},()=>new Map)]}]),t[r][0].states[u][s].set(0,{prob:1})):(t.push([{states:[Array.from({length:11},()=>new Map),new Map]}]),t[r][0].states[u][s].set(0,{prob:1})):(t.push([{states:[new Map,new Map]}]),t[r][0].states[u].set(0,{prob:1}))}return t}function qt(e){let o=[];for(let n of e)for(let a=0;a<n.length;a++)for(let t=0;t<n[a].states.length;t++)if(Array.isArray(n[a].states[t]))for(let r=0;r<n[a].states[t].length;r++)for(let[s,c]of n[a].states[t][r])if(o[a]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[a].states[0].set(s,{prob:c.prob});else{const u=o[a].states[t],i=u.get(s);i?i.prob+=c.prob:u.set(s,{prob:c.prob})}else for(let[r,s]of n[a].states[t])if(o[a]===void 0)o.push({states:Array.from({length:2},()=>new Map)}),o[a].states[0].set(r,{prob:s.prob});else{const c=o[a].states[t],u=c.get(r);u?u.prob+=s.prob:c.set(r,{prob:s.prob})}return o}function Ht(e){let o=0;for(let t of e)o+=t.pullsSum;if(Math.abs(o-1)>1e-5)for(let t of e)t.pullsSum/=o,t.rankUps/=o}function Ft(e,o){let n=[],a={},t=!1,r=!1,s=x.pity.pitySSR*2;const c=zt(e,x.pity);let u=Bt(e,c.SSR,s),i=_t(e),l=0;const p=10;for(;!r&&!t;){if(a=Tt(u,q,x.pity.pitySSR),Ht(a),Nt(i,pt,a),l++,l===p){M(u);for(let b of i)M(b);l=0}n.push(bt(u)),t=dt(u,o,n.length),t||(r=H(u,t))}if(!l===p){M(u);for(let b of i)M(b)}i=qt(i);const f={SSR:F(u),SR:F(i)};for(mt(u),i=null;!r;)t&&(l++,Ut(u,q,x.pity.pitySSR),l===p&&gt(u),n.push(yt(u)),r=H(u,t));return{chartData:n,cashbackData:f}}class U{constructor(o,n,a){this.rateUps=o,this.offRates=n,this.probability=a}}function Kt(e,o,n){const a=[],t=new Array(n).fill(0);function r(s,c){if(s===n){if(c===o){const i=Y(t,e);a.push(new U([...t],i))}return}const u=Math.min(e[s],o-c);for(let i=0;i<=u;i++)t[s]=i,r(s+1,c+i),t[s]=0}return r(0,0),a}function Y(e,o){const n=[...o];for(let a=0;a<e.length;a++)n[a]-=e[a];return n}function Vt(e,o,n){const a=new Array(Object.keys(n).length).fill(0);for(const t of o)if(t==="new")e[0]++,a[0]++;else{const r=n[t];r!==void 0?a[r]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return a}function Wt(e,o,n){const a=e.length,t=n.reduce((i,l)=>i+l,0),r=o-t;if(r<0)return console.error("Error: More items are known than the total required."),[];const s=new Array(a);for(let i=0;i<a;i++)if(s[i]=e[i]-n[i],s[i]<0)return console.error(`Error: Known picks for constellation ${i} exceed its capacity.`),[];return Kt(s,r,a).map(i=>{const l=i.rateUps.map((f,h)=>f+n[h]),p=Y(l,e);return new U(l,p)})}function Yt(e,o,n){const a=o.map((s,c)=>s-n[c]),t=new Map;for(const s of e){const c=s.rateUps.map((i,l)=>i-n[l]);if(c.some(i=>i<0)){s.probability=0;continue}const u=new U(c,[]);t.set(u,s)}const r=Array.from(t.keys());r.length>0&&ft(r,a);for(const[s,c]of t.entries())c.probability=s.probability}function jt(e,o,n){let a=o[e.rateUpCount],t=n[e.charOffRateCount];return{mean:a+t.mean,variance:t.variance}}function Gt(e){const n=Math.sqrt(e.variance),a=1/Math.sqrt(.2);let t=e.mean-n*a;t<0&&(t=0);const r=e.mean+n*a,s=e.mean;return{LOWER_BOUND:t,MEAN:s,UPPER_BOUND:r}}function $t(e,o){const n=[];let a=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries()){const c=r;s.prob>o&&(n.push({rateUpCount:t,charOffRateCount:c,probability:s.prob}),a=Math.max(a,c))}return{combos:n,maxOffRateCount:a}}function Jt(e,o){const n=[];let a=0;for(let t=0;t<e.length;t++)for(const[r,s]of e[t].offRates.entries())s.prob>o&&(n.push({rateUpCount:t,offRateCount:r,probability:s.prob}),a=Math.max(a,r));return{combos:n,maxOffRateCount:a}}function Xt(e,o,n){let a=0,t=0;for(const{rateUpCount:r,offRateCount:s,probability:c}of e){const u=o[r],i=n[s],l=u.mean+i.mean,p=u.variance+i.variance+Math.pow(l,2);a+=c*l,t+=c*p}return{mean:a,variance:Math.max(0,t-Math.pow(a,2))}}function j(e){let o=0,n=0;for(const{probability:a,cashback:t}of e)o+=a*t.mean;for(const{probability:a,cashback:t}of e){const r=t.variance+Math.pow(t.mean,2);n+=a*r}return{mean:o,variance:Math.max(0,n-Math.pow(o,2))}}const G=1e-8;function Zt(e,o,n,a,t,r){n=Qt(n),t=Vt(e.SR.consCount,t,r);const s=Wt(e.SR.consCount,o.rateUpCharacterSR,t);Yt(s,e.SR.consCount,t);const c=te(n,o.poolStandardCharSSR,e.SSR.consCountStandard,e.SSR.cashbackRoadmap,o),u=ee(s,a,o),i=c;for(let l=0;l<i.length;l++)i[l].mean+=u.mean,i[l].variance+=u.variance,i[l]=Gt(i[l]);return i}function Qt(e){let o=0;for(const n of e)for(const[a,t]of n.offRates)o+=t.prob;for(const n of e)for(const[a,t]of n.offRates)t.prob/=o;return e}function te(e,o,n,a,t){const{combos:r,maxOffRateCount:s}=$t(e,G),c=[0];let u=0;for(let l=0;l<e.length;l++)a[l-1]==="none"?c.push(u):a[l-1]==="regular"&&(u+=t.configSSR.regularPoints,c.push(u));const i=Array.from({length:e.length},()=>[]);for(const l of r){const p=l.rateUpCount,f=l.probability,b=new I(n,o,t.configSSR).runSteps(s),d=jt(l,c,b);i[p].push({cashback:d,probability:f})}for(let l=0;l<i.length;l++){const p=ne(i[l]);i[l]=j(p)}return i}function ee(e,o,n){const{combos:a,maxOffRateCount:t}=Jt(o,G);return ae(e,a,t,n)}function ae(e,o,n,a){const t=Math.max(...o.map(s=>s.rateUpCount)),r=[];for(const{rateUps:s,offRates:c,probability:u}of e){const l=new I(s,a.rateUpCharacterSR,a.configSR).runSteps(t),f=new I(c,a.poolCharSR-a.rateUpCharacterSR,a.configSR).runSteps(n),h=Xt(o,l,f);r.push({probability:u,cashback:h})}return j(r)}function ne(e){let o=0;for(const n of e)o+=n.probability;for(const n of e)n.probability/=o;return e}document.addEventListener("DOMContentLoaded",()=>{const e={gachaConfig:x,CONSTELLATION_MAP:O,runCalcFn:Ft,cashbackFn:Zt,updateTableFn:ht};new Mt(e).initialize()});
