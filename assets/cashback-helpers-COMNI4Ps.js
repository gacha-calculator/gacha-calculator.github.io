import{t as F,v as z}from"./solvers-CU3sbQzp.js";function G(a){const{cashbackCalculator:i,uiUpdater:r}=a;return function(e){const{results:o,inputConfig:n,chartLabels:c,gachaConfig:m,CONSTELLATION_MAP:s}=e,p=i(n,m,o.cashbackData.SSR,o.cashbackData.CharSR,o.cashbackData.WepSR,n.SR.rateUps,s);r(o.cashbackData.SSR,c,p)}}class ${constructor(i,r={}){this.config=i,this.adapters={statesLimits:null,distributionArrays:{makeSSR:()=>{throw new Error("makeSSR not implemented")},makeSR:()=>{throw new Error("makeSR not implemented")},sortPity:()=>{throw new Error("sortPity not implemented")}},pullLogic:{rankUpSSRCheap:()=>{throw new Error("rankUpSSRCheap not implemented")}},workers:{ssrWorker:()=>{throw new Error("ssrWorker not implemented")},srWorker:()=>{throw new Error("srWorker not implemented")}},contexts:{contextSSR:()=>{throw new Error("contextSSR not implemented")},contextSR:()=>{throw new Error("contextSR not implemented")}},helpers:{consolidateDistributionForCashback:()=>{throw new Error("consolidateDistributionForCashback not implemented")},consolidateProbabilitiesCheap:()=>{throw new Error("consolidateProbabilitiesCheap not implemented")},simplifyDistribution:()=>{throw new Error("simplifyDistribution not implemented")},normalizeCheap:()=>{throw new Error("normalizeCheap not implemented")},checkIsEmpty:()=>{throw new Error("checkIsEmpty not implemented")}},...r}}async runGachaCalculation(i,r){this.adapters.contexts.contextSSR.target=r;let t=[],e={},o=!1,n=!1;const{ssrWorker:c,srWorker:m}=this.adapters.workerManager.getWorkers(),s=this.adapters.distributionArrays.sortPity(i);this.adapters.contexts.contextSSR.pities=s;let{distributionSSR:p}=this.adapters.distributionArrays.makeSSR(i,s),{distributionCharSR:f,distributionWepSR:R}=this.adapters.distributionArrays.makeSR(i);try{await P(c,m,this.adapters.contexts,p,{distributionCharSR:f,distributionWepSR:R},s)}catch(l){console.error("Failed to initialize workers:",l)}let u=await E(c);for(u.type==="IterationComplete"?e=u.lossData:(e=u.lossData,o=u.isTarget,n=u.isEmpty,t=u.allPullsDistributionSSR,p=u.distributionSSR);!n&&!o;)T(e),[u]=await Promise.all([E(c),x(m,e)]),u.type==="IterationComplete"?e=u.lossData:(e=u.lossData,o=u.isTarget,n=u.isEmpty,t=u.allPullsDistributionSSR,p=u.distributionSSR);let S=await A(m,e);this.adapters.workerManager.terminateWorkers(),f=S.distributionCharSR,R=S.distributionWepSR;const O={SSR:this.adapters.helpers.consolidateDistributionForCashback(p),CharSR:this.adapters.helpers.consolidateDistributionForCashback(f),WepSR:this.adapters.helpers.consolidateDistributionForCashback(R)};this.adapters.helpers.simplifyDistribution(p),f=null,R=null;let g=0;const v=10;for(;!n;)o&&(g++,this.adapters.pullLogic.rankUpSSRCheap(p,s),g===v&&this.adapters.helpers.normalizeCheap(p),t.push(this.adapters.helpers.consolidateProbabilitiesCheap(p)),n=this.adapters.helpers.checkIsEmpty(p,o));return{chartData:t,cashbackData:O};async function P(l,h,k,b,{distributionCharSR:w,distributionWepSR:L}){return new Promise((N,_)=>{let W=!1,M=!1,C=!1;function D(){!C&&W&&M&&N()}function U(d){C||(C=!0,_(d))}l.onerror=d=>{console.error("Worker error:",d),U(d)},h.onerror=d=>{U(d)},l.onmessage=function(d){switch(d.data.type){case"InitComplete":W=!0,D();break;default:console.warn("Unknown message type")}},h.onmessage=function(d){switch(d.data.type){case"InitComplete":M=!0,D();break;default:console.warn("Unknown message type")}},l.postMessage({type:"Initiate",distribution:b,context:k}),h.postMessage({type:"Initiate",distribution:{distributionCharSR:w,distributionWepSR:L},context:k})})}function E(l){return new Promise((h,k)=>{l.onmessage=b=>{switch(b.data.type){case"IterationComplete":h(b.data);break;case"LastIteration":h(b.data);break}},l.onerror=k,l.postMessage({type:"Iterate"})})}function x(l,h){return new Promise((k,b)=>{l.onmessage=w=>{k()},l.onerror=b,l.postMessage({type:"Iterate",lossData:h})})}function A(l,h){return new Promise((k,b)=>{l.onmessage=w=>{k(w.data)},l.onerror=b,l.postMessage({type:"IterateLast",lossData:h})})}function T(l){const h=l.charRankUps.pullsSum+l.wepRankUps.pullsSum;Math.abs(h-1)>1e-5&&(l.charRankUps.pullsSum/=h,l.charRankUps.rankUps/=h,l.wepRankUps.pullsSum/=h,l.wepRankUps.rankUps/=h)}}}function H(a){return new Worker("/assets/ssr-worker-C_SG_wKf.js",{type:"module",name:a?.name})}function K(a){return new Worker("/assets/sr-worker-CXkWv8LU.js",{type:"module",name:a?.name})}class Z{constructor(){this.ssrWorker=null,this.srWorker=null}getWorkers(){return this.ssrWorker||(this.ssrWorker=new H),this.srWorker||(this.srWorker=new K),{ssrWorker:this.ssrWorker,srWorker:this.srWorker}}terminateWorkers(){this.ssrWorker&&this.ssrWorker.terminate(),this.srWorker&&this.srWorker.terminate(),this.ssrWorker=null,this.srWorker=null}}class y{constructor(i,r,t){this.rateUps=i,this.offRates=r,this.probability=t}}function V(a,i,r){const t=[],e=new Array(r).fill(0);function o(n,c){if(n===r){if(c===i){const s=I(e,a);t.push(new y([...e],s))}return}const m=Math.min(a[n],i-c);for(let s=0;s<=m;s++)e[n]=s,o(n+1,c+s),e[n]=0}return o(0,0),t}function I(a,i){const r=[...i];for(let t=0;t<a.length;t++)r[t]-=a[t];return r}function X(a,i,r){const t=new Array(Object.keys(r).length).fill(0);for(const e of i)if(e==="new")a[0]++,t[0]++;else{const o=r[e];o!==void 0?t[o]++:console.warn(`Invalid or unhandled rate-up value found: "${selectedValue}"`)}return t}function Y(a,i,r){const t=a.length,e=r.reduce((s,p)=>s+p,0),o=i-e;if(o<0)return console.error("Error: More items are known than the total required."),[];const n=new Array(t);for(let s=0;s<t;s++)if(n[s]=a[s]-r[s],n[s]<0)return console.error(`Error: Known picks for constellation ${s} exceed its capacity.`),[];return V(n,o,t).map(s=>{const p=s.rateUps.map((R,u)=>R+r[u]),f=I(p,a);return new y(p,f)})}function B(a,i,r){const t=i.map((n,c)=>n-r[c]),e=new Map;for(const n of a){const c=n.rateUps.map((s,p)=>s-r[p]);if(c.some(s=>s<0)){n.probability=0;continue}const m=new y(c,[]);e.set(m,n)}const o=Array.from(e.keys());o.length>0&&F(o,t);for(const[n,c]of e.entries())c.probability=n.probability}function J(a,i,r,t){return Array.from({length:a+1},(e,o)=>{const n=z(o,t);let c=0,m=0;for(let s=0;s<=o;s++){const p=o-s,f=i[s],R=p*r,u=f.mean+R,S=f.variance+Math.pow(u,2);c+=u*n[s],m+=S*n[s]}return{mean:c,variance:Math.max(0,m-Math.pow(c,2))}})}function Q(a,i,r,t){let e=i[a.rateUpCount],o=r[a.charOffRateCount],n=a.wepOffRateCount*t;return{mean:e+o.mean+n,variance:o.variance}}function tt(a){const r=Math.sqrt(a.variance),t=1/Math.sqrt(.2);let e=a.mean-r*t;e<0&&(e=0);const o=a.mean+r*t,n=a.mean;return{LOWER_BOUND:e,MEAN:n,UPPER_BOUND:o}}function et(a,i){const r=[];let t=0;for(let e=0;e<a.length;e++)for(const[o,n]of a[e].offRates.entries()){const c=Math.floor(o/100);n.prob>i&&(r.push({rateUpCount:e,charOffRateCount:c,wepOffRateCount:o%100,probability:n.prob}),t=Math.max(t,c))}return{combos:r,maxOffRateCount:t}}function at(a,i){const r=[];let t=0;for(let e=0;e<a.length;e++)for(const[o,n]of a[e].offRates.entries())n.prob>i&&(r.push({rateUpCount:e,offRateCount:o,probability:n.prob}),t=Math.max(t,o));return{combos:r,maxOffRateCount:t}}function rt(a,i,r){let t=0,e=0;for(const{rateUpCount:o,offRateCount:n,probability:c}of a){const m=i[o],s=r[n],p=m.mean+s.mean,f=m.variance+s.variance+Math.pow(p,2);t+=c*p,e+=c*f}return{mean:t,variance:Math.max(0,e-Math.pow(t,2))}}function ot(a){let i=0,r=0;for(const{probability:t,cashback:e}of a)i+=t*e.mean;for(const{probability:t,cashback:e}of a){const o=e.variance+Math.pow(e.mean,2);r+=t*o}return{mean:i,variance:Math.max(0,r-Math.pow(i,2))}}function nt(...a){return a.reduce((i,r)=>({mean:i.mean+r.mean,variance:i.variance+r.variance}),{mean:0,variance:0})}export{Z as W,Y as a,B as b,G as c,tt as d,et as e,Q as f,$ as g,ot as h,at as i,nt as j,J as k,rt as l,X as p};
